{"job":{"components":{"6332636":{"id":6332636,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":176,"y":0,"width":32,"height":32,"inputConnectorIDs":[6332602],"outputSuccessConnectorIDs":[6332601],"outputFailureConnectorIDs":[6332603],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"REPORT_FPR"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\n\ncursor = context.cursor()\ncursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR\")\ncursor.execute(\"INSERT INTO ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR ( BRANCH ,\tREGION ,\tCUST_ID ,\tCUST_NAME ,\tINVOICE ,\tWORK_STATE ,\tASSIGNMENT ,\tEMPL_ID ,\tLAST ,\tFIRST ,\tORDER_TYPE ,\tJOB_CODE ,\tNORM_POSTING_DATE ,\tTRAN_DATE ,\tWC_CODE ,\tGL_ACCOUNT ,\tWAGE_CODE ,\tWAGE_CODE_DESCRIPTION ,\tBILL_HRS ,\tBILL_RATE ,\tBILL_AMT ,\tPAY_HRS ,\tPAY_RATE ,\tPAY_AMT ,\tFICA ,\tFICA_PERCENT ,\tFUTA ,\tFUTA_PERCENT ,\tSUI ,\tSUI_PERCENT ,\tWORK_COMP ,\tWC_BY_100 ,\tGLI_EPLI ,\tACA ,\tOTHER ,\tOTHER_PERCENT ,\tGM ,\tGM_PERCENT ,\tFILLEDBY ,\tSUPERVISOR ,\tSALES_REP ) SELECT DISTINCT A.ACCT_UNIT AS BRANCH, A.REGION AS REGION, A.CUST_ID AS CUST_ID, A.CUST_NAME AS CUST_NAME, A.INVOICE AS  INVOICE, A.WORK_STATE AS WORK_STATE, A.ACTIVITY AS ASSIGNMENT, A.SRC_EMP_ID AS EMPL_ID, A.LAST AS LAST, A.FIRST AS FIRST, A.ORDER_TYPE AS ORDER_TYPE, A.JOB_CODE AS JOB_CODE, A.NORM_POSTING_DATE AS NORM_POSTING_DATE, A.TRAN_DATE AS TRAN_DATE, A.WC_CODE AS WC_CODE, CASE WHEN A.ACCT_CATEGORY2_A = 'BILLD' THEN A.ACCOUNT  ELSE ''END AS  GL_ACCOUNT, A.ACCT_CATEGORY2_A AS WAGE_CODE, A.WAGE_CODE_DESCRIPTION AS WAGE_CODE_DESCRIPTION, A.BILLABLE_UNIT AS BILL_HRS, A.BILL_RATE AS BILL_RATE, A.BILLABLE_AMT AS BILL_AMT, A.PAY_HRS AS PAY_HRS, CAST(A.PAY_RATE AS NUMBER(18,2)) AS PAY_RATE, A.PAY_AMT AS PAY_AMT, A.FICA AS FICA, A.FICA_PERCENT AS FICA_PERCENT, A.FUTA AS FUTA, A.FUTA_PERCENT AS FUTA_PERCENT, A.SUI AS SUI, A.SUI_PERCENT AS SUI_PERCENT, A.WORK_COMP AS WORK_COMP, A.WC_BY_100, A.GLI_EPLI AS GLI_EPLI,  A.ACA AS ACA,   A.OTHER AS OTHER, A.OTHER_PERCENT AS OTHER_PERCENT, A.GM AS GM, A.GM_PERCENT AS GM_PERCENT, A.FILLEDBY AS FILLEDBY, A.SUPERVISOR AS SUPERVISOR, A.SALES_REP AS SALES_REP  FROM  (SELECT A.*  ,CASE WHEN ACCT_CATEGORY2 IS NULL AND BILLABLE_AMT = 0 AND (BILLABLE_UNIT = 0 OR BILLABLE_UNIT IS NULL)  AND (PAY_HRS = 0 OR PAY_HRS IS NULL) AND PAY_AMT = 0 AND (OTHER <> 0 OR GLI_EPLI <> 0 OR ACA <> 0)  THEN 'PDSP' ELSE\tACCT_CATEGORY2\t END AS ACCT_CATEGORY2_A  , B.BRANCH_ID FROM ${SNFLKDB}.${SNFLKSCH}.DIM_MEASURE_SUMMARY_A_TEMP  A  LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_BRANCH B ON A.ACCT_UNIT=B.BRANCH_NM AND B.ACTIVE_STATUS='Y' )A  UNION ALL  SELECT B.WBS_ACCT_UNIT AS BRANCH, '' AS REGION, B.CUSTOMER AS CUST_ID, B.SEARCH_NAME AS CUST_NAME, B.INVOICE AS  INVOICE, '' AS WORK_STATE, B.WBS_ACTIVITY AS ASSIGNMENT, '' AS EMPL_ID, B.DESCRIPTION AS LAST, '' AS FIRST, '' AS ORDER_TYPE, '' AS JOB_CODE, B.WBS_NORM_POSTING_DATE, B.WBS_TRAN_DATE, '' AS WC_CODE, CASE WHEN B.WBS_ACCT_CATEGORY = 'BILLD' THEN WBS_ACCOUNT  ELSE '' END AS  GL_ACCOUNT, B.WBS_ACCT_CATEGORY AS WAGE_CODE, '' AS WAGE_CODE_DESCRIPTION, 0.00 AS BILL_HRS, 0.00 AS BILL_RATE, B.WBS_TRAN_AMOUNT AS BILL_AMT, 0.00 AS PAY_HRS, 0.00 AS PAY_RATE, 0.00 AS PAY_AMT, 0.00 AS FICA, 0.00 AS FICA_PERCENT, 0.00 AS FUTA, 0.00 AS FUTA_PERCENT, 0.00 AS SUI, 0.00 AS SUI_PERCENT, 0.00 AS WORK_COMP, 0.00 AS WC_BY_100, 0.00 AS GLI_EPLI, 0.00 AS ACA,  B.WBS_OTHER AS OTHER, 0.00 AS OTHER_PERCENT, (B.WBS_TRAN_AMOUNT - B.WBS_OTHER) AS GM,  0.00 AS GM_PERCENT, '' AS FILLEDBY, '' AS SUPERVISOR, '' AS SALES_REP FROM ${SNFLKDB}.${SNFLKSCH}.ACTIV_B_TEMP B \")\n\ncursor.execute(\"INSERT INTO ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR (BRANCH, REGION, CUST_ID, CUST_NAME, INVOICE, WORK_STATE, ASSIGNMENT, EMPL_ID, LAST, FIRST, ORDER_TYPE, JOB_CODE, NORM_POSTING_DATE, TRAN_DATE, WC_CODE, GL_ACCOUNT, WAGE_CODE, WAGE_CODE_DESCRIPTION, BILL_HRS, BILL_RATE, BILL_AMT, PAY_HRS, PAY_RATE, PAY_AMT, FICA, FICA_PERCENT, FUTA, FUTA_PERCENT, SUI, SUI_PERCENT, WORK_COMP, WC_BY_100, GLI_EPLI, ACA, OTHER, OTHER_PERCENT, GM, GM_PERCENT, FILLEDBY, SUPERVISOR, SALES_REP) SELECT DISTINCT TRANS.ACCT_UNIT_TXT BRANCH,  REGION.MX_VALUE REGION,  CUST.CUSTOMER ,  CUST.SEARCH_NAME ,  INV.INVOICE_NUM INVOICE,  PR.WORK_STATE WORK_STATE,  TRANS.ACTIVITY ASSIGNMENT,  EMP.SRC_EMP_ID AS EMPL_ID ,  EMP.LAST_NAME AS LAST,  EMP.FIRST_NAME AS FIRST,  JO.JOB_ORD_TYP ORDER_TYPE,  JO.JOB_CD_NM JOB_CODE,  DATEADD(DAY, (7 - DATE_PART(WEEKDAY, TRANS.POSTING_DT)) % 7, TRANS.POSTING_DT) NORM_POSTING_DATE,  TRANS.TRAN_DT TRAN_DATE ,  COALESCE(TRANS.JOB_CODE, CWC.CDA_CODE) AS WC_CODE,  '' GL_ACCOUNT,  TRANS.ACCT_CAT_CD WAGE_CODE,  WC.WAGE_CD_DESC_TXT WAGE_CODE_DESCRIPTION,  SUM(TRANS.UNITS_AMOUNT) BILL_HRS,  0.00 BILL_RATE,  0.00 BILL_AMT,  PR.HOURS AS PAY_HRS ,  0.00 PAY_RATE,  CASE  WHEN (TRANS.ACCOUNT_NM IN (5100,5950,5525,6120,5520,5515) OR (TRANS.ACCOUNT_NM IN (5900) AND SUM(TRANS.UNITS_AMOUNT) <> 0)) THEN SUM(TRANS.TRAN_AMT)  ELSE 0.00  END AS PAY_AMT,  0.00 FICA,  0.00 FICA_PERCENT,  0.00 FUTA,  0.00 FUTA_PERCENT,  0.00 SUI,  0.00 SUI_PERCENT,  0.00 WORK_COMP,  0.00 WC_BY_100,  0.00 GLI_EPLI,  0.00 ACA,  0.00 OTHER,  0.00 OTHER_PERCENT,  0.00 GM,  0.00 GM_PERCENT,  ASGN.FILLED_BY_ID_NAME FILLED_BY_ID_NAME ,  ASGN.REPORTS_TO_ID_NM SUPERVISOR,  ACT.SALES_REP_NM SALES_REP_NM FROM ${SNFLKDB}.${SNFLKSCH}.DIM_TRANS TRANS LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_INVOICE INV ON TRANS.SRC_OBJ_ID=INV.SRC_OBJ_ID AND INV.ACTIVE_STATUS='Y' LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_PAYRATE_TRANS PR ON PR.ATN_OBJ_ID=TRANS.SRC_OBJ_ID AND PR.ACTIVE_STATUS='Y' LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_ACTIVITY ACT ON TRANS.ACTIVITY=ACT.ACTIVITY_TXT AND ACT.ACTIVE_STATUS='Y' LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_WAGE_CODE WC ON WC.WAGE_CD=TRANS.ACCT_CAT_CD AND WC.ACTIVE_STATUS='Y' LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_ASSIGNMENT ASGN ON SUBSTR(TRANS.ACTIVITY, 2)=ASGN.ASSIGN_NUM AND ASGN.ACTIVE_STATUS='Y' LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_ASSIGNMENTBASE LASGN ON ASGN.ASSIGN_NUM=LASGN.CDA_ASSIGNMENTNUMBER LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_JOB_ORDER JO ON JO.SRC_JOB_ORD_ID= LASGN.CDA_JOBORDER AND JO.ACTIVE_STATUS='Y' LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_WCCODEBASE CWC ON LASGN.CDA_WCCODE = CWC.CDA_WCCODEID LEFT JOIN (SELECT CUS.*, ACT.ACTIVITY_TXT  FROM ${SNFLKDB}.${SNFLKSCH}.DIM_CUSTOMER CUS  JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_ACTIVITY ACT ON CUS.CUSTOMER = ACT.LEVEL_DETAIL_02  AND ACT.ACTIVE_STATUS='Y'  WHERE CUS.ACTIVE_STATUS='Y' )CUST ON TRANS.ACTIVITY =CUST.ACTIVITY_TXT LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_EMPLOYEE EMP ON EMP.RESOURCE_CD= TRY_TO_NUMBER(TRANS.RESOURCE_CD) AND EMP.ACTIVE_STATUS='Y' LEFT JOIN (SELECT DISTINCT MX_VALUE, ACT.ACTIVITY_TXT, REGION_ID  FROM ${SNFLKDB}.${SNFLKSCH}.DIM_ACTIVITY ACT  LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.ARCUSTOMER ARC ON LTRIM(ARC.CUSTOMER) = ACT.LEVEL_DETAIL_02  INNER JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.ARCSTMXVAL ARMX ON ARMX.OBJ_ID = ARC.OBJ_ID  INNER JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_REGION RE ON RE.REGION_NM=ARMX.MX_VALUE  AND RE.ACTIVE_STATUS='Y'  AND ARMX.MATRIX_CAT LIKE 'REGN'  WHERE ACT.ACTIVE_STATUS='Y' )REGION ON REGION.ACTIVITY_TXT=ACT.ACTIVITY_TXT WHERE TRANS.ACTIVE_STATUS='Y' \tAND TRANS.ACCT_CAT_CD = '51RW' GROUP BY TRANS.ACCT_UNIT_TXT,  REGION.MX_VALUE,  TRANS.ACTIVITY,  JO.JOB_ORD_TYP,  INV.INVOICE_NUM,  CUST.CUSTOMER,  CUST.SEARCH_NAME,  ASGN.FILLED_BY_ID_NAME,  ASGN.REPORTS_TO_ID_NM,  ACT.SALES_REP_NM,  TRANS.POSTING_DT,  TRANS.TRAN_DT,  JO.JOB_CD_NM,  TRANS.ACCT_CAT_CD,  TRANS.ACCOUNT_NM,  CWC.CDA_CODE,  TRANS.JOB_CODE,  PR.WORK_STATE,  PR.HOURS,  WC.WAGE_CD_DESC_TXT,  EMP.SRC_EMP_ID ,  EMP.FIRST_NAME ,  EMP.LAST_NAME\")\n\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.CLIENT_BRAND = CLIENT_BRAND.MX_VALUE FROM ( SELECT DISTINCT MX_VALUE ,ACT.ACTIVITY_TXT FROM  ${SNFLKDB}.${SNFLKSCH}.DIM_ACTIVITY ACT LEFT JOIN  ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.ARCUSTOMER ARC ON LTRIM(ARC.CUSTOMER) = ACT.LEVEL_DETAIL_02 INNER JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.ARCSTMXVAL ARMX ON ARMX.OBJ_ID = ARC.OBJ_ID AND ARMX.MATRIX_CAT LIKE 'BRAND' WHERE ACT.ACTIVE_STATUS='Y') CLIENT_BRAND WHERE FPR.ASSIGNMENT = CLIENT_BRAND.ACTIVITY_TXT\")\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.TIMEENTRY_ID = TEEID.TIMEENTRY_ID FROM (SELECT INV.INVOICE_NUM, TRANS.NORM_POSTING_DT, MAX(TRANS.TIMEENTRY_ID) AS TIMEENTRY_ID FROM ${SNFLKDB}.${SNFLKSCH}.DIM_TRANS TRANS LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_INVOICE INV ON INV.SRC_OBJ_ID = TRANS.SRC_OBJ_ID WHERE INV.ACTIVE_STATUS = 'Y'   AND TRANS.ACTIVE_STATUS = 'Y' GROUP BY INV.INVOICE_NUM, TRANS.NORM_POSTING_DT   )TEEID WHERE FPR.INVOICE = TEEID.INVOICE_NUM AND FPR.NORM_POSTING_DATE = TEEID.NORM_POSTING_DT\")\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.WORK_COMP = COALESCE(WC.FINAL_WORK_COMP, 0.0),  FPR.WC_BY_100 = WC.WC_BY_100 FROM    (SELECT DISTINCT  BRANCH,  ASSIGNMENT,  NORM_POSTING_DATE,  TRAN_DATE,  WAGE_CODE,   CASE WHEN TOTAL_WC_YES_PAY_HRS <> 0 THEN (WC_YES_PAY_HRS/TOTAL_WC_YES_PAY_HRS)*TOTAL_WORK_COMP ELSE 0 END AS FINAL_WORK_COMP,  CASE WHEN TOTAL_WC_YES_PAY_HRS <> 0 AND PAY_AMT <> 0 THEN CAST((((WC_YES_PAY_HRS/TOTAL_WC_YES_PAY_HRS)*TOTAL_WORK_COMP)/PAY_AMT)*100 AS NUMBER(18,4)) ELSE 0.0 END AS WC_BY_100  FROM  (SELECT DISTINCT   BRANCH,   ASSIGNMENT,   NORM_POSTING_DATE,   TRAN_DATE,   WAGE_CODE,   WC_YES_PAY_HRS,   PAY_AMT,   SUM(WC_YES_PAY_HRS) OVER (PARTITION BY BRANCH, ASSIGNMENT, NORM_POSTING_DATE, TRAN_DATE ORDER BY BRANCH, ASSIGNMENT, NORM_POSTING_DATE, TRAN_DATE) AS TOTAL_WC_YES_PAY_HRS,   TOTAL_WORK_COMP  FROM  (SELECT DISTINCT   BRANCH,   ASSIGNMENT,   NORM_POSTING_DATE,   TRAN_DATE,   WAGE_CODE,   PAY_HRS AS WC_YES_PAY_HRS,   PAY_AMT,   PTM.WORK_COMP AS TOTAL_WORK_COMP  FROM ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR  LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.PAY_TRAN_MEASURES_TEMP PTM   ON PTM.ACTIVITY = FPR.ASSIGNMENT   AND PTM.ACCT_UNIT_TXT = FPR.BRANCH   AND PTM.NORM_POSTING_DT = FPR.NORM_POSTING_DATE   AND PTM.NORM_TRAN_DT = FPR.TRAN_DATE  WHERE FPR.WAGE_CODE IN (SELECT PAY_CODE    FROM ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRPAYCODE CD    JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PSGRELATE WCL ON CD.COMPANY = WCL.COMPANY     AND CD.PAY_SUM_GRP = WCL.PAY_SUM_GRP     AND WCL.PAY_CLASS = 'WC'))))WC WHERE FPR.BRANCH = WC.BRANCH  AND FPR.ASSIGNMENT = WC.ASSIGNMENT  AND FPR.NORM_POSTING_DATE = WC.NORM_POSTING_DATE  AND FPR.TRAN_DATE = WC.TRAN_DATE  AND FPR.WAGE_CODE = WC.WAGE_CODE\")\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET WORK_COMP = 0, WC_BY_100 = 0.0 WHERE WAGE_CODE NOT IN (SELECT PAY_CODE  FROM ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRPAYCODE CD  JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PSGRELATE WCL ON CD.COMPANY = WCL.COMPANY AND CD.PAY_SUM_GRP = WCL.PAY_SUM_GRP AND WCL.PAY_CLASS = 'WC' ORDER BY PAY_CODE)\")\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.FINALIZED_BY_NAME = DTLS.FINALIZED_BY_NAME,  FPR.SUPERVISOR = DTLS.SUPERVISOR,  FPR.BRAND_DESCRIPTION = DTLS.BRAND_DESCRIPTION,  FPR.PARENT_CLIENT_NUMBER = DTLS.ACCOUNTNUMBER,  FPR.ACCOUNT_TYPE = DTLS.ACCOUNT_TYPE,  FPR.CONVERTED_BILL_HOURS_WORKED = DTLS.CONVERTED_BILL_HOURS_WORKED,  FPR.TOTAL_COST_OF_SALES = DTLS.TOTAL_COST_OF_SALES FROM  (SELECT FPR.EMPL_ID, CUS.CUSTOMER,  FPR.ASSIGNMENT,  FPR.NORM_POSTING_DATE,  FPR.TRAN_DATE,  EMP.FULLNAME AS FINALIZED_BY_NAME,  AST.FULLNAME AS SUPERVISOR,  BRD.BRAND_DESC AS BRAND_DESCRIPTION,  CUS.ACCOUNTNUMBER,  CUS.ACCOUNT_TYPE, FPR.WAGE_CODE, CBC.CONV_WCODE, FPR.BILL_HRS, FPR.BILL_AMT, CASE WHEN (CBC.CONV_WCODE IS NULL OR CBC.CONV_WCODE = '') THEN 0.0  WHEN UPPER(CBC.CONVERSION_FACTOR) = 'NONE' THEN to_number(FPR.BILL_HRS, 15,2)   WHEN REPLACE(UPPER(CBC.CONVERSION_FACTOR), ' ', '') = REPLACE('BILLABLE_UNIT / 55', ' ', '') THEN to_number(FPR.BILL_HRS/55, 15,2) WHEN REPLACE(UPPER(CBC.CONVERSION_FACTOR), ' ', '') = REPLACE('BILLABLE_AMT / 25', ' ', '') THEN to_number(FPR.BILL_AMT/25, 15,2) WHEN REPLACE(UPPER(CBC.CONVERSION_FACTOR), ' ', '') = REPLACE('BILLABLE_UNIT * 8', ' ', '') THEN to_number(FPR.BILL_HRS*8, 15,2) END AS CONVERTED_BILL_HOURS_WORKED,  FPR.PAY_AMT + FPR.FICA + FPR.FUTA + FPR.SUI + FPR.WORK_COMP + FPR.GLI_EPLI + FPR.ACA + FPR.OTHER AS TOTAL_COST_OF_SALES  FROM ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR  LEFT JOIN   (SELECT EMP.SRC_EMP_ID, SB.FULLNAME FROM ${SNFLKDB}.${SNFLKSCH}.DIM_EMPLOYEE EMP    LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.SYSTEMUSERBASE SB    ON EMP.FINALIZEDBY = SB.SYSTEMUSERID     WHERE EMP.ACTIVE_STATUS = 'Y') EMP  ON FPR.EMPL_ID = EMP.SRC_EMP_ID  LEFT JOIN   (SELECT AST.ASSIGN_NUM, SB.FULLNAME FROM ${SNFLKDB}.${SNFLKSCH}.DIM_ASSIGNMENT AST    LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.SYSTEMUSERBASE SB    ON AST.CDA_STAFFINGSUPERVISORID = SB.SYSTEMUSERID    WHERE AST.ACTIVE_STATUS = 'Y') AST   ON AST.ASSIGN_NUM = REGEXP_REPLACE(FPR.ASSIGNMENT, '^[A-Z]', '')   LEFT JOIN    (SELECT DISTINCT     TRANS.ACTIVITY,    TRANS.NORM_POSTING_DT,    BRAND.BRAND_VAL_DESC_TXT AS BRAND_DESC   FROM ${SNFLKDB}.${SNFLKSCH}.DIM_TRANS TRANS   LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_ACTIVITY ACT    ON ACT.ACTIVITY_TXT = TRANS.ACTIVITY   LEFT JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_BRAND BRAND    ON BRAND.ACTIVITY_TXT = ACT.ACTIVITY_TXT     WHERE    (BRAND.VALID_TO_DT >= IFF(DATEADD('DAY', 7, TRANS.NORM_POSTING_DT) < '2019-06-30', '2019-06-30', DATEADD('DAY', 7, TRANS.NORM_POSTING_DT)) OR BRAND.VALID_TO_DT IS NULL)   AND (BRAND.VALID_FRM_DT < IFF(DATEADD('DAY', 7, TRANS.NORM_POSTING_DT) < '2019-06-30', '2019-06-30', DATEADD('DAY', 7, TRANS.NORM_POSTING_DT)) OR BRAND.VALID_FRM_DT IS NULL)   AND TRANS.ACTIVE_STATUS = 'Y'   AND ACT.ACTIVE_STATUS = 'Y')BRD   ON BRD.ACTIVITY = FPR.ASSIGNMENT   AND BRD.NORM_POSTING_DT = FPR.NORM_POSTING_DATE  LEFT JOIN   (SELECT CUS.CUSTOMER, AB.ACCOUNTNUMBER, CM.ACCOUNT_TYPE   FROM ${SNFLKDB}.${SNFLKSCH}.DIM_CUSTOMER CUS   LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.ACCOUNTBASE AB   ON AB.ACCOUNTID = CUS.PARENTCLIENTNUMBER   LEFT JOIN ${NPG_ENV_DB}.${NPG_ENV_SCH}.NPG_VIP_DL_LDG_CLIENT_MASTER CM   ON CM.CUSTOMER_ID = CUS.CUSTOMER   WHERE CUS.ACTIVE_STATUS = 'Y')CUS  ON CUS.CUSTOMER = FPR.CUST_ID  LEFT JOIN   (SELECT DISTINCT ACCOUNT_CATEGORY, REPLACE(ACCOUNT_CATEGORY, '0', '') CONV_WCODE, DESCRIPTION, CONVERSION_FACTOR   FROM ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_CONV_BILLED_CODES)CBC   ON CBC.CONV_WCODE = FPR.WAGE_CODE  )DTLS WHERE FPR.EMPL_ID is not distinct from DTLS.EMPL_ID   AND FPR.ASSIGNMENT is not distinct from DTLS.ASSIGNMENT   AND FPR.NORM_POSTING_DATE = DTLS.NORM_POSTING_DATE   AND FPR.TRAN_DATE = DTLS.TRAN_DATE AND FPR.WAGE_CODE is not distinct from DTLS.WAGE_CODE  AND FPR.BILL_HRS is not distinct from DTLS.BILL_HRS AND FPR.BILL_AMT is not distinct from DTLS.BILL_AMT\")\n\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.WAGE_CODE = CASE WHEN FPR.WAGE_CODE LIKE '8%' THEN CONCAT(REPLACE(LEFT(FPR.WAGE_CODE, 1), '8', '9'), RIGHT(RTRIM(FPR.WAGE_CODE), LENGTH(RTRIM(FPR.WAGE_CODE))-1)) ELSE FPR.WAGE_CODE END, FPR.WORK_STATE = CASE WHEN FPR.WORK_STATE = '' THEN NULL ELSE FPR.WORK_STATE END\")\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.EMPL_ID = TO_VARCHAR(COALESCE(EMP.SRC_EMP_ID, CASE WHEN FPR.EMPL_ID = '' THEN NULL ELSE FPR.EMPL_ID END, NULL)), FPR.LAST = COALESCE(EMP.LAST,FPR.LAST, NULL), FPR.FIRST = COALESCE(EMP.FIRST, FPR.FIRST, NULL),  FPR.WC_CODE = COALESCE(EMP.CDA_CODE, EMP.JOB_CODE) FROM( SELECT DISTINCT ASGN.ASSIGN_NUM , EMP.SRC_EMP_ID,  LPEMP.NICK_NAME AS LAST,  LPEMP.NICK_NAME AS FIRST , PR.WORK_STATE ,PRP.PAY_CODE ,CWC.CDA_CODE CDA_CODE, PR.JOB_CODE JOB_CODE FROM (SELECT *, ROW_NUMBER() OVER (PARTITION BY ASSIGN_NUM, EMP_ID ORDER BY ASSIGN_NUM, EMP_ID, MODIFIED_DT DESC) ROWNUM FROM ${SNFLKDB}.${SNFLKSCH}.DIM_ASSIGNMENT) ASGN INNER JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_ASSIGNMENTBASE LASGN ON ASGN.ASSIGN_NUM=LASGN.CDA_ASSIGNMENTNUMBER INNER JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_EMPLOYEEBASE CEB ON LASGN.CDA_EMPLOYEEID = CEB.CDA_EMPLOYEEID INNER JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_EMPLOYEE EMP ON EMP.SRC_EMP_ID = CEB.CDA_EMPLOYEENUMBER AND EMP.ACTIVE_STATUS = 'Y' INNER JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.EMPLOYEE LPEMP ON LPEMP.EMPLOYEE = CEB.CDA_EMPLOYEENUMBER LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRTIME PRT ON PRT.COMPANY = LPEMP.COMPANY AND PRT.EMPLOYEE = LPEMP.EMPLOYEE AND PRT.PROCESS_LEVEL = LPEMP.PROCESS_LEVEL LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRPAYCODE PRP ON PRP.SEQ_NBR = PRT.PCD_SEQ_NBR LEFT JOIN (SELECT DISTINCT EMPLOYEE, WORK_STATE, JOB_CODE FROM ${SNFLKDB}.${SNFLKSCH}.DIM_PAYRATE_TRANS PR WHERE PR.ACTIVE_STATUS='Y' ) PR ON PR.EMPLOYEE =LPEMP.EMPLOYEE LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_WCCODEBASE CWC ON LASGN.CDA_WCCODE = CWC.CDA_WCCODEID WHERE ASGN.ROWNUM = 1 AND PRP.PAY_CODE LIKE '99%' )EMP WHERE SUBSTR(FPR.ASSIGNMENT, 2) = EMP.ASSIGN_NUM \")\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.EMPL_ID = TO_VARCHAR(COALESCE(CASE WHEN FPR.EMPL_ID = '' THEN NULL ELSE FPR.EMPL_ID END, EMP.SRC_EMP_ID,NULL)), FPR.LAST = COALESCE(FPR.LAST,EMP.LAST, NULL), FPR.FIRST = COALESCE(FPR.FIRST,EMP.FIRST,NULL),  FPR.WC_CODE = COALESCE(FPR.WC_CODE, EMP.CDA_CODE, EMP.JOB_CODE) FROM( SELECT DISTINCT ASGN.ASSIGN_NUM , EMP.SRC_EMP_ID,  LPEMP.LAST_NAME AS LAST,  LPEMP.FIRST_NAME AS FIRST , PR.WORK_STATE ,PRP.PAY_CODE ,CWC.CDA_CODE CDA_CODE, PR.JOB_CODE JOB_CODE FROM (SELECT *, ROW_NUMBER() OVER (PARTITION BY ASSIGN_NUM, EMP_ID ORDER BY ASSIGN_NUM, EMP_ID, MODIFIED_DT DESC) ROWNUM FROM ${SNFLKDB}.${SNFLKSCH}.DIM_ASSIGNMENT) ASGN INNER JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_ASSIGNMENTBASE LASGN ON ASGN.ASSIGN_NUM=LASGN.CDA_ASSIGNMENTNUMBER INNER JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_EMPLOYEEBASE CEB ON LASGN.CDA_EMPLOYEEID = CEB.CDA_EMPLOYEEID INNER JOIN ${SNFLKDB}.${SNFLKSCH}.DIM_EMPLOYEE EMP ON EMP.SRC_EMP_ID = CEB.CDA_EMPLOYEENUMBER AND EMP.ACTIVE_STATUS = 'Y' INNER JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.EMPLOYEE LPEMP ON LPEMP.EMPLOYEE = CEB.CDA_EMPLOYEENUMBER LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRTIME PRT ON PRT.COMPANY = LPEMP.COMPANY AND PRT.EMPLOYEE = LPEMP.EMPLOYEE AND PRT.PROCESS_LEVEL = LPEMP.PROCESS_LEVEL LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRPAYCODE PRP ON PRP.SEQ_NBR = PRT.PCD_SEQ_NBR LEFT JOIN (SELECT DISTINCT EMPLOYEE, WORK_STATE, JOB_CODE FROM ${SNFLKDB}.${SNFLKSCH}.DIM_PAYRATE_TRANS PR WHERE PR.ACTIVE_STATUS='Y' ) PR ON PR.EMPLOYEE =LPEMP.EMPLOYEE LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_WCCODEBASE CWC ON LASGN.CDA_WCCODE = CWC.CDA_WCCODEID WHERE ASGN.ROWNUM = 1 AND PRP.PAY_CODE NOT LIKE '99%' )EMP WHERE SUBSTR(FPR.ASSIGNMENT, 2) = EMP.ASSIGN_NUM\")\n\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.TOTAL_COST_OF_SALES = FPR.PAY_AMT + FPR.FICA + FPR.FUTA + FPR.SUI + FPR.WORK_COMP + FPR.GLI_EPLI + FPR.ACA + FPR.OTHER\")\n\n# Update work_state\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.WORK_STATE = SRC.WORK_STATE FROM (SELECT ACTIVITY, WORK_STATE, CNT FROM (SELECT DISTINCT ACTIVITY, WORK_STATE, COUNT(DISTINCT WORK_STATE) OVER (PARTITION BY ACTIVITY) AS CNT FROM ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRTIME)  WHERE CNT = 1) SRC WHERE SRC.ACTIVITY = FPR.ASSIGNMENT AND FPR.WORK_STATE IS NULL\")\ncursor.execute(\"UPDATE ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR FPR SET FPR.WORK_STATE = SRC.WORK_STATE FROM (SELECT DISTINCT ASGN.CDA_ASSIGNMENTNUMBER, SMB.VALUE AS WORK_STATE FROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_ASSIGNMENTBASE ASGN INNER JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_JOBORDERBASE JBODR ON ASGN.CDA_JOBORDER = JBODR.CDA_JOBORDERID INNER JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_LOCATIONBASE LCTN ON LCTN.CDA_LOCATIONID = JBODR.CDA_WORKLOCATION INNER JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.STRINGMAPBASE SMB ON SMB.ATTRIBUTEVALUE = LCTN.CDA_ADDRESSSTATE AND OBJECTTYPECODE = '10023' AND ATTRIBUTENAME = 'cda_addressstate' WHERE CDA_ASSIGNMENTNUMBER IS NOT NULL) SRC WHERE SRC.CDA_ASSIGNMENTNUMBER = REPLACE(FPR.ASSIGNMENT,'A','') AND FPR.WORK_STATE IS NULL\")\n\ncursor.execute('select count(*) from ${SNFLKDB}.${SNFLKSCH}.REPORT_FPR')\nresult = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount\", int(result[0]))\nrowcount = result[0]\nprint(rowcount)\n\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.ACTIV_B_TEMP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.REPORT_DIMENSIONS_TEMP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.REPORT_MEASURES_TEMP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.REPORT_MEASURES_PAY_TEMP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.CALC_TRANAMOUNT_TEMP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.TRANS_TEMP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.ACT_TRAN_AMT_TOTAL\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.PREP_CALC_TRANAMOUNT\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.HOURS_PREP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.ACCT_CAT_COUNT\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.CALC_WORKCOMPAC\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.PAY_TRAN_MEASURES_TEMP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.DIM_MEASURE_TEMP\")\n#cursor.execute(\"DELETE FROM ${SNFLKDB}.${SNFLKSCH}.DIM_MEASURE_SUMMARY_A_TEMP\")\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6332637":{"id":6332637,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6332602],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6332638":{"id":6332638,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":304,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6332601],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit_REPORT_FPR_SUCCESS"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit_REPORT_FPR"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6332639":{"id":6332639,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":304,"y":32,"width":32,"height":32,"inputConnectorIDs":[6332603],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit_REPORT_FPR_FAILURE"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit_REPORT_FPR"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6332601":{"id":6332601,"sourceID":6332636,"targetID":6332638}},"failureConnectors":{"6332603":{"id":6332603,"sourceID":6332636,"targetID":6332639}},"unconditionalConnectors":{"6332602":{"id":6332602,"sourceID":6332637,"targetID":6332636}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_REPORT_FPR_20250529","description":"","type":"ORCHESTRATION","tag":"7a79beed-4dbc-431a-87bd-4a76a06ed71e"}}