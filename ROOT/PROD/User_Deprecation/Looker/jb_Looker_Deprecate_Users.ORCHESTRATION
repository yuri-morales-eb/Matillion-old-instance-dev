{"job":{"components":{"6343125":{"id":6343125,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":773867971,"x":288,"y":48,"width":32,"height":32,"inputConnectorIDs":[6343101],"outputSuccessConnectorIDs":[6343134],"outputFailureConnectorIDs":[6343154],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Load Log table from S3"}}}},"visible":true},"4":{"slot":4,"name":"S3 Object Prefix","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"s3://etld1/User_Deprecation/Looker/Logs/"}}}},"visible":true},"5":{"slot":5,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"6":{"slot":6,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKDB_ADMIN}"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKSCH_ADMIN}"}}}},"visible":true},"8":{"slot":8,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"LOOKER_USER_DEPRECATION_LOG"}}}},"visible":true},"9":{"slot":9,"name":"Load Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"EVENT_TS"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"LOG_LEVEL"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"PROCESS_NAME"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"MESSAGE"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"STATUS"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"EXECUTION_ID"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"CREATED_BY"}}}},"visible":true},"10":{"slot":10,"name":"Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":true},"11":{"slot":11,"name":"File Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CSV"}}}},"visible":true},"12":{"slot":12,"name":"Compression","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AUTO"}}}},"visible":true},"20":{"slot":20,"name":"Record Delimiter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"21":{"slot":21,"name":"Field Delimiter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"22":{"slot":22,"name":"Skip Header","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"1"}}}},"visible":true},"23":{"slot":23,"name":"Date Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"24":{"slot":24,"name":"Time Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"25":{"slot":25,"name":"Timestamp Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"26":{"slot":26,"name":"","elements":{},"visible":false},"27":{"slot":27,"name":"Escape","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR_OR_ESCAPE_SEQUENCE","value":""}}}},"visible":true},"28":{"slot":28,"name":"Escape Unenclosed Field","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR_OR_ESCAPE_SEQUENCE","value":""}}}},"visible":true},"29":{"slot":29,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"30":{"slot":30,"name":"Field Optionally Enclosed","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\""}}}},"visible":true},"31":{"slot":31,"name":"Null If","elements":{},"visible":true},"32":{"slot":32,"name":"Error On Column Count Mismatch","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"True"}}}},"visible":true},"33":{"slot":33,"name":"Empty Field as Null","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"True"}}}},"visible":true},"34":{"slot":34,"name":"Encoding Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"35":{"slot":35,"name":"Skip Blank Lines","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"36":{"slot":36,"name":"Replace Invalid Characters","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"40":{"slot":40,"name":"Enable Octal","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"41":{"slot":41,"name":"Allow Duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"42":{"slot":42,"name":"Strip Outer Array","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"43":{"slot":43,"name":"Strip Null Values","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"44":{"slot":44,"name":"Ignore UTF8 Errors","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"45":{"slot":45,"name":"Nest Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"46":{"slot":46,"name":"Null If","elements":{},"visible":false},"47":{"slot":47,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"50":{"slot":50,"name":"Null If","elements":{},"visible":false},"51":{"slot":51,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"60":{"slot":60,"name":"Ignore UTF8 Errors","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"61":{"slot":61,"name":"Preserve Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"62":{"slot":62,"name":"Strip Outer Element","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"63":{"slot":63,"name":"Disable Snowflake Data","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"64":{"slot":64,"name":"Disable Auto Convert","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"66":{"slot":66,"name":"Null If","elements":{},"visible":false},"67":{"slot":67,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"70":{"slot":70,"name":"Null If","elements":{},"visible":false},"71":{"slot":71,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"120":{"slot":120,"name":"On Error","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Abort Statement"}}}},"visible":true},"121":{"slot":121,"name":"n","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":""}}}},"visible":false},"122":{"slot":122,"name":"Size Limit (B)","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":""}}}},"visible":true},"123":{"slot":123,"name":"Purge Files","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"124":{"slot":124,"name":"Truncate Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"125":{"slot":125,"name":"Force Load","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"126":{"slot":126,"name":"Match By Column Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":false},"140":{"slot":140,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":true},"141":{"slot":141,"name":"Master Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"142":{"slot":142,"name":"KMS Key Id","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"143":{"slot":143,"name":"Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Credentials"}}}},"visible":true},"144":{"slot":144,"name":"Storage Integration","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"200":{"slot":200,"name":"Stage","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":true},"201":{"slot":201,"name":"Pattern","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":".*"}}}},"visible":true},"203":{"slot":203,"name":"Metadata Fields","elements":{},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343126":{"id":6343126,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":560,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343153],"outputSuccessConnectorIDs":[6343103],"outputFailureConnectorIDs":[6343157],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Archive Files"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Sebastian Jimenez\n-- Create date  : 10/6/2025\n-- Description  : Archive processed files.\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7745\n-- =============================================\n\"\"\"\n\nimport boto3\nfrom datetime import datetime\n\ns3_session = boto3.Session()\ns3_client = s3_session.client('s3')\ns3 = s3_session.resource('s3')\ns3_bucket_name= s3_URL.replace(\"s3:\", '').strip('/')\nbucket = s3.Bucket(s3_bucket_name)\ns3_resource = boto3.resource('s3')\n\nnow = datetime.now().strftime('_%Y%m%d%H%M%S')\n\n# Archiving active users file\ntry:\n    \n    source_folder = 'User_Deprecation/Looker/Files'\n    target_folder = 'User_Deprecation/Looker/Files/Archived'\n    src_file = 'looker_active_users.csv'\n    \n    s3_src_file_path = source_folder +'/'+ src_file\n    dest_file = src_file[:-4] + now + '.csv'\n    \n    # Construct the destination file path\n    s3_dest_file_path = target_folder +'/'+ dest_file\n\n    obj = s3.Object(s3_bucket_name, s3_src_file_path)\n    obj_data = obj.get()['Body'].read()\n    res = s3_client.put_object(Bucket=s3_bucket_name, Body=obj_data, Key=s3_dest_file_path)\n    print('Successfully Moved... ')\n    s3_client.delete_object(Bucket=s3_bucket_name, Key=s3_src_file_path)\n    print('Successfully Deleted... ')\n        \nexcept Exception as e:\n    print(f\"Exception: {e}\")\n    print('Error archiving file : ' + src_file)\n\n\nprint('\\n****Files successfully moved to archived folder...!')\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343127":{"id":6343127,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":704,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343103],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Success"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343128":{"id":6343128,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":235671163,"x":423,"y":-8,"width":32,"height":32,"inputConnectorIDs":[6343102,6343134],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343153],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343129":{"id":6343129,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":704,"y":-144,"width":32,"height":32,"inputConnectorIDs":[6343151],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343130":{"id":6343130,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":288,"y":-144,"width":32,"height":32,"inputConnectorIDs":[6343154,6343155,6343156,6343157],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343151],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Failure Path"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343131":{"id":6343131,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":288,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6343135],"outputSuccessConnectorIDs":[6343102],"outputFailureConnectorIDs":[6343156],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send notification email"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Sebastian Jimenez\n-- Create date  : 10/6/2025\n-- Description  : The goal of this script is to call Madrill API to send a notification\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7745\n-- =============================================\n\"\"\"\n\nimport requests\nimport json\nimport logging\n\nMANDRILL_API_KEY = mandrill_api_key\n\n# Setup logging\nlogging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')\n\ndef send_email_to_multiple(recipient, subject, html_content, from_email='svc_lookerreports@bluecrewjobs.com', from_name='Looker User Deprecation Service'):\n    url = 'https://mandrillapp.com/api/1.0/messages/send.json'\n        \n    payload = {\n        \"key\": MANDRILL_API_KEY,\n        \"message\": {\n            \"html\": html_content,\n            \"subject\": subject,\n            \"from_email\": from_email,\n            \"from_name\": from_name,\n            \"to\": recipient,\n            \"important\": False,\n            \"track_opens\": True,\n            \"track_clicks\": True\n        }\n    }\n\n    response = requests.post(url, data=json.dumps(payload))\n    \n    print(response)\n    \n    if response.status_code == 200:\n        logging.info(\"Emails sent successfully!\")\n        logging.info(response.json())\n    else:\n        context.updateVariable(\"looker_error_message\",response.json())\n        logging.error(\"Failed to send emails.\")\n        logging.error(response.text)\n\n        \ndef format_email_name(email):\n    # Split the email at '@' to remove the domain\n    local_part = email.split('@')[0]\n    \n    # Replace '.' with space\n    name_with_spaces = local_part.replace('.', ' ')\n    \n    # Capitalize each word\n    formatted_name = ' '.join(word.capitalize() for word in name_with_spaces.split())\n    \n    return formatted_name\n\n\n# Run the workflow\nif __name__ == \"__main__\":\n    name = format_email_name(looker_user_email)\n    print(name)\n    recipients = [{\"email\": f\"{looker_user_email}\", \"name\": f\"{name}\"}]\n    \n    recipient = recipients\n    print(recipient)\n    if looker_process_action == 'WARNING':\n        subject = \"LOOKER USER DEPRECATION - Your account will be deactivated\"\n        html_content = (\n            f\"<h2>Hello {name}!</h2>\"\n            f\"<p>This email is to notify you that your Looker account will be deactivated \"\n            f\"because you haven't logged in during the past {int(looker_deprecation_months) - 1} months.</p>\"\n        \n        )\n    elif looker_process_action == 'DEPRECATED':\n        subject = \"LOOKER USER DEPRECATION - Your account has been deactivated\"\n        html_content = (\n            f\"<h2>Hello {name}!</h2>\"\n            f\"<p>This email is to notify you that your Looker account has been deactivated \"\n            f\"because you haven't logged in during the past {looker_deprecation_months} months.</p>\"\n        )\n    \n    if looker_process_action in ['WARNING', 'DEPRECATED']:\n        send_email_to_multiple(recipient, subject, html_content)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343132":{"id":6343132,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":144,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343152],"outputSuccessConnectorIDs":[6343101,6343135],"outputFailureConnectorIDs":[6343155],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Deprecate Users"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Sebastian Jimenez\n-- Create date  : 10/6/2025\n-- Description  : Use the API method to deprecate the users in Looker.\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7745\n-- =============================================\n\"\"\"\n\nimport os\nfrom looker_sdk import init40, error\nfrom datetime import datetime\nimport boto3\nimport logging\nfrom io import StringIO\nimport pandas as pd\nimport getpass\n\n# Use Matillion environment variables\nos.environ[\"LOOKERSDK_BASE_URL\"] = \"${looker_svc_url}\"\nos.environ[\"LOOKERSDK_CLIENT_ID\"] = \"${looker_svc_client_id}\"\nos.environ[\"LOOKERSDK_CLIENT_SECRET\"] = \"${looker_svc_client_secret}\"\n\n# Get datetime\nnow = datetime.now().strftime('_%Y%m%d%H%M%S')\n\n# S3 Configuration\nsession = boto3.Session()\ns3_bucket_name = s3_URL.replace(\"s3:\", '').strip('/')\ns3_folder = 'User_Deprecation/Looker/Logs'\n\n# Configure logging\nlogging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')\n\n# Connect to Looker\nsdk = init40()\n\n# Create CSV file in S3 \ndef write_results_to_s3(df, filename):\n    try:\n        client = session.client('s3')\n        csv_buffer = StringIO()\n        df.to_csv(csv_buffer, index=False)\n        res = client.put_object(Bucket=s3_bucket_name, Body=csv_buffer.getvalue(), Key=f'{s3_folder}/{filename}')\n        logging.info(f'Successfully wrote results to S3: {filename}')\n    except Exception as e:\n        logging.error(f'Failed to write results to S3: {e}')\n\n# Main code\ndef main():\n    # Deprecate the users\n    log_entries = []\n    timestamp = datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")\n    status = \"NONE\"\n    message = \"None\"\n    log_level = \"INFO\"\n    system_user = getpass.getuser()\n\n    try:\n        users = sdk.search_users(email=looker_user_email)\n        if not users:\n            status = \"NOT_FOUND\"\n            message = f\"User {looker_user_email} not found in Looker.\"\n            log_level = \"WARNING\"\n            logging.warning(f\"{looker_user_email}: {message}\")\n        else:\n            user = users[0]\n            if user.is_disabled:\n                status = \"ALREADY_DISABLED\"\n                message = f\"User {looker_user_email} was already disabled.\"\n                log_level = \"INFO\"\n                logging.info(f\"{looker_user_email}: {message}\")\n            else:\n                sdk.update_user(user.id, {\"is_disabled\": True})\n                status = \"SUCCESS\"\n                message = f\"User {looker_user_email} deprecated successfully.\"\n                log_level = \"INFO\"\n                logging.info(f\"{looker_user_email}: {message}\")\n\n    except error.SDKError as e:\n        status = \"ERROR\"\n        error_message = str(e)\n        message = f\"Error deprecating user {looker_user_email}: {error_message}\" \n        log_level = \"ERROR\"\n        logging.error(message)\n\n    log_entries.append((timestamp, log_level, 'LOOKER_USER_DEPRECATION', message, status, '${run_history_id}', system_user))\n    \n    # Write CSV in S3\n    df_log = pd.DataFrame(log_entries)\n    print(df_log.columns)\n    write_results_to_s3(df_log, f\"looker_users_log_{now}.csv\")\n\n    # Process complete\n    logging.info(\"Deprecation process completed for {looker_user_email}\")\n\nif __name__ == \"__main__\":\n    main()"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343133":{"id":6343133,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343152],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6343101":{"id":6343101,"sourceID":6343132,"targetID":6343125},"6343102":{"id":6343102,"sourceID":6343131,"targetID":6343128},"6343103":{"id":6343103,"sourceID":6343126,"targetID":6343127},"6343134":{"id":6343134,"sourceID":6343125,"targetID":6343128},"6343135":{"id":6343135,"sourceID":6343132,"targetID":6343131}},"failureConnectors":{"6343154":{"id":6343154,"sourceID":6343125,"targetID":6343130},"6343155":{"id":6343155,"sourceID":6343132,"targetID":6343130},"6343156":{"id":6343156,"sourceID":6343131,"targetID":6343130},"6343157":{"id":6343157,"sourceID":6343126,"targetID":6343130}},"unconditionalConnectors":{"6343151":{"id":6343151,"sourceID":6343130,"targetID":6343129},"6343152":{"id":6343152,"sourceID":6343133,"targetID":6343132},"6343153":{"id":6343153,"sourceID":6343128,"targetID":6343126}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_Looker_Deprecate_Users","description":"","type":"ORCHESTRATION","tag":"049a9d5e-cfbd-4125-9fc3-c998820c2314"}}