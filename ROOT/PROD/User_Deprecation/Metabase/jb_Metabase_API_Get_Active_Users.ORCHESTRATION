{"job":{"components":{"6343001":{"id":6343001,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":576,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343041],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Success 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343002":{"id":6343002,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":773867971,"x":-512,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343044],"outputSuccessConnectorIDs":[6343007],"outputFailureConnectorIDs":[6343072],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"S3 Load 0"}}}},"visible":true},"4":{"slot":4,"name":"S3 Object Prefix","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"s3://etld1/User_Deprecation/Metabase/"}}}},"visible":true},"5":{"slot":5,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"6":{"slot":6,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKDB_ADMIN}"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKSCH_ADMIN}"}}}},"visible":true},"8":{"slot":8,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"LDG_METABASE_USERS"}}}},"visible":true},"9":{"slot":9,"name":"Load Columns","elements":{},"visible":true},"10":{"slot":10,"name":"Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":true},"11":{"slot":11,"name":"File Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CSV"}}}},"visible":true},"12":{"slot":12,"name":"Compression","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AUTO"}}}},"visible":true},"20":{"slot":20,"name":"Record Delimiter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"21":{"slot":21,"name":"Field Delimiter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"22":{"slot":22,"name":"Skip Header","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"1"}}}},"visible":true},"23":{"slot":23,"name":"Date Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"24":{"slot":24,"name":"Time Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"25":{"slot":25,"name":"Timestamp Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"26":{"slot":26,"name":"","elements":{},"visible":false},"27":{"slot":27,"name":"Escape","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR_OR_ESCAPE_SEQUENCE","value":""}}}},"visible":true},"28":{"slot":28,"name":"Escape Unenclosed Field","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"CHAR_OR_ESCAPE_SEQUENCE","value":""}}}},"visible":true},"29":{"slot":29,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"30":{"slot":30,"name":"Field Optionally Enclosed","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\""}}}},"visible":true},"31":{"slot":31,"name":"Null If","elements":{},"visible":true},"32":{"slot":32,"name":"Error On Column Count Mismatch","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"True"}}}},"visible":true},"33":{"slot":33,"name":"Empty Field as Null","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"True"}}}},"visible":true},"34":{"slot":34,"name":"Encoding Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":true},"35":{"slot":35,"name":"Skip Blank Lines","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"36":{"slot":36,"name":"Replace Invalid Characters","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"40":{"slot":40,"name":"Enable Octal","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"41":{"slot":41,"name":"Allow Duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"42":{"slot":42,"name":"Strip Outer Array","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"43":{"slot":43,"name":"Strip Null Values","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"44":{"slot":44,"name":"Ignore UTF8 Errors","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"45":{"slot":45,"name":"Nest Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"46":{"slot":46,"name":"Null If","elements":{},"visible":false},"47":{"slot":47,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"50":{"slot":50,"name":"Null If","elements":{},"visible":false},"51":{"slot":51,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"60":{"slot":60,"name":"Ignore UTF8 Errors","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"61":{"slot":61,"name":"Preserve Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"62":{"slot":62,"name":"Strip Outer Element","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"63":{"slot":63,"name":"Disable Snowflake Data","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"64":{"slot":64,"name":"Disable Auto Convert","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"66":{"slot":66,"name":"Null If","elements":{},"visible":false},"67":{"slot":67,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"70":{"slot":70,"name":"Null If","elements":{},"visible":false},"71":{"slot":71,"name":"Trim Space","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"120":{"slot":120,"name":"On Error","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Abort Statement"}}}},"visible":true},"121":{"slot":121,"name":"n","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":""}}}},"visible":false},"122":{"slot":122,"name":"Size Limit (B)","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":""}}}},"visible":true},"123":{"slot":123,"name":"Purge Files","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"124":{"slot":124,"name":"Truncate Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"125":{"slot":125,"name":"Force Load","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":true},"126":{"slot":126,"name":"Match By Column Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":false},"140":{"slot":140,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":true},"141":{"slot":141,"name":"Master Key","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"142":{"slot":142,"name":"KMS Key Id","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"143":{"slot":143,"name":"Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Credentials"}}}},"visible":true},"144":{"slot":144,"name":"Storage Integration","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"200":{"slot":200,"name":"Stage","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":true},"201":{"slot":201,"name":"Pattern","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":".*"}}}},"visible":true},"203":{"slot":203,"name":"Metadata Fields","elements":{},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343003":{"id":6343003,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":224,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343040],"outputSuccessConnectorIDs":[6343045],"outputFailureConnectorIDs":[6343073],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Insert users out of Range"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\nselect_query = \"\"\"\n INSERT INTO ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.METABASE_USERS_TO_DEPRECATE \n (ID, EMAIL, GROUP_IDS, LAST_LOGIN, DATE_JOINED, REASON, DL_CREATED_DATE ,DL_CREATED_BY, DL_JOBID)\n SELECT DISTINCT\n ID,\n EMAIL, \n GROUP_IDS, \n LAST_LOGIN, \n DATE_JOINED,\n 'OUT OF RANGE',\n CURRENT_TIMESTAMP,\n CURRENT_USER,\n ${run_history_id}\n FROM ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.LDG_METABASE_USERS\n WHERE NOT ARRAY_CONTAINS(2, GROUP_IDS) \n AND NOT ARRAY_CONTAINS(10, GROUP_IDS)\n AND COALESCE(LAST_LOGIN, DATE_JOINED) < DATEADD('month', -'${metabase_deprecation_months_range}', CURRENT_TIMESTAMP())\n AND EMAIL NOT IN (\n    SELECT EMAIL FROM ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.METABASE_USERS_TO_DEPRECATE WHERE CAST(DL_CREATED_DATE AS DATE) = CURRENT_DATE()\n )\n ORDER BY LAST_LOGIN, DATE_JOINED, EMAIL\n\"\"\" \ncursor.execute(select_query)\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343004":{"id":6343004,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-1072,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343046],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343005":{"id":6343005,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-896,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343046],"outputSuccessConnectorIDs":[6343042],"outputFailureConnectorIDs":[6343048],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Metabase_API_Get_Active_User_List"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Alexander Escobar\n-- Create date  : OCT-08_2025\n-- Description  : The goal of this script is to call Metabase API and create a file in the S3 bucket within the active users\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7746\n-- =============================================\n\"\"\"\n\nimport requests\nimport os\nimport boto3\nimport logging\nfrom io import StringIO\nimport pandas as pd\n\n# Metabase credentials and URL\nMETABASE_URL = \"https://data.bluecrewjobs.com\"\nUSERNAME = metabase_svc_username\nPASSWORD = metabase_svc_password\n\n\n# Configuration\nsession = boto3.Session()\ns3_bucket_name = s3_URL.replace(\"s3:\", '').strip('/')\n#session = boto3.Session()\nUSER_FOLDER = 'User_Deprecation/Metabase'\n\n# Setup logging\nlogging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')\n\n# Step 1: Test token validity\ndef test_token(endpoint):\n    \"\"\"Make an authenticated request and refresh token if needed.\"\"\"\n    url = f\"{METABASE_URL}{endpoint}\"\n    headers = {\"X-Metabase-Session\": metabase_api_id}\n\n    try:\n        response = requests.get(url, headers=headers)\n        if response.status_code == 401:\n            # Token expired or invalid, re-authenticate\n            logging.info(\"Session expired. Re-authenticating...\")\n            id = get_session_token()\n            context.updateVariable(\"metabase_api_id\",id)\n        else:\n            logging.info(\"Token is valid.\")\n\n    except requests.exceptions.RequestException as e:\n        logging.error(f\"Request failed: {e}\")\n    \n# Step 2: Authenticate and get session token\ndef get_session_token():\n    url = f\"{METABASE_URL}/api/session\"\n    payload = {\"username\": USERNAME, \"password\": PASSWORD}\n    \n    # Debug print\n    logging.info(\"Sending payload:\", payload)\n    \n    response = requests.post(url, json=payload)\n    \n    # Check for errors\n    if response.status_code != 200:\n        logging(\"Error:\", response.json())\n        response.raise_for_status()\n    \n    return response.json()[\"id\"]\n\n# Step 2: Get list of users\ndef get_users(session_token):\n    url = f\"{METABASE_URL}/api/user\"\n    headers = {\"X-Metabase-Session\": session_token}\n    response = requests.get(url, headers=headers)\n    response.raise_for_status()\n    return response.json()\n\n#Function to write data to S3\ndef write_results_to_s3(df, filename):\n    \"\"\"Write the DataFrame to S3.\"\"\"\n    try:\n        client = session.client('s3')\n        csv_buffer = StringIO()\n        df.to_csv(csv_buffer, index=False)\n        res = client.put_object(Bucket=s3_bucket_name, Body=csv_buffer.getvalue(), Key=f'{USER_FOLDER}/{filename}')\n        logging.info(f'Successfully wrote results to S3: {filename}')\n    except Exception as e:\n        logging.error(f'Failed to write results to S3: {e}')\n\n# Run the workflow\nif __name__ == \"__main__\":\n    test_token(\"/api/user/current\")\n    #token = get_session_token()\n    token = metabase_api_id\n    #print(token)\n    users = get_users(token)\n    # Extract specific fields\n    user_list = [{ \"id\": user[\"id\"], \"email\": user[\"email\"], \"group_ids\": user[\"group_ids\"], \"last_login\": user[\"last_login\"], \"date_joined\": user[\"date_joined\"] } for user in users[\"data\"]]\n    user_dataframe= pd.DataFrame(user_list)\n    write_results_to_s3(user_dataframe, f\"metabase_active_user_list.csv\")\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343033":{"id":6343033,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":237373210,"x":-352,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343007],"outputSuccessConnectorIDs":[6343043],"outputFailureConnectorIDs":[6343074],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate Users to Deprecate Table"}}}},"visible":true},"3":{"slot":3,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKDB_ADMIN}"}}}},"visible":true},"4":{"slot":4,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKSCH_ADMIN}"}}}},"visible":true},"5":{"slot":5,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"METABASE_USERS_TO_DEPRECATE"}}}},"visible":true},"6":{"slot":6,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343034":{"id":6343034,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":416,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343045],"outputSuccessConnectorIDs":[6343041],"outputFailureConnectorIDs":[6343050],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Archive Files"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Alexander Escobar\n-- Create date  : OCT-08_2025\n-- Description  : The goal of this script is archive the file within the list of users from Metabase API\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7746\n-- =============================================\n\"\"\"\nimport boto3\n\ns3_session = boto3.Session()\ns3_client = s3_session.client('s3')\ns3 = s3_session.resource('s3')\ns3_bucket_name= s3_URL.replace(\"s3:\", '').strip('/')\nbucket = s3.Bucket(s3_bucket_name)\ns3_resource = boto3.resource('s3')\n\nsource_folder = 'User_Deprecation/Metabase'\ntarget_folder = 'User_Deprecation/Metabase/Archived'\n\ntime_now = datetime.datetime.now().strftime('_%Y%m%d%H%M%S')\n\ntry:\n    \n    src_file = 'metabase_active_user_list.csv'\n    \n    s3_src_file_path = source_folder +'/'+ src_file\n    dest_file = src_file[:-4] + time_now + '.csv'\n    # Construct the destination file path\n    s3_dest_file_path = target_folder +'/'+ dest_file\n\n    obj = s3.Object(s3_bucket_name, s3_src_file_path)\n    obj_data = obj.get()['Body'].read()\n    res = s3_client.put_object(Bucket=s3_bucket_name, Body=obj_data, Key=s3_dest_file_path)\n    print('Successfully Moved... ')\n    s3_client.delete_object(Bucket=s3_bucket_name, Key=s3_src_file_path)\n    print('Successfully Deleted... ')\n        \nexcept Exception as e:\n    print(f\"Exception: {e}\")\n    print('Error Moving file : ' + src_file)\n\nprint('\\n****File successfully moved to archived folder...!')\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343035":{"id":6343035,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-160,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343043],"outputSuccessConnectorIDs":[6343006],"outputFailureConnectorIDs":[6343049],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Insert users to warn deprecation"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\nselect_query = \"\"\"\n INSERT INTO ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.METABASE_USERS_TO_DEPRECATE \n (ID, EMAIL, GROUP_IDS, LAST_LOGIN, DATE_JOINED, REASON, DL_CREATED_DATE ,DL_CREATED_BY, DL_JOBID)\n SELECT DISTINCT\n ID,\n EMAIL,\n GROUP_IDS,\n LAST_LOGIN,\n DATE_JOINED,\n 'WARNING',\n CURRENT_TIMESTAMP,\n CURRENT_USER,\n ${run_history_id}\n FROM ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.LDG_METABASE_USERS\n WHERE NOT ARRAY_CONTAINS(2, GROUP_IDS) AND NOT ARRAY_CONTAINS(10, GROUP_IDS)\n AND COALESCE(LAST_LOGIN, DATE_JOINED) > DATEADD('month', -'${metabase_deprecation_months_range}', CURRENT_TIMESTAMP())\n AND COALESCE(LAST_LOGIN, DATE_JOINED) < DATEADD('month', -('${metabase_deprecation_months_range}'-1), CURRENT_TIMESTAMP())\n AND EMAIL NOT IN (\n    SELECT EMAIL FROM ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.METABASE_USERS_TO_DEPRECATE WHERE CAST(DL_CREATED_DATE AS DATE) = CURRENT_DATE()\n )\n\"\"\" \ncursor.execute(select_query)\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343036":{"id":6343036,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":237373210,"x":-688,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343042],"outputSuccessConnectorIDs":[6343044],"outputFailureConnectorIDs":[6343075],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate LDG Table"}}}},"visible":true},"3":{"slot":3,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKDB_ADMIN}"}}}},"visible":true},"4":{"slot":4,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKSCH_ADMIN}"}}}},"visible":true},"5":{"slot":5,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"LDG_METABASE_USERS"}}}},"visible":true},"6":{"slot":6,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343037":{"id":6343037,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":-352,"y":-208,"width":32,"height":32,"inputConnectorIDs":[6343048,6343049,6343050,6343072,6343073,6343074,6343075,6343076],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343047],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Failure Path"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343038":{"id":6343038,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":16,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343006],"outputSuccessConnectorIDs":[6343040],"outputFailureConnectorIDs":[6343076],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Insert users from termination list"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\nselect_query = \"\"\"\n INSERT INTO ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.METABASE_USERS_TO_DEPRECATE \n (ID, EMAIL, GROUP_IDS, LAST_LOGIN, DATE_JOINED, REASON, DL_CREATED_DATE ,DL_CREATED_BY, DL_JOBID)\n SELECT DISTINCT\n ID,\n EMAIL,\n GROUP_IDS,\n LAST_LOGIN,\n DATE_JOINED,\n 'TERMINATION LIST',\n CURRENT_TIMESTAMP,\n CURRENT_USER,\n ${run_history_id}\n FROM ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.LDG_METABASE_USERS\n WHERE NOT ARRAY_CONTAINS(2, GROUP_IDS) AND NOT ARRAY_CONTAINS(10, GROUP_IDS)\n AND EMAIL IN (\n    SELECT\n    DISTINCT PRIMARY_EMAIL_ADDRESS\n    FROM PROD_EDW.ENT.ACTIVE_DIRECTORY_DIM\n    WHERE DW_ACTIVE_FLAG ='N'\n    AND  DW_END_DATE > DATEADD('month', -1, CURRENT_TIMESTAMP())\n )\n AND EMAIL NOT IN (\n    SELECT EMAIL FROM ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.METABASE_USERS_TO_DEPRECATE WHERE CAST(DL_CREATED_DATE AS DATE) = CURRENT_DATE()\n )\n\"\"\" \ncursor.execute(select_query)\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343039":{"id":6343039,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":576,"y":-208,"width":32,"height":32,"inputConnectorIDs":[6343047],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6343006":{"id":6343006,"sourceID":6343035,"targetID":6343038},"6343007":{"id":6343007,"sourceID":6343002,"targetID":6343033},"6343040":{"id":6343040,"sourceID":6343038,"targetID":6343003},"6343041":{"id":6343041,"sourceID":6343034,"targetID":6343001},"6343042":{"id":6343042,"sourceID":6343005,"targetID":6343036},"6343043":{"id":6343043,"sourceID":6343033,"targetID":6343035},"6343044":{"id":6343044,"sourceID":6343036,"targetID":6343002},"6343045":{"id":6343045,"sourceID":6343003,"targetID":6343034}},"failureConnectors":{"6343048":{"id":6343048,"sourceID":6343005,"targetID":6343037},"6343049":{"id":6343049,"sourceID":6343035,"targetID":6343037},"6343050":{"id":6343050,"sourceID":6343034,"targetID":6343037},"6343072":{"id":6343072,"sourceID":6343002,"targetID":6343037},"6343073":{"id":6343073,"sourceID":6343003,"targetID":6343037},"6343074":{"id":6343074,"sourceID":6343033,"targetID":6343037},"6343075":{"id":6343075,"sourceID":6343036,"targetID":6343037},"6343076":{"id":6343076,"sourceID":6343038,"targetID":6343037}},"unconditionalConnectors":{"6343046":{"id":6343046,"sourceID":6343004,"targetID":6343005},"6343047":{"id":6343047,"sourceID":6343037,"targetID":6343039}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_Metabase_API_Get_Active_Users","description":"","type":"ORCHESTRATION","tag":"0f6974b0-3ec7-482f-b2c3-fb01a500bb74"}}