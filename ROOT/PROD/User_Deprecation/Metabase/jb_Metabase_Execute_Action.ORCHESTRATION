{"job":{"components":{"6343078":{"id":6343078,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":128,"y":272,"width":32,"height":32,"inputConnectorIDs":[6343090],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343092],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Table Error Insert"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Alexander Escobar\n-- Create date  : OCT-16_2025\n-- Description  : The goal of this script is to insert a record in the audit table when we got an error\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7746\n-- =============================================\n\"\"\"\n\ncursor = context.cursor()\nselect_query = \"\"\"INSERT INTO ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.METABASE_APPLICATION_LOGS \n(EVENT_TS, \nLOG_LEVEL, \nPROCESS_NAME, \nMESSAGE, \nEXECUTION_ID, \nCONTEXT, \nCREATED_BY) \nSELECT\nCURRENT_TIMESTAMP, \n'ERROR', \n'METABASE_USER_DEPRECATION',  \n${metabase_error_message}, \n${run_history_id},\nTO_VARIANT('{\"Job\": \"jb_Metabase_Execute_Action\"}'), \nCURRENT_USER\"\"\"\nprint(select_query)\ncursor.execute(select_query)\nresult = cursor.fetchone()\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343079":{"id":6343079,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":336,"y":272,"width":32,"height":32,"inputConnectorIDs":[6343092,6343095],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343093],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or 3"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343080":{"id":6343080,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":-16,"y":272,"width":32,"height":32,"inputConnectorIDs":[6343094,6343096],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343090],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or 2"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343081":{"id":6343081,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":560,"y":272,"width":32,"height":32,"inputConnectorIDs":[6343093],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343082":{"id":6343082,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":112,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343087],"outputSuccessConnectorIDs":[6343089],"outputFailureConnectorIDs":[6343094],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send notification email"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Alexander Escobar\n-- Create date  : OCT-16_2025\n-- Description  : The goal of this script is to call Madrill API to send a notification\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7746\n-- =============================================\n\"\"\"\n\nimport requests\nimport json\nimport logging\n\nMANDRILL_API_KEY = mandrill_api_key\n\n# Setup logging\nlogging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')\n\ndef send_email_to_multiple(recipient, subject, html_content, from_email='svc_metabaseuserdep@employbridge.com', from_name='User Deprecation Service'):\n    url = 'https://mandrillapp.com/api/1.0/messages/send.json'\n        \n    payload = {\n        \"key\": MANDRILL_API_KEY,\n        \"message\": {\n            \"html\": html_content,\n            \"subject\": subject,\n            \"from_email\": from_email,\n            \"from_name\": from_name,\n            \"to\": recipient,\n            \"important\": False,\n            \"track_opens\": True,\n            \"track_clicks\": True\n        }\n    }\n\n    response = requests.post(url, data=json.dumps(payload))\n    \n    if response.status_code == 200:\n        logging.info(\"Emails sent successfully!\")\n        logging.info(response.json())\n    else:\n        context.updateVariable(\"metabase_error_message\",response.json())\n        logging.error(\"Failed to send emails.\")\n        logging.error(response.text)\n\n        \ndef format_email_name(email):\n    # Split the email at '@' to remove the domain\n    local_part = email.split('@')[0]\n    \n    # Replace '.' with space\n    name_with_spaces = local_part.replace('.', ' ')\n    \n    # Capitalize each word\n    formatted_name = ' '.join(word.capitalize() for word in name_with_spaces.split())\n    \n    return formatted_name\n\n\n# Run the workflow\nif __name__ == \"__main__\":\n    name = format_email_name(metabase_user_email)\n    recipients = [\n    {\"email\": f\"{metabase_user_email}\", \"name\": f\"{name}\"}\n    ]\n    \n    recipient = recipients\n    if metabase_process_action == 'WARNING':\n        subject = \"METABASE USER DEPRECATION - Your account will be deactivated\"\n        html_content = (\n            f\"<h2>Hello {name}!</h2>\"\n            f\"<p>This email is to notify you that your Metabase account will be deactivated \"\n            f\"because you haven't logged in during the past {int(metabase_deprecation_months_range) - 1} months.</p>\"\n        \n        )\n    elif metabase_process_action == 'OUT OF RANGE':\n        subject = \"METABASE USER DEPRECATION - Your account has been deactivated\"\n        html_content = (\n            f\"<h2>Hello {name}!</h2>\"\n            f\"<p>This email is to notify you that your Metabase account has been deactivated \"\n            f\"because you haven't logged in during the past {metabase_deprecation_months_range} months.</p>\"\n        )\n    \n    if metabase_process_action in ['WARNING', 'OUT OF RANGE']:\n        send_email_to_multiple(recipient, subject, html_content)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343083":{"id":6343083,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":560,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343088],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Success 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343084":{"id":6343084,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-128,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343091],"outputSuccessConnectorIDs":[6343087],"outputFailureConnectorIDs":[6343096],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Metabase deprecate using API"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Alexander Escobar\n-- Create date  : OCT-16_2025\n-- Description  : The goal of this script is to call Metabase API to call the endpind to deactive users\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7746\n-- =============================================\n\"\"\"\n\nimport requests\nimport os\nimport boto3\nimport logging\nfrom io import StringIO\nimport pandas as pd\n\n# Metabase credentials and URL\nMETABASE_URL = \"https://data.bluecrewjobs.com\"\nUSERNAME = metabase_svc_username\nPASSWORD = metabase_svc_password\n\n\n# Setup logging\nlogging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')\n\n# Step 1: Test token validity\ndef test_token(endpoint):\n    \"\"\"Make an authenticated request and refresh token if needed.\"\"\"\n    url = f\"{METABASE_URL}{endpoint}\"\n    headers = {\"X-Metabase-Session\": metabase_api_id}\n\n    try:\n        response = requests.get(url, headers=headers)\n        if response.status_code == 401:\n            # Token expired or invalid, re-authenticate\n            logging.info(\"Session expired. Re-authenticating...\")\n            id = get_session_token()\n            context.updateVariable(\"metabase_api_id\",id)\n        else:\n            logging.info(\"Token is valid.\")\n\n    except requests.exceptions.RequestException as e:\n        context.updateVariable(\"metabase_error_message\",e)\n        logging.error(f\"Request failed: {e}\")\n    \n# Step 2: Authenticate and get session token\ndef get_session_token():\n    url = f\"{METABASE_URL}/api/session\"\n    payload = {\"username\": USERNAME, \"password\": PASSWORD}\n    \n    # Debug print\n    logging.info(\"Sending payload:\", payload)\n    \n    response = requests.post(url, json=payload)\n    \n    # Check for errors\n    if response.status_code != 200:\n        logging.error(\"Error:\", response.json())\n        context.updateVariable(\"metabase_error_message\",response.json())\n        response.raise_for_status()\n    \n    return response.json()[\"id\"]\n\n# Step 2: Call API endpoint to deprecate users\ndef deprecate_user(session_token):\n    url = f\"{METABASE_URL}/api/user/{metabase_user_id}\"\n    headers = {\"X-Metabase-Session\": session_token}\n    response = requests.delete(url, headers=headers)\n    response.raise_for_status()\n    return response.json()\n\n# Run the workflow\nif __name__ == \"__main__\":\n    if metabase_process_action in ['TERMINATION LIST', 'OUT OF RANGE']:\n        test_token(\"/api/user/current\")\n        #token = get_session_token()\n        token = metabase_api_id\n        #print(token)\n        deprecation_result = deprecate_user(token)\n        logging.info(\"User deprecation result:\", deprecation_result)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343085":{"id":6343085,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":336,"y":0,"width":32,"height":32,"inputConnectorIDs":[6343089],"outputSuccessConnectorIDs":[6343088],"outputFailureConnectorIDs":[6343095],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Table Insert"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"\"\"\n-- =============================================\n-- Author       : Alexander Escobar\n-- Create date  : OCT-16_2025\n-- Description  : The goal of this script is to insert a record in the audit table to follow up the action executed\n-- UPDATED BY\t: \n-- UPDATED ON\t:\n-- JIRA TICKET\t: CER-7746\n-- =============================================\n\"\"\"\n\n\ncursor = context.cursor()\nselect_query = \"\"\"INSERT INTO ${SNFLKDB_ADMIN}.${SNFLKSCH_ADMIN}.METABASE_APPLICATION_LOGS \n(EVENT_TS, \nLOG_LEVEL, \nPROCESS_NAME, \nMESSAGE, \nEXECUTION_ID, \nCONTEXT, \nCREATED_BY) \nSELECT\nCURRENT_TIMESTAMP, \n'INFO', \n'METABASE_USER_DEPRECATION',  \n'${metabase_process_action} - ${metabase_user_email}', \n${run_history_id},\nTO_VARIANT('{\"Job\": \"jb_Metabase_Execute_Action\"}'), \nCURRENT_USER\"\"\"\n#print(select_query)\ncursor.execute(select_query)\nresult = cursor.fetchone()\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6343086":{"id":6343086,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-320,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6343091],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6343087":{"id":6343087,"sourceID":6343084,"targetID":6343082},"6343088":{"id":6343088,"sourceID":6343085,"targetID":6343083},"6343089":{"id":6343089,"sourceID":6343082,"targetID":6343085}},"failureConnectors":{"6343094":{"id":6343094,"sourceID":6343082,"targetID":6343080},"6343095":{"id":6343095,"sourceID":6343085,"targetID":6343079},"6343096":{"id":6343096,"sourceID":6343084,"targetID":6343080}},"unconditionalConnectors":{"6343090":{"id":6343090,"sourceID":6343080,"targetID":6343078},"6343091":{"id":6343091,"sourceID":6343086,"targetID":6343084},"6343092":{"id":6343092,"sourceID":6343078,"targetID":6343079},"6343093":{"id":6343093,"sourceID":6343079,"targetID":6343081}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"metabase_error_message":{"definition":{"name":"metabase_error_message","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"'NOT CAPTURED'"}},"grids":{}},"info":{"name":"jb_Metabase_Execute_Action","description":null,"type":"ORCHESTRATION","tag":"9ac53175-590e-4e03-b474-4bbe575633f1"}}