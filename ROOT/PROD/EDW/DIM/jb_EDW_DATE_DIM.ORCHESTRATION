{"job":{"components":{"6337312":{"id":6337312,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-624,"y":-80,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6337315],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6337313":{"id":6337313,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-240,"y":-80,"width":32,"height":32,"inputConnectorIDs":[6337316],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DATE_DIM_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'EDW_DATE_DIM'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLEDWDB}.${SNFLEDWSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLEDWDB}' AS DESTINATIONDB_NAME ,'${SNFLEDWSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (job_name,Job_StartTimeStamp))\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6337314":{"id":6337314,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-432,"y":-80,"width":32,"height":32,"inputConnectorIDs":[6337315],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6337316],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DATE_DIM"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'EDW_DATE_DIM'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\ncursor = context.cursor()\n\ncursor.execute(\"MERGE INTO ${SNFLEDWDB}.${SNFLEDWSCH}.DATE_DIM T USING (Select ${SNFLEDWDB}.${SNFLEDWSCH}.hash_diff(array_construct(DATEID,CALENDARDATE,CALENDARDAY,CALENDARWEEK,CALENDARMONTH,CALENDARMONTH_STR,CALENDARYEAR,CALENDARQUARTER,FISCALPERIOD,FISCALWEEK,FISCALQUARTER,FISCALYEAR,SUNNORMPOSTINGDATE,WEEKYEAR,MONTHYEAR,PERIODYEAR,DAYSUFFIX,DAYOFWEEK,MONTHNAME,QUARTERCODE,QUARTERNAME,STANDARDDATE,FISCALWEEKYEAR,WEEKDESC,YEARPERIOD,PERIODDESC,YEARQUART,QUARTDESC,DAYOFYEAR)) trackingHash,TO_NUMBER(TO_CHAR(DATEID,'MMDDYYYY')) AS Date_Key, DATEID, CALENDARDATE, CALENDARDAY, CALENDARWEEK, CALENDARMONTH, CALENDARMONTH_STR, CALENDARYEAR, CALENDARQUARTER, TO_NUMBER(LTRIM(FISCALPERIOD,'P')) AS FISCAL_MONTH, FISCALPERIOD, FISCALWEEK, FISCALQUARTER, FISCALYEAR,\tSUNNORMPOSTINGDATE, WEEKYEAR, MONTHYEAR, PERIODYEAR, DAYSUFFIX, DAYOFWEEK, MONTHNAME, QUARTERCODE, QUARTERNAME, STANDARDDATE, FISCALWEEKYEAR, WEEKDESC, YEARPERIOD, PERIODDESC, YEARQUART, QUARTDESC, DAYOFYEAR, CURRENT_TIMESTAMP AS DW_Start_Date, TO_TIMESTAMP('9999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS') AS DW_End_Date, 'Y' AS DW_Active_Flag from  ${SNFLDWHDB}.${SNFLDWHSCH}.dim_date) X ON T.DATE_KEY = X.DATE_KEY AND T.trackingHash =  X.trackingHash AND T.DW_END_DATE = TO_TIMESTAMP('9999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS') WHEN MATCHED AND T.trackingHash <> X.trackingHash THEN UPDATE SET DATE = DATEID, CALENDAR_DATE =\tCALENDARDATE, CALENDAR_DAY = CALENDARDAY, CALENDAR_WEEK = CALENDARWEEK, CALENDAR_MONTH = CALENDARMONTH, CALENDAR_MONTH_NM = CALENDARMONTH_STR, CALENDAR_YEAR = CALENDARYEAR, CALENDAR_QUARTER = CALENDARQUARTER, FISCAL_MONTH = X.FISCAL_MONTH, FISCAL_PERIOD = FISCALPERIOD, FISCAL_WEEK\t= FISCALWEEK, FISCAL_QUARTER = FISCALQUARTER, FISCAL_YEAR = FISCALYEAR, SUNNORM_POSTING_DATE = SUNNORMPOSTINGDATE, WEEK_YEAR =\tWEEKYEAR, MONTH_YEAR = MONTHYEAR, PERIOD_YEAR = PERIODYEAR, DAY_SUFFIX = DAYSUFFIX, DAY_OF_WEEK = DAYOFWEEK, MONTH_NAME = MONTHNAME, QUARTER_CODE = QUARTERCODE, QUARTER_NAME = QUARTERNAME, STANDARD_DATE = STANDARDDATE, FISCAL_WEEK_YEAR = FISCALWEEKYEAR, WEEK_DESC = WEEKDESC, YEAR_PERIOD = YEARPERIOD, PERIOD_DESC = PERIODDESC, YEAR_QUART = YEARQUART, QUART_DESC = QUARTDESC, DAY_OF_YEAR = DAYOFYEAR, DW_START_DATE = X.DW_Start_Date, DW_END_DATE = X.DW_End_Date, DW_ACTIVE_FLAG = X.DW_Active_Flag WHEN NOT MATCHED THEN INSERT(TRACKINGHASH,DATE_KEY,DATE,CALENDAR_DATE,CALENDAR_DAY,CALENDAR_WEEK,CALENDAR_MONTH,CALENDAR_MONTH_NM,CALENDAR_YEAR,CALENDAR_QUARTER,FISCAL_MONTH,FISCAL_PERIOD,FISCAL_WEEK,FISCAL_QUARTER,FISCAL_YEAR,SUNNORM_POSTING_DATE,WEEK_YEAR,MONTH_YEAR,PERIOD_YEAR,DAY_SUFFIX,DAY_OF_WEEK,MONTH_NAME,QUARTER_CODE,QUARTER_NAME,STANDARD_DATE,FISCAL_WEEK_YEAR,WEEK_DESC,YEAR_PERIOD,PERIOD_DESC,YEAR_QUART,QUART_DESC,DAY_OF_YEAR,DW_START_DATE,DW_END_DATE,DW_ACTIVE_FLAG) VALUES(TRACKINGHASH,Date_Key,DATEID,CALENDARDATE,CALENDARDAY,CALENDARWEEK,CALENDARMONTH,CALENDARMONTH_STR,CALENDARYEAR,CALENDARQUARTER,FISCAL_MONTH,FISCALPERIOD,FISCALWEEK,FISCALQUARTER,FISCALYEAR,SUNNORMPOSTINGDATE,WEEKYEAR,MONTHYEAR,PERIODYEAR,DAYSUFFIX,DAYOFWEEK,MONTHNAME,QUARTERCODE,QUARTERNAME,STANDARDDATE,FISCALWEEKYEAR,WEEKDESC,YEARPERIOD,PERIODDESC,YEARQUART,QUARTDESC,DAYOFYEAR,DW_Start_Date,DW_End_Date,DW_Active_Flag);\")\n# Get rows inserted count\ncursor.execute('WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) SELECT Rows_Inserted FROM CTE')\nrows_inserted = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount\",rows_inserted[0])\n#print audit_rowcount\n\n# Update Holiday flag\ncursor.execute(\"UPDATE ${SNFLEDWDB}.${SNFLEDWSCH}.DATE_DIM set holiday_flag = 'Y' where date IN ('2019-01-01','2019-05-27','2019-07-04','2019-09-04','2019-11-28','2019-11-29','2019-12-25','2020-01-01','2020-05-25','2020-07-03','2020-09-07','2020-11-26','2020-11-27','2020-12-25',               '2021-01-01','2021-05-31','2021-07-05','2021-09-06','2021-11-25','2021-11-26','2021-12-24','2022-01-03','2022-05-30','2022-07-04','2022-09-05','2022-11-24','2022-11-25','2022-12-23');\")\ncursor.execute(\"UPDATE ${SNFLEDWDB}.${SNFLEDWSCH}.DATE_DIM T SET T.DW_END_DATE = DATEADD(minute,-1,current_timestamp()),T.DW_ACTIVE_FLAG = 'N' FROM (SELECT ${SNFLEDWDB}.${SNFLEDWSCH}.hash_diff(array_construct(DATEID,CALENDARDATE,CALENDARDAY,CALENDARWEEK,CALENDARMONTH,CALENDARMONTH_STR,CALENDARYEAR,CALENDARQUARTER,FISCALPERIOD,FISCALWEEK,FISCALQUARTER,FISCALYEAR,SUNNORMPOSTINGDATE,WEEKYEAR,MONTHYEAR,PERIODYEAR,DAYSUFFIX,DAYOFWEEK,MONTHNAME,QUARTERCODE,QUARTERNAME,STANDARDDATE,FISCALWEEKYEAR,WEEKDESC,YEARPERIOD,PERIODDESC,YEARQUART,QUARTDESC,DAYOFYEAR)) as TrackingHash, TO_NUMBER(TO_CHAR(DATEID,'MMDDYYYY')) DATE_KEY from ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_DATE) A WHERE A.DATE_KEY = T.DATE_KEY AND   A.TRACKINGHASH <> T.TRACKINGHASH AND   T.DW_END_DATE = TO_TIMESTAMP_NTZ('9999-12-31 23:59:59', 'YYYY-MM-DD HH24:MI:SS');\") \n# Get rows Updated count\ncursor.execute('WITH CTE (Rows_Updated,MultiJoinRows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) SELECT Rows_Updated FROM CTE')\nrows_updated = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount1\",rows_updated[0])\n#print audit_rowcount1\n\nif audit_rowcount1>0:\n   audit_rowcount = audit_rowcount-audit_rowcount1\nelse:\n   audit_rowcount = audit_rowcount\nprint 'Inserted Count = ',audit_rowcount\nprint 'Updated Count = ',audit_rowcount1\n\n#Insert in Audit Table\ncursor.execute(\"INSERT INTO ${SNFLEDWDB}.${SNFLEDWSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLEDWDB}' AS DESTINATIONDB_NAME ,'${SNFLEDWSCH}' AS DESTINATIONSCHEMA_NAME ,'%s' ,'%s' ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS\" % (job_name, audit_rowcount, audit_rowcount1, Job_StartTimeStamp))\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6337316":{"id":6337316,"sourceID":6337314,"targetID":6337313}},"unconditionalConnectors":{"6337315":{"id":6337315,"sourceID":6337312,"targetID":6337314}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_EDW_DATE_DIM","description":"","type":"ORCHESTRATION","tag":"2d572f32-3fff-472a-9bf6-1574331b5506"}}