{"job":{"components":{"6337977":{"id":6337977,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":240,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SalesForceAccountOwnerTracking_retry"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'jb_SalesForceAccountOwnerTracking'\ncontext.updateVariable(\"Job_Name\",job_name)\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_EndTimeStamp\",CurrentTime.strftime(fmt))\n\n###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking t using ( SELECT id, customer_number, customer_name, bdm_empid, min(bdm_name) AS bdm_name, min(npg_emp_id) AS npg_emp_id, min(npg_manager) AS npg_manager, min(npg_ops_mgr_empid) AS npg_ops_mgr_empid, min(npg_ops_manager) AS npg_ops_manager, min(sps_empid) AS sps_empid, min(sps) AS sps, min(vip_empid) AS vip_empid, min(vip) AS vip, min(client_success_leader_empid) AS client_success_leader_empid, min(client_success_leader) AS client_success_leader, from_date, to_date, active_status FROM ( SELECT DISTINCT acc.id AS id, accountnumber AS customer_number, NAME AS customer_name, ownerid AS bdm_empid, concat(us1.firstname,' ',us1.lastname) AS bdm_name, CASE WHEN team.teammemberrole ='NPG Manager' THEN us.id END AS npg_emp_id, CASE WHEN team.teammemberrole ='NPG Manager' THEN concat(us.firstname,' ',us.lastname) END AS npg_manager, CASE WHEN team.teammemberrole ='NPG Ops Manager' THEN us.id END AS npg_ops_mgr_empid, CASE WHEN team.teammemberrole ='NPG Ops Manager' THEN concat(us.firstname,' ',us.lastname) END AS npg_ops_manager, CASE WHEN team.teammemberrole ='SPS Specialist' THEN us.id END AS sps_empid, CASE WHEN team.teammemberrole ='SPS Specialist' THEN concat(us.firstname,' ',us.lastname) END AS sps, CASE WHEN team.teammemberrole ='VIP Sales Director' THEN us.id END AS vip_empid, CASE WHEN team.teammemberrole ='VIP Sales Director' THEN concat(us.firstname,' ',us.lastname) END AS vip, CASE WHEN team.teammemberrole ='Client Success Leader' THEN us.id END AS client_success_leader_empid, CASE WHEN team.teammemberrole ='Client Success Leader' THEN concat(us.firstname,' ',us.lastname) END AS client_success_leader, CASE WHEN dayname(CURRENT_DATE()) = 'Sun' THEN previous_day(CURRENT_DATE(), 'Monday') WHEN dayname(CURRENT_DATE()) = 'Mon' THEN previous_day(CURRENT_DATE(), 'Monday') ELSE previous_day(dateadd(week,-1,CURRENT_DATE()), 'Monday') END AS from_date, CASE WHEN dayname(CURRENT_DATE()) = 'Sun' THEN date(CURRENT_DATE()) ELSE previous_day(CURRENT_DATE(), 'Sunday') END AS to_date, 'Y' AS active_status FROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.account acc LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.accountteammember team ON team.accountid = acc.id LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.USER us ON team.userid = us.id LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.USER us1 ON acc.ownerid = us1.id)AS temp GROUP BY id, customer_number, customer_name, bdm_empid, from_date, to_date, active_status )s ON t.id = s.id AND t.active_status = s.active_status WHEN matched AND ( t.customer_number <> s.customer_number OR ( t.customer_number IS NULL AND s.customer_number IS NOT NULL) OR ( t.customer_number IS NOT NULL AND s.customer_number IS NULL) OR t.customer_name <> s.customer_name OR ( t.customer_name IS NULL AND s.customer_name IS NOT NULL) OR ( t.customer_name IS NOT NULL AND s.customer_name IS NULL) OR t.bdm_empid <> s.bdm_empid OR ( t.bdm_empid IS NULL AND s.bdm_empid IS NOT NULL) OR ( t.bdm_empid IS NOT NULL AND s.bdm_empid IS NULL) OR t.bdm <> s.bdm_name OR ( t.bdm IS NULL AND s.bdm_name IS NOT NULL) OR ( t.bdm IS NOT NULL AND s.bdm_name IS NULL) OR t.npg_manager_empid <> s.npg_emp_id OR ( t.npg_manager_empid IS NULL AND s.npg_emp_id IS NOT NULL) OR ( t.npg_manager_empid IS NOT NULL AND s.npg_emp_id IS NULL) OR t.npg_manager <> s.npg_manager OR ( t.npg_manager IS NULL AND s.npg_manager IS NOT NULL) OR ( t.npg_manager IS NOT NULL AND s.npg_manager IS NULL) OR t.npg_ops_mgr_empid <> s.npg_ops_mgr_empid OR ( t.npg_ops_mgr_empid IS NULL AND s.npg_ops_mgr_empid IS NOT NULL) OR ( t.npg_ops_mgr_empid IS NOT NULL AND s.npg_ops_mgr_empid IS NULL) OR t.npg_ops_manager <> s.npg_ops_manager OR ( t.npg_ops_manager IS NULL AND s.npg_ops_manager IS NOT NULL) OR ( t.npg_ops_manager IS NOT NULL AND s.npg_ops_manager IS NULL) OR t.sps_specialist_empid <> s.sps_empid OR ( t.sps_specialist_empid IS NULL AND s.sps_empid IS NOT NULL) OR ( t.sps_specialist_empid IS NOT NULL AND s.sps_empid IS NULL) OR t.sps_specialist <> s.sps OR ( t.sps_specialist IS NULL AND s.sps IS NOT NULL) OR ( t.sps_specialist IS NOT NULL AND s.sps IS NULL) OR t.vip_director_empid <> s.vip_empid OR ( t.vip_director_empid IS NULL AND s.vip_empid IS NOT NULL) OR ( t.vip_director_empid IS NOT NULL AND s.vip_empid IS NULL) OR t.vip_director <> s.vip OR ( t.vip_director IS NULL AND s.vip IS NOT NULL) OR ( t.vip_director IS NOT NULL AND s.vip IS NULL) OR t.client_success_leader_empid <> s.client_success_leader_empid OR ( t.client_success_leader_empid IS NULL AND s.client_success_leader_empid IS NOT NULL) OR ( t.client_success_leader_empid IS NOT NULL AND s.client_success_leader_empid IS NULL) OR t.client_success_leader <> s.client_success_leader OR ( t.client_success_leader IS NULL AND s.client_success_leader IS NOT NULL) OR ( t.client_success_leader IS NOT NULL AND s.client_success_leader IS NULL) ) AND t.modified_dt = ( SELECT max(modified_dt) FROM ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking WHERE id =s.id ) THEN UPDATE SET t.modified_dt = CURRENT_TIMESTAMP, t.modified_by = CURRENT_USER(), t.active_status ='N', t.to_date = previous_day( CASE WHEN dayname(CURRENT_DATE()) = 'Sun' THEN previous_day(CURRENT_DATE(), 'Monday') WHEN dayname(CURRENT_DATE()) = 'Mon' THEN previous_day(CURRENT_DATE(), 'Monday') ELSE previous_day(dateadd(week,-1,CURRENT_DATE()), 'Monday') END, 'Sunday') WHEN NOT matched THEN INSERT ( id, customer_number, customer_name, bdm_empid, bdm, npg_manager_empid, npg_manager, npg_ops_mgr_empid, npg_ops_manager, sps_specialist_empid, sps_specialist, vip_director_empid, vip_director, client_success_leader_empid, client_success_leader, from_date, to_date, active_status, created_dt, created_by, modified_dt, modified_by ) VALUES ( s.id, s.customer_number, s.customer_name, s.bdm_empid, s.bdm_name, s.npg_emp_id, s.npg_manager, s.npg_ops_mgr_empid, s.npg_ops_manager, s.sps_empid, s.sps, s.vip_empid, s.vip, s.client_success_leader_empid, s.client_success_leader, s.from_date, '9999-12-31 00:00:00.000', 'Y', CURRENT_TIMESTAMP, CURRENT_USER(), CURRENT_TIMESTAMP, CURRENT_USER() )\")\nresult = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount\", int(result[0]))\n    #rowCount = rowCount + int(result[0])\n    #rowcount = int(cursor.fetchone()[0])\ncursor.execute(\"INSERT INTO ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking ( id, customer_number, customer_name, bdm_empid, bdm, npg_manager_empid, npg_manager, npg_ops_mgr_empid, npg_ops_manager, sps_specialist_empid, sps_specialist, vip_director_empid, vip_director, client_success_leader_empid, client_success_leader, from_date, to_date, active_status, created_dt, created_by, modified_dt, modified_by ) SELECT s.* FROM ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking t INNER JOIN ( SELECT id, customer_number, customer_name, bdm_empid, min(bdm_name) AS bdm_name, min(npg_emp_id) AS npg_emp_id, min(npg_manager) AS npg_manager, min(npg_ops_mgr_empid) AS npg_ops_mgr_empid, min(npg_ops_manager) AS npg_ops_manager, min(sps_empid) AS sps_empid, min(sps) AS sps, min(vip_empid) AS vip_empid, min(vip) AS vip, min(client_success_leader_empid) AS client_success_leader_empid, min(client_success_leader) AS client_success_leader, from_date, to_date, active_status, CURRENT_TIMESTAMP, CURRENT_USER(), CURRENT_TIMESTAMP, CURRENT_USER() FROM ( SELECT DISTINCT acc.id AS id, accountnumber AS customer_number, NAME AS customer_name, ownerid AS bdm_empid, concat(us1.firstname,' ',us1.lastname) AS bdm_name, CASE WHEN team.teammemberrole ='NPG Manager' THEN us.id END AS npg_emp_id, CASE WHEN team.teammemberrole ='NPG Manager' THEN concat(us.firstname,' ',us.lastname) END AS npg_manager, CASE WHEN team.teammemberrole ='NPG Ops Manager' THEN us.id END AS npg_ops_mgr_empid, CASE WHEN team.teammemberrole ='NPG Ops Manager' THEN concat(us.firstname,' ',us.lastname) END AS npg_ops_manager, CASE WHEN team.teammemberrole ='SPS Specialist' THEN us.id END AS sps_empid, CASE WHEN team.teammemberrole ='SPS Specialist' THEN concat(us.firstname,' ',us.lastname) END AS sps, CASE WHEN team.teammemberrole ='VIP Sales Director' THEN us.id END AS vip_empid, CASE WHEN team.teammemberrole ='VIP Sales Director' THEN concat(us.firstname,' ',us.lastname) END AS vip, CASE WHEN team.teammemberrole ='Client Success Leader' THEN us.id END AS client_success_leader_empid, CASE WHEN team.teammemberrole ='Client Success Leader' THEN concat(us.firstname,' ',us.lastname) END AS client_success_leader, CASE WHEN dayname(CURRENT_DATE()) = 'Sun' THEN previous_day(CURRENT_DATE(), 'Monday') WHEN dayname(CURRENT_DATE()) = 'Mon' THEN previous_day(CURRENT_DATE(), 'Monday') ELSE previous_day(dateadd(week,-1,CURRENT_DATE()), 'Monday') END AS from_date, '9999-12-31 00:00:00.000' AS to_date, 'Y' AS active_status FROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.account acc LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.accountteammember team ON team.accountid = acc.id LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.USER us ON team.userid = us.id LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.USER us1 ON acc.ownerid = us1.id)AS temp GROUP BY id, customer_number, customer_name, bdm_empid, from_date, to_date, active_status )s ON t.id = s.id AND ( t.customer_number <> s.customer_number OR ( t.customer_number IS NULL AND s.customer_number IS NOT NULL) OR ( t.customer_number IS NOT NULL AND s.customer_number IS NULL) OR t.customer_name <> s.customer_name OR ( t.customer_name IS NULL AND s.customer_name IS NOT NULL) OR ( t.customer_name IS NOT NULL AND s.customer_name IS NULL) OR t.bdm_empid <> s.bdm_empid OR ( t.bdm_empid IS NULL AND s.bdm_empid IS NOT NULL) OR ( t.bdm_empid IS NOT NULL AND s.bdm_empid IS NULL) OR t.bdm <> s.bdm_name OR ( t.bdm IS NULL AND s.bdm_name IS NOT NULL) OR ( t.bdm IS NOT NULL AND s.bdm_name IS NULL) OR t.npg_manager_empid <> s.npg_emp_id OR ( t.npg_manager_empid IS NULL AND s.npg_emp_id IS NOT NULL) OR ( t.npg_manager_empid IS NOT NULL AND s.npg_emp_id IS NULL) OR t.npg_manager <> s.npg_manager OR ( t.npg_manager IS NULL AND s.npg_manager IS NOT NULL) OR ( t.npg_manager IS NOT NULL AND s.npg_manager IS NULL) OR t.npg_ops_mgr_empid <> s.npg_ops_mgr_empid OR ( t.npg_ops_mgr_empid IS NULL AND s.npg_ops_mgr_empid IS NOT NULL) OR ( t.npg_ops_mgr_empid IS NOT NULL AND s.npg_ops_mgr_empid IS NULL) OR t.npg_ops_manager <> s.npg_ops_manager OR ( t.npg_ops_manager IS NULL AND s.npg_ops_manager IS NOT NULL) OR ( t.npg_ops_manager IS NOT NULL AND s.npg_ops_manager IS NULL) OR t.sps_specialist_empid <> s.sps_empid OR ( t.sps_specialist_empid IS NULL AND s.sps_empid IS NOT NULL) OR ( t.sps_specialist_empid IS NOT NULL AND s.sps_empid IS NULL) OR t.sps_specialist <> s.sps OR ( t.sps_specialist IS NULL AND s.sps IS NOT NULL) OR ( t.sps_specialist IS NOT NULL AND s.sps IS NULL) OR t.vip_director_empid <> s.vip_empid OR ( t.vip_director_empid IS NULL AND s.vip_empid IS NOT NULL) OR ( t.vip_director_empid IS NOT NULL AND s.vip_empid IS NULL) OR t.vip_director <> s.vip OR ( t.vip_director IS NULL AND s.vip IS NOT NULL) OR ( t.vip_director IS NOT NULL AND s.vip IS NULL) OR t.client_success_leader_empid <> s.client_success_leader_empid OR ( t.client_success_leader_empid IS NULL AND s.client_success_leader_empid IS NOT NULL) OR ( t.client_success_leader_empid IS NOT NULL AND s.client_success_leader_empid IS NULL) OR t.client_success_leader <> s.client_success_leader OR ( t.client_success_leader IS NULL AND s.client_success_leader IS NOT NULL) OR ( t.client_success_leader IS NOT NULL AND s.client_success_leader IS NULL) ) AND t.modified_dt = ( SELECT max(modified_dt) FROM ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking WHERE id =s.id )\")\nresult = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount1\", int(result[0]))\n    #rowCount1 = rowCount1 + int(result[0])\n#cursor.execute(\"INSERT INTO ${SNFLKDB}.${SNFLKSCH}.AUDIT_METRICS(ROW_COUNT,START_DATE,END_DATE,JOB_ID,JOB_NAME,JOB_STATUS)VALUES(0,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,CAST('${run_history_id}' as VARCHAR(50)),'jb_SalesForceAccountOwnerTracking','SUCCESS')\")\t\n#cursor = context.cursor()\n#cursor.execute(\"INSERT INTO ${SNFLKDB}.${SNFLKSCH}.AUDIT_METRICS(ROW_COUNT,START_DATE,END_DATE,JOB_ID,JOB_NAME,JOB_STATUS)VALUES(12,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP,CAST('${run_history_id}' as VARCHAR(50)),'jb_SalesForceAccountOwnerTracking','SUCCESS')\")\t\ncursor.execute(\"INSERT INTO ${SNFLKDB}.${SNFLKSCH}.AUDIT_METRICS (ROW_COUNT,START_DATE, END_DATE, JOB_ID, JOB_NAME, JOB_STATUS) select '%s' AS ROW_COUNT, '%s' AS START_DATE ,'%s' AS END_DATE ,'%s'  AS JOB_ID, '%s' as JOB_NAME ,'SUCCESS' AS JOB_STATUS\" % ((audit_rowcount+audit_rowcount1),Job_StartTimeStamp,Job_EndTimeStamp, run_history_id, job_name))"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[6338016]},"6337978":{"id":6337978,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":496,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6337951],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"JOB Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'jb_SalesForceAccountOwnerTracking'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_EndTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\n\ncursor.execute(\"INSERT INTO ${SNFLKDB}.${SNFLKSCH}.AUDIT_METRICS (ROW_COUNT,START_DATE, END_DATE, JOB_ID, JOB_NAME, JOB_STATUS) select 0 AS ROW_COUNT, '%s' AS START_DATE ,'%s' AS END_DATE ,'%s'  AS JOB_ID, '%s' as JOB_NAME ,'FAILED' AS JOB_STATUS\" % (Job_StartTimeStamp, Job_EndTimeStamp, run_history_id, job_name))\t\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6337979":{"id":6337979,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-160,"y":-16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6337982],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6337980":{"id":6337980,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"ITERATE","implementationID":-158614544,"x":240,"y":-16,"width":32,"height":16,"inputConnectorIDs":[6337983],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6337951],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Retry"}}}},"visible":true},"2":{"slot":2,"name":"Number of Retries","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"9"}}}},"visible":true},"3":{"slot":3,"name":"Retry Delay","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Retry immediately"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[6338016],"inputIterationConnectorIDs":[]},"6337981":{"id":6337981,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":16,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6337982],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6337983],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SalesForceAccountOwnerTracking"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'jb_SalesForceAccountOwnerTracking'\ncontext.updateVariable(\"Job_Name\",job_name)\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_EndTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking t using ( SELECT id, customer_number, customer_name, bdm_empid, min(bdm_name) AS bdm_name, min(npg_emp_id) AS npg_emp_id, min(npg_manager) AS npg_manager, min(npg_ops_mgr_empid) AS npg_ops_mgr_empid, min(npg_ops_manager) AS npg_ops_manager, min(sps_empid) AS sps_empid, min(sps) AS sps, min(vip_empid) AS vip_empid, min(vip) AS vip, min(client_success_leader_empid) AS client_success_leader_empid, min(client_success_leader) AS client_success_leader, from_date, to_date, active_status FROM ( SELECT DISTINCT acc.id AS id, accountnumber AS customer_number, NAME AS customer_name, ownerid AS bdm_empid, concat(us1.firstname,' ',us1.lastname) AS bdm_name, CASE WHEN team.teammemberrole ='NPG Manager' THEN us.id END AS npg_emp_id, CASE WHEN team.teammemberrole ='NPG Manager' THEN concat(us.firstname,' ',us.lastname) END AS npg_manager, CASE WHEN team.teammemberrole ='NPG Ops Manager' THEN us.id END AS npg_ops_mgr_empid, CASE WHEN team.teammemberrole ='NPG Ops Manager' THEN concat(us.firstname,' ',us.lastname) END AS npg_ops_manager, CASE WHEN team.teammemberrole ='SPS Specialist' THEN us.id END AS sps_empid, CASE WHEN team.teammemberrole ='SPS Specialist' THEN concat(us.firstname,' ',us.lastname) END AS sps, CASE WHEN team.teammemberrole ='VIP Sales Director' THEN us.id END AS vip_empid, CASE WHEN team.teammemberrole ='VIP Sales Director' THEN concat(us.firstname,' ',us.lastname) END AS vip, CASE WHEN team.teammemberrole ='Client Success Leader' THEN us.id END AS client_success_leader_empid, CASE WHEN team.teammemberrole ='Client Success Leader' THEN concat(us.firstname,' ',us.lastname) END AS client_success_leader, CASE WHEN dayname(CURRENT_DATE()) = 'Sun' THEN previous_day(CURRENT_DATE(), 'Monday') WHEN dayname(CURRENT_DATE()) = 'Mon' THEN previous_day(CURRENT_DATE(), 'Monday') ELSE previous_day(dateadd(week,-1,CURRENT_DATE()), 'Monday') END AS from_date, CASE WHEN dayname(CURRENT_DATE()) = 'Sun' THEN date(CURRENT_DATE()) ELSE previous_day(CURRENT_DATE(), 'Sunday') END AS to_date, 'Y' AS active_status FROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.account acc LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.accountteammember team ON team.accountid = acc.id LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.USER us ON team.userid = us.id LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.USER us1 ON acc.ownerid = us1.id)AS temp GROUP BY id, customer_number, customer_name, bdm_empid, from_date, to_date, active_status )s ON t.id = s.id AND t.active_status = s.active_status WHEN matched AND ( t.customer_number <> s.customer_number OR ( t.customer_number IS NULL AND s.customer_number IS NOT NULL) OR ( t.customer_number IS NOT NULL AND s.customer_number IS NULL) OR t.customer_name <> s.customer_name OR ( t.customer_name IS NULL AND s.customer_name IS NOT NULL) OR ( t.customer_name IS NOT NULL AND s.customer_name IS NULL) OR t.bdm_empid <> s.bdm_empid OR ( t.bdm_empid IS NULL AND s.bdm_empid IS NOT NULL) OR ( t.bdm_empid IS NOT NULL AND s.bdm_empid IS NULL) OR t.bdm <> s.bdm_name OR ( t.bdm IS NULL AND s.bdm_name IS NOT NULL) OR ( t.bdm IS NOT NULL AND s.bdm_name IS NULL) OR t.npg_manager_empid <> s.npg_emp_id OR ( t.npg_manager_empid IS NULL AND s.npg_emp_id IS NOT NULL) OR ( t.npg_manager_empid IS NOT NULL AND s.npg_emp_id IS NULL) OR t.npg_manager <> s.npg_manager OR ( t.npg_manager IS NULL AND s.npg_manager IS NOT NULL) OR ( t.npg_manager IS NOT NULL AND s.npg_manager IS NULL) OR t.npg_ops_mgr_empid <> s.npg_ops_mgr_empid OR ( t.npg_ops_mgr_empid IS NULL AND s.npg_ops_mgr_empid IS NOT NULL) OR ( t.npg_ops_mgr_empid IS NOT NULL AND s.npg_ops_mgr_empid IS NULL) OR t.npg_ops_manager <> s.npg_ops_manager OR ( t.npg_ops_manager IS NULL AND s.npg_ops_manager IS NOT NULL) OR ( t.npg_ops_manager IS NOT NULL AND s.npg_ops_manager IS NULL) OR t.sps_specialist_empid <> s.sps_empid OR ( t.sps_specialist_empid IS NULL AND s.sps_empid IS NOT NULL) OR ( t.sps_specialist_empid IS NOT NULL AND s.sps_empid IS NULL) OR t.sps_specialist <> s.sps OR ( t.sps_specialist IS NULL AND s.sps IS NOT NULL) OR ( t.sps_specialist IS NOT NULL AND s.sps IS NULL) OR t.vip_director_empid <> s.vip_empid OR ( t.vip_director_empid IS NULL AND s.vip_empid IS NOT NULL) OR ( t.vip_director_empid IS NOT NULL AND s.vip_empid IS NULL) OR t.vip_director <> s.vip OR ( t.vip_director IS NULL AND s.vip IS NOT NULL) OR ( t.vip_director IS NOT NULL AND s.vip IS NULL) OR t.client_success_leader_empid <> s.client_success_leader_empid OR ( t.client_success_leader_empid IS NULL AND s.client_success_leader_empid IS NOT NULL) OR ( t.client_success_leader_empid IS NOT NULL AND s.client_success_leader_empid IS NULL) OR t.client_success_leader <> s.client_success_leader OR ( t.client_success_leader IS NULL AND s.client_success_leader IS NOT NULL) OR ( t.client_success_leader IS NOT NULL AND s.client_success_leader IS NULL) ) AND t.modified_dt = ( SELECT max(modified_dt) FROM ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking WHERE id =s.id ) THEN UPDATE SET t.modified_dt = CURRENT_TIMESTAMP, t.modified_by = CURRENT_USER(), t.active_status ='N', t.to_date = previous_day( CASE WHEN dayname(CURRENT_DATE()) = 'Sun' THEN previous_day(CURRENT_DATE(), 'Monday') WHEN dayname(CURRENT_DATE()) = 'Mon' THEN previous_day(CURRENT_DATE(), 'Monday') ELSE previous_day(dateadd(week,-1,CURRENT_DATE()), 'Monday') END, 'Sunday') WHEN NOT matched THEN INSERT ( id, customer_number, customer_name, bdm_empid, bdm, npg_manager_empid, npg_manager, npg_ops_mgr_empid, npg_ops_manager, sps_specialist_empid, sps_specialist, vip_director_empid, vip_director, client_success_leader_empid, client_success_leader, from_date, to_date, active_status, created_dt, created_by, modified_dt, modified_by ) VALUES ( s.id, s.customer_number, s.customer_name, s.bdm_empid, s.bdm_name, s.npg_emp_id, s.npg_manager, s.npg_ops_mgr_empid, s.npg_ops_manager, s.sps_empid, s.sps, s.vip_empid, s.vip, s.client_success_leader_empid, s.client_success_leader, s.from_date, '9999-12-31 00:00:00.000', 'Y', CURRENT_TIMESTAMP, CURRENT_USER(), CURRENT_TIMESTAMP, CURRENT_USER() )\")\nresult = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount\", int(result[0]))\n#rowcount = rowcount+int(result[0])\ncursor.execute(\"INSERT INTO ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking ( id, customer_number, customer_name, bdm_empid, bdm, npg_manager_empid, npg_manager, npg_ops_mgr_empid, npg_ops_manager, sps_specialist_empid, sps_specialist, vip_director_empid, vip_director, client_success_leader_empid, client_success_leader, from_date, to_date, active_status, created_dt, created_by, modified_dt, modified_by ) SELECT s.* FROM ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking t INNER JOIN ( SELECT id, customer_number, customer_name, bdm_empid, min(bdm_name) AS bdm_name, min(npg_emp_id) AS npg_emp_id, min(npg_manager) AS npg_manager, min(npg_ops_mgr_empid) AS npg_ops_mgr_empid, min(npg_ops_manager) AS npg_ops_manager, min(sps_empid) AS sps_empid, min(sps) AS sps, min(vip_empid) AS vip_empid, min(vip) AS vip, min(client_success_leader_empid) AS client_success_leader_empid, min(client_success_leader) AS client_success_leader, from_date, to_date, active_status, CURRENT_TIMESTAMP, CURRENT_USER(), CURRENT_TIMESTAMP, CURRENT_USER() FROM ( SELECT DISTINCT acc.id AS id, accountnumber AS customer_number, NAME AS customer_name, ownerid AS bdm_empid, concat(us1.firstname,' ',us1.lastname) AS bdm_name, CASE WHEN team.teammemberrole ='NPG Manager' THEN us.id END AS npg_emp_id, CASE WHEN team.teammemberrole ='NPG Manager' THEN concat(us.firstname,' ',us.lastname) END AS npg_manager, CASE WHEN team.teammemberrole ='NPG Ops Manager' THEN us.id END AS npg_ops_mgr_empid, CASE WHEN team.teammemberrole ='NPG Ops Manager' THEN concat(us.firstname,' ',us.lastname) END AS npg_ops_manager, CASE WHEN team.teammemberrole ='SPS Specialist' THEN us.id END AS sps_empid, CASE WHEN team.teammemberrole ='SPS Specialist' THEN concat(us.firstname,' ',us.lastname) END AS sps, CASE WHEN team.teammemberrole ='VIP Sales Director' THEN us.id END AS vip_empid, CASE WHEN team.teammemberrole ='VIP Sales Director' THEN concat(us.firstname,' ',us.lastname) END AS vip, CASE WHEN team.teammemberrole ='Client Success Leader' THEN us.id END AS client_success_leader_empid, CASE WHEN team.teammemberrole ='Client Success Leader' THEN concat(us.firstname,' ',us.lastname) END AS client_success_leader, CASE WHEN dayname(CURRENT_DATE()) = 'Sun' THEN previous_day(CURRENT_DATE(), 'Monday') WHEN dayname(CURRENT_DATE()) = 'Mon' THEN previous_day(CURRENT_DATE(), 'Monday') ELSE previous_day(dateadd(week,-1,CURRENT_DATE()), 'Monday') END AS from_date, '9999-12-31 00:00:00.000' AS to_date, 'Y' AS active_status FROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.account acc LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.accountteammember team ON team.accountid = acc.id LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.USER us ON team.userid = us.id LEFT JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.USER us1 ON acc.ownerid = us1.id)AS temp GROUP BY id, customer_number, customer_name, bdm_empid, from_date, to_date, active_status )s ON t.id = s.id AND ( t.customer_number <> s.customer_number OR ( t.customer_number IS NULL AND s.customer_number IS NOT NULL) OR ( t.customer_number IS NOT NULL AND s.customer_number IS NULL) OR t.customer_name <> s.customer_name OR ( t.customer_name IS NULL AND s.customer_name IS NOT NULL) OR ( t.customer_name IS NOT NULL AND s.customer_name IS NULL) OR t.bdm_empid <> s.bdm_empid OR ( t.bdm_empid IS NULL AND s.bdm_empid IS NOT NULL) OR ( t.bdm_empid IS NOT NULL AND s.bdm_empid IS NULL) OR t.bdm <> s.bdm_name OR ( t.bdm IS NULL AND s.bdm_name IS NOT NULL) OR ( t.bdm IS NOT NULL AND s.bdm_name IS NULL) OR t.npg_manager_empid <> s.npg_emp_id OR ( t.npg_manager_empid IS NULL AND s.npg_emp_id IS NOT NULL) OR ( t.npg_manager_empid IS NOT NULL AND s.npg_emp_id IS NULL) OR t.npg_manager <> s.npg_manager OR ( t.npg_manager IS NULL AND s.npg_manager IS NOT NULL) OR ( t.npg_manager IS NOT NULL AND s.npg_manager IS NULL) OR t.npg_ops_mgr_empid <> s.npg_ops_mgr_empid OR ( t.npg_ops_mgr_empid IS NULL AND s.npg_ops_mgr_empid IS NOT NULL) OR ( t.npg_ops_mgr_empid IS NOT NULL AND s.npg_ops_mgr_empid IS NULL) OR t.npg_ops_manager <> s.npg_ops_manager OR ( t.npg_ops_manager IS NULL AND s.npg_ops_manager IS NOT NULL) OR ( t.npg_ops_manager IS NOT NULL AND s.npg_ops_manager IS NULL) OR t.sps_specialist_empid <> s.sps_empid OR ( t.sps_specialist_empid IS NULL AND s.sps_empid IS NOT NULL) OR ( t.sps_specialist_empid IS NOT NULL AND s.sps_empid IS NULL) OR t.sps_specialist <> s.sps OR ( t.sps_specialist IS NULL AND s.sps IS NOT NULL) OR ( t.sps_specialist IS NOT NULL AND s.sps IS NULL) OR t.vip_director_empid <> s.vip_empid OR ( t.vip_director_empid IS NULL AND s.vip_empid IS NOT NULL) OR ( t.vip_director_empid IS NOT NULL AND s.vip_empid IS NULL) OR t.vip_director <> s.vip OR ( t.vip_director IS NULL AND s.vip IS NOT NULL) OR ( t.vip_director IS NOT NULL AND s.vip IS NULL) OR t.client_success_leader_empid <> s.client_success_leader_empid OR ( t.client_success_leader_empid IS NULL AND s.client_success_leader_empid IS NOT NULL) OR ( t.client_success_leader_empid IS NOT NULL AND s.client_success_leader_empid IS NULL) OR t.client_success_leader <> s.client_success_leader OR ( t.client_success_leader IS NULL AND s.client_success_leader IS NOT NULL) OR ( t.client_success_leader IS NOT NULL AND s.client_success_leader IS NULL) ) AND t.modified_dt = ( SELECT max(modified_dt) FROM ${SNFLENTDB}.${SNFLSALSCH}.salesforceaccountownertracking WHERE id =s.id )\")\nresult = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount1\", int(result[0]))\n#      rowcount1 = rowcount1+int(result[0])\n      \nprint audit_rowcount\nprint audit_rowcount1\ncursor.execute(\"INSERT INTO ${SNFLKDB}.${SNFLKSCH}.AUDIT_METRICS (ROW_COUNT,START_DATE, END_DATE, JOB_ID, JOB_NAME, JOB_STATUS) select '%s' AS ROW_COUNT, '%s' AS START_DATE ,'%s' AS END_DATE ,'%s'  AS JOB_ID, '%s' as JOB_NAME ,'SUCCESS' AS JOB_STATUS\" % ((audit_rowcount+audit_rowcount1),Job_StartTimeStamp,Job_EndTimeStamp, run_history_id, job_name))"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6337951":{"id":6337951,"sourceID":6337980,"targetID":6337978},"6337983":{"id":6337983,"sourceID":6337981,"targetID":6337980}},"unconditionalConnectors":{"6337982":{"id":6337982,"sourceID":6337979,"targetID":6337981}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{"6338016":{"id":6338016,"sourceID":6337980,"targetID":6337977}},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_SalesForceAccountOwnerTracking","description":"","type":"ORCHESTRATION","tag":"292b4859-5d50-40c8-9518-45b7060c9a73"}}