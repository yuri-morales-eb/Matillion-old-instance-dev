{"job":{"components":{"6338009":{"id":6338009,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":448,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6338080],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Success"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6338010":{"id":6338010,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"ITERATE","implementationID":-158614544,"x":144,"y":-16,"width":32,"height":16,"inputConnectorIDs":[6338082],"outputSuccessConnectorIDs":[6338050],"outputFailureConnectorIDs":[6338085],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Retry"}}}},"visible":true},"2":{"slot":2,"name":"Number of Retries","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"9"}}}},"visible":true},"3":{"slot":3,"name":"Retry Delay","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Short delay with backoff"}}}},"visible":true},"4":{"slot":4,"name":"Retry Interval","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"1"}}}},"visible":false},"5":{"slot":5,"name":"Retry Time Unit","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Second"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[6338086],"inputIterationConnectorIDs":[]},"6338011":{"id":6338011,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":304,"y":-128,"width":32,"height":32,"inputConnectorIDs":[6338083],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6338084],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Failure"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_End"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"FAILURE"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"audit_rowcount"},"2":{"slot":2,"type":"STRING","value":"0"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6338012":{"id":6338012,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":-16,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6338081],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6338082],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Begin"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_Begin"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"RUNNING"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6338013":{"id":6338013,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":448,"y":-128,"width":32,"height":32,"inputConnectorIDs":[6338084],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6338014":{"id":6338014,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":144,"y":-128,"width":32,"height":32,"inputConnectorIDs":[6338085],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6338083],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6338015":{"id":6338015,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":304,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6338050],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6338080],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Success"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_End"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"SUCCESS"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"audit_rowcount"},"2":{"slot":2,"type":"STRING","value":"${RowCount}"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6338048":{"id":6338048,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-144,"y":-16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6338081],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6338049":{"id":6338049,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":144,"y":-16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SalesForceAccountTypeTracking_retry"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'jb_SalesForceAccountTypeTracking'\ncontext.updateVariable(\"Job_Name\",job_name)\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_EndTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute('''\n-- Check for the most recent data an either updates the previous record or inserts a new one\n-- When id and active_status match, for example, x for id and 'Y' and the other fields are different, that current record\n-- is updated and becomes old but we cannot insert the new one right away, that is done in the next merge.\n-- If values do not match, then it's simply an insert.\nMERGE INTO ${SNFLENTDB}.${SNFLFINSCH}.SalesForceAccountTypeTracking T\nUSING (\n\tSELECT DISTINCT ID, ACCOUNTNUMBER, NPG_ACCOUNT__C, VIP_ACCOUNT__C, VIP_ACCOUNT1__C, VMS_ACCOUNT__C, RETAIL_ACCOUNT__C, CASE WHEN (\n\t(\n\t\tNPG_ACCOUNT__C IS NULL\n\t\tAND VIP_ACCOUNT__C IS NULL\n\t\tAND VIP_ACCOUNT1__C IS NULL\n\t\tAND VMS_ACCOUNT__C IS NULL\n\t\tAND RETAIL_ACCOUNT__C IS NULL\n\t\t)\n\tOR (\n\t\tNPG_ACCOUNT__C = FALSE\n\t\tAND VIP_ACCOUNT__C = FALSE\n\t\tAND VIP_ACCOUNT1__C = FALSE\n\t\tAND VMS_ACCOUNT__C = FALSE\n\t\tAND RETAIL_ACCOUNT__C = FALSE\n\t\t)\n\t) THEN 'Prospect' \n\tELSE\n\tcase\n        when (NPG_ACCOUNT__C or VIP_ACCOUNT__C or VIP_ACCOUNT1__C or VMS_ACCOUNT__C)\n        then ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.account_type(array_construct(NPG_ACCOUNT__C, VIP_ACCOUNT__C, VIP_ACCOUNT1__C, VMS_ACCOUNT__C))\n        else 'RETAIL'\n        end\n\tEND AS ACCOUNT_TYPE__C, \n\tCASE \n\tWHEN dayname(CURRENT_DATE ()) = 'Sun' \n\tTHEN previous_day(CURRENT_DATE (), 'Monday') \n\tWHEN dayname(CURRENT_DATE ()) = 'Mon' \n\tTHEN previous_day(CURRENT_DATE (), 'Monday') \n\tELSE previous_day(DATEADD(week, - 1, CURRENT_DATE ()), 'Monday') \n\tEND AS EFFECTIVE_FROM, \n\tCASE \n\tWHEN dayname(CURRENT_DATE ()) = 'Sun' \n\tTHEN DATE (CURRENT_DATE ()) \n\tELSE previous_day(CURRENT_DATE (), 'Sunday') \n\tEND AS EFFECTIVE_TO, \n\t'Y' AS ACTIVE_STATUS, \n\tCURRENT_TIMESTAMP AS CREATED_DT, \n\tCURRENT_TIMESTAMP AS MODIFIED_DT\n\tFROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.ACCOUNT\n\t) S\n\tON T.ID = S.ID\n\t\tAND T.ACTIVE_STATUS = S.ACTIVE_STATUS\nWHEN MATCHED\n\tand (T.ACCOUNT is distinct from S.ACCOUNTNUMBER\n\tor T.NPG is distinct from S.NPG_ACCOUNT__C\n\tor T.VIP is distinct from S.VIP_ACCOUNT__C\n\tor T.VIP_PLUS is distinct from S.VIP_ACCOUNT1__C\n\tor T.VMS is distinct from S.VMS_ACCOUNT__C\n\tor T.RETAIL is distinct from S.RETAIL_ACCOUNT__C\n\tor T.ACCOUNT_TYPE is distinct from S.ACCOUNT_TYPE__C)\nTHEN\n\tUPDATE\n\tSET T.MODIFIED_DT = CURRENT_TIMESTAMP, \n\tT.MODIFIED_BY = CURRENT_USER(), \n\tT.ACTIVE_STATUS = 'N', \n\tT.effective_to = previous_day(\n\t\tCASE \n\t\tWHEN dayname(CURRENT_DATE ()) = 'Sun' \n\t\tTHEN previous_day(CURRENT_DATE (), 'Monday') \n\t\tWHEN dayname(CURRENT_DATE ()) = 'Mon' \n\t\tTHEN previous_day(CURRENT_DATE (), 'Monday') \n\t\tELSE previous_day(DATEADD(week, - 1, CURRENT_DATE ()), 'Monday') \n\t\tEND, 'Sunday')\nWHEN NOT MATCHED\n\tTHEN\n\t\tINSERT (ID, \n\t\tACCOUNT, \n\t\tNPG, \n\t\tVIP, \n\t\tVIP_PLUS, \n\t\tVMS, \n\t\tRETAIL, \n\t\tACCOUNT_TYPE, \n\t\tEFFECTIVE_FROM, \n\t\tEFFECTIVE_TO, \n\t\tACTIVE_STATUS, \n\t\tCREATED_DT, \n\t\tCREATED_BY, \n\t\tMODIFIED_DT, \n\t\tMODIFIED_BY)\n\t\tVALUES (S.ID, \n\t\tS.ACCOUNTNUMBER, \n\t\tS.NPG_ACCOUNT__C, \n\t\tS.VIP_ACCOUNT__C, \n\t\tS.VIP_ACCOUNT1__C, \n\t\tS.VMS_ACCOUNT__C, \n\t\tS.RETAIL_ACCOUNT__C, \n\t\tS.ACCOUNT_TYPE__C,  \n\t\tS.EFFECTIVE_FROM, \n\t\t'9999-12-31 00:00:00.000', \n\t\t'Y', \n\t\tCURRENT_TIMESTAMP, \n\t\tCURRENT_USER(), \n\t\tCURRENT_TIMESTAMP, \n\t\tCURRENT_USER())''')\n\ncursor.execute('''\n-- After previous merge, do another merge to insert the latest record for each id\n-- So, previously id and active_status match for x and 'Y'. The it's turned into x and 'N'. So now the x and 'Y' won't match which is the new record.\n-- Also, the entirely new records were already inserted, so there is no worries about duplicates.\nMERGE INTO ${SNFLENTDB}.${SNFLFINSCH}.SalesForceAccountTypeTracking T\nUSING (\n\tSELECT DISTINCT ID, ACCOUNTNUMBER, NPG_ACCOUNT__C, VIP_ACCOUNT__C, VIP_ACCOUNT1__C, VMS_ACCOUNT__C, RETAIL_ACCOUNT__C, CASE WHEN (\n\t(\n\t\tNPG_ACCOUNT__C IS NULL\n\t\tAND VIP_ACCOUNT__C IS NULL\n\t\tAND VIP_ACCOUNT1__C IS NULL\n\t\tAND VMS_ACCOUNT__C IS NULL\n\t\tAND RETAIL_ACCOUNT__C IS NULL\n\t\t)\n\tOR (\n\t\tNPG_ACCOUNT__C = FALSE\n\t\tAND VIP_ACCOUNT__C = FALSE\n\t\tAND VIP_ACCOUNT1__C = FALSE\n\t\tAND VMS_ACCOUNT__C = FALSE\n\t\tAND RETAIL_ACCOUNT__C = FALSE\n\t\t)\n\t) THEN 'Prospect' \n\tELSE\n\tcase\n        when (NPG_ACCOUNT__C or VIP_ACCOUNT__C or VIP_ACCOUNT1__C or VMS_ACCOUNT__C)\n        then ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.account_type(array_construct(NPG_ACCOUNT__C, VIP_ACCOUNT__C, VIP_ACCOUNT1__C, VMS_ACCOUNT__C))\n        else 'RETAIL'\n        end\n\tEND AS ACCOUNT_TYPE__C, \n\tCASE \n\tWHEN dayname(CURRENT_DATE ()) = 'Sun' \n\tTHEN previous_day(CURRENT_DATE (), 'Monday') \n\tWHEN dayname(CURRENT_DATE ()) = 'Mon' \n\tTHEN previous_day(CURRENT_DATE (), 'Monday') \n\tELSE previous_day(DATEADD(week, - 1, CURRENT_DATE ()), 'Monday') \n\tEND AS EFFECTIVE_FROM, \n\tCASE \n\tWHEN dayname(CURRENT_DATE ()) = 'Sun' \n\tTHEN DATE (CURRENT_DATE ()) \n\tELSE previous_day(CURRENT_DATE (), 'Sunday') \n\tEND AS EFFECTIVE_TO, \n\t'Y' AS ACTIVE_STATUS, \n\tCURRENT_TIMESTAMP AS CREATED_DT, \n\tCURRENT_TIMESTAMP AS MODIFIED_DT\n\tFROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_SALESFORCE}.ACCOUNT\n\t) S\n\tON T.ID = S.ID\n\t\tAND T.ACTIVE_STATUS = S.ACTIVE_STATUS\nWHEN NOT MATCHED\n\tTHEN\n\t\tINSERT (ID, \n\t\tACCOUNT, \n\t\tNPG, \n\t\tVIP, \n\t\tVIP_PLUS, \n\t\tVMS, \n\t\tRETAIL, \n\t\tACCOUNT_TYPE, \n\t\tEFFECTIVE_FROM, \n\t\tEFFECTIVE_TO, \n\t\tACTIVE_STATUS, \n\t\tCREATED_DT, \n\t\tCREATED_BY, \n\t\tMODIFIED_DT, \n\t\tMODIFIED_BY)\n\t\tVALUES (S.ID, \n\t\tS.ACCOUNTNUMBER, \n\t\tS.NPG_ACCOUNT__C, \n\t\tS.VIP_ACCOUNT__C, \n\t\tS.VIP_ACCOUNT1__C, \n\t\tS.VMS_ACCOUNT__C, \n\t\tS.RETAIL_ACCOUNT__C, \n\t\tS.ACCOUNT_TYPE__C, \n\t\tS.EFFECTIVE_FROM, \n\t\t'9999-12-31 00:00:00.000', \n\t\t'Y', \n\t\tCURRENT_TIMESTAMP, \n\t\tCURRENT_USER(), \n\t\tCURRENT_TIMESTAMP, \n\t\tCURRENT_USER());''')\nresult = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount\", int(result[0]))\ncontext.updateVariable(\"RowCount\", audit_rowcount)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[6338086]}},"successConnectors":{"6338050":{"id":6338050,"sourceID":6338010,"targetID":6338015}},"failureConnectors":{"6338085":{"id":6338085,"sourceID":6338010,"targetID":6338014}},"unconditionalConnectors":{"6338080":{"id":6338080,"sourceID":6338015,"targetID":6338009},"6338081":{"id":6338081,"sourceID":6338048,"targetID":6338012},"6338082":{"id":6338082,"sourceID":6338012,"targetID":6338010},"6338083":{"id":6338083,"sourceID":6338014,"targetID":6338011},"6338084":{"id":6338084,"sourceID":6338011,"targetID":6338013}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{"6338086":{"id":6338086,"sourceID":6338010,"targetID":6338049}},"noteConnectors":{},"notes":{},"variables":{"RowCount":{"definition":{"name":"RowCount","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"0"}},"grids":{}},"info":{"name":"jb_SalesForceAccountTypeTracking","description":"","type":"ORCHESTRATION","tag":"1c0b9e73-4c7a-4ee2-bc9b-2c4d1b8c7dc7"}}