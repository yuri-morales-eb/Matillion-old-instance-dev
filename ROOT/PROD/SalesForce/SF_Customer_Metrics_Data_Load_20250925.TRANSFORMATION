{"job":{"components":{"6338034":{"id":6338034,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-1136,"y":-16,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6338036],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"src_SF_CUSTOMER_METRICS"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH YTD_STG AS\n  (SELECT DISTINCT TSF.CUSTOMER_NUMBER AS CLIENT_ACCOUNT_NUMBER,\n                   TSF.CUSTOMER_NAME AS CLIENT_ACCOUNT_NAME,\n                   SFD.ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID,\n                   FEES,\n                   REVENUE,\n                   COST,\n                   TDF.CONVERTED_HOURS_BILLED,\n                   TSF.MAX_POSTING_DATE\n   FROM\n     (\n\t SELECT TSF.CUSTOMER_NUMBER,\n             TSF.CUSTOMER_NAME,\n             TSF.EMPLOYEE_NUMBER,\n             TSF.POSTING_DATE_KEY,\n             TSF.TRAN_DATE_KEY,\n             SUM(TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) \n\t\t\t OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS FEES,\n     SUM(TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV \n\t\t+ TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS REVENUE,\n\tSUM(TSF.TEMP_WAGE + TSF.SUB_CONTCOST + TSF.FICA + TSF.FUTA + TSF.SUTA + TSF.WC \n\t\t+ TSF.WC_MEDICAL + TSF.INSURANCE + TSF.BENEFIT \n\t\t+ TSF.VACATION + TSF.HOLIDAY + TSF.K401 + TSF.OTHER_COST + TSF.FLD_EMPTEST \n\t\t+ TSF.COM_DATA + TSF.ACA_COST + TSF.SICK_PAY_COST + TSF.LOCAL_TAX) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS COST,\n       MAX(TSF.POSTING_DATE) OVER(PARTITION BY TSF.CUSTOMER_NUMBER) AS MAX_POSTING_DATE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   \n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n      FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n      INNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n      WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n        AND DT.DW_ACTIVE_FLAG = 'Y' AND DT.FISCAL_YEAR = YEAR(CURRENT_DATE())\n ) TSF\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" SFD ON TSF.CUSTOMER_NUMBER = SFD.ACCOUNT_NUMBER\n   INNER JOIN\n     (SELECT CUSTOMER_NUMBER,\n             SUM(BILLABLE_UNIT) - SUM(CASE\n                                          WHEN GL_ACCOUNT = 5800 THEN BILLABLE_UNIT\n                                          ELSE 0\n                                      END) CONVERTED_HOURS_BILLED\n      FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_DETAIL_FACT\" TSF\n      JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n      WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n        AND DT.DW_ACTIVE_FLAG = 'Y'\n        AND DT.FISCAL_YEAR = YEAR(CURRENT_DATE())\n      GROUP BY CUSTOMER_NUMBER) TDF ON TSF.CUSTOMER_NUMBER = TDF.CUSTOMER_NUMBER\n   WHERE SFD.DW_ACTIVE_FLAG = 'Y' ), \n   \n   YTD AS (\n   \n   \n   \n   select   ACCOUNT_NUMBER as CLIENT_ACCOUNT_NUMBER, NAME as CLIENT_ACCOUNT_NAME, \n            ACCOUNT_ID as SALESFORCE_ACCOUNT_ID\n            , CASE WHEN CTE.FEES is null then 0 else CTE.FEES end  as FEES_YTD\n            , CASE WHEN CTE.REVENUE is null then 0 else CTE.REVENUE end as REVENUE\n            , CASE WHEN CTE.COST is null then 0 else CTE.COST end as COST\n            , CASE WHEN CTE.CONVERTED_HOURS_BILLED is null then 0 else CTE.CONVERTED_HOURS_BILLED end as CONVERTED_HOURS_BILLED\n            , CASE \tWHEN CTE.MAX_POSTING_DATE is null \n\t\t\t\t\tthen \n\t\t\t\t\t\tMAX(TSF.POSTING_DATE) OVER(PARTITION BY TSF.CUSTOMER_NUMBER) \n\t\t\t\t\telse \n\t\t\t\t\t\tCTE.MAX_POSTING_DATE end as MAX_POSTING_DATE\n    from \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" DIM\n   LEFT JOIN    \"PROD_EDW\".\"ENT\".\"INVOICE_SUMMARY_FACT\" TSF\n   ON       \t ltrim(rtrim(TSF.CUSTOMER_NUMBER)) = ltrim(rtrim(DIM.ACCOUNT_NUMBER))\n   INNER JOIN \t\"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n   AND  \t\tTSF.DW_ACTIVE_FLAG = 'Y'\n   AND \t\t\tDT.DW_ACTIVE_FLAG = 'Y'\n   \n   LEFT JOIN \n            ( \n              select CLIENT_ACCOUNT_NUMBER,\n                      CLIENT_ACCOUNT_NAME,\n                      SALESFORCE_ACCOUNT_ID,\n                        FEES,\n                        REVENUE, \n                        COST, \n                        CONVERTED_HOURS_BILLED, \n                        MAX_POSTING_DATE\n              from  YTD_STG\n            \n           ) CTE\n            ON CTE.CLIENT_ACCOUNT_NUMBER = DIM.ACCOUNT_NUMBER\n       where    DIM.DW_ACTIVE_FLAG = 'Y' AND ACCOUNT_NUMBER IS NOT NULL\n     )\n\n\n, PRR_STG AS (\n  SELECT DISTINCT TSF.CUSTOMER_NUMBER AS CLIENT_ACCOUNT_NUMBER,\n                   TSF.CUSTOMER_NAME AS CLIENT_ACCOUNT_NAME,\n                   SFD.ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID,\n                   FEES,\n                   REVENUE,\n                   COST,\n                   TDF.CONVERTED_HOURS_BILLED\n   FROM\n     (SELECT TSF.CUSTOMER_NUMBER,\n             TSF.CUSTOMER_NAME,\n             TSF.EMPLOYEE_NUMBER,\n             TSF.POSTING_DATE_KEY,\n             TSF.TRAN_DATE_KEY,\n             SUM(TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS FEES,\n              SUM(TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV +\n                  TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS REVENUE,\n                                                                                                                                                                                                                         SUM(TSF.TEMP_WAGE + TSF.SUB_CONTCOST + TSF.FICA + TSF.FUTA + TSF.SUTA + TSF.WC + TSF.WC_MEDICAL + TSF.INSURANCE + TSF.BENEFIT + TSF.VACATION + TSF.HOLIDAY + TSF.K401 + TSF.OTHER_COST + TSF.FLD_EMPTEST + TSF.COM_DATA + TSF.ACA_COST + TSF.SICK_PAY_COST + TSF.LOCAL_TAX) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS COST\n      FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n      INNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n      WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n        AND DT.DW_ACTIVE_FLAG = 'Y' AND DT.FISCAL_YEAR = YEAR(CURRENT_DATE())-1\n ) TSF\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" SFD ON TSF.CUSTOMER_NUMBER = SFD.ACCOUNT_NUMBER\n   INNER JOIN\n     (SELECT CUSTOMER_NUMBER,\n             SUM(BILLABLE_UNIT) - SUM(CASE\n                                          WHEN GL_ACCOUNT = 5800 THEN BILLABLE_UNIT\n                                          ELSE 0\n                                      END) CONVERTED_HOURS_BILLED\n      FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_DETAIL_FACT\" TSF\n      JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n      WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n        AND DT.DW_ACTIVE_FLAG = 'Y'  AND DT.FISCAL_YEAR = YEAR(CURRENT_DATE())-1\n\n      GROUP BY CUSTOMER_NUMBER) TDF ON TSF.CUSTOMER_NUMBER = TDF.CUSTOMER_NUMBER\n   WHERE SFD.DW_ACTIVE_FLAG = 'Y' )\n   \n , PRR AS (  select   ACCOUNT_NUMBER as CLIENT_ACCOUNT_NUMBER, NAME as CLIENT_ACCOUNT_NAME, \n            ACCOUNT_ID as SALESFORCE_ACCOUNT_ID\n            , CASE WHEN CTE.FEES is null then 0 else CTE.FEES end  as FEES_YTD\n            , CASE WHEN CTE.REVENUE is null then 0 else CTE.REVENUE end as REVENUE\n            , CASE WHEN CTE.COST is null then 0 else CTE.COST end as COST\n            , CASE WHEN CTE.CONVERTED_HOURS_BILLED is null then 0 else CTE.CONVERTED_HOURS_BILLED end as CONVERTED_HOURS_BILLED\n           -- , CASE WHEN CTE.MAX_POSTING_DATE is null then null else CTE.MAX_POSTING_DATE end as MAX_POSTING_DATE\n   from     \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" DIM\n   \n   LEFT JOIN \n            ( \n              select CLIENT_ACCOUNT_NUMBER,\n                      CLIENT_ACCOUNT_NAME,\n                      SALESFORCE_ACCOUNT_ID,\n                        FEES,\n                        REVENUE, \n                        COST, \n                        CONVERTED_HOURS_BILLED\n                        \n              from  PRR_STG\n            \n           ) CTE\n            ON CTE.CLIENT_ACCOUNT_NUMBER = DIM.ACCOUNT_NUMBER\n       where    DIM.DW_ACTIVE_FLAG = 'Y' AND ACCOUNT_NUMBER IS NOT NULL\n  ),\n     LFT AS\n  (SELECT DISTINCT TSF.CUSTOMER_NUMBER AS CLIENT_ACCOUNT_NUMBER,\n                   SFD.ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID,\n                   REVENUE\n   FROM\n     (SELECT TSF.CUSTOMER_NUMBER,\n             TSF.CUSTOMER_NAME,\n             SUM(TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS REVENUE\n      FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n      INNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n      WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n        AND DT.DW_ACTIVE_FLAG = 'Y') TSF\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" SFD ON TSF.CUSTOMER_NUMBER = SFD.ACCOUNT_NUMBER\n   WHERE SFD.DW_ACTIVE_FLAG = 'Y' ),\n     MIN_PST_DT AS\n  (SELECT DISTINCT TSF.CUSTOMER_NUMBER AS CLIENT_ACCOUNT_NUMBER,\n                   SFD.ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID,\n                   MIN(TSF.POSTING_DATE) OVER(PARTITION BY TSF.CUSTOMER_NUMBER) AS MIN_POSTING_DATE\n   FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" SFD ON TSF.CUSTOMER_NUMBER = SFD.ACCOUNT_NUMBER\n   WHERE SFD.DW_ACTIVE_FLAG = 'Y'\n     AND TSF.DW_ACTIVE_FLAG = 'Y'\n     AND DT.DW_ACTIVE_FLAG = 'Y'\n     AND (TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) > 0),\n     SND AS\n  (SELECT DATE, SUNNORM_POSTING_DATE\n   FROM \"PROD_EDW\".\"ENT\".\"DATE_DIM\"),\n     APY AS\n  (SELECT CUSTOMER_NUMBER,\n          COUNT(DISTINCT EMPLOYEE_NUMBER) AOA_PAID_YTD\n   FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n   AND TSF.TRAN_DATE_KEY = DT.DATE_KEY\n   WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n     AND DT.DW_ACTIVE_FLAG = 'Y'  AND DT.FISCAL_YEAR = YEAR(CURRENT_DATE())\n\n     AND TEMP_WAGE > 0\n   GROUP BY CUSTOMER_NUMBER),\n     APP AS\n  (SELECT CUSTOMER_NUMBER,\n          COUNT(DISTINCT EMPLOYEE_NUMBER) AOA_PAID_PRIOR_YEAR\n   FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n   AND TSF.TRAN_DATE_KEY = DT.DATE_KEY\n   WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n     AND DT.DW_ACTIVE_FLAG = 'Y'\n     AND DT.FISCAL_YEAR = YEAR(CURRENT_DATE())-1\n     AND TEMP_WAGE > 0\n   GROUP BY CUSTOMER_NUMBER),\n     ABY AS\n  (SELECT CUSTOMER_NUMBER,\n          COUNT(DISTINCT EMPLOYEE_NUMBER) AOA_BILLED_YTD\n   FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n   AND TSF.TRAN_DATE_KEY = DT.DATE_KEY\n   WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n     AND DT.DW_ACTIVE_FLAG = 'Y' AND DT.FISCAL_YEAR = YEAR(CURRENT_DATE())\n\n     AND TSF.TEMP_BILLING IS NOT NULL --AND (TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) > 0\n\n   GROUP BY CUSTOMER_NUMBER),\n     ABP AS\n  (SELECT CUSTOMER_NUMBER,\n          COUNT(DISTINCT EMPLOYEE_NUMBER) AOA_BILLED_PRIOR_YEAR\n   FROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n   INNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n   AND TSF.TRAN_DATE_KEY = DT.DATE_KEY\n   WHERE TSF.DW_ACTIVE_FLAG = 'Y'\n     AND DT.DW_ACTIVE_FLAG = 'Y' AND DT.FISCAL_YEAR = YEAR(CURRENT_DATE())-1\n\n     AND (TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) > 0\n   GROUP BY CUSTOMER_NUMBER)\n, CTE_RESULT AS (SELECT DISTINCT YTD.CLIENT_ACCOUNT_NUMBER,\n       YTD.CLIENT_ACCOUNT_NAME,\n       YTD.SALESFORCE_ACCOUNT_ID,\n       YTD.FEES_YTD,\n       PRR.FEES_YTD AS FEES_PRIOR_YEAR,\n       YTD.REVENUE AS REVENUE_YTD,\n       PRR.REVENUE AS REVENUE_PRIOR_YEAR,\n       LFT.REVENUE AS REVENUE_LIFETIME_TO_DATE,\n       YTD.REVENUE - YTD.COST AS GROSS_MARGIN_YTD,\n       PRR.REVENUE - PRR.COST AS GROSS_MARGIN_PRIOR_YEAR,\n       CASE\n           WHEN YTD.REVENUE > 0 THEN ROUND((YTD.REVENUE - YTD.COST)/YTD.REVENUE, 2)\n           ELSE 0\n       END AS \"GM%_YTD\",\n       CASE\n           WHEN PRR.REVENUE > 0 THEN ROUND((PRR.REVENUE - PRR.COST)/PRR.REVENUE, 2)\n           ELSE 0\n       END AS \"GM%_PRIOR_YEAR\",\n       YTD.CONVERTED_HOURS_BILLED AS CONVERTED_HOURS_BILLED_YTD,\n       PRR.CONVERTED_HOURS_BILLED AS CONVERTED_HOURS_BILLED_LAST_YEAR,\n       SND1.SUNNORM_POSTING_DATE AS FIRST_BILLED_DATE,\n       SND2.SUNNORM_POSTING_DATE AS LAST_BILLED_DATE,\n       NVL(APP.AOA_PAID_PRIOR_YEAR, 0) AS AOA_PAID_PRIOR_YEAR,\n       NVL(APY.AOA_PAID_YTD, 0) AS AOA_PAID_YTD,\n       NVL(ABP.AOA_BILLED_PRIOR_YEAR, 0) AS AOA_BILLED_PRIOR_YEAR,\n       NVL(ABY.AOA_BILLED_YTD, 0) AS AOA_BILLED_YTD,\n       AR_INFO.AR_BALANCE,\n       AR_INFO.PAST_DUE\nFROM YTD -- year till date \nLEFT JOIN PRR ON YTD.CLIENT_ACCOUNT_NUMBER = PRR.CLIENT_ACCOUNT_NUMBER -- prior year date \nAND YTD.SALESFORCE_ACCOUNT_ID = PRR.SALESFORCE_ACCOUNT_ID\nLEFT JOIN LFT ON YTD.CLIENT_ACCOUNT_NUMBER = LFT.CLIENT_ACCOUNT_NUMBER\nAND YTD.SALESFORCE_ACCOUNT_ID = LFT.SALESFORCE_ACCOUNT_ID\nLEFT JOIN MIN_PST_DT ON YTD.CLIENT_ACCOUNT_NUMBER = MIN_PST_DT.CLIENT_ACCOUNT_NUMBER\nAND YTD.SALESFORCE_ACCOUNT_ID = MIN_PST_DT.SALESFORCE_ACCOUNT_ID\nLEFT JOIN SND SND1 ON MIN_PST_DT.MIN_POSTING_DATE = SND1.DATE\nLEFT JOIN SND SND2 ON YTD.MAX_POSTING_DATE = SND2.DATE\nLEFT JOIN APY ON YTD.CLIENT_ACCOUNT_NUMBER = APY.CUSTOMER_NUMBER\nLEFT JOIN APP ON YTD.CLIENT_ACCOUNT_NUMBER = APP.CUSTOMER_NUMBER\nLEFT JOIN ABY ON YTD.CLIENT_ACCOUNT_NUMBER = ABY.CUSTOMER_NUMBER\nLEFT JOIN ABP ON YTD.CLIENT_ACCOUNT_NUMBER = ABP.CUSTOMER_NUMBER\nLEFT JOIN\n  (SELECT CUSTOMER,\n          SUM(TRAN_AMT) AS AR_BALANCE,\n          SUM(OPEN_AMT) AS PAST_DUE\n   FROM\n     (SELECT BASE_QRY.CUSTOMER,\n             TRAN_AMT,\n             CASE\n                 WHEN CUST_AGING_INFO.TERMS_CD = 'DUR'\n                      AND AGE_DAYS > 0 THEN OPEN_AMT\n                 WHEN CUST_AGING_INFO.TERMS_CD <> 'DUR'\n                      AND AGE_DAYS > SUBSTR(CUST_AGING_INFO.TERMS_CD, 2, LENGTH(CUST_AGING_INFO.TERMS_CD)) THEN OPEN_AMT\n                 ELSE 0\n             END AS OPEN_AMT\n      FROM\n        (SELECT *,\n                CASE\n                    WHEN TRANS_TYPE <> 'P' THEN DATEDIFF(DAY, TRANS_DATE, CURRENT_DATE())\n                    ELSE 0\n                END AS AGE_DAYS\n         FROM  ${SNFLENTDB}.${SNFLSALSCH}.\"VW_CUST_AGING_PAST_DUE_INVOICE\"  \n         UNION ALL SELECT *,\n                          CASE\n                              WHEN TRANS_TYPE <> 'P' THEN DATEDIFF(DAY, TRANS_DATE, CURRENT_DATE())\n                              ELSE 0\n                          END AS AGE_DAYS\n         FROM   ${SNFLENTDB}.${SNFLSALSCH}.VW_CUST_AGING_UNAPPLIED_CASH_PYMNT \n\t\t ) BASE_QRY\n      INNER JOIN\n        (SELECT DISTINCT ARCOMP.COMPANY,\n                         ARCUSTOMER.CUSTOMER,\n                         ARCUSTOMER.TERMS_CD\n         FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER AS ARCUSTOMER\n         LEFT OUTER JOIN PROD_DATALAKE.LAWPROD.ARCUSTFLDS AS ARCUSTFLDS ON ARCUSTOMER.COMPANY = ARCUSTFLDS.COMPANY\n         AND ARCUSTOMER.CUSTOMER = ARCUSTFLDS.CUSTOMER\n         INNER JOIN PROD_DATALAKE.LAWPROD.ARCOMP AS ARCOMP ON ARCUSTOMER.COMPANY = ARCOMP.COMPANY\n         INNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTGRP AS ARCUSTGRP ON ARCOMP.CUST_GROUP = ARCUSTGRP.CUST_GROUP\n         INNER JOIN PROD_DATALAKE.LAWPROD.CUSTDESC AS CUSTDESC ON ARCUSTGRP.CUST_GROUP = CUSTDESC.CUST_GROUP\n         AND ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER\n         INNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTOMER AS SUMCUST ON ARCUSTOMER.COMPANY = SUMCUST.COMPANY\n         AND ARCUSTOMER.CUSTOMER = SUMCUST.CUSTOMER) CUST_AGING_INFO ON CUST_AGING_INFO.COMPANY = BASE_QRY.COMPANY\n      AND CUST_AGING_INFO.CUSTOMER = BASE_QRY.CUSTOMER\n      WHERE (BASE_QRY.OPEN_AMT > 0\n             OR BASE_QRY.OPEN_AMT < 0) )\n   GROUP BY CUSTOMER) AR_INFO ON TRIM(YTD.CLIENT_ACCOUNT_NUMBER) = TRIM(AR_INFO.CUSTOMER)\n   ), CTE_RESULT_PRR AS (SELECT DISTINCT PRR.CLIENT_ACCOUNT_NUMBER,\n       PRR.CLIENT_ACCOUNT_NAME,\n       PRR.SALESFORCE_ACCOUNT_ID,\n       PRR.FEES_YTD,\n       YTD.FEES_YTD AS FEES_PRIOR_YEAR,\n       PRR.REVENUE AS REVENUE_YTD,\n       YTD.REVENUE AS REVENUE_PRIOR_YEAR,\n       LFT.REVENUE AS REVENUE_LIFETIME_TO_DATE,\n       0 AS GROSS_MARGIN_YTD,\n       PRR.REVENUE - PRR.COST AS GROSS_MARGIN_PRIOR_YEAR,\n\t   0 as  \"GM%_YTD\",\n        CASE\n           WHEN PRR.REVENUE > 0 THEN ROUND((PRR.REVENUE - PRR.COST)/PRR.REVENUE, 2)\n           ELSE 0\n       END AS   \"GM%_PRIOR_YEAR\",\n       PRR.CONVERTED_HOURS_BILLED AS CONVERTED_HOURS_BILLED_YTD,\n       YTD.CONVERTED_HOURS_BILLED AS CONVERTED_HOURS_BILLED_LAST_YEAR,\n       SND1.SUNNORM_POSTING_DATE AS FIRST_BILLED_DATE,\n       SND2.SUNNORM_POSTING_DATE AS LAST_BILLED_DATE,\n       NVL(APP.AOA_PAID_PRIOR_YEAR, 0) AS AOA_PAID_PRIOR_YEAR,\n       NVL(APY.AOA_PAID_YTD, 0) AS AOA_PAID_YTD,\n       NVL(ABP.AOA_BILLED_PRIOR_YEAR, 0) AS AOA_BILLED_PRIOR_YEAR,\n       NVL(ABY.AOA_BILLED_YTD, 0) AS AOA_BILLED_YTD,\n       AR_INFO.AR_BALANCE,\n       AR_INFO.PAST_DUE\nFROM PRR  -- year till date \nLEFT JOIN  YTD ON YTD.CLIENT_ACCOUNT_NUMBER = PRR.CLIENT_ACCOUNT_NUMBER -- prior year date \nAND YTD.SALESFORCE_ACCOUNT_ID = PRR.SALESFORCE_ACCOUNT_ID\nLEFT JOIN LFT ON YTD.CLIENT_ACCOUNT_NUMBER = LFT.CLIENT_ACCOUNT_NUMBER\nAND YTD.SALESFORCE_ACCOUNT_ID = LFT.SALESFORCE_ACCOUNT_ID\nLEFT JOIN MIN_PST_DT ON YTD.CLIENT_ACCOUNT_NUMBER = MIN_PST_DT.CLIENT_ACCOUNT_NUMBER\nAND YTD.SALESFORCE_ACCOUNT_ID = MIN_PST_DT.SALESFORCE_ACCOUNT_ID\nLEFT JOIN SND SND1 ON MIN_PST_DT.MIN_POSTING_DATE = SND1.DATE\nLEFT JOIN SND SND2 ON YTD.MAX_POSTING_DATE = SND2.DATE\nLEFT JOIN APY ON YTD.CLIENT_ACCOUNT_NUMBER = APY.CUSTOMER_NUMBER\nLEFT JOIN APP ON YTD.CLIENT_ACCOUNT_NUMBER = APP.CUSTOMER_NUMBER\nLEFT JOIN ABY ON YTD.CLIENT_ACCOUNT_NUMBER = ABY.CUSTOMER_NUMBER\nLEFT JOIN ABP ON YTD.CLIENT_ACCOUNT_NUMBER = ABP.CUSTOMER_NUMBER\nLEFT JOIN\n  (SELECT CUSTOMER,\n          SUM(TRAN_AMT) AS AR_BALANCE,\n          SUM(OPEN_AMT) AS PAST_DUE\n   FROM\n     (SELECT BASE_QRY.CUSTOMER,\n             TRAN_AMT,\n             CASE\n                 WHEN CUST_AGING_INFO.TERMS_CD = 'DUR'\n                      AND AGE_DAYS > 0 THEN OPEN_AMT\n                 WHEN CUST_AGING_INFO.TERMS_CD <> 'DUR'\n                      AND AGE_DAYS > SUBSTR(CUST_AGING_INFO.TERMS_CD, 2, LENGTH(CUST_AGING_INFO.TERMS_CD)) THEN OPEN_AMT\n                 ELSE 0\n             END AS OPEN_AMT\n      FROM\n        (SELECT *,\n                CASE\n                    WHEN TRANS_TYPE <> 'P' THEN DATEDIFF(DAY, TRANS_DATE, CURRENT_DATE())\n                    ELSE 0\n                END AS AGE_DAYS\n         FROM \"PROD_ENTERPRISE\".\"SALES\".\"VW_CUST_AGING_PAST_DUE_INVOICE\"\n         UNION ALL SELECT *,\n                          CASE\n                              WHEN TRANS_TYPE <> 'P' THEN DATEDIFF(DAY, TRANS_DATE, CURRENT_DATE())\n                              ELSE 0\n                          END AS AGE_DAYS\n         FROM \"PROD_ENTERPRISE\".\"SALES\".VW_CUST_AGING_UNAPPLIED_CASH_PYMNT) BASE_QRY\n      INNER JOIN\n        (SELECT DISTINCT ARCOMP.COMPANY,\n                         ARCUSTOMER.CUSTOMER,\n                         ARCUSTOMER.TERMS_CD\n         FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER AS ARCUSTOMER\n         LEFT OUTER JOIN PROD_DATALAKE.LAWPROD.ARCUSTFLDS AS ARCUSTFLDS ON ARCUSTOMER.COMPANY = ARCUSTFLDS.COMPANY\n         AND ARCUSTOMER.CUSTOMER = ARCUSTFLDS.CUSTOMER\n         INNER JOIN PROD_DATALAKE.LAWPROD.ARCOMP AS ARCOMP ON ARCUSTOMER.COMPANY = ARCOMP.COMPANY\n         INNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTGRP AS ARCUSTGRP ON ARCOMP.CUST_GROUP = ARCUSTGRP.CUST_GROUP\n         INNER JOIN PROD_DATALAKE.LAWPROD.CUSTDESC AS CUSTDESC ON ARCUSTGRP.CUST_GROUP = CUSTDESC.CUST_GROUP\n         AND ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER\n         INNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTOMER AS SUMCUST ON ARCUSTOMER.COMPANY = SUMCUST.COMPANY\n         AND ARCUSTOMER.CUSTOMER = SUMCUST.CUSTOMER) CUST_AGING_INFO ON CUST_AGING_INFO.COMPANY = BASE_QRY.COMPANY\n      AND CUST_AGING_INFO.CUSTOMER = BASE_QRY.CUSTOMER\n      WHERE (BASE_QRY.OPEN_AMT > 0\n             OR BASE_QRY.OPEN_AMT < 0) )\n   GROUP BY CUSTOMER) AR_INFO ON TRIM(YTD.CLIENT_ACCOUNT_NUMBER) = TRIM(AR_INFO.CUSTOMER)\n   ), CTE_FINAL AS \n   \n  ( select \t*\n   from \tCTE_RESULT\n   union \n   select   *\n   from     CTE_RESULT_PRR WHERE CLIENT_ACCOUNT_NUMBER IN \n   (SELECT DISTINCT CLIENT_ACCOUNT_NUMBER\n    FROM CTE_RESULT_PRR\n    EXCEPT \n    SELECT DISTINCT CLIENT_ACCOUNT_NUMBER\n    FROM CTE_RESULT\n   ))\n , CTE_FIRST_BILL_DT_NULL as (\n  SELECT *\n  FROM   CTE_FINAL --55518 \n  where   FIRST_BILLED_DATE is null and LAST_BILLED_DATE is not null\n ), CTE_FINAL_RESULT AS (\n  SELECT distinct CTE.CLIENT_ACCOUNT_NUMBER,\n        CTE.CLIENT_ACCOUNT_NAME,\n        CTE.SALESFORCE_ACCOUNT_ID,\n        CTE.FEES_YTD,FEES_PRIOR_YEAR,\n        CTE.REVENUE_YTD,\n        CTE.REVENUE_PRIOR_YEAR,\n        CTE.REVENUE_LIFETIME_TO_DATE,\n        CTE.GROSS_MARGIN_YTD,\n        CTE.GROSS_MARGIN_PRIOR_YEAR,\n        CTE.\"GM%_YTD\" as GM_YTD,\n        CTE.\"GM%_PRIOR_YEAR\" as GM_PRIOR_YEAR,\n        CTE.CONVERTED_HOURS_BILLED_YTD,\n        CTE.CONVERTED_HOURS_BILLED_LAST_YEAR,\n        MIN(TSF.POSTING_DATE) OVER(PARTITION BY TSF.CUSTOMER_NUMBER) AS FIRST_BILLED_DATE,\n        --CTE.FIRST_BILLED_DATE,\n        CTE.LAST_BILLED_DATE,\n        CTE.AOA_PAID_PRIOR_YEAR,\n        CTE.AOA_PAID_YTD,\n        CTE.AOA_BILLED_PRIOR_YEAR,\n        CTE.AOA_BILLED_YTD,\n        CTE.AR_BALANCE,\n        CTE.PAST_DUE\n  FROM   CTE_FIRST_BILL_DT_NULL CTE\n  LEFT JOIN \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n  ON TSF.CUSTOMER_NUMBER = CTE.CLIENT_ACCOUNT_NUMBER\n  union \n   SELECT * \n   from \n    (\n    SELECT *\n    FROM   CTE_FINAL\n     EXCEPT\n      SELECT *\n      FROM   CTE_FINAL --55518 \n      where   FIRST_BILLED_DATE is null and LAST_BILLED_DATE is not null\n     )\n   )\n    \n    select  *\n    from    CTE_FINAL_RESULT \n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6338035":{"id":6338035,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":-864,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6338036],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"TARGET"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SALESFORCE_CUSTOMER_METRICS"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CLIENT_ACCOUNT_NUMBER"},"2":{"slot":2,"type":"STRING","value":"CLIENT_ACCOUNT_NUMBER"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"CLIENT_ACCOUNT_NAME"},"2":{"slot":2,"type":"STRING","value":"CLIENT_ACCOUNT_NAME"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"SALESFORCE_ACCOUNT_ID"},"2":{"slot":2,"type":"STRING","value":"SALESFORCE_ACCOUNT_ID"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"FEES_YTD"},"2":{"slot":2,"type":"STRING","value":"FEES_YTD"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"FEES_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"FEES_PRIOR_YEAR"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"REVENUE_YTD"},"2":{"slot":2,"type":"STRING","value":"REVENUE_YTD"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"REVENUE_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"REVENUE_PRIOR_YEAR"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"REVENUE_LIFETIME_TO_DATE"},"2":{"slot":2,"type":"STRING","value":"REVENUE_LIFETIME_TO_DATE"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"GROSS_MARGIN_YTD"},"2":{"slot":2,"type":"STRING","value":"GROSS_MARGIN_YTD"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"GROSS_MARGIN_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"GROSS_MARGIN_PRIOR_YEAR"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"GM_YTD"},"2":{"slot":2,"type":"STRING","value":"GM_PERCENT_YTD"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"GM_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"GM_PERCENT_PRIOR_YEAR"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"CONVERTED_HOURS_BILLED_YTD"},"2":{"slot":2,"type":"STRING","value":"CONVERTED_HOURS_BILLED_YTD"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"CONVERTED_HOURS_BILLED_LAST_YEAR"},"2":{"slot":2,"type":"STRING","value":"CONVERTED_HOURS_BILLED_LAST_YEAR"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"FIRST_BILLED_DATE"},"2":{"slot":2,"type":"STRING","value":"FIRST_BILLED_DATE"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"LAST_BILLED_DATE"},"2":{"slot":2,"type":"STRING","value":"LAST_BILLED_DATE"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"AOA_PAID_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"AOA_PAID_PRIOR_YEAR"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"AOA_PAID_YTD"},"2":{"slot":2,"type":"STRING","value":"AOA_PAID_YTD"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"AOA_BILLED_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"AOA_BILLED_PRIOR_YEAR"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"AOA_BILLED_YTD"},"2":{"slot":2,"type":"STRING","value":"AOA_BILLED_YTD"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"AR_BALANCE"},"2":{"slot":2,"type":"STRING","value":"AR_BALANCE"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"PAST_DUE"},"2":{"slot":2,"type":"STRING","value":"PAST_DUE"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLSALSCH}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLENTDB}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Row Count","mapTo":"Jb_Var_RowCount"}},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6338036":{"id":6338036,"sourceID":6338034,"targetID":6338035}},"notes":{},"noteConnectors":{},"variables":{"Jb_Var_RowCount":{"definition":{"name":"Jb_Var_RowCount","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"SF_Customer_Metrics_Data_Load_20250925","description":"","type":"TRANSFORMATION","tag":"09efb536-cdd4-4702-a51b-1331e8062c16"}}