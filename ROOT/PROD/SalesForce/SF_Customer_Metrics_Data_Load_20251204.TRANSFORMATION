{"job":{"components":{"6338088":{"id":6338088,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-1136,"y":-16,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6338090],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"src_SF_CUSTOMER_METRICS"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH YTD_STG\nAS (\n\tSELECT TSF.CUSTOMER_NUMBER AS CLIENT_ACCOUNT_NUMBER\n\t\t,TSF.CUSTOMER_NAME AS CLIENT_ACCOUNT_NAME\n\t\t,SFD.ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID\n\t    /*AF CER-7618*/\n\t\t,SUM(TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) AS FEES\n\t\t,SUM(TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) AS REVENUE\n\t\t,SUM(TSF.TEMP_WAGE + TSF.SUB_CONTCOST + TSF.FICA + TSF.FUTA + TSF.SUTA + TSF.WC + TSF.WC_MEDICAL + TSF.INSURANCE + TSF.BENEFIT + TSF.VACATION + TSF.HOLIDAY + TSF.K401 + TSF.OTHER_COST + TSF.FLD_EMPTEST + TSF.COM_DATA + TSF.ACA_COST + TSF.SICK_PAY_COST + TSF.LOCAL_TAX) AS COST\n\t\t/*AF CER-7618*/\n\t     ,TDF.CONVERTED_HOURS_BILLED\n        /*AF CER-7618*/\n\t\t,TDF.MAX_POSTING_DATE\n\t    /*AF CER-7618*/\n\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n\tJOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\tJOIN \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" SFD ON TSF.CUSTOMER_NUMBER = SFD.ACCOUNT_NUMBER\n\tJOIN (\n\t\tSELECT CUSTOMER_NUMBER\n\t\t\t,MAX(POSTING_DATE) AS MAX_POSTING_DATE\n\t\t\t,SUM(BILLABLE_UNIT) - SUM(CASE\n\t\t\t\t\tWHEN GL_ACCOUNT = 5800\n\t\t\t\t\t\tTHEN BILLABLE_UNIT\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND) AS CONVERTED_HOURS_BILLED\n\t\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_DETAIL_FACT\"\n\t\tWHERE DW_ACTIVE_FLAG = 'Y' /*AF CER-7618*/ AND (GL_ACCOUNT BETWEEN '4100' AND '5999' OR GL_ACCOUNT = '2660') /*AF CER-7618*/\n\t\tGROUP BY CUSTOMER_NUMBER\n\t\t) TDF ON TSF.CUSTOMER_NUMBER = TDF.CUSTOMER_NUMBER\n\tWHERE TSF.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\tAND SFD.DW_ACTIVE_FLAG = 'Y'\n\t\tAND TSF.POSTING_DATE = TDF.MAX_POSTING_DATE\n\t\tAND DT.FISCAL_YEAR = YEAR(CURRENT_DATE ())\n\t/*AF CER-7618*/\n\tGROUP BY TSF.CUSTOMER_NUMBER\n\t\t,TSF.CUSTOMER_NAME\n\t\t,SFD.ACCOUNT_ID\n\t\t,TDF.CONVERTED_HOURS_BILLED\n\t\t,TDF.MAX_POSTING_DATE\n\t/*AF CER-7618*/\n\t)\n,YTD\nAS (\n\tSELECT /*AF CER-7618*/ DISTINCT /*AF CER-7618*/ ACCOUNT_NUMBER AS CLIENT_ACCOUNT_NUMBER\n\t\t,NAME AS CLIENT_ACCOUNT_NAME\n\t\t,ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID\n\t\t,CASE\n\t\t\tWHEN CTE.FEES IS NULL\n\t\t\t\tTHEN 0\n\t\t\tELSE CTE.FEES\n\t\t\tEND AS FEES_YTD\n\t\t,CASE\n\t\t\tWHEN CTE.REVENUE IS NULL\n\t\t\t\tTHEN 0\n\t\t\tELSE CTE.REVENUE\n\t\t\tEND AS REVENUE\n\t\t,CASE\n\t\t\tWHEN CTE.COST IS NULL\n\t\t\t\tTHEN 0\n\t\t\tELSE CTE.COST\n\t\t\tEND AS COST\n\t\t,CASE\n\t\t\tWHEN CTE.CONVERTED_HOURS_BILLED IS NULL\n\t\t\t\tTHEN 0\n\t\t\tELSE CTE.CONVERTED_HOURS_BILLED\n\t\t\tEND AS CONVERTED_HOURS_BILLED\n\t\t,CASE\n\t\t\tWHEN CTE.MAX_POSTING_DATE IS NULL\n\t\t\t\tTHEN MAX(TSF.POSTING_DATE) OVER (PARTITION BY TSF.CUSTOMER_NUMBER)\n\t\t\tELSE CTE.MAX_POSTING_DATE\n\t\t\tEND AS MAX_POSTING_DATE\n\tFROM \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" DIM\n\tLEFT JOIN \"PROD_EDW\".\"ENT\".\"INVOICE_SUMMARY_FACT\" TSF ON ltrim(rtrim(TSF.CUSTOMER_NUMBER)) = ltrim(rtrim(DIM.ACCOUNT_NUMBER))\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\t\tAND TSF.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\tLEFT JOIN (\n\t\tSELECT CLIENT_ACCOUNT_NUMBER\n\t\t\t,CLIENT_ACCOUNT_NAME\n\t\t\t,SALESFORCE_ACCOUNT_ID\n\t\t\t,FEES\n\t\t\t,REVENUE\n\t\t\t,COST\n\t\t\t,CONVERTED_HOURS_BILLED\n\t\t\t,MAX_POSTING_DATE\n\t\tFROM YTD_STG\n\t\t) CTE ON CTE.CLIENT_ACCOUNT_NUMBER = DIM.ACCOUNT_NUMBER\n\tWHERE DIM.DW_ACTIVE_FLAG = 'Y'\n\t\tAND ACCOUNT_NUMBER IS NOT NULL\n\t)\n,PRR_STG\nAS (\n\tSELECT DISTINCT TSF.CUSTOMER_NUMBER AS CLIENT_ACCOUNT_NUMBER\n\t\t,TSF.CUSTOMER_NAME AS CLIENT_ACCOUNT_NAME\n\t\t,SFD.ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID\n\t\t,FEES\n\t\t,REVENUE\n\t\t,COST\n\t\t,TDF.CONVERTED_HOURS_BILLED\n\tFROM (\n\t\tSELECT TSF.CUSTOMER_NUMBER\n\t\t\t,TSF.CUSTOMER_NAME\n\t\t\t,TSF.EMPLOYEE_NUMBER\n\t\t\t,TSF.POSTING_DATE_KEY\n\t\t\t,TSF.TRAN_DATE_KEY\n\t\t\t,SUM(TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS FEES\n\t\t\t,SUM(TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS REVENUE\n\t\t\t,SUM(TSF.TEMP_WAGE + TSF.SUB_CONTCOST + TSF.FICA + TSF.FUTA + TSF.SUTA + TSF.WC + TSF.WC_MEDICAL + TSF.INSURANCE + TSF.BENEFIT + TSF.VACATION + TSF.HOLIDAY + TSF.K401 + TSF.OTHER_COST + TSF.FLD_EMPTEST + TSF.COM_DATA + TSF.ACA_COST + TSF.SICK_PAY_COST + TSF.LOCAL_TAX) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS COST\n\t\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n\t\tINNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\t\tWHERE TSF.DW_ACTIVE_FLAG = 'Y'\n\t\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\t\tAND DT.FISCAL_YEAR = YEAR(CURRENT_DATE ()) - 1\n\t\t) TSF\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" SFD ON TSF.CUSTOMER_NUMBER = SFD.ACCOUNT_NUMBER\n\tINNER JOIN (\n\t\tSELECT CUSTOMER_NUMBER\n\t\t\t,SUM(BILLABLE_UNIT) - SUM(CASE\n\t\t\t\t\tWHEN GL_ACCOUNT = 5800\n\t\t\t\t\t\tTHEN BILLABLE_UNIT\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND) CONVERTED_HOURS_BILLED\n\t\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_DETAIL_FACT\" TSF\n\t\tJOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\t\tWHERE TSF.DW_ACTIVE_FLAG = 'Y'\n\t\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\t\tAND DT.FISCAL_YEAR = YEAR(CURRENT_DATE ()) - 1\n\t\tGROUP BY CUSTOMER_NUMBER\n\t\t) TDF ON TSF.CUSTOMER_NUMBER = TDF.CUSTOMER_NUMBER\n\tWHERE SFD.DW_ACTIVE_FLAG = 'Y'\n\t)\n,PRR\nAS (\n\tSELECT ACCOUNT_NUMBER AS CLIENT_ACCOUNT_NUMBER\n\t\t,NAME AS CLIENT_ACCOUNT_NAME\n\t\t,ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID\n\t\t,CASE\n\t\t\tWHEN CTE.FEES IS NULL\n\t\t\t\tTHEN 0\n\t\t\tELSE CTE.FEES\n\t\t\tEND AS FEES_YTD\n\t\t,CASE\n\t\t\tWHEN CTE.REVENUE IS NULL\n\t\t\t\tTHEN 0\n\t\t\tELSE CTE.REVENUE\n\t\t\tEND AS REVENUE\n\t\t,CASE\n\t\t\tWHEN CTE.COST IS NULL\n\t\t\t\tTHEN 0\n\t\t\tELSE CTE.COST\n\t\t\tEND AS COST\n\t\t,CASE\n\t\t\tWHEN CTE.CONVERTED_HOURS_BILLED IS NULL\n\t\t\t\tTHEN 0\n\t\t\tELSE CTE.CONVERTED_HOURS_BILLED\n\t\t\tEND AS CONVERTED_HOURS_BILLED\n\t-- , CASE WHEN CTE.MAX_POSTING_DATE is null then null else CTE.MAX_POSTING_DATE end as MAX_POSTING_DATE\n\tFROM \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" DIM\n\tLEFT JOIN (\n\t\tSELECT CLIENT_ACCOUNT_NUMBER\n\t\t\t,CLIENT_ACCOUNT_NAME\n\t\t\t,SALESFORCE_ACCOUNT_ID\n\t\t\t,FEES\n\t\t\t,REVENUE\n\t\t\t,COST\n\t\t\t,CONVERTED_HOURS_BILLED\n\t\tFROM PRR_STG\n\t\t) CTE ON CTE.CLIENT_ACCOUNT_NUMBER = DIM.ACCOUNT_NUMBER\n\tWHERE DIM.DW_ACTIVE_FLAG = 'Y'\n\t\tAND ACCOUNT_NUMBER IS NOT NULL\n\t)\n,LFT\nAS (\n\tSELECT DISTINCT TSF.CUSTOMER_NUMBER AS CLIENT_ACCOUNT_NUMBER\n\t\t,SFD.ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID\n\t\t,REVENUE\n\tFROM (\n\t\tSELECT TSF.CUSTOMER_NUMBER\n\t\t\t,TSF.CUSTOMER_NAME\n\t\t\t,SUM(TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS REVENUE\n\t\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n\t\tINNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\t\tWHERE TSF.DW_ACTIVE_FLAG = 'Y'\n\t\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\t) TSF\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" SFD ON TSF.CUSTOMER_NUMBER = SFD.ACCOUNT_NUMBER\n\tWHERE SFD.DW_ACTIVE_FLAG = 'Y'\n\t)\n,MIN_PST_DT\nAS (\n\tSELECT DISTINCT TSF.CUSTOMER_NUMBER AS CLIENT_ACCOUNT_NUMBER\n\t\t,SFD.ACCOUNT_ID AS SALESFORCE_ACCOUNT_ID\n\t\t,MIN(TSF.POSTING_DATE) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS MIN_POSTING_DATE\n\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"CUSTOMER_SF_DIM\" SFD ON TSF.CUSTOMER_NUMBER = SFD.ACCOUNT_NUMBER\n\tWHERE SFD.DW_ACTIVE_FLAG = 'Y'\n\t\tAND TSF.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\tAND (TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) > 0\n\t)\n,SND\nAS (\n\tSELECT DATE\n\t\t,SUNNORM_POSTING_DATE\n\tFROM \"PROD_EDW\".\"ENT\".\"DATE_DIM\"\n\t)\n,APY\nAS (\n\tSELECT CUSTOMER_NUMBER\n\t\t,COUNT(DISTINCT EMPLOYEE_NUMBER) AOA_PAID_YTD\n\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\t\tAND TSF.TRAN_DATE_KEY = DT.DATE_KEY\n\tWHERE TSF.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.FISCAL_YEAR = YEAR(CURRENT_DATE ())\n\t\tAND TEMP_WAGE > 0\n\tGROUP BY CUSTOMER_NUMBER\n\t)\n,APP\nAS (\n\tSELECT CUSTOMER_NUMBER\n\t\t,COUNT(DISTINCT EMPLOYEE_NUMBER) AOA_PAID_PRIOR_YEAR\n\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\t\tAND TSF.TRAN_DATE_KEY = DT.DATE_KEY\n\tWHERE TSF.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.FISCAL_YEAR = YEAR(CURRENT_DATE ()) - 1\n\t\tAND TEMP_WAGE > 0\n\tGROUP BY CUSTOMER_NUMBER\n\t)\n,ABY\nAS (\n\tSELECT CUSTOMER_NUMBER\n\t\t,COUNT(DISTINCT EMPLOYEE_NUMBER) AOA_BILLED_YTD\n\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\t\tAND TSF.TRAN_DATE_KEY = DT.DATE_KEY\n\tWHERE TSF.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.FISCAL_YEAR = YEAR(CURRENT_DATE ())\n\t\tAND TSF.TEMP_BILLING IS NOT NULL\n\tGROUP BY CUSTOMER_NUMBER\n\t)\n,ABP\nAS (\n\tSELECT CUSTOMER_NUMBER\n\t\t,COUNT(DISTINCT EMPLOYEE_NUMBER) AOA_BILLED_PRIOR_YEAR\n\tFROM \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF\n\tINNER JOIN \"PROD_EDW\".\"ENT\".\"DATE_DIM\" DT ON TSF.POSTING_DATE_KEY = DT.DATE_KEY\n\t\tAND TSF.TRAN_DATE_KEY = DT.DATE_KEY\n\tWHERE TSF.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.DW_ACTIVE_FLAG = 'Y'\n\t\tAND DT.FISCAL_YEAR = YEAR(CURRENT_DATE ()) - 1\n\t\tAND (TSF.TEMP_BILLING + TSF.SUB_CONTREV + TSF.OTHER_REVENUE + TSF.ACA_REVENUE + TSF.SICK_REV + TSF.REPL_FEES + TSF.QUICK_HIRE + TSF.CONV_FEES) > 0\n\tGROUP BY CUSTOMER_NUMBER\n\t)\n,CTE_RESULT\nAS (\n\tSELECT DISTINCT YTD.CLIENT_ACCOUNT_NUMBER\n\t\t,YTD.CLIENT_ACCOUNT_NAME\n\t\t,YTD.SALESFORCE_ACCOUNT_ID\n\t\t,YTD.FEES_YTD\n\t\t,PRR.FEES_YTD AS FEES_PRIOR_YEAR\n\t\t,YTD.REVENUE AS REVENUE_YTD\n\t\t,PRR.REVENUE AS REVENUE_PRIOR_YEAR\n\t\t,LFT.REVENUE AS REVENUE_LIFETIME_TO_DATE\n\t\t,YTD.REVENUE - YTD.COST AS GROSS_MARGIN_YTD\n\t\t,PRR.REVENUE - PRR.COST AS GROSS_MARGIN_PRIOR_YEAR\n\t\t,CASE\n\t\t\tWHEN YTD.REVENUE > 0\n\t\t\t\tTHEN ROUND((YTD.REVENUE - YTD.COST) / YTD.REVENUE, 2)\n\t\t\tELSE 0\n\t\t\tEND AS \"GM%_YTD\"\n\t\t,CASE\n\t\t\tWHEN PRR.REVENUE > 0\n\t\t\t\tTHEN ROUND((PRR.REVENUE - PRR.COST) / PRR.REVENUE, 2)\n\t\t\tELSE 0\n\t\t\tEND AS \"GM%_PRIOR_YEAR\"\n\t\t,YTD.CONVERTED_HOURS_BILLED AS CONVERTED_HOURS_BILLED_YTD\n\t\t,PRR.CONVERTED_HOURS_BILLED AS CONVERTED_HOURS_BILLED_LAST_YEAR\n\t\t,SND1.SUNNORM_POSTING_DATE AS FIRST_BILLED_DATE\n\t\t,SND2.SUNNORM_POSTING_DATE AS LAST_BILLED_DATE\n\t\t,NVL(APP.AOA_PAID_PRIOR_YEAR, 0) AS AOA_PAID_PRIOR_YEAR\n\t\t,NVL(APY.AOA_PAID_YTD, 0) AS AOA_PAID_YTD\n\t\t,NVL(ABP.AOA_BILLED_PRIOR_YEAR, 0) AS AOA_BILLED_PRIOR_YEAR\n\t\t,NVL(ABY.AOA_BILLED_YTD, 0) AS AOA_BILLED_YTD\n\t\t,AR_INFO.AR_BALANCE\n\t\t,AR_INFO.PAST_DUE\n\tFROM YTD -- year till date\n\tLEFT JOIN PRR ON YTD.CLIENT_ACCOUNT_NUMBER = PRR.CLIENT_ACCOUNT_NUMBER -- prior year date\n\t\tAND YTD.SALESFORCE_ACCOUNT_ID = PRR.SALESFORCE_ACCOUNT_ID\n\tLEFT JOIN LFT ON YTD.CLIENT_ACCOUNT_NUMBER = LFT.CLIENT_ACCOUNT_NUMBER\n\t\tAND YTD.SALESFORCE_ACCOUNT_ID = LFT.SALESFORCE_ACCOUNT_ID\n\tLEFT JOIN MIN_PST_DT ON YTD.CLIENT_ACCOUNT_NUMBER = MIN_PST_DT.CLIENT_ACCOUNT_NUMBER\n\t\tAND YTD.SALESFORCE_ACCOUNT_ID = MIN_PST_DT.SALESFORCE_ACCOUNT_ID\n\tLEFT JOIN SND SND1 ON MIN_PST_DT.MIN_POSTING_DATE = SND1.DATE\n\tLEFT JOIN SND SND2 ON YTD.MAX_POSTING_DATE = SND2.DATE\n\tLEFT JOIN APY ON YTD.CLIENT_ACCOUNT_NUMBER = APY.CUSTOMER_NUMBER\n\tLEFT JOIN APP ON YTD.CLIENT_ACCOUNT_NUMBER = APP.CUSTOMER_NUMBER\n\tLEFT JOIN ABY ON YTD.CLIENT_ACCOUNT_NUMBER = ABY.CUSTOMER_NUMBER\n\tLEFT JOIN ABP ON YTD.CLIENT_ACCOUNT_NUMBER = ABP.CUSTOMER_NUMBER\n\tLEFT JOIN (\n\t\tSELECT CUSTOMER\n\t\t\t,SUM(TRAN_AMT) AS AR_BALANCE\n\t\t\t,SUM(OPEN_AMT) AS PAST_DUE\n\t\tFROM (\n\t\t\tSELECT BASE_QRY.CUSTOMER\n\t\t\t\t,TRAN_AMT\n\t\t\t\t,CASE\n\t\t\t\t\tWHEN CUST_AGING_INFO.TERMS_CD = 'DUR'\n\t\t\t\t\t\tAND AGE_DAYS > 0\n\t\t\t\t\t\tTHEN OPEN_AMT\n\t\t\t\t\tWHEN CUST_AGING_INFO.TERMS_CD <> 'DUR'\n\t\t\t\t\t\tAND AGE_DAYS > SUBSTR(CUST_AGING_INFO.TERMS_CD, 2, LENGTH(CUST_AGING_INFO.TERMS_CD))\n\t\t\t\t\t\tTHEN OPEN_AMT\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND AS OPEN_AMT\n\t\t\tFROM (\n\t\t\t\tSELECT *\n\t\t\t\t\t,CASE\n\t\t\t\t\t\tWHEN TRANS_TYPE <> 'P'\n\t\t\t\t\t\t\tTHEN DATEDIFF(DAY, TRANS_DATE, CURRENT_DATE ())\n\t\t\t\t\t\tELSE 0\n\t\t\t\t\t\tEND AS AGE_DAYS\n\t\t\t\tFROM PROD_ENTERPRISE.SALES.\"VW_CUST_AGING_PAST_DUE_INVOICE\"\n\n\t\t\t\tUNION ALL\n\n\t\t\t\tSELECT *\n\t\t\t\t\t,CASE\n\t\t\t\t\t\tWHEN TRANS_TYPE <> 'P'\n\t\t\t\t\t\t\tTHEN DATEDIFF(DAY, TRANS_DATE, CURRENT_DATE ())\n\t\t\t\t\t\tELSE 0\n\t\t\t\t\t\tEND AS AGE_DAYS\n\t\t\t\tFROM PROD_ENTERPRISE.SALES.VW_CUST_AGING_UNAPPLIED_CASH_PYMNT\n\t\t\t\t) BASE_QRY\n\t\t\tINNER JOIN (\n\t\t\t\tSELECT DISTINCT ARCOMP.COMPANY\n\t\t\t\t\t,ARCUSTOMER.CUSTOMER\n\t\t\t\t\t,ARCUSTOMER.TERMS_CD\n\t\t\t\tFROM PROD_DATALAKE.LAWPROD.ARCUSTOMER AS ARCUSTOMER\n\t\t\t\tLEFT OUTER JOIN PROD_DATALAKE.LAWPROD.ARCUSTFLDS AS ARCUSTFLDS ON ARCUSTOMER.COMPANY = ARCUSTFLDS.COMPANY\n\t\t\t\t\tAND ARCUSTOMER.CUSTOMER = ARCUSTFLDS.CUSTOMER\n\t\t\t\tINNER JOIN PROD_DATALAKE.LAWPROD.ARCOMP AS ARCOMP ON ARCUSTOMER.COMPANY = ARCOMP.COMPANY\n\t\t\t\tINNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTGRP AS ARCUSTGRP ON ARCOMP.CUST_GROUP = ARCUSTGRP.CUST_GROUP\n\t\t\t\tINNER JOIN PROD_DATALAKE.LAWPROD.CUSTDESC AS CUSTDESC ON ARCUSTGRP.CUST_GROUP = CUSTDESC.CUST_GROUP\n\t\t\t\t\tAND ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER\n\t\t\t\tINNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTOMER AS SUMCUST ON ARCUSTOMER.COMPANY = SUMCUST.COMPANY\n\t\t\t\t\tAND ARCUSTOMER.CUSTOMER = SUMCUST.CUSTOMER\n\t\t\t\t) CUST_AGING_INFO ON CUST_AGING_INFO.COMPANY = BASE_QRY.COMPANY\n\t\t\t\tAND CUST_AGING_INFO.CUSTOMER = BASE_QRY.CUSTOMER\n\t\t\tWHERE (\n\t\t\t\t\tBASE_QRY.OPEN_AMT > 0\n\t\t\t\t\tOR BASE_QRY.OPEN_AMT < 0\n\t\t\t\t\t)\n\t\t\t)\n\t\tGROUP BY CUSTOMER\n\t\t) AR_INFO ON TRIM(YTD.CLIENT_ACCOUNT_NUMBER) = TRIM(AR_INFO.CUSTOMER)\n\t)\n,CTE_RESULT_PRR\nAS (\n\tSELECT DISTINCT PRR.CLIENT_ACCOUNT_NUMBER\n\t\t,PRR.CLIENT_ACCOUNT_NAME\n\t\t,PRR.SALESFORCE_ACCOUNT_ID\n\t\t,PRR.FEES_YTD\n\t\t,YTD.FEES_YTD AS FEES_PRIOR_YEAR\n\t\t,PRR.REVENUE AS REVENUE_YTD\n\t\t,YTD.REVENUE AS REVENUE_PRIOR_YEAR\n\t\t,LFT.REVENUE AS REVENUE_LIFETIME_TO_DATE\n\t\t,0 AS GROSS_MARGIN_YTD\n\t\t,PRR.REVENUE - PRR.COST AS GROSS_MARGIN_PRIOR_YEAR\n\t\t,0 AS \"GM%_YTD\"\n\t\t,CASE\n\t\t\tWHEN PRR.REVENUE > 0\n\t\t\t\tTHEN ROUND((PRR.REVENUE - PRR.COST) / PRR.REVENUE, 2)\n\t\t\tELSE 0\n\t\t\tEND AS \"GM%_PRIOR_YEAR\"\n\t\t,PRR.CONVERTED_HOURS_BILLED AS CONVERTED_HOURS_BILLED_YTD\n\t\t,YTD.CONVERTED_HOURS_BILLED AS CONVERTED_HOURS_BILLED_LAST_YEAR\n\t\t,SND1.SUNNORM_POSTING_DATE AS FIRST_BILLED_DATE\n\t\t,SND2.SUNNORM_POSTING_DATE AS LAST_BILLED_DATE\n\t\t,NVL(APP.AOA_PAID_PRIOR_YEAR, 0) AS AOA_PAID_PRIOR_YEAR\n\t\t,NVL(APY.AOA_PAID_YTD, 0) AS AOA_PAID_YTD\n\t\t,NVL(ABP.AOA_BILLED_PRIOR_YEAR, 0) AS AOA_BILLED_PRIOR_YEAR\n\t\t,NVL(ABY.AOA_BILLED_YTD, 0) AS AOA_BILLED_YTD\n\t\t,AR_INFO.AR_BALANCE\n\t\t,AR_INFO.PAST_DUE\n\tFROM PRR -- year till date\n\tLEFT JOIN YTD ON YTD.CLIENT_ACCOUNT_NUMBER = PRR.CLIENT_ACCOUNT_NUMBER -- prior year date\n\t\tAND YTD.SALESFORCE_ACCOUNT_ID = PRR.SALESFORCE_ACCOUNT_ID\n\tLEFT JOIN LFT ON YTD.CLIENT_ACCOUNT_NUMBER = LFT.CLIENT_ACCOUNT_NUMBER\n\t\tAND YTD.SALESFORCE_ACCOUNT_ID = LFT.SALESFORCE_ACCOUNT_ID\n\tLEFT JOIN MIN_PST_DT ON YTD.CLIENT_ACCOUNT_NUMBER = MIN_PST_DT.CLIENT_ACCOUNT_NUMBER\n\t\tAND YTD.SALESFORCE_ACCOUNT_ID = MIN_PST_DT.SALESFORCE_ACCOUNT_ID\n\tLEFT JOIN SND SND1 ON MIN_PST_DT.MIN_POSTING_DATE = SND1.DATE\n\tLEFT JOIN SND SND2 ON YTD.MAX_POSTING_DATE = SND2.DATE\n\tLEFT JOIN APY ON YTD.CLIENT_ACCOUNT_NUMBER = APY.CUSTOMER_NUMBER\n\tLEFT JOIN APP ON YTD.CLIENT_ACCOUNT_NUMBER = APP.CUSTOMER_NUMBER\n\tLEFT JOIN ABY ON YTD.CLIENT_ACCOUNT_NUMBER = ABY.CUSTOMER_NUMBER\n\tLEFT JOIN ABP ON YTD.CLIENT_ACCOUNT_NUMBER = ABP.CUSTOMER_NUMBER\n\tLEFT JOIN (\n\t\tSELECT CUSTOMER\n\t\t\t,SUM(TRAN_AMT) AS AR_BALANCE\n\t\t\t,SUM(OPEN_AMT) AS PAST_DUE\n\t\tFROM (\n\t\t\tSELECT BASE_QRY.CUSTOMER\n\t\t\t\t,TRAN_AMT\n\t\t\t\t,CASE\n\t\t\t\t\tWHEN CUST_AGING_INFO.TERMS_CD = 'DUR'\n\t\t\t\t\t\tAND AGE_DAYS > 0\n\t\t\t\t\t\tTHEN OPEN_AMT\n\t\t\t\t\tWHEN CUST_AGING_INFO.TERMS_CD <> 'DUR'\n\t\t\t\t\t\tAND AGE_DAYS > SUBSTR(CUST_AGING_INFO.TERMS_CD, 2, LENGTH(CUST_AGING_INFO.TERMS_CD))\n\t\t\t\t\t\tTHEN OPEN_AMT\n\t\t\t\t\tELSE 0\n\t\t\t\t\tEND AS OPEN_AMT\n\t\t\tFROM (\n\t\t\t\tSELECT *\n\t\t\t\t\t,CASE\n\t\t\t\t\t\tWHEN TRANS_TYPE <> 'P'\n\t\t\t\t\t\t\tTHEN DATEDIFF(DAY, TRANS_DATE, CURRENT_DATE ())\n\t\t\t\t\t\tELSE 0\n\t\t\t\t\t\tEND AS AGE_DAYS\n\t\t\t\tFROM \"PROD_ENTERPRISE\".\"SALES\".\"VW_CUST_AGING_PAST_DUE_INVOICE\"\n\n\t\t\t\tUNION ALL\n\n\t\t\t\tSELECT *\n\t\t\t\t\t,CASE\n\t\t\t\t\t\tWHEN TRANS_TYPE <> 'P'\n\t\t\t\t\t\t\tTHEN DATEDIFF(DAY, TRANS_DATE, CURRENT_DATE ())\n\t\t\t\t\t\tELSE 0\n\t\t\t\t\t\tEND AS AGE_DAYS\n\t\t\t\tFROM \"PROD_ENTERPRISE\".\"SALES\".VW_CUST_AGING_UNAPPLIED_CASH_PYMNT\n\t\t\t\t) BASE_QRY\n\t\t\tINNER JOIN (\n\t\t\t\tSELECT DISTINCT ARCOMP.COMPANY\n\t\t\t\t\t,ARCUSTOMER.CUSTOMER\n\t\t\t\t\t,ARCUSTOMER.TERMS_CD\n\t\t\t\tFROM PROD_DATALAKE.LAWPROD.ARCUSTOMER AS ARCUSTOMER\n\t\t\t\tLEFT OUTER JOIN PROD_DATALAKE.LAWPROD.ARCUSTFLDS AS ARCUSTFLDS ON ARCUSTOMER.COMPANY = ARCUSTFLDS.COMPANY\n\t\t\t\t\tAND ARCUSTOMER.CUSTOMER = ARCUSTFLDS.CUSTOMER\n\t\t\t\tINNER JOIN PROD_DATALAKE.LAWPROD.ARCOMP AS ARCOMP ON ARCUSTOMER.COMPANY = ARCOMP.COMPANY\n\t\t\t\tINNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTGRP AS ARCUSTGRP ON ARCOMP.CUST_GROUP = ARCUSTGRP.CUST_GROUP\n\t\t\t\tINNER JOIN PROD_DATALAKE.LAWPROD.CUSTDESC AS CUSTDESC ON ARCUSTGRP.CUST_GROUP = CUSTDESC.CUST_GROUP\n\t\t\t\t\tAND ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER\n\t\t\t\tINNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTOMER AS SUMCUST ON ARCUSTOMER.COMPANY = SUMCUST.COMPANY\n\t\t\t\t\tAND ARCUSTOMER.CUSTOMER = SUMCUST.CUSTOMER\n\t\t\t\t) CUST_AGING_INFO ON CUST_AGING_INFO.COMPANY = BASE_QRY.COMPANY\n\t\t\t\tAND CUST_AGING_INFO.CUSTOMER = BASE_QRY.CUSTOMER\n\t\t\tWHERE (\n\t\t\t\t\tBASE_QRY.OPEN_AMT > 0\n\t\t\t\t\tOR BASE_QRY.OPEN_AMT < 0\n\t\t\t\t\t)\n\t\t\t)\n\t\tGROUP BY CUSTOMER\n\t\t) AR_INFO ON TRIM(YTD.CLIENT_ACCOUNT_NUMBER) = TRIM(AR_INFO.CUSTOMER)\n\t)\n,CTE_FINAL\nAS (\n\tSELECT *\n\tFROM CTE_RESULT\n\n\tUNION\n\n\tSELECT *\n\tFROM CTE_RESULT_PRR\n\tWHERE CLIENT_ACCOUNT_NUMBER IN (\n\t\t\tSELECT DISTINCT CLIENT_ACCOUNT_NUMBER\n\t\t\tFROM CTE_RESULT_PRR\n\n\t\t\tEXCEPT\n\n\t\t\tSELECT DISTINCT CLIENT_ACCOUNT_NUMBER\n\t\t\tFROM CTE_RESULT\n\t\t\t)\n\t)\n,CTE_FIRST_BILL_DT_NULL\nAS (\n\tSELECT *\n\tFROM CTE_FINAL\n\tWHERE FIRST_BILLED_DATE IS NULL\n\t\tAND LAST_BILLED_DATE IS NOT NULL\n\t)\n,CTE_FINAL_RESULT\nAS (\n\tSELECT DISTINCT CTE.CLIENT_ACCOUNT_NUMBER\n\t\t,CTE.CLIENT_ACCOUNT_NAME\n\t\t,CTE.SALESFORCE_ACCOUNT_ID\n\t\t,CTE.FEES_YTD\n\t\t,FEES_PRIOR_YEAR\n\t\t,CTE.REVENUE_YTD\n\t\t,CTE.REVENUE_PRIOR_YEAR\n\t\t,CTE.REVENUE_LIFETIME_TO_DATE\n\t\t,CTE.GROSS_MARGIN_YTD\n\t\t,CTE.GROSS_MARGIN_PRIOR_YEAR\n\t\t,CTE.\"GM%_YTD\" AS GM_YTD\n\t\t,CTE.\"GM%_PRIOR_YEAR\" AS GM_PRIOR_YEAR\n\t\t,CTE.CONVERTED_HOURS_BILLED_YTD\n\t\t,CTE.CONVERTED_HOURS_BILLED_LAST_YEAR\n\t\t,MIN(TSF.POSTING_DATE) OVER (PARTITION BY TSF.CUSTOMER_NUMBER) AS FIRST_BILLED_DATE\n\t\t,CTE.LAST_BILLED_DATE\n\t\t,CTE.AOA_PAID_PRIOR_YEAR\n\t\t,CTE.AOA_PAID_YTD\n\t\t,CTE.AOA_BILLED_PRIOR_YEAR\n\t\t,CTE.AOA_BILLED_YTD\n\t\t,CTE.AR_BALANCE\n\t\t,CTE.PAST_DUE\n\tFROM CTE_FIRST_BILL_DT_NULL CTE\n\tLEFT JOIN \"PROD_EDW\".\"ENT\".\"TRANSACTION_SUMMARY_FACT\" TSF ON TSF.CUSTOMER_NUMBER = CTE.CLIENT_ACCOUNT_NUMBER\n\n\tUNION\n\n\tSELECT *\n\tFROM (\n\t\tSELECT *\n\t\tFROM CTE_FINAL\n\n\t\tEXCEPT\n\n\t\tSELECT *\n\t\tFROM CTE_FINAL\n\t\tWHERE FIRST_BILLED_DATE IS NULL\n\t\t\tAND LAST_BILLED_DATE IS NOT NULL\n\t\t)\n\t)\nSELECT *\nFROM CTE_FINAL_RESULT"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6338089":{"id":6338089,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":-864,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6338090],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"TARGET"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SALESFORCE_CUSTOMER_METRICS"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CLIENT_ACCOUNT_NUMBER"},"2":{"slot":2,"type":"STRING","value":"CLIENT_ACCOUNT_NUMBER"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"CLIENT_ACCOUNT_NAME"},"2":{"slot":2,"type":"STRING","value":"CLIENT_ACCOUNT_NAME"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"SALESFORCE_ACCOUNT_ID"},"2":{"slot":2,"type":"STRING","value":"SALESFORCE_ACCOUNT_ID"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"FEES_YTD"},"2":{"slot":2,"type":"STRING","value":"FEES_YTD"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"FEES_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"FEES_PRIOR_YEAR"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"REVENUE_YTD"},"2":{"slot":2,"type":"STRING","value":"REVENUE_YTD"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"REVENUE_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"REVENUE_PRIOR_YEAR"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"REVENUE_LIFETIME_TO_DATE"},"2":{"slot":2,"type":"STRING","value":"REVENUE_LIFETIME_TO_DATE"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"GROSS_MARGIN_YTD"},"2":{"slot":2,"type":"STRING","value":"GROSS_MARGIN_YTD"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"GROSS_MARGIN_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"GROSS_MARGIN_PRIOR_YEAR"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"GM_YTD"},"2":{"slot":2,"type":"STRING","value":"GM_PERCENT_YTD"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"GM_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"GM_PERCENT_PRIOR_YEAR"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"CONVERTED_HOURS_BILLED_YTD"},"2":{"slot":2,"type":"STRING","value":"CONVERTED_HOURS_BILLED_YTD"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"CONVERTED_HOURS_BILLED_LAST_YEAR"},"2":{"slot":2,"type":"STRING","value":"CONVERTED_HOURS_BILLED_LAST_YEAR"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"FIRST_BILLED_DATE"},"2":{"slot":2,"type":"STRING","value":"FIRST_BILLED_DATE"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"LAST_BILLED_DATE"},"2":{"slot":2,"type":"STRING","value":"LAST_BILLED_DATE"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"AOA_PAID_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"AOA_PAID_PRIOR_YEAR"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"AOA_PAID_YTD"},"2":{"slot":2,"type":"STRING","value":"AOA_PAID_YTD"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"AOA_BILLED_PRIOR_YEAR"},"2":{"slot":2,"type":"STRING","value":"AOA_BILLED_PRIOR_YEAR"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"AOA_BILLED_YTD"},"2":{"slot":2,"type":"STRING","value":"AOA_BILLED_YTD"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"AR_BALANCE"},"2":{"slot":2,"type":"STRING","value":"AR_BALANCE"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"PAST_DUE"},"2":{"slot":2,"type":"STRING","value":"PAST_DUE"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLSALSCH}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLENTDB}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Row Count","mapTo":"Jb_Var_RowCount"}},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6338090":{"id":6338090,"sourceID":6338088,"targetID":6338089}},"notes":{},"noteConnectors":{},"variables":{"Jb_Var_RowCount":{"definition":{"name":"Jb_Var_RowCount","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"SF_Customer_Metrics_Data_Load_20251204","description":"","type":"TRANSFORMATION","tag":"a1bdc90d-831c-460d-9aa1-1e54852e4211"}}