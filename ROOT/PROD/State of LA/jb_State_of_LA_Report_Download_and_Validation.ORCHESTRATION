{"job":{"components":{"6342401":{"id":6342401,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":560,"y":80,"width":32,"height":32,"inputConnectorIDs":[6342414,6342422],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342426],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Success Path"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342402":{"id":6342402,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":720,"y":-352,"width":32,"height":32,"inputConnectorIDs":[6342424],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342403":{"id":6342403,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":32,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6342421],"outputSuccessConnectorIDs":[6342415],"outputFailureConnectorIDs":[6342466],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get Report Validations"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\nselect_query = \"SELECT CELL_VALIDATION FROM ${SNFLKDB_PDL}.STATEOFLA.CONFIG_REPORT_VALIDATION WHERE REPORT_ID = ${stateofla_report_id}\"\ncursor.execute(select_query)\nresult = cursor.fetchone()\nprint(\"Configuation\")\nprint(result)\ncontext.updateVariable(\"cell_validation\", result[0])"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342404":{"id":6342404,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-832,"y":-48,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342425],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342405":{"id":6342405,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"CONDITIONAL","executionHint":"FLOW","implementationID":-1357378929,"x":-128,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6342429],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[6342421],"outputFalseConnectorIDs":[6342422],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"TYPE IS AUTOMATIC"}}}},"visible":true},"2":{"slot":2,"name":"Mode","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Simple"}}}},"visible":true},"3":{"slot":3,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"stateofla_check_type"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"AUTOMATIC"}}}},"visible":true},"4":{"slot":4,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":true},"5":{"slot":5,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342406":{"id":6342406,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":208,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6342415],"outputSuccessConnectorIDs":[6342417],"outputFailureConnectorIDs":[6342498],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Download report"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import requests\nfrom requests_ntlm import HttpNtlmAuth\nimport boto3\nimport logging\nfrom io import BytesIO\n\n# Setting up logging for better traceability\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n# Configuration\nsession = boto3.Session()\ns3_bucket_name = s3_URL.replace(\"s3:\", '').strip('/')\n\n\ndef download_report(filename, url):\n    print(\"Starting report download\")\n    r = requests.get(url, auth=HttpNtlmAuth(ssrs_username, ssrs_password))\n    print(\"Downloaded\")\n    print(r.status_code)\n    \n    if r.status_code == 200:\n\t\t# Create a BytesIO buffer to hold the content in memory\n        buffer = BytesIO()\n\n        for bits in r.iter_content():\n            buffer.write(bits)\n        print(\"report buffered\")\n        # Move the buffer's cursor to the beginning\n        buffer.seek(0)\n\n        # Upload the buffer to S3\n        write_report_to_s3(buffer, filename)\n\n        logger.info(\"File created, process completed!!\")\n    else:\n        logger.info(\"File NOT created, process with ERROR!!\")\n\ndef write_report_to_s3(buffer, filename):\n    \"\"\"Write the DataFrame to S3.\"\"\"\n    try:\n        print(\"starting s3 save\")\n        print(filename)\n        client = session.client('s3')\n        res = client.put_object(Bucket=s3_bucket_name, Body=buffer.getvalue(), Key=filename)\n        print(\"starting s3 save\")\n        logging.info(f'Successfully wrote results to S3: {filename}')\n    except Exception as e:\n        logging.error(f'Failed to write results to S3: {e}')\n\n#URL report construction\nprint(\"report url\")\nurl = f'http://crmrclp1rax2/ReportServer/Pages/ReportViewer.aspx?%2FState%20of%20LA%2F{stateofla_report_name}&rs:Format='\nprint(url+\"PDF\")\n\ndownload_report(f\"State_Of_LA/{stateofla_year_month}/PDF/{stateofla_report_name}.pdf\", url+\"PDF\")\ndownload_report(f\"State_Of_LA/{stateofla_year_month}/Excel/{stateofla_report_name}.xls\", url+\"Excel\")"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342407":{"id":6342407,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":-530,"y":-347,"width":32,"height":32,"inputConnectorIDs":[6342467,6342499],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342427],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or Failure"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342408":{"id":6342408,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":-400,"y":-192,"width":32,"height":32,"inputConnectorIDs":[6342412,6342416],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342431],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or Success"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342409":{"id":6342409,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":560,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6342419],"outputSuccessConnectorIDs":[6342414],"outputFailureConnectorIDs":[6342464],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Upsert table validation result"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import logging\nimport ast\n\n# Setting up logging for better traceability\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n# This is a placeholder for the actual implementation\nlogger.info(\"Saving data in Snowflake\")\n# Implement your Snowflake saving logic here\ncursor = context.cursor()\n\n\ninput_data = ast.literal_eval(stateofla_data_result)\nfor row in input_data:\n    insert_sql = None\n    my_data_list = ast.literal_eval(row)\n    values = [str(item[0]) for item in my_data_list]\n    if len(my_data_list) == 4:\n        insert_sql = \"\"\"\n            MERGE INTO ${SNFLKDB_PDL}.STATEOFLA.STATEOFLA_REPORT_VALIDATION AS target\n            USING (\n                SELECT \n                    '${stateofla_year_month}' AS YEAR_MONTH,\n                    ? AS REPORT_NAME,\n                    ? AS FIELD_VALIDATED,\n                    ? AS VALUE_1,\n                    ? AS VALIDATION_RESULT\n            ) AS source\n            ON target.YEAR_MONTH = source.YEAR_MONTH\n                AND target.REPORT_NAME = source.REPORT_NAME\n                AND target.FIELD_VALIDATED = source.FIELD_VALIDATED\n            WHEN MATCHED THEN\n                UPDATE SET \n                    VALUE_1 = source.VALUE_1,\n                    VALIDATION_RESULT = source.VALIDATION_RESULT\n            WHEN NOT MATCHED THEN\n                INSERT (YEAR_MONTH, REPORT_NAME, FIELD_VALIDATED, VALUE_1, VALUE_2, VALIDATION_RESULT)\n                VALUES (source.YEAR_MONTH, source.REPORT_NAME, source.FIELD_VALIDATED, source.VALUE_1, NULL, source.VALIDATION_RESULT)\"\"\"\n    if len(my_data_list) == 5:\n        insert_sql = \"\"\"\n            MERGE INTO ${SNFLKDB_PDL}.STATEOFLA.STATEOFLA_REPORT_VALIDATION AS target\n            USING (\n                SELECT \n                    '${stateofla_year_month}' AS YEAR_MONTH,\n                    ? AS REPORT_NAME,\n                    ? AS FIELD_VALIDATED,\n                    ? AS VALUE_1,\n                    ? AS VALUE_2,\n                    ? AS VALIDATION_RESULT\n            ) AS source\n            ON target.YEAR_MONTH = source.YEAR_MONTH\n               AND target.REPORT_NAME = source.REPORT_NAME\n               AND target.FIELD_VALIDATED = source.FIELD_VALIDATED\n            WHEN MATCHED THEN\n                UPDATE SET \n                    VALUE_1 = source.VALUE_1,\n                    VALUE_2 = source.VALUE_2,\n                    VALIDATION_RESULT = source.VALIDATION_RESULT\n            WHEN NOT MATCHED THEN\n                INSERT (YEAR_MONTH, REPORT_NAME, FIELD_VALIDATED, VALUE_1, VALUE_2, VALIDATION_RESULT)\n                VALUES (source.YEAR_MONTH, source.REPORT_NAME, source.FIELD_VALIDATED, source.VALUE_1, source.VALUE_2, source.VALIDATION_RESULT);\"\"\"\n\n    if insert_sql is not None:\n        cursor.execute(insert_sql, values)\n        logger.info(\"Data saved!!\")"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342410":{"id":6342410,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-528,"y":-192,"width":32,"height":32,"inputConnectorIDs":[6342413],"outputSuccessConnectorIDs":[6342416],"outputFailureConnectorIDs":[6342499],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get Month Values from BD"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\nselect_query = \"SELECT HRS, BILLAMOUNT FROM ${SNFLKDB_PDL}.STATEOFLA.STATEOFLA_MONTH_EXPECTED_VALUES\"\ncursor.execute(select_query)\nresult = cursor.fetchone()\nprint(\"Expected values\")\nprint(result)\ncontext.updateVariable(\"STATEOFLA_EXPECTED_HRS\", str(result[0]))\ncontext.updateVariable(\"STATEOFLA_EXPECTED_BILLAMOUNT\", str(result[1]))\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342411":{"id":6342411,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":237373210,"x":-683,"y":-196,"width":32,"height":32,"inputConnectorIDs":[6342420],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342496],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate Table"}}}},"visible":true},"3":{"slot":3,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKDB_PDL}"}}}},"visible":true},"4":{"slot":4,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STATEOFLA"}}}},"visible":true},"5":{"slot":5,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STATEOFLA_MONTH_EXPECTED_VALUES"}}}},"visible":true},"6":{"slot":6,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342441":{"id":6342441,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":-272,"y":-352,"width":32,"height":32,"inputConnectorIDs":[6342497,6342500],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342428],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Failure Path"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342442":{"id":6342442,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-272,"y":-192,"width":32,"height":32,"inputConnectorIDs":[6342431],"outputSuccessConnectorIDs":[6342418],"outputFailureConnectorIDs":[6342497],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Create Validation Sheet"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport calendar\nimport logging\nimport io\nfrom openpyxl import load_workbook\n\n\n# Setting up logging for better traceability\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\ns3_session = boto3.Session()\ns3_bucket_name= s3_URL.replace(\"s3:\", '').strip('/')\n\ndef create_result_sheet():\n    try:\n        current_year = stateofla_year_month[:2] # Extract first two digits \n        month_number = int(stateofla_year_month[-2:]) - 1  # Extract last two digits and convert to int\n        report_month = calendar.month_name[month_number]\n        logger.info(f\"Report month to use: {report_month} and year {current_year}\")\n        \n        # S3 parameters\n        key = f'State_Of_LA/{stateofla_year_month}/Detail by Month -{report_month}- 20{current_year}.xlsx'\n        \n        # Create S3 client\n        s3_client = s3_session.client('s3')\n        \n        # Download the file into memory\n        response = s3_client.get_object(Bucket=s3_bucket_name, Key=key)\n        file_content = response['Body'].read()\n        \n        \n        # Wrap the bytes in a BytesIO object\n        excel_file = io.BytesIO(file_content)\n\n        # Load workbook using openpyxl\n        workbook = load_workbook(excel_file)\n      \n        sheet_name = 'ReportValidation'\n\n        if sheet_name not in workbook.sheetnames:\n            # Add a new sheet\n            workbook.create_sheet(sheet_name)\n        #This else condition is for keep adding rows on each execution\n        else:\n            excel_row = workbook[sheet_name].max_row + 1\n            context.updateVariable(\"stateofla_excel_row\", excel_row)\n\t    \n        # Save the modified file\n        output_stream = io.BytesIO()\n        workbook.save(output_stream)\n\n        output_stream.seek(0)  # Reset stream position to the beginning\n\n        # Upload back to S3\n        s3_client.put_object(\n            Bucket=s3_bucket_name,\n            Key=key,  # Same key to overwrite, or a new one to save as a new file\n            Body=output_stream.getvalue()\n        )\n\n    except Exception as e:\n        logger.error(f\"Error adding sheet to control file\")\n\n\ncreate_result_sheet()"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342443":{"id":6342443,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-741198691,"x":-688,"y":-352,"width":32,"height":32,"inputConnectorIDs":[6342496],"outputSuccessConnectorIDs":[6342413],"outputFailureConnectorIDs":[6342467],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Row Count","mapTo":"audit_rowcount"},"3":{"slot":3,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"4":{"slot":4,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"5":{"slot":5,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"6":{"slot":6,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"MONTH VALUES FROM DB"}}}},"visible":true},"2":{"slot":2,"name":"Database Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Microsoft SQL Server"}}}},"visible":true},"3":{"slot":3,"name":"Connection URL","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"jdbc:jtds:sqlserver://LAWLDBP1LAS1/stateofla"}}}},"visible":true},"6":{"slot":6,"name":"Username","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"StateofLA_Update"}}}},"visible":true},"7":{"slot":7,"name":"Password","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"EcHH8tMkuzTW5bnEpHJL"}}}},"visible":true},"8":{"slot":8,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DECLARE @BegPostDt DATE = '${stateofla_begin_date}'\n  , @EndPostDt DATE = '${stateofla_end_date}'\n\n--- Account info from CRM\nSELECT p.AccountNumber ParentAccountNumber\n  , p.cda_legacyid LegacyParentAccountNumber\n  , p.Name ParentAccountName\n  , c.AccountNumber\n  , c.cda_legacyid LegacyAccountNumber\n  , c.Name AccountName\nINTO #Customer\nFROM Alias.crm.Account c\nJOIN Alias.crm.Account p\n  ON c.[ParentAccountId] = p.AccountId\n    AND p.cda_legacyid = 'CUS2909916'\nORDER BY c.cda_legacyid\n\nDECLARE @JobTitle VARCHAR(100)\n\nSET @JobTitle = ''\n\n---- #TransData\nSELECT ACTRANS.POSTING_DATE PostWEDate\n  , CUST.LegacyAccountNumber\n  , CUSTOMER = LTRIM(CUSTDESC.CUSTOMER)\n  , SEARCH_NAME CLIENTNAME\n  , ACTRANS.ACCT_UNIT ORDERBRANCH\n  , ACHISTHDR.INVOICE INVOICENUM\n  , ACHISTHDR.INVOICE_DATE\n  , ACTRANS.TRAN_DATE WORKWEDATE\n  , rtrim(substring(ACACTIVITY.ACTIVITY, 2, 30)) ACTIVITY\n  , EMPLOYEE.FIRST_NAME\n  , EMPLOYEE.LAST_NAME\n  , EMPLOYEE.[FICA_NBR] NATIONAL_ID\n  , JOB_TITLE = @JobTitle\n  , CASE \n    WHEN RTRIM(ACTRANS.ACCT_CATEGORY) IN ('510O', '520O', '51O', '51O') -- Overtime\n      THEN '510O'\n    WHEN RTRIM(ACTRANS.ACCT_CATEGORY) IN ('510R', '520R', '51R') -- Regular\n      THEN '510R'\n    ELSE 'OTHR'\n    END ACCT_CATEGORY\n  , sum(ACTRANS.TRAN_AMOUNT) PAY_AMT\n  , sum(ACTRANS.BILLABLE_UNIT) HRS\n  , sum(ACTRANS.BILLABLE_AMT) BILLABLE_AMT\n  , EMPLOYEE.EMPLOYEE\nINTO #TransData\nFROM Alias.lawson.ACTRANS AS ACTRANS \n  ---> WITH (NOLOCK, INDEX = IDXATN_SET1) This index does not exist on Law10\nJOIN Alias.lawson.ACACTIVITY AS ACACTIVITY\n  ON ACTRANS.ACTIVITY = ACACTIVITY.ACTIVITY\nJOIN #Customer CUST\n  ON CAST(ACACTIVITY.LEVEL_DETAIL_02 AS INT) = CUST.AccountNumber\nLEFT JOIN Alias.lawson.CUSTDESC AS CUSTDESC\n  ON ACACTIVITY.LEVEL_DETAIL_02 = CAST(CUSTDESC.CUSTOMER AS INT)\nLEFT JOIN (\n  SELECT E.COMPANY\n    , E.EMPLOYEE\n    , E.FICA_NBR\n    , E.LAST_NAME\n    , E.FIRST_NAME\n    , E.SHIFT\n    , E.JOB_CODE\n    , J.DESCRIPTION\n  FROM Alias.lawson.EMPLOYEE AS E\n  INNER JOIN Alias.lawson.JOBCODE AS J\n    ON E.COMPANY = J.COMPANY\n      AND E.JOB_CODE = J.JOB_CODE\n  ) AS EMPLOYEE\n  ON ACTRANS.FROM_COMPANY = EMPLOYEE.COMPANY\n    AND CAST(ACTRANS.RESOURCE_CODE AS INT) = EMPLOYEE.EMPLOYEE\nLEFT JOIN (\n  SELECT max(OBJ_ID) OBJ_ID\n    , PT_ACTIVITY\n    , (\n      cast((\n          CASE \n            WHEN datename(dw, TRAN_DATE) = 'sunday'\n              THEN cast(CONVERT(CHAR(10), TRAN_DATE, 110) AS DATETIME)\n            ELSE cast(convert(CHAR(10), (7 - datepart(dw, cast(TRAN_DATE AS DATETIME) - 1) + TRAN_DATE\n                    ), 110) AS DATETIME)\n            END\n          ) AS DATETIME)\n      ) TRAN_DATE\n  FROM Alias.lawson.ACHISTDTL WITH (\n      NOLOCK\n      , INDEX = IDXHDT_PT_ACTIVITY\n      )\n  GROUP BY PT_ACTIVITY\n    , (\n      cast((\n          CASE \n            WHEN datename(dw, TRAN_DATE) = 'sunday'\n              THEN cast(CONVERT(CHAR(10), TRAN_DATE, 110) AS DATETIME)\n            ELSE cast(convert(CHAR(10), (7 - datepart(dw, cast(TRAN_DATE AS DATETIME) - 1) + TRAN_DATE\n                    ), 110) AS DATETIME)\n            END\n          ) AS DATETIME)\n      )\n  ) ACHISTDTL\n  ON ACTRANS.ACTIVITY = ACHISTDTL.PT_ACTIVITY\n    AND cast((\n        CASE \n          WHEN datename(dw, ACTRANS.TRAN_DATE) = 'sunday'\n            THEN cast(CONVERT(CHAR(10), ACTRANS.TRAN_DATE, 110) AS DATETIME)\n          ELSE cast(convert(CHAR(10), (7 - datepart(dw, cast(ACTRANS.TRAN_DATE AS DATETIME) - 1) + ACTRANS.TRAN_DATE\n                  ), 110) AS DATETIME)\n          END\n        ) AS DATETIME) = ACHISTDTL.TRAN_DATE\nLEFT JOIN Alias.lawson.ACHISTHDR ACHISTHDR\n  ON ACHISTDTL.OBJ_ID = ACHISTHDR.OBJ_ID\nWHERE ACTRANS.POSTING_DATE >= @BegPostDt\n  AND ACTRANS.POSTING_DATE <= @EndPostDt\n  AND ACTRANS.ACCOUNT IN (5100, 5950)\nGROUP BY ACTRANS.POSTING_DATE\n  , LTRIM(CUSTDESC.CUSTOMER)\n  , ACTRANS.ACCT_UNIT\n  , ACTRANS.TRAN_DATE\n  , ACACTIVITY.ACTIVITY\n  , EMPLOYEE.FIRST_NAME\n  , EMPLOYEE.LAST_NAME\n  , EMPLOYEE.[FICA_NBR]\n  , UPPER(LEFT(ACACTIVITY.DESCRIPTION, 15))\n  , CASE \n    WHEN RTRIM(ACTRANS.ACCT_CATEGORY) IN ('510O', '520O', '51O', '51O') -- Overtime\n      THEN '510O'\n    WHEN RTRIM(ACTRANS.ACCT_CATEGORY) IN ('510R', '520R', '51R') -- Regular\n      THEN '510R'\n    ELSE 'OTHR'\n    END\n  , SEARCH_NAME\n  , ACHISTHDR.INVOICE\n  , ACHISTHDR.INVOICE_DATE\n  , CUST.LegacyAccountNumber\n  , EMPLOYEE.EMPLOYEE\nORDER BY ACACTIVITY.ACTIVITY\n  , EMPLOYEE.FIRST_NAME\n  , EMPLOYEE.LAST_NAME\n\n--\t#NAME?\nSELECT DISTINCT cda_AssignmentNumber\n  , cda_jobtitle\nINTO #AsgnJobTitle\nFROM Alias.crm.cda_assignment a\nJOIN #TransData b\n  ON a.cda_AssignmentNumber COLLATE Latin1_General_BIN = b.ACTIVITY COLLATE Latin1_General_BIN\n\n--\t#NAME?\nUPDATE b\nSET JOB_TITLE = a.cda_jobtitle\nFROM #AsgnJobTitle a\nJOIN #TransData b\n  ON a.cda_AssignmentNumber COLLATE Latin1_General_BIN = b.ACTIVITY COLLATE Latin1_General_BIN\n\n--- #TransData_2\nSELECT cast((\n      CASE \n        WHEN datename(dw, PostWEDate) = 'sunday'\n          THEN cast(CONVERT(CHAR(10), PostWEDate, 110) AS DATETIME)\n        ELSE cast(convert(CHAR(10), (7 - datepart(dw, cast(PostWEDate AS DATETIME) - 1) + PostWEDate\n                ), 110) AS DATETIME)\n        END\n      ) AS DATETIME) POSTWEDATE\n  , LegacyAccountNumber\n  , CUSTOMER\n  , CLIENTNAME\n  , ORDERBRANCH\n  , INVOICENUM\n  , INVOICE_DATE\n  , WORKWEDATE\n  , FIRST_NAME\n  , LAST_NAME\n  , NATIONAL_ID\n  , JOB_TITLE\n  , ACCT_CATEGORY\n  , sum(PAY_AMT) PAY_AMT\n  , SUM(HRS) HRS\n  , SUM(BILLABLE_AMT) BILLABLE_AMT\n  , EMPLOYEE\nINTO #TransData_2\nFROM #TransData\nGROUP BY cast((\n      CASE \n        WHEN datename(dw, PostWEDate) = 'sunday'\n          THEN cast(CONVERT(CHAR(10), PostWEDate, 110) AS DATETIME)\n        ELSE cast(convert(CHAR(10), (7 - datepart(dw, cast(PostWEDate AS DATETIME) - 1) + PostWEDate\n                ), 110) AS DATETIME)\n        END\n      ) AS DATETIME)\n  , CUSTOMER\n  , CLIENTNAME\n  , ORDERBRANCH\n  , WORKWEDATE\n  , FIRST_NAME\n  , LAST_NAME\n  , NATIONAL_ID\n  , JOB_TITLE\n  , ACCT_CATEGORY\n  , INVOICENUM\n  , INVOICE_DATE\n  , LegacyAccountNumber\n  , EMPLOYEE\nORDER BY LAST_NAME\n\nSELECT \n\tSUM(HRS) \n\tHRS, SUM(BILLABLE_AMT) BILLAMOUNT\nFROM #TransData_2\n"}}}},"visible":true},"9":{"slot":9,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKDB_PDL}"}}}},"visible":true},"11":{"slot":11,"name":"Connection Options","elements":{},"visible":true},"12":{"slot":12,"name":"Concurrency","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"2"}}}},"visible":false},"13":{"slot":13,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STATEOFLA"}}}},"visible":true},"14":{"slot":14,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STATEOFLA_MONTH_EXPECTED_VALUES"}}}},"visible":true},"15":{"slot":15,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"16":{"slot":16,"name":"S3 Staging Area","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"17":{"slot":17,"name":"Primary Keys","elements":{},"visible":true},"20":{"slot":20,"name":"Data Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"101":{"slot":101,"name":"Basic/Advanced Mode","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Advanced"}}}},"visible":true},"102":{"slot":102,"name":"Data Source","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"103":{"slot":103,"name":"Data Selection","elements":{},"visible":false},"104":{"slot":104,"name":"Data Source Filter","elements":{},"visible":false},"105":{"slot":105,"name":"Combine Filters","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":false},"106":{"slot":106,"name":"Limit","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"100"}}}},"visible":false},"1001":{"slot":1001,"name":"","elements":{},"visible":false},"1992":{"slot":1992,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"1993":{"slot":1993,"name":"Use Accelerated Endpoint","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"1994":{"slot":1994,"name":"Stage","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"1995":{"slot":1995,"name":"Stage Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"1996":{"slot":1996,"name":"Stage Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"1997":{"slot":1997,"name":"New Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"1998":{"slot":1998,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"1999":{"slot":1999,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"2000":{"slot":2000,"name":"Type","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Standard"}}}},"visible":true},"40000":{"slot":40000,"name":"Encryption","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"None"}}}},"visible":false},"40001":{"slot":40001,"name":"KMS Key ID","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"40501":{"slot":40501,"name":"","elements":{},"visible":false},"40502":{"slot":40502,"name":"Load Options","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"On"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"Off"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"Off"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":""}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"On"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"Gzip"}}}},"visible":true},"63319":{"slot":63319,"name":"Stage Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Credentials"}}}},"visible":false},"63320":{"slot":63320,"name":"Storage Account","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"63321":{"slot":63321,"name":"Blob Container","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"63322":{"slot":63322,"name":"Storage Integration","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"84533":{"slot":84533,"name":"Integration","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"88340":{"slot":88340,"name":"","elements":{},"visible":false},"88341":{"slot":88341,"name":"Staging","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Snowflake Managed"}}}},"visible":true},"88342":{"slot":88342,"name":"Stage Authentication","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Credentials"}}}},"visible":false},"88343":{"slot":88343,"name":"Storage Integration","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"88344":{"slot":88344,"name":"Use Accelerated Endpoint","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"False"}}}},"visible":false},"88345":{"slot":88345,"name":"Stage","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Custom]"}}}},"visible":true},"98776":{"slot":98776,"name":"GCS Staging Area","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342444":{"id":6342444,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":560,"y":-352,"width":32,"height":32,"inputConnectorIDs":[6342430],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342424],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update Current Status -1"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\nselect_query = \"UPDATE ${SNFLKDB_PDL}.STATEOFLA.CONFIG_DATE_RANGES SET CURRENT_STATUS_ID = -1 WHERE YEAR_MONTH = ${stateofla_year_month}\"\ncursor.execute(select_query)\nresult = cursor.fetchone()\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342445":{"id":6342445,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-400,"y":-352,"width":32,"height":32,"inputConnectorIDs":[6342427],"outputSuccessConnectorIDs":[6342412],"outputFailureConnectorIDs":[6342500],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Get Month Values"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import logging\nimport boto3\nimport io\nimport calendar\nimport pandas as pd\n\n\n# Setting up logging for better traceability\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\n\n# AWS variables\ns3_session = boto3.Session()\ns3 = s3_session.resource('s3')\ns3_bucket_name= s3_URL.replace(\"s3:\", '').strip('/')\n\ndef read_expected_values_from_excel():\n    try:\n        \n        current_year = stateofla_year_month[:2] # Extract first two digits \n        month_number = int(stateofla_year_month[-2:]) - 1  # Extract last two digits and convert to int\n        report_month = calendar.month_name[month_number]\n\n        # Report month name\n        logger.info(f\"Report month to use: {report_month} and year {current_year}\")\n        # S3 parameters\n        key = f'State_Of_LA/{stateofla_year_month}/Detail by Month -{report_month}- 20{current_year}.xlsx'\n        logger.info(f\"S3 Key: {key}\")\n\n        # Create S3 client\n        s3_client = s3_session.client('s3')\n        \n        # Download the file into memory\n        response = s3_client.get_object(Bucket=s3_bucket_name, Key=key)\n        file_content = response['Body'].read()\n\n        # Wrap the bytes in a BytesIO object\n        excel_file = io.BytesIO(file_content)\n\n        # Read the Excel file\n        df = pd.read_excel(excel_file, sheet_name='YTD', engine='openpyxl')\n       \n        cell_value =  df.iloc[0, 6]\n        context.updateVariable(\"STATEOFLA_EXPECTED_HRS\", cell_value)\n        cell_value =  df.iloc[0, 7]\n        context.updateVariable(\"STATEOFLA_EXPECTED_BILLAMOUNT\", cell_value)\n        \n        \n        logger.info(f\"Expected Values HRS: [{STATEOFLA_EXPECTED_HRS}] and BILLAMOUNT Value : [{STATEOFLA_EXPECTED_BILLAMOUNT}] to check\")\n        result = True\n        if STATEOFLA_EXPECTED_HRS > 0 and STATEOFLA_EXPECTED_BILLAMOUNT > 0:\n            logger.info(\"Everything is AWESOME!!\")\n        else:\n            logger.info(f\"Please put the HRS and BILLAMOUNT Expected in the Excel file and load it to S3 in the path: {s3_bucket_name}/{key}!!\")\n        \n    except Exception as e:\n        raise Exception(f\"Error reading the Excel control file: {str(e)}\")\n\n      \nread_expected_values_from_excel()"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342446":{"id":6342446,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":368,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6342417],"outputSuccessConnectorIDs":[6342419],"outputFailureConnectorIDs":[6342465],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Validate report"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport xlrd\nimport logging\nimport numpy as np\nimport ast\nimport io\nimport calendar\nfrom openpyxl import load_workbook\n\ns3_session = boto3.Session()\ns3_bucket_name= s3_URL.replace(\"s3:\", '').strip('/')\n\n\n# Setting up logging for better traceability\nlogging.basicConfig(level=logging.INFO)\nlogger = logging.getLogger(__name__)\nlogger.info(\"Data Setted\")\n\noutput_data = []\n\ndef add_report_result(data):\n    try:\n        logger.info(\"Data to add:{data}\")\n        output_data.append(str(data))\n        logger.info(\"Adding value\")\n        current_year = stateofla_year_month[:2] # Extract first two digits \n        month_number = int(stateofla_year_month[-2:]) - 1  # Extract last two digits and convert to int\n        report_month = calendar.month_name[month_number]\n        logger.info(f\"Report month to use: {report_month} and year {current_year}\")\n        \n        # S3 parameters\n        key = f'State_Of_LA/{stateofla_year_month}/Detail by Month -{report_month}- 20{current_year}.xlsx'\n        \n        # Create S3 client\n        s3_client = s3_session.client('s3')\n        \n        # Download the file into memory\n        response = s3_client.get_object(Bucket=s3_bucket_name, Key=key)\n        file_content = response['Body'].read()\n\n         # Wrap the bytes in a BytesIO object\n        excel_file = io.BytesIO(file_content)\n\n        # Load workbook using openpyxl\n        workbook = load_workbook(excel_file)\n        \n        sheet_name = 'ReportValidation'\n        sheet = workbook[sheet_name]\n        \n        for value, col in data:\n        \tlogger.info(f\"row: {stateofla_excel_row}, col: {col}, value: {value}\")  \n        \tsheet.cell(row=stateofla_excel_row, column=col, value=value)\n\n        excel_row = stateofla_excel_row + 1\n        context.updateVariable(\"stateofla_excel_row\", excel_row)\n        \n        # Save the modified file\n        output_stream = io.BytesIO()\n        workbook.save(output_stream)\n\n        output_stream.seek(0)  # Reset stream position to the beginning\n\n        # Upload back to S3\n        s3_client.put_object(\n            Bucket=s3_bucket_name,\n            Key=key,  # Same key to overwrite, or a new one to save as a new file\n            Body=output_stream.getvalue()\n        )\n    except Exception as e:\n        logger.error(f\"Error adding result to output file {e}\")\n        return False\n\n\ndef update_constant_values(report_name, row, col, value):\n    if report_name == 'MthEmpl_EBRLA' and col == 7:\n        context.updateVariable(\"STATEOFLA_EXPECTED_BILL_ST_HRS\", value) \n    if report_name == 'MthEmpl_EBRLA' and col == 9:\n        context.updateVariable(\"STATEOFLA_EXPECTED_BILL_OT_HRS\", value)  \n    if report_name == 'YTDByCust_CJS' and col == 13:\n        context.updateVariable(\"STATEOFLA_YTD_HOURS\", value) \n    if report_name == 'YTDByCust_CJS' and col == 17:\n        context.updateVariable(\"STATEOFLA_YTD_BILLAMOUNT\", value)  \n    if report_name == 'YTDEmpl_EBRLA' and col == 11:\n        context.updateVariable(\"STATEOFLA_YTD_BILL_ST_HRS\", value)\n    if report_name == 'YTDEmpl_EBRLA' and col == 17:\n        context.updateVariable(\"STATEOFLA_YTD_BILL_OT_HRS\", value)\n\n\ndef value_comparison(filename, cell_row_col, constant_name, sheet_number):\n    data = []\n    try:\n        # S3 parameters\n        key = f'State_Of_LA/{stateofla_year_month}/Excel/{filename}.xls'\n\n        # Create S3 client\n        s3_client = s3_session.client('s3')\n        \n        # Download the file into memory\n        response = s3_client.get_object(Bucket=s3_bucket_name, Key=key)\n        file_content = response['Body'].read()\n\n        # Open the workbook from bytes\n        workbook = xlrd.open_workbook(file_contents=file_content)\n        \n        ## Get the last sheet by index\n        last_sheet = workbook.nsheets - 1\n        if sheet_number != last_sheet:\n            sheet_number = last_sheet\n        worksheet = workbook.sheet_by_index(sheet_number)\n        report_col = 2\n        data.append((filename, 1))\n        data.append((constant_name, 2))\n        cell_array = np.array(cell_row_col)\n        logger.info(f\"CELL ARRAY: {cell_array}\")\n        value_to_check = 0\n        for cell in cell_array:\n            report_col = report_col + 1\n            last_row = worksheet.nrows - 1\n            #This report has one more line that the others, so we need to remove it\n            if filename == 'MthEmpl_EBR':\n                last_row = last_row -1 \n            row = cell[0]\n            if row != last_row:\n                row = last_row\n            col = cell[1]\n            cell_value = worksheet.cell(row, col).value\n            logger.info(f\"Value: {cell_value}\")\n            value_to_check = value_to_check + cell_value if isinstance(cell_value, (int, float)) else 0\n            if value_to_check:\n                value_to_check = round(value_to_check,2)\n                logger.info(f\"Round Value: {value_to_check}\")\n            data.append((round(cell_value,2), report_col))\n            update_constant_values(filename, row, col, round(cell_value,2))\n        logger.info(f\"Constant name: {constant_name}\")\n        environment_variable_constant_prefix = 'STATEOFLA_'\n        EXPECTED_VALUE = globals().get(environment_variable_constant_prefix+constant_name)\n        logger.info(f\"Expected Value: {EXPECTED_VALUE} vs. Value to check: {value_to_check}\")\n        result = True\n        if float(value_to_check) == float(EXPECTED_VALUE):\n            logger.info(\"Everything is AWESOME!!\")\n        else:\n            logger.info(\"HOUSTON.... we have a problem!!\")\n            result = False\n        data.append((result, report_col+1))\n        add_report_result(data)\n        return result\n    except Exception as e:\n        logger.error(f\"Error in value_comparison function: {str(e)}\")\n        return False\n\n\ndef validation_process(report_name):\n    cell_list = ast.literal_eval(cell_validation)\n    sheet_number = 1\n    result = True\n    logger.info(f\"REPORT: {report_name} validation:\")\n    logger.info(f\"CELL: {cell_list}\")\n    if cell_list:\n        cell_row_col_list, value_name_list = zip(*cell_list)\n        for cell_row_col, value_name in zip(cell_row_col_list, value_name_list):\n            logger.info(f\"Checking value at CELL: {cell_row_col}, CONSTANT: {value_name}\")\n            result = result and value_comparison(report_name, cell_row_col, value_name, sheet_number)\n    logger.info(f\"OUPUT DATA: {output_data}\")\n    context.updateVariable(\"stateofla_data_result\", str(output_data))\n    if result:\n        logger.info(f\"RESULT: Correct!!\")\n    else:\n        raise Exception(f\"RESULT: With Errors!!\")\n\nreport_name = stateofla_report_name\nvalidation_process(report_name)\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342447":{"id":6342447,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":-272,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6342418,6342423],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342429],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Validation Path"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342448":{"id":6342448,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"CONDITIONAL","executionHint":"FLOW","implementationID":-1357378929,"x":-688,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6342425],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[6342420],"outputFalseConnectorIDs":[6342423],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"HRS = 0 or BILLAMOUNT = 0"}}}},"visible":true},"2":{"slot":2,"name":"Mode","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Simple"}}}},"visible":true},"3":{"slot":3,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STATEOFLA_EXPECTED_HRS"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"0"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"STATEOFLA_EXPECTED_BILLAMOUNT"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Equal to"},"4":{"slot":4,"type":"STRING","value":"0"}}}},"visible":true},"4":{"slot":4,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or"}}}},"visible":true},"5":{"slot":5,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342449":{"id":6342449,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":720,"y":80,"width":32,"height":32,"inputConnectorIDs":[6342426],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Success 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6342450":{"id":6342450,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":272,"y":-352,"width":32,"height":32,"inputConnectorIDs":[6342428,6342464,6342465,6342466,6342498],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6342430],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Failure Path 1"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6342412":{"id":6342412,"sourceID":6342445,"targetID":6342408},"6342413":{"id":6342413,"sourceID":6342443,"targetID":6342410},"6342414":{"id":6342414,"sourceID":6342409,"targetID":6342401},"6342415":{"id":6342415,"sourceID":6342403,"targetID":6342406},"6342416":{"id":6342416,"sourceID":6342410,"targetID":6342408},"6342417":{"id":6342417,"sourceID":6342406,"targetID":6342446},"6342418":{"id":6342418,"sourceID":6342442,"targetID":6342447},"6342419":{"id":6342419,"sourceID":6342446,"targetID":6342409}},"failureConnectors":{"6342464":{"id":6342464,"sourceID":6342409,"targetID":6342450},"6342465":{"id":6342465,"sourceID":6342446,"targetID":6342450},"6342466":{"id":6342466,"sourceID":6342403,"targetID":6342450},"6342467":{"id":6342467,"sourceID":6342443,"targetID":6342407},"6342497":{"id":6342497,"sourceID":6342442,"targetID":6342441},"6342498":{"id":6342498,"sourceID":6342406,"targetID":6342450},"6342499":{"id":6342499,"sourceID":6342410,"targetID":6342407},"6342500":{"id":6342500,"sourceID":6342445,"targetID":6342441}},"unconditionalConnectors":{"6342424":{"id":6342424,"sourceID":6342444,"targetID":6342402},"6342425":{"id":6342425,"sourceID":6342404,"targetID":6342448},"6342426":{"id":6342426,"sourceID":6342401,"targetID":6342449},"6342427":{"id":6342427,"sourceID":6342407,"targetID":6342445},"6342428":{"id":6342428,"sourceID":6342441,"targetID":6342450},"6342429":{"id":6342429,"sourceID":6342447,"targetID":6342405},"6342430":{"id":6342430,"sourceID":6342450,"targetID":6342444},"6342431":{"id":6342431,"sourceID":6342408,"targetID":6342442},"6342496":{"id":6342496,"sourceID":6342411,"targetID":6342443}},"trueConnectors":{"6342420":{"id":6342420,"sourceID":6342448,"targetID":6342411},"6342421":{"id":6342421,"sourceID":6342405,"targetID":6342403}},"falseConnectors":{"6342422":{"id":6342422,"sourceID":6342405,"targetID":6342401},"6342423":{"id":6342423,"sourceID":6342448,"targetID":6342447}},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"cell_validation":{"definition":{"name":"cell_validation","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""},"ssrs_password":{"definition":{"name":"ssrs_password","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"yr^WZi93*kBdKml"},"ssrs_username":{"definition":{"name":"ssrs_username","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"Work\\svc_SSRS_reports"}},"grids":{}},"info":{"name":"jb_State_of_LA_Report_Download_and_Validation","description":"","type":"ORCHESTRATION","tag":"5a235a15-d1c2-4666-a243-5a3fda0c69b8"}}