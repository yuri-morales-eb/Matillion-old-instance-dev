{"job":{"components":{"6336194":{"id":6336194,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":144,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336162],"outputSuccessConnectorIDs":[6336160],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Fetch_Dts"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\ncursor = context.cursor()\n#cursor.execute(\"SELECT TO_TIMESTAMP_NTZ(TO_DATE('2020-04-06') -7)\")\ncursor.execute(\"select TO_TIMESTAMP_NTZ(min(norm_posting_date) -6) from dim_calendar_format where substring(NORM_POSTING_DATE,1,4) in (select extract(year from (current_date)))\")\nresult = cursor.fetchone()\ncontext.updateVariable(\"StartPostingDT\", (result[0]))\n\nprint StartPostingDT\n\n\n#cursor.execute(\"SELECT TO_TIMESTAMP_NTZ(TO_DATE('2020-04-06') -1)\")\ncursor.execute(\"SELECT TO_TIMESTAMP_NTZ(CURRENT_DATE - DATE_PART(DW,CURRENT_DATE)-7)\")\nresult = cursor.fetchone()\ncontext.updateVariable(\"EndPostingDT\", (result[0]))\n\nprint EndPostingDT"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336195":{"id":6336195,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":432,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336161],"outputSuccessConnectorIDs":[6336200],"outputFailureConnectorIDs":[6336163],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"YTD_CLIENT_BILLING"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\n\n\n\nimport time\nimport datetime\n\n\n\nst = datetime.datetime.fromtimestamp(time.time()).strftime('%Y%m%d%H%M%S')\n\ncontext.updateVariable(\"filetimestamp\",st)\n\ncursor = context.cursor()\ncursor.execute('SELECT COUNT(*) FROM ${NPG_ENV_DB}.${NPG_ENV_SCH}.YTD_Client_Billing')\nrowcount = cursor.fetchone()[0]\ncontext.updateVariable(\"audit_rowcount\",rowcount)\n#print(audit_rowcount);\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336196":{"id":6336196,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":-64,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336162],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336197":{"id":6336197,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":288,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336160],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336161],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"TableLoad"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DELETE FROM ${NPG_ENV_DB}.${NPG_ENV_SCH}.YTD_Client_Billing;\n\nINSERT INTO ${NPG_ENV_DB}.${NPG_ENV_SCH}.YTD_Client_Billing\n(\n\t\t\t   ACCT_UNIT,\n\t\t\t   POSTING_DATE,\n\t\t\t   CUSTOMER,\n\t\t\t   NAME,\n\t\t\t   BILL_HRS,\n\t\t\t   TOTAL_SALES,\n\t\t\t   GROSS_PROFIT,\n               DL_CREATED_DATE,\n               DL_CREATEDBY,\n               DL_JOBID\n)\nSELECT \n  distinct ACTRANS.ACCT_UNIT, \n  CASE WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 7 THEN dateadd(day, 1, ACTRANS.posting_date)\n  \t   WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 6 THEN dateadd(day, 2, ACTRANS.posting_date)\n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 5 THEN dateadd(day, 3, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 4 THEN dateadd(day, 4, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 3 THEN dateadd(day, 5, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 2 THEN dateadd(day, 6, ACTRANS.posting_date) \n       ELSE ACTRANS.posting_date END AS POSTWEDATE, \n  ARCUSTOMER.CUSTOMER CUSTID, \n  CUSTDESC.NAME CUSTNAME, \n  sum(BILL_HRS) BILLHRS, \n  SUM(TOTAL_SALES) SALES, \n  SUM(GROSS_PROFIT) MARGIN,\n  CAST(CURRENT_TIMESTAMP AS TIMESTAMP_NTZ) ,\n  CAST('${environment_username}' as  VARCHAR(50)) ,\n  CAST('${run_history_id}' as VARCHAR(50))\n from \n (select distinct * from ${SNFLKDB}.${SNFLKSCH}.VW_ZZZ_ACTRANS) ACTRANS \n  INNER JOIN (\n    SELECT \n      * \n    FROM \n      ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_ACACTIVITY_PH3 QUALIFY ROW_NUMBER() OVER(\n        PARTITION BY ACTIVITY \n        ORDER BY \n          DL_CREATED_DATE DESC\n      )= 1\n  ) ACACTIVITY ON ACTRANS.ACTIVITY = ACACTIVITY.ACTIVITY \n  INNER JOIN ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_ARCUSTOMER ARCUSTOMER ON ACACTIVITY.LEVEL_DETAIL_02 = CAST(\n    ARCUSTOMER.CUSTOMER AS NUMBER(10)\n  ) \n  INNER JOIN ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_CUSTDESC CUSTDESC ON ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER \nWHERE \n  TO_TIMESTAMP(ACTRANS.POSTING_DATE) >= '${StartPostingDT}' AND TO_TIMESTAMP(ACTRANS.POSTING_DATE) <='${EndPostingDT}'\n  AND ACTRANS.ACCT_UNIT NOT LIKE '5%' \n  AND ACTRANS.ACCT_UNIT NOT LIKE '13%' \n  AND ACTRANS.ACCT_UNIT NOT LIKE ('21%') \n  AND ACTRANS.ACCT_UNIT NOT IN ('70545', '70510') \nGROUP BY \n  ACTRANS.ACCT_UNIT, \n  CASE WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 7 THEN dateadd(day, 1, ACTRANS.posting_date)\n  \t   WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 6 THEN dateadd(day, 2, ACTRANS.posting_date)\n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 5 THEN dateadd(day, 3, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 4 THEN dateadd(day, 4, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 3 THEN dateadd(day, 5, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 2 THEN dateadd(day, 6, ACTRANS.posting_date) \n       ELSE ACTRANS.posting_date END, \n  ARCUSTOMER.CUSTOMER, \n  CUSTDESC.NAME \n  \n/*UNION \n\nselect \n  distinct ACTRANS.ACCT_UNIT, \n  CASE WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 7 THEN dateadd(day, 1, ACTRANS.posting_date)\n  \t   WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 6 THEN dateadd(day, 2, ACTRANS.posting_date)\n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 5 THEN dateadd(day, 3, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 4 THEN dateadd(day, 4, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 3 THEN dateadd(day, 5, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 2 THEN dateadd(day, 6, ACTRANS.posting_date) \n       ELSE ACTRANS.posting_date END AS POSTWEDATE, \n  ARCUSTOMER.CUSTOMER CUSTID, \n  CUSTDESC.NAME CUSTNAME, \n  sum(BILL_HRS) BILLHRS, \n  SUM(TOTAL_SALES) SALES, \n  SUM(GROSS_PROFIT) MARGIN,\n  CAST(CURRENT_TIMESTAMP AS TIMESTAMP_NTZ) ,\n  CAST('${environment_username}' as  VARCHAR(50)) ,\n  CAST('${run_history_id}' as VARCHAR(50))\n from \n  ${NPG_ENV_DB}.${NPG_ENV_SCH}.VW_ZZZ_ACTRANS_FRANA ACTRANS \n  INNER JOIN (\n    SELECT \n      * \n    FROM \n      ${NPG_ENV_DB}.${NPG_ENV_SCH}.LAWSON_FRANA_DL_LDG_ACACTIVITY QUALIFY ROW_NUMBER() OVER(\n        PARTITION BY ACTIVITY \n        ORDER BY \n          DL_CREATED_DATE DESC\n      )= 1\n  ) ACACTIVITY ON ACTRANS.ACTIVITY = ACACTIVITY.ACTIVITY \n  INNER JOIN ${NPG_ENV_DB}.${NPG_ENV_SCH}.LAWSON_FRANA_DL_LDG_ARCUSTOMER ARCUSTOMER ON ACACTIVITY.LEVEL_DETAIL_02 = CAST(\n    ARCUSTOMER.CUSTOMER AS NUMBER(10)\n  ) \n  INNER JOIN ${NPG_ENV_DB}.${NPG_ENV_SCH}.LAWSON_FRANA_DL_LDG_CUSTDESC CUSTDESC ON ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER \nWHERE \n   TO_TIMESTAMP(ACTRANS.POSTING_DATE) >='${StartPostingDT}' AND TO_TIMESTAMP(ACTRANS.POSTING_DATE) <='${EndPostingDT}'\n  AND ACTRANS.ACCT_UNIT NOT LIKE '5%' \n  AND ACTRANS.ACCT_UNIT NOT LIKE '13%' \n  AND ACTRANS.ACCT_UNIT NOT LIKE ('21%') \n  AND ACTRANS.ACCT_UNIT NOT IN ('70545', '70510') \nGROUP BY \n  ACTRANS.ACCT_UNIT, \n  CASE WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 7 THEN dateadd(day, 1, ACTRANS.posting_date)\n  \t   WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 6 THEN dateadd(day, 2, ACTRANS.posting_date)\n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 5 THEN dateadd(day, 3, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 4 THEN dateadd(day, 4, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 3 THEN dateadd(day, 5, ACTRANS.posting_date) \n       WHEN date_part(dw, ACTRANS.posting_date)+ 1 = 2 THEN dateadd(day, 6, ACTRANS.posting_date) \n       ELSE ACTRANS.posting_date END, \n  ARCUSTOMER.CUSTOMER, \n  CUSTDESC.NAME*/;                     "}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336198":{"id":6336198,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":592,"y":-144,"width":32,"height":32,"inputConnectorIDs":[6336200],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit_YTD_CLIENT_BILLING_SUCCESS"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit_YTD_Client_Billing"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336199":{"id":6336199,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":592,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6336163],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit_YTD_CLIENT_BILLING_FAILURE"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit_YTD_Client_Billing"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6336160":{"id":6336160,"sourceID":6336194,"targetID":6336197},"6336200":{"id":6336200,"sourceID":6336195,"targetID":6336198}},"failureConnectors":{"6336163":{"id":6336163,"sourceID":6336195,"targetID":6336199}},"unconditionalConnectors":{"6336161":{"id":6336161,"sourceID":6336197,"targetID":6336195},"6336162":{"id":6336162,"sourceID":6336196,"targetID":6336194}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"EndPostingDT":{"definition":{"name":"EndPostingDT","type":"DATETIME","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":""},"StartPostingDT":{"definition":{"name":"StartPostingDT","type":"DATETIME","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"jb_YTD_CLIENT_BILLING","description":"","type":"ORCHESTRATION","tag":"53ed1b3c-e160-40fb-8848-57b0da48e271"}}