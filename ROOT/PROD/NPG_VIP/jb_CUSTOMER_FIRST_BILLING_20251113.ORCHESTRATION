{"job":{"components":{"6336229":{"id":6336229,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":48,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336246],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336245],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Begin"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_Begin"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"RUNNING"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336230":{"id":6336230,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":960,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336244],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Success"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336231":{"id":6336231,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":160,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336245],"outputSuccessConnectorIDs":[6336240],"outputFailureConnectorIDs":[6336202],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Fetch_InvoiceDts"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\ncursor = context.cursor()\ncursor.execute(\"SELECT TO_TIMESTAMP_NTZ(CURRENT_DATE - DATE_PART(DW,CURRENT_DATE)-6)\")\nresult = cursor.fetchone()\ncontext.updateVariable(\"BeginInvoiceDt\", (result[0]))\n\nprint BeginInvoiceDt\n\ncursor.execute(\"SELECT TO_TIMESTAMP_NTZ(CURRENT_DATE - DATE_PART(DW,CURRENT_DATE))\")\nresult = cursor.fetchone()\ncontext.updateVariable(\"EndInvoiceDt\", (result[0]))\n\nprint EndInvoiceDt"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336232":{"id":6336232,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":848,"y":-208,"width":32,"height":32,"inputConnectorIDs":[6336247],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336233":{"id":6336233,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":640,"y":-208,"width":32,"height":32,"inputConnectorIDs":[6336248],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336247],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Failure"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_End"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"FAILURE"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"audit_rowcount"},"2":{"slot":2,"type":"STRING","value":"0"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336234":{"id":6336234,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":384,"y":-208,"width":32,"height":32,"inputConnectorIDs":[6336201,6336202,6336249,6336250],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336248],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Failure Path"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336235":{"id":6336235,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-112,"y":-64,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336246],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336236":{"id":6336236,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":592,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336242],"outputSuccessConnectorIDs":[6336243],"outputFailureConnectorIDs":[6336249],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"2":{"slot":2,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"},"3":{"slot":3,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Row Count","mapTo":"audit_rowcount1"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"TargetLoadSalesforceUpdate"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"UPDATE ${NPG_ENV_DB}.${NPG_ENV_SCH}.CUSTOMER_FIRST_BILLING CFB \n SET CFB.ACCOUNT_TYPE = ACT.ACCOUNT_TYPE,\n     CFB.NPG_OPS_MGR_1 = ACT.NPG_OPS_MGR_1,\n     CFB.NPG_OPS_MGR_2 = ACT.NPG_OPS_MGR_2,\n     CFB.SPS_SPEC_1 = ACT.SPS_SPEC_1,\n     CFB.SPS_SPEC_2 = ACT.SPS_SPEC_2,\n     CFB.VIP_DIR = ACT.VIP_DIR\n FROM (SELECT DISTINCT B.ACCOUNTNUMBER,\n                  B.ACCOUNT_TYPE,\n                  MAX(NPG_OPS_MGR_1) AS  NPG_OPS_MGR_1,\n                  MAX(NPG_OPS_MGR_2) AS  NPG_OPS_MGR_2,\n                  MAX(SPS_SPEC_1) AS  SPS_SPEC_1,\n                  MAX(SPS_SPEC_2) AS  SPS_SPEC_2,\n                  MAX(VIP_DIR) AS  VIP_DIR\n          FROM\n          (SELECT DISTINCT\n              ACCOUNTNUMBER,\n              ACCOUNT_TYPE,\n              CASE WHEN TITLE = 'NPG Ops Manager' AND ROWNUMBER = 1 THEN Name END AS NPG_OPS_MGR_1,\n              CASE WHEN TITLE = 'NPG Ops Manager' AND ROWNUMBER = 2 THEN Name END AS NPG_OPS_MGR_2,\n              CASE WHEN TITLE = 'SPS Specialist'  AND ROWNUMBER = 1 THEN Name END AS SPS_SPEC_1,\n              CASE WHEN TITLE = 'SPS Specialist'  AND ROWNUMBER = 2 THEN Name END AS SPS_SPEC_2,\n              CASE WHEN TITLE = 'VIP Sales Director' THEN NAME END AS VIP_DIR\n          FROM\n              (SELECT DISTINCT\n                      ACCOUNTNUMBER\n                      ,NAME\n                      ,ACCOUNT_TYPE\n                      ,TITLE\n                      ,row_number() over (PARTITION BY ACCOUNTNUMBER, ACCOUNT_TYPE, TITLE ORDER BY ACCOUNTNUMBER, ACCOUNT_TYPE, NAME, TITLE) AS ROWNUMBER\n          FROM(\n                  SELECT DISTINCT\n                  b.ACCOUNTNUMBER\n                  ,CONCAT (d.FIRSTNAME||' '||d.LASTNAME) AS NAME\n                  ,c.ACCOUNT_TYPE\n                  ,a.TEAMMEMBERROLE as Title\n                  FROM PROD_DATALAKE.SALESFORCE.ACCOUNTTEAMMEMBER a\n                  LEFT JOIN PROD_DATALAKE.SALESFORCE.ACCOUNT b on a.ACCOUNTID = b.ID\n                  LEFT JOIN PROD_ENTERPRISE.FINANCE.SALESFORCEACCOUNTTYPETRACKING c on c.ID = b.ID\n                  LEFT JOIN PROD_DATALAKE.SALESFORCE.USER d on d.ID = a.USERID\n                  LEFT JOIN PROD_ENTERPRISE.SALES.SALESFORCEACCOUNTOWNERTRACKING e on e.CUSTOMER_NUMBER = b.ACCOUNTNUMBER\n                  WHERE a.TEAMMEMBERROLE IN ('NPG Ops Manager','SPS Specialist','VIP Sales Director')\n                    AND c.ACTIVE_STATUS = 'Y'\n                  )\n              )A\n           )B\n           GROUP BY\n              ACCOUNTNUMBER,\n              ACCOUNT_TYPE)ACT\nWHERE CFB.CUSTOMER = ACT.ACCOUNTNUMBER"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336237":{"id":6336237,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":768,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336243],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336244],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Success"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_End"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"SUCCESS"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336238":{"id":6336238,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":448,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336241],"outputSuccessConnectorIDs":[6336242],"outputFailureConnectorIDs":[6336250],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Row Count","mapTo":"audit_rowcount"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"TargetLoad"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"-- Display on report\nINSERT INTO ${NPG_ENV_DB}.${NPG_ENV_SCH}.CUSTOMER_FIRST_BILLING\n(\nBRANDNAME,\nCUSTOMER,\nINVOICE_AMT,\nTOTAL_SALES,\nGP,\nGP_PERCENT,\nTERMS_CD,\nCUSTOMERNAME,\nFIRSTINVOICEDATE,\nBRANCHNUMBER,\nACCOUNTINGUNITNUMBER,\nBRANCHNAME,\nAREANAME,\nREGIONNAME,\nSALESREPID,\nSALESREPNAME,\nLEGACYID,\nVMSFLAG,\nNATIONALFLAG,\nNPGMANAGER,\nPARENTNUMBER,\nPARENTNAME,\nADDR1,\nCITY,\nSTATE,\nZIP,\nDL_CREATED_DATE,\nDL_CREATEDBY,\nDL_JOBID,\nDIVISION,\nFIRSTBILLEDON,\nCLIENTTYPE,\nADDR2,\nFIRSTTRANSDATE,\nFIRST_POSTING_DT_PERM  \n)\nwith hist_acc as \n ( select distinct hdr.CUSTOMER cust,a.accountnumber curr_acc,b.CRM_ACCOUNT_NUMBER__C hist_account\n  from \"PROD_DATALAKE\".\"SALESFORCE\".\"ACCOUNT\" a inner join \"PROD_DATALAKE\".\"SALESFORCE\".\"BRANCH_ACCOUNT_HISTORY__C\" B\n  on a.id=b.ACCOUNT_NAME__C\n  inner join ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP  HDR   \n  on  LTRIM(RTRIM(HDR.CUSTOMER))=  a.accountnumber\n  inner join ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP HDR1\n  on LTRIM(RTRIM(HDR1.CUSTOMER))=b.CRM_ACCOUNT_NUMBER__C\n  and a.accountnumber<>b.CRM_ACCOUNT_NUMBER__C\n  group by cust,curr_acc,hist_account),\n \n hist_acc_updt as\n (select distinct curr_acc customer ,act.invoice_date as invoice_dt\n from hist_acc \nleft join  PROD_DATALAKE.LAWPROD.ACHISTHDR act on ltrim(rtrim(act.customer))=hist_acc.hist_account\nLEFT join prod_edw.ent.date_dim dm on dm.date=act.posting_date),\n\ncurr_acc as\n(SELECT fct.CUSTOMER_NUMBER as customer,fct.invoice_date as invoice_dt\n FROM PROD_EDW.ENT.INVOICE_SUMMARY_FACT fct inner join ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP tmp\n on fct.customer_number=tmp.customer\n),\ncur_hist as\n(select * from hist_acc_updt\nunion \nselect * from curr_acc)\n\n,NEWCLIENT_TEMP AS\n(SELECT \n  B.BRAND_NAME BRANDNAME\n, NC.CUSTOMER\n, SUM(NC.INVC_AMT) INVOICE_AMT\n, A.PAYMENT_TERMS TERMS_CD\n, CRM.CUSTOMER_NAME CUSTOMERNAME\n, NC.INVOICE_DATE FIRSTINVOICEDATE\n, B.BRANCH_NUMBER BRANCHNUMBER\n, B.ACCOUNTING_UNIT ACCOUNTINGUNITNUMBER\n, B.BRANCH_NAME BRANCHNAME\n, E.CNS_REP_AREA_NAME AREANAME\n, E.REGION_NAME REGIONNAME\n, D.CDA_USERNUMBER AS SALESREPID\n, CONCAT(CRM.SALE_REP_FIRST_NAME,' ',CRM.SALE_REP_LAST_NAME) AS SALESREPNAME\n, CRM.LEGACY_ID LEGACYID\n, case when CRM.VMS_ACCOUNT_STATUS = 'FALSE' THEN 0 WHEN CRM.VMS_ACCOUNT_STATUS = 'TRUE' THEN 1 END AS VMSFLAG\n, case when CRM.NATIONAL_ACCOUNT_STATUS = 'FALSE' THEN 0 WHEN CRM.NATIONAL_ACCOUNT_STATUS = 'TRUE' THEN 1 END AS NATIONALFLAG \n, CONCAT(CRM.NPG_MGR_FIRST_NAME, ' ' ,CRM.NPG_MGR_LAST_NAME)NPGMANAGER\n, CRM.PARENT_NUMBER AS PARENTNUMBER\n, CRM.PARENT_NAME AS PARENTNAME\n, G.ADDR1\n, G.CITY\n, G.STATE\n, G.ZIP\n, CAST(CURRENT_TIMESTAMP AS TIMESTAMP_NTZ) DL_CREATED_DATE\n, CAST('${environment_username}' as  VARCHAR(50)) DL_CREATEDBY\n, CAST('${run_history_id}' as VARCHAR(50)) DL_JOBID\n, E.DIVISION_NAME DIVISION\n, MAX(CRM.FIRST_BILLED_ON) FIRSTBILLEDON\n,(CASE WHEN MIN(CH.invoice_dt)<MAX(NC.LAST_SIX_MONTHS_DATE) THEN 'Reactivated'\n   WHEN MAX(CRM.FIRST_BILLED_ON) = MAX(NC.INVOICE_DATE) or MAX(CRM.FIRST_BILLED_ON) IS NULL\n  THEN 'New' end)ClientType\n, G.ADDR2\n, MIN(NC.TRAN_DATE) FIRSTTRANSDATE\n, MIN(NC.POSTING_DATE) FIRST_POSTING_DT_PERM\nFROM ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP NC\nINNER JOIN cur_hist CH ON CH.CUSTOMER=NC.CUSTOMER\nLEFT JOIN PROD_EDW.ENT.CUSTOMER_DIM A ON A.CUSTOMER_NUMBER = NC.CUSTOMER AND A.DW_ACTIVE_FLAG = 'Y' AND A.DW_DATA_SOURCE_KEY =3\nLEFT JOIN PROD_EDW.ENT.CUSTOMER_DIM CRM ON A.CUSTOMER_NUMBER = CRM.CUSTOMER_NUMBER AND CRM.DW_ACTIVE_FLAG = 'Y' AND CRM.DW_DATA_SOURCE_KEY = 1\nLEFT JOIN PROD_EDW.ENT.BRANCH_DIM B ON CRM.BRANCH_ID = B.BRANCH_ID AND B.DW_ACTIVE_FLAG = 'Y' AND B.DW_DATA_SOURCE_KEY = 1\nLEFT JOIN PROD_DATALAKE.CRM_MSCRM.SYSTEMUSERBASE D ON CRM.SALE_REP_ID = D.SYSTEMUSERID\nLEFT JOIN PROD_EDW.ENT.ACCOUNTING_UNIT_HIERARCHY_DIM E ON E.ACCOUNT_UNIT_CODE = B.ACCOUNTING_UNIT AND E.DW_ACTIVE_FLAG = 'Y'\nLEFT JOIN PROD_EDW.ENT.SYSTEM_USERS_DIM F ON F.USER_ID = A.PREFERRED_SYSTEM_USER_ID AND F.DW_ACTIVE_FLAG = 'Y'\nLEFT JOIN PROD_DATALAKE.LAWPROD.CUSTDESC G ON ltrim(rtrim( G.CUSTOMER ))= A.CUSTOMER_NUMBER \nWHERE NOT EXISTS (SELECT 'X' FROM ${NPG_ENV_DB}.${NPG_ENV_SCH}.CUSTOMER_FIRST_BILLING X WHERE X.CUSTOMER = NC.CUSTOMER AND X.FIRSTINVOICEDATE = NC.INVOICE_DATE)\nGROUP BY A.BRAND_NAME,NC.CUSTOMER,A.PAYMENT_TERMS,CRM.CUSTOMER_NAME,NC.INVOICE_DATE,B.BRANCH_NUMBER,B.ACCOUNTING_UNIT,B.BRANCH_NAME,E.CNS_REP_AREA_NAME\n,E.REGION_NAME,D.CDA_USERNUMBER,F.USER_NUMBER,CRM.SALE_REP_FIRST_NAME,CRM.SALE_REP_LAST_NAME,CRM.NATIONAL_ACCOUNT_STATUS,CRM.NPG_MGR_FIRST_NAME,CRM.NPG_MGR_LAST_NAME\n,A.CREATED_BY_NAME,CRM.PARENT_NUMBER,A.PARENT_NAME, E.DIVISION_NAME,B.BRAND_NAME,CRM.LEGACY_ID,CRM.VMS_ACCOUNT_STATUS ,CRM.PARENT_NAME\n,G.ADDR1, G.CITY, G.STATE, G.ZIP, G.ADDR2\n)\n \n,KPI_WBS_DETAIL_FACT AS\n(SELECT\n B.CUSTOMER_NUMBER\n, SUM(B.TOTAL_REVENUES) TOTAL_SALES\n, SUM(B.TOTAL_GROSS_PROFIT) GP\nFROM PROD_EDW.ENT.KPI_WBS_DETAIL_FACT B\nINNER JOIN (SELECT DISTINCT INVOICE_DATE, CUSTOMER FROM ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP) C ON B.CUSTOMER_NUMBER = C.CUSTOMER \nWHERE B.BEGIN_DATE BETWEEN previous_day(C.INVOICE_DATE,'Monday') AND previous_day(C.INVOICE_DATE,'Sunday') AND B.DW_ACTIVE_FLAG = 'Y'\nAND YEAR(C.INVOICE_DATE) = B.FISCAL_YEAR\nGROUP BY CUSTOMER_NUMBER\n)\n \nSELECT\nA.BRANDNAME\n, A.CUSTOMER\n, A.INVOICE_AMT\n, B.TOTAL_SALES\n, B.GP\n, CASE WHEN B.TOTAL_SALES > 0 THEN ((B.GP)/(B.TOTAL_SALES)) * 100 ELSE 0 END AS GP_PERCENT\n, A.TERMS_CD\n, A.CUSTOMERNAME\n, A.FIRSTINVOICEDATE\n, A.BRANCHNUMBER\n, A.ACCOUNTINGUNITNUMBER\n, A.BRANCHNAME\n, A.AREANAME\n, A.REGIONNAME\n, A.SALESREPID\n, A.SALESREPNAME\n, A.LEGACYID\n, A.VMSFLAG\n, A.NATIONALFLAG \n, A.NPGMANAGER\n, A.PARENTNUMBER\n, A.PARENTNAME\n, A.ADDR1\n, A.CITY\n, A.STATE \n, A.ZIP\n, A.DL_CREATED_DATE\n, A.DL_CREATEDBY\n, A.DL_JOBID\n, A.DIVISION\n, A.FIRSTBILLEDON\n, A.ClientType\n, A.ADDR2\n, A.FIRSTTRANSDATE\n, A.FIRST_POSTING_DT_PERM\nFROM NEWCLIENT_TEMP A\nLEFT JOIN KPI_WBS_DETAIL_FACT B ON A.CUSTOMER = B.CUSTOMER_NUMBER\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336239":{"id":6336239,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":320,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336240],"outputSuccessConnectorIDs":[6336241],"outputFailureConnectorIDs":[6336201],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"TempTableLoad"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--All invoices based on dates input\n\nTRUNCATE TABLE ${NPG_ENV_DB}.${NPG_ENV_SCH}.CLIENTINVOICE_TEMP;\n\nINSERT INTO ${NPG_ENV_DB}.${NPG_ENV_SCH}.CLIENTINVOICE_TEMP\n(\nCUSTOMER,\nINVOICE_DATE,\nLAST_SIX_MONTHS_DATE,\nINVC_AMT,\nPT_ACTIVITY,\nACCT_UNIT,\nTERMS_CD,\nTRAN_DATE\n)\nSELECT     CUSTOMER_NUMBER AS CUSTOMER,\n\t\t   (INVOICE_DATE) AS INVOICE_DATE,\n           -- Add calculation to go back 6 months instead of one year, based on the invoice date.\n           DATEADD(month, -6, TO_DATE(INVOICE_DATE)) AS LAST_SIX_MONTHS_DATE,\n\t\t   INVOICE_AMOUNT AS INVC_AMT,\n           ACTIVITY,\n\t\t   ACCOUNT_UNIT_CODE,\n           NULL AS TERMS_CD,\n           TRAN_DATE  \n\tFROM PROD_EDW.ENT.INVOICE_DETAIL_FACT\n    WHERE DW_ACTIVE_FLAG = 'Y' \n\tAND INVOICE_DATE >= '${BeginInvoiceDt}'\n\tAND INVOICE_DATE <= '${EndInvoiceDt}'\n\tAND INVOICE_AMOUNT > 0 \n;\n              \n\n--- New Clients\n\nTRUNCATE TABLE ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP_1;\nINSERT INTO ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP_1\n(\nCUSTOMER,\nINVOICE_DATE,\nLAST_SIX_MONTHS_DATE,\nINVC_AMT,\nPT_ACTIVITY,\nACCT_UNIT,\nTERMS_CD,\nTRAN_DATE\n)\nwith hist_acc as \n ( select distinct hdr.CUSTOMER_NUMBER cust,a.accountnumber curr_acc,b.CRM_ACCOUNT_NUMBER__C hist_account,min(hdr.invoice_date)cur_inv,max(hdr1.invoice_date)hist_inv,\n  from \"PROD_DATALAKE\".\"SALESFORCE\".\"ACCOUNT\" a inner join \"PROD_DATALAKE\".\"SALESFORCE\".\"BRANCH_ACCOUNT_HISTORY__C\" B\n  on a.id=b.ACCOUNT_NAME__C\n  inner join PROD_EDW.ENT.INVOICE_SUMMARY_FACT  HDR   \n  on  LTRIM(RTRIM(HDR.CUSTOMER_NUMBER))=  a.accountnumber--\n  and  HDR.DW_ACTIVE_FLAG = 'Y'\n  inner join PROD_EDW.ENT.INVOICE_SUMMARY_FACT HDR1\n  on LTRIM(RTRIM(HDR1.CUSTOMER_NUMBER))=b.CRM_ACCOUNT_NUMBER__C\n  and  HDR1.DW_ACTIVE_FLAG = 'Y'\n  and a.accountnumber<>b.CRM_ACCOUNT_NUMBER__C\n  group by cust,curr_acc,hist_account),\n \n hist_acc_updt as\n (select distinct curr_acc customer ,act.invoice_date\n from hist_acc \nleft join  PROD_DATALAKE.LAWPROD.ACHISTHDR act on ltrim(rtrim(act.customer))=hist_acc.hist_account\nLEFT join prod_edw.ent.date_dim dm on dm.date=act.posting_date),\n\ncurr_acc as\n(SELECT CUSTOMER_NUMBER as customer,invoice_date FROM PROD_EDW.ENT.INVOICE_SUMMARY_FACT\n),\ncur_hist as\n(select * from hist_acc_updt\nunion \nselect * from curr_acc)\nSELECT \nA.CUSTOMER,\nA.INVOICE_DATE,\nA.LAST_SIX_MONTHS_DATE,\nA.INVC_AMT,\nA.PT_ACTIVITY,\nA.ACCT_UNIT,\nA.TERMS_CD,\nA.TRAN_DATE\n\tFROM ${NPG_ENV_DB}.${NPG_ENV_SCH}.CLIENTINVOICE_TEMP A\n\tWHERE NOT EXISTS (-- check for billing in the last 6 months \n\t\t\t\t\t  SELECT 'X'\n\t\t\t\t\t  FROM (SELECT * FROM cur_hist) HDR\n\t\t\t\t\t  WHERE A.CUSTOMER = HDR.CUSTOMER\n                     -- AND  HDR.DW_ACTIVE_FLAG = 'Y'\n\t\t\t\t\t  AND  HDR.INVOICE_DATE > A.LAST_SIX_MONTHS_DATE\n\t\t\t\t\t  AND  HDR.INVOICE_DATE < A.INVOICE_DATE)\n                      ;\n-- PERM\nTRUNCATE TABLE ${NPG_ENV_DB}.${NPG_ENV_SCH}.CLIENTINVOICE_PERM_TEMP;\nINSERT INTO ${NPG_ENV_DB}.${NPG_ENV_SCH}.CLIENTINVOICE_PERM_TEMP\n(\nCUSTOMER,\nPOSTING_DATE  \n)\nSelect ISF.CUSTOMER_NUMBER AS CUSTOMER,\n    MIN(ISF.POSTING_DATE) POSTING_DATE\n\tFROM ${NPG_ENV_DB}.${SNFLKSCH_LDG}.NEWCLIENT_TEMP_1 A\n\tLEFT JOIN PROD_EDW.ENT.INVOICE_SUMMARY_FACT  ISF ON A.INVOICE_DATE = ISF.INVOICE_DATE AND A.CUSTOMER = ISF.CUSTOMER_NUMBER AND ISF.DW_ACTIVE_FLAG = 'Y' AND ISF.DW_DATA_SOURCE_KEY = 3\n\tINNER JOIN PROD_EDW.ENT.INVOICE_DETAIL_FACT IDF ON ISF.OBJ_ID = IDF.OBJ_ID AND IDF.DW_ACTIVE_FLAG = 'Y' AND IDF.DW_DATA_SOURCE_KEY = 3\n    WHERE IDF.WAGE_CODE IN ('590CN','590DH','590QH')\n  \tGROUP BY ISF.CUSTOMER_NUMBER;\n\nTRUNCATE TABLE ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP;\nINSERT INTO ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP\n(\nCUSTOMER,\nINVOICE_DATE,\nLAST_SIX_MONTHS_DATE,\nINVC_AMT,\nPT_ACTIVITY,\nACCT_UNIT,\nTERMS_CD,\nTRAN_DATE,\nPOSTING_DATE  \n)\nSELECT \nA.CUSTOMER,\nA.INVOICE_DATE,\nA.LAST_SIX_MONTHS_DATE,\nA.INVC_AMT,\nA.PT_ACTIVITY,\nA.ACCT_UNIT,\nA.TERMS_CD,\nA.TRAN_DATE,\nB.POSTING_DATE\n\tFROM ${NPG_ENV_DB}.${NPG_ENV_SCH}.NEWCLIENT_TEMP_1 A\n    LEFT JOIN ${NPG_ENV_DB}.${NPG_ENV_SCH}.CLIENTINVOICE_PERM_TEMP B ON A.CUSTOMER = B.CUSTOMER "}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6336240":{"id":6336240,"sourceID":6336231,"targetID":6336239},"6336241":{"id":6336241,"sourceID":6336239,"targetID":6336238},"6336242":{"id":6336242,"sourceID":6336238,"targetID":6336236},"6336243":{"id":6336243,"sourceID":6336236,"targetID":6336237}},"failureConnectors":{"6336201":{"id":6336201,"sourceID":6336239,"targetID":6336234},"6336202":{"id":6336202,"sourceID":6336231,"targetID":6336234},"6336249":{"id":6336249,"sourceID":6336236,"targetID":6336234},"6336250":{"id":6336250,"sourceID":6336238,"targetID":6336234}},"unconditionalConnectors":{"6336244":{"id":6336244,"sourceID":6336237,"targetID":6336230},"6336245":{"id":6336245,"sourceID":6336229,"targetID":6336231},"6336246":{"id":6336246,"sourceID":6336235,"targetID":6336229},"6336247":{"id":6336247,"sourceID":6336233,"targetID":6336232},"6336248":{"id":6336248,"sourceID":6336234,"targetID":6336233}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"6336228":{"id":6336228,"x":-86,"y":-171,"width":245,"height":50,"text":"business owner is Sara Swart","colour":"00ce4f"}},"variables":{"BeginInvoiceDt":{"definition":{"name":"BeginInvoiceDt","type":"DATETIME","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":null},"EndInvoiceDt":{"definition":{"name":"EndInvoiceDt","type":"DATETIME","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":null}},"grids":{}},"info":{"name":"jb_CUSTOMER_FIRST_BILLING_20251113","description":"","type":"ORCHESTRATION","tag":"90be593a-446a-4935-8f31-1c9fc9861f87"}}