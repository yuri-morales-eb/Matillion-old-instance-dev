{"job":{"components":{"6341825":{"id":6341825,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-1456,"y":-16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6341829],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6341826":{"id":6341826,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-1268,"y":-11,"width":32,"height":32,"inputConnectorIDs":[6341829],"outputSuccessConnectorIDs":[6341828],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STAGE_EDW_BKP"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import date\n\ntoday = date.today()\n\n\ndb_sync_sproc = ('''\nWITH DB_SYNC AS PROCEDURE (SOURCE_DB VARCHAR, TARGET_DB VARCHAR, TARGET_ROLE VARCHAR)\nRETURNS VARCHAR\nLANGUAGE PYTHON\nRUNTIME_VERSION = '3.9'\nPACKAGES=('snowflake-snowpark-python')\nHANDLER = 'edw_bd_sync'\nAS\n$$\nimport snowflake.snowpark as snowpark\nimport logging\nfrom datetime import date\nfrom snowflake.snowpark.functions import col, current_date\n\ndef edw_bd_sync(session: snowpark.Session, SOURCE_DB: str, TARGET_DB: str, TARGET_ROLE: str): \n    logger = logging.getLogger(__name__)\n    logger.setLevel(logging.INFO)\n    logger.info(\"Starting process\")\n    tableName = 'information_schema.procedures'\n    source_db = SOURCE_DB\n    \n    target_db = TARGET_DB\n    target_schema = 'ENT'\n    role = TARGET_ROLE\n\n\n    # CLONING THE SOURCE DATABASE INTO THE TARGET DATABASE\n    try:\n        logger.info(f\"Cloning {source_db} into {target_db}\")\n        clone_command = f'CREATE OR REPLACE DATABASE {target_db} CLONE {source_db};' #Clone PROD DB into TARGET DB\n        session.sql(clone_command).collect()\n        #logger.info(clone_command)\n        logger.info(\"Cloning complete!\")\n        \n    except Exception as e:\n        logger.error(\"Can't continue because an error:\")\n        logger.error(e)\n        raise e\n\n\n    # Assign role developera as owner of DB and objects\n    try:\n        logger.info(f\"Setting up new objects ownser:\")\n        grant_command = f'GRANT OWNERSHIP ON DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n\n        grant_command = f'GRANT OWNERSHIP ON ALL SCHEMAS IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n                          \n        grant_command = f'GRANT OWNERSHIP ON ALL TABLES IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n                 \n        grant_command = f'GRANT OWNERSHIP ON ALL VIEWS IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n\n        grant_command = f'GRANT OWNERSHIP ON ALL PROCEDURES IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n                \n        grant_command = f'GRANT OWNERSHIP ON ALL FUNCTIONS IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n                 \n        logger.info(f\"Setting up objects ownser complete!\")\n        \n    except Exception as e:\n        logger.error(\"Can't continue because an error:\")\n        logger.error(e)\n        raise e\n        \n    return f'Cloning {source_db} into {target_db} database process succeed'\n$$'''\n+\n'''CALL DB_SYNC ('STAGE_EDW', 'STAGE_EDW_BACKUP_{}', 'DEVELOPER');\n                '''.format(today.strftime(\"%Y%m%d\")))\n\ncursor = context.cursor()\ncursor.execute(db_sync_sproc)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6341827":{"id":6341827,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":-1088,"y":-16,"width":32,"height":32,"inputConnectorIDs":[6341828],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STAGE_EDW_SYNC"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import date\n\ntoday = date.today()\n\n\ndb_sync_sproc = ('''\nWITH DB_SYNC AS PROCEDURE (SOURCE_DB VARCHAR, TARGET_DB VARCHAR, TARGET_ROLE VARCHAR)\nRETURNS VARCHAR\nLANGUAGE PYTHON\nRUNTIME_VERSION = '3.9'\nPACKAGES=('snowflake-snowpark-python')\nHANDLER = 'edw_bd_sync'\nAS\n$$\nimport snowflake.snowpark as snowpark\nimport logging\nfrom datetime import date\nfrom snowflake.snowpark.functions import col, current_date\n\ndef edw_bd_sync(session: snowpark.Session, SOURCE_DB: str, TARGET_DB: str, TARGET_ROLE: str): \n    logger = logging.getLogger(__name__)\n    logger.setLevel(logging.INFO)\n    logger.info(\"Starting process\")\n    tableName = 'information_schema.procedures'\n    source_db = SOURCE_DB\n    \n    target_db = TARGET_DB\n    target_schema = 'ENT'\n    role = TARGET_ROLE\n\n\n    # CLONING THE SOURCE DATABASE INTO THE TARGET DATABASE\n    try:\n        logger.info(f\"Cloning {source_db} into {target_db}\")\n        clone_command = f'CREATE OR REPLACE DATABASE {target_db} CLONE {source_db};' #Clone PROD DB into TARGET DB\n        session.sql(clone_command).collect()\n        #logger.info(clone_command)\n        logger.info(\"Cloning complete!\")\n        \n    except Exception as e:\n        logger.error(\"Can't continue because an error:\")\n        logger.error(e)\n        raise e\n\n\n    # Assign role developera as owner of DB and objects\n    try:\n        logger.info(f\"Setting up new objects ownser:\")\n        grant_command = f'GRANT OWNERSHIP ON DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n\n        grant_command = f'GRANT OWNERSHIP ON ALL SCHEMAS IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n                          \n        grant_command = f'GRANT OWNERSHIP ON ALL TABLES IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n                 \n        grant_command = f'GRANT OWNERSHIP ON ALL VIEWS IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n\n        grant_command = f'GRANT OWNERSHIP ON ALL PROCEDURES IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n                \n        grant_command = f'GRANT OWNERSHIP ON ALL FUNCTIONS IN DATABASE {target_db} TO ROLE {role} REVOKE CURRENT GRANTS;'        \n        session.sql(grant_command).collect()\n                 \n        logger.info(f\"Setting up objects ownser complete!\")\n        \n    except Exception as e:\n        logger.error(\"Can't continue because an error:\")\n        logger.error(e)\n        raise e\n        \n    return f'Cloning {source_db} into {target_db} database process succeed'\n$$'''\n+\n'''CALL DB_SYNC ('PROD_EDW', 'STAGE_EDW', 'DEVELOPER');\n                ''')\n\ncursor = context.cursor()\ncursor.execute(db_sync_sproc)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6341828":{"id":6341828,"sourceID":6341826,"targetID":6341827}},"failureConnectors":{},"unconditionalConnectors":{"6341829":{"id":6341829,"sourceID":6341825,"targetID":6341826}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"STAGE_EDW_Sync_Database","description":"Job for STAGE_EDW database synchronization from the the PROD_EDW database.","type":"ORCHESTRATION","tag":"8ffa13a3-a668-4351-84bb-2968e5718bdd"}}