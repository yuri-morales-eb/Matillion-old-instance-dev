{"job":{"components":{"6339312":{"id":6339312,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-480,"y":304,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6339317],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Dataset 2 - Grouping based on Titles mapping"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH GEF AS(WITH BASE as (SELECT A.*,\n                     LPAD(a.ACCOUNTING_UNIT, 5, 0) as NEW_ACCOUNTING_UNIT, \n                     CONCAT(d.FISCAL_YEAR,d.FISCAL_WEEK) As NORM_POST_WEEK,\n                     D.FISCAL_WEEK, d.FISCAL_YEAR\n                FROM ${DB_Datalake}.${Sch_UKG}.UKG_HEADCOUNT_PAYDATA_ALLOCATIONS A\n               INNER JOIN ${SNFLEDWDB}.${SNFLDWHSCH}.DATE_DIM  D\n                  ON to_date(D.DATE) = to_date(A.PERIOD_CONTROL_DATE)\n               WHERE EXISTS (SELECT 1\n                               from ${SNFLEDWDB}.${SNFLDWHSCH}.DATE_DIM  dim1\n                              WHERE dim1.date = CURRENT_DATE()-1\n                                AND (dim1.FISCAL_WEEK) = D.FISCAL_WEEK \n                                AND D.FISCAL_YEAR = dim1.FISCAL_YEAR\n                            )  \n             ),\n        tit as (select distinct trim(title) AS TITLE,trim(mapping) AS MAPPING from prod_datalake.ukg.FTE_TITLES\n     ),      \n     CTE_ALL AS  (SELECT (NEW_ACCOUNTING_UNIT)||'B' AS CC,\n                         CASE WHEN (TRIM(COMPANY_CODE) ='ESMI' or TRIM(COMPANY_CODE) ='DECCA')  THEN 'STAFF - '||HMT.MAPPING \n                              WHEN TRIM(COMPANY_CODE)='EBDAL'  THEN 'AIB - '||HMT.MAPPING \n                          END AS CATEGORY,\n                         CASE WHEN BASE.TOTAL_HOURS > 80 THEN 80.00 \n                              ELSE round(BASE.TOTAL_HOURS,2) \n                          END AS NEW_TOTAL_HOURS,\n                        CASE WHEN (TRIM(COMPANY_CODE)='ESMI' OR  TRIM(COMPANY_CODE)='DECCA') THEN ALLOCATION_PERCENTAGE * 1 \n                              ELSE 0 \n                          END AS ESMI_FTE_COUNT,\n                         CASE WHEN TRIM(COMPANY_CODE)='EBDAL' THEN ROUND(ALLOCATION_PERCENTAGE*(NEW_TOTAL_HOURS/80.00),2)\n                              ELSE 0\n                          END EBDAL_FTE_COUNT,\n                         FISCAL_WEEK ,\n                         FISCAL_YEAR\n                    FROM BASE \n                   LEFT JOIN tit HMT\n                      ON (trim(BASE.JOB_TITLE)) = (trim(HMT.TITLE)))\n\nSELECT CC,\n       CATEGORY,\n       SUM(ESMI_FTE_COUNT+EBDAL_FTE_COUNT) AS FTE_COUNT,\n       'Week'||to_varchar(CAST(FISCAL_WEEK AS int), '00MI') AS Week,     \n       FISCAL_YEAR as Year \n  FROM CTE_ALL\n GROUP BY CC,CATEGORY,FISCAL_WEEK,FISCAL_YEAR\nUNION ALL\nSELECT CC,\n       CATEGORY,\n       SUM(ESMI_FTE_COUNT+EBDAL_FTE_COUNT) AS FTE_COUNT,\n       'Week'||to_varchar(CAST(trunc(FISCAL_WEEK-1) AS int), '00MI') AS Week,\n       FISCAL_YEAR as Year\n  FROM CTE_ALL\n GROUP BY CC,CATEGORY,FISCAL_WEEK,FISCAL_YEAR)\n SELECT * FROM GEF where FTE_COUNT<>0"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6339313":{"id":6339313,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-1841822228,"x":-265,"y":254,"width":32,"height":32,"inputConnectorIDs":[6339316,6339317],"outputConnectorIDs":[6339318],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"union all"}}}},"visible":true},"2":{"slot":2,"name":"Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"All Columns"}}}},"visible":true},"3":{"slot":3,"name":"Cast Types","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Add Source Component Column","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Remove duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6339314":{"id":6339314,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":-48,"y":256,"width":32,"height":32,"inputConnectorIDs":[6339318],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ESSBASE_FTE_UKG_HEADCOUNT_EXPORT"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ESSBASE_FTE_UKG_HEADCOUNT_EXPORT"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CC"},"2":{"slot":2,"type":"STRING","value":"CC"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"CATEGORY"},"2":{"slot":2,"type":"STRING","value":"Category"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"FTE_COUNT"},"2":{"slot":2,"type":"STRING","value":"Count"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"WEEK"},"2":{"slot":2,"type":"STRING","value":"Week"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"YEAR"},"2":{"slot":2,"type":"STRING","value":"Year"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLFINSCH}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${DB_Enterprise}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6339315":{"id":6339315,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-480,"y":192,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6339316],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Dataset 1"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with dataset1 as (WITH BASE as (SELECT A.*,\n                     LPAD(a.ACCOUNTING_UNIT, 5, 0) as NEW_ACCOUNTING_UNIT, \n                     CONCAT(d.FISCAL_YEAR,d.FISCAL_WEEK) As NORM_POST_WEEK,\n                     d.FISCAL_YEAR,\n                     d.FISCAL_WEEK\n                FROM  ${DB_Datalake}.${Sch_UKG}.UKG_HEADCOUNT_PAYDATA_ALLOCATIONS A\n               INNER JOIN ${SNFLEDWDB}.${SNFLDWHSCH}.DATE_DIM D\n                  ON to_date(D.DATE) = to_date(A.PERIOD_CONTROL_DATE)\n               WHERE EXISTS (SELECT 1\n                               from ${SNFLEDWDB}.${SNFLDWHSCH}.DATE_DIM dim1\n                              WHERE dim1.date = CURRENT_DATE()-1\n                                AND (dim1.FISCAL_WEEK) = D.FISCAL_WEEK \n                                AND D.FISCAL_YEAR = dim1.FISCAL_YEAR\n                            ) \n             ),\n      ESMI AS (SELECT NEW_ACCOUNTING_UNIT||'B' AS CC,\n                      'RSTAFF' AS CATEGORY,\n                      SUM(ALLOCATION_PERCENTAGE) * 1 as FTE_COUNT ,\n                      FISCAL_WEEK,\n                      FISCAL_YEAR\n                 FROM BASE \n                WHERE TRIM(COMPANY_CODE) in ('ESMI','DECCA')\n                GROUP BY NEW_ACCOUNTING_UNIT, FISCAL_WEEK, FISCAL_YEAR),\n      EBDAL AS (SELECT NEW_ACCOUNTING_UNIT||'B' AS CC,\n                       'IN-HOUSE' AS CATEGORY, \n                       SUM(ROUND(ALLOCATION_PERCENTAGE*(NEW_TOTAL_HOURS/80.00),2)) as FTE_COUNT,\n                       FISCAL_WEEK,\n                       FISCAL_YEAR                          \n                  FROM (SELECT BASE.*,\n                               CASE WHEN BASE.TOTAL_HOURS > 80 THEN 80.00 \n                                    ELSE round(BASE.TOTAL_HOURS,2) \n                                END AS NEW_TOTAL_HOURS \n                          FROM BASE\n                         WHERE TRIM(COMPANY_CODE)='EBDAL')\n                  GROUP BY NEW_ACCOUNTING_UNIT, FISCAL_WEEK, FISCAL_YEAR)  \n\nSELECT CC,\n       CATEGORY, \n       FTE_COUNT,\n       'Week'||to_varchar(CAST(trunc(FISCAL_WEEK-1) AS int), '00MI') AS Week,           \n       FISCAL_YEAR  AS Year\n  FROM ESMI\n UNION ALL\nSELECT CC,\n       CATEGORY, \n       FTE_COUNT,\n       'Week'||to_varchar(CAST(trunc(FISCAL_WEEK-1) AS int), '00MI') AS Week,\n       FISCAL_YEAR AS Year\n  FROM EBDAL\n UNION ALL\n SELECT CC,\n       CATEGORY, \n       FTE_COUNT,\n       'Week'||to_varchar(CAST(trunc(FISCAL_WEEK) AS int), '00MI') AS Week,\n       FISCAL_YEAR  \n  FROM ESMI\n UNION ALL\nSELECT CC,\n      CATEGORY,\n      FTE_COUNT ,\n      'Week'||to_varchar(CAST(trunc(FISCAL_WEEK) AS int), '00MI') AS Week, \n      FISCAL_YEAR as Year\n  FROM EBDAL)\n  select * from dataset1 where FTE_COUNT<>0"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6339316":{"id":6339316,"sourceID":6339315,"targetID":6339313},"6339317":{"id":6339317,"sourceID":6339312,"targetID":6339313},"6339318":{"id":6339318,"sourceID":6339313,"targetID":6339314}},"notes":{},"noteConnectors":{},"variables":{"Max_week":{"definition":{"name":"Max_week","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"jb_UKG_FTE_Headcount_Export_SQL_to_Table","description":"","type":"TRANSFORMATION","tag":"3b33cee2-70ac-4f5f-9e7a-b716865e8e9e"}}