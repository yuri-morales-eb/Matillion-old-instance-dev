{"job":{"components":{"6339290":{"id":6339290,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-1841822228,"x":-265,"y":254,"width":32,"height":32,"inputConnectorIDs":[6339251,6339295],"outputConnectorIDs":[6339294],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"union all"}}}},"visible":true},"2":{"slot":2,"name":"Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"All Columns"}}}},"visible":true},"3":{"slot":3,"name":"Cast Types","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Add Source Component Column","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Remove duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6339291":{"id":6339291,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-480,"y":192,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6339295],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WBS_BIWEEKLY_ALT_BIWEEKLY"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with BiWeek_cust as (select distinct b.SEARCH_NAME as customer_name,\n                        \tp.value AS bill_cycle,\n                        \ta.active_status Activity_Status, \n                        \tactivity_txt,\n                        \ttry_to_number(level_detail_02) as customer\n                       from datalake.public.dim_activity a \n                       left join (select a.* \n\t\t                            from \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" a\n                                    inner join (select distinct CUSTOMER,count(CUSTOMER)  \n                                                  from \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\"\n                                                 group by CUSTOMER\n                                                having count(CUSTOMER)=1) b \n                                       on  a.customer=b.customer\n                                    union all\n                                   select a.* \n                                     from \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" a\n                                    inner join (select distinct CUSTOMER,count(CUSTOMER)  \n                                                  from \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\"\n                                                 group by CUSTOMER\n                                                having count(CUSTOMER)>1) b \n\t\t                               on  a.customer=b.customer\n\t\t                            where a.company=2) b  \n                         on try_to_number(a.level_detail_02) = b.customer\n                       left join(select Distinct a.ACCOUNTNUMBER as Customer_Number, a.NAME as Customer_Name, a.CDA_PAYCYCLE,k.value\n                                   from \"PROD_DATALAKE\".\"CRM_MSCRM\".\"ACCOUNTBASE\" a\n                                   left join (select distinct attributevalue,value \n\t\t\t\t\t                            from datalake.public.crm_dl_ldg_stringmapbase\n\t\t\t\t\t                           where attributename ='cda_paycycle') k \n\t\t                             on k.attributevalue=a.CDA_PAYCYCLE) p \n                         on p.Customer_Number=try_to_number(a.level_detail_02)  \n                      where a.active_status='Y'\n                        and p.value in ('Bi-Weekly','Alternate Bi-Weekly')\n                     ),\n     dt as (select  \n                   distinct sunnorm_posting_date,\n                   FISCAL_WEEK,\n                   FISCAL_YEAR\n              from \"PROD_EDW\".\"ENT\".\"DATE_DIM\" dim \n            WHERE EXISTS (SELECT 1\n                            from \"PROD_EDW\".\"ENT\".\"DATE_DIM\" dim1\n             WHERE (dim1.date >= current_date()-20\n                             AND dim1.date  = dim.date)\n                          )\n           ),\n      dt2 as (select  \n                   distinct date, \n                   sunnorm_posting_date,\n                   FISCAL_WEEK,\n                   FISCAL_YEAR\n              from \"PROD_EDW\".\"ENT\".\"DATE_DIM\" dim  \n           ),\n     biweek as (select DISTINCT SUNNORM_POSTING_DATE, case when mod(FISCAL_WEEK,2) = 0 then trunc(SUNNORM_POSTING_DATE, 'week')+6 else \n                       trunc(SUNNORM_POSTING_DATE, 'week')+13 end biweekly,\n                       FISCAL_WEEK\n                  from \"PROD_EDW\".\"ENT\".\"DATE_DIM\" dim\n                 ) ,   \n     prep1 as (SELECT TR.ACCT_UNIT_TXT||'B' AS \"Organization_\"\n                            ,TR.account_nm||'AL' AS \"Account_\"\n                            ,iff(g.brand_val_txt is null, 'UB', brand_val_txt) AS brand_level\n                            ,TR.norm_posting_dt\n                            ,CUST.customer\n                            ,CASE WHEN (SUBSTR(TR.account_nm,1,1) = '4' OR TR.account_nm = '2660') THEN (0-TR.TRAN_AMT) \n                                  ELSE TR.TRAN_AMT\n                              END AS Total_Bill_Amount\n                      from datalake.public.dim_trans TR\n                      left join BiWeek_cust cust on cust.activity_txt = TR.activity \n                      left join datalake.public.dim_brand g \n                        on g.activity_txt = CUST.activity_txt\n                       and  ( g.valid_to_dt >=  iff(dateadd('day', 7, TR.norm_posting_dt) < '2019-06-30', '2019-06-30', dateadd('day', 7, TR.norm_posting_dt)) \n                       and  g.valid_frm_dt < iff(dateadd('day', 7, TR.norm_posting_dt) < '2019-06-30', '2019-06-30', dateadd('day', 7, TR.norm_posting_dt))  )\n                     where ( TR.norm_posting_dt <= case when DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) in (1,2,3,4) then \n                                                             DATEADD(DAY, -7 - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), \n                                                             to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) \n                                                        else DATEADD(DAY, - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), \n                                                             to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) \n                                                    end\n                       and TR.norm_posting_dt >= DATE_FROM_PARTS(YEAR(to_date(current_timestamp())) - 1, 01, 01))\n                       and ((TR.account_nm >= '4100' and TR.account_nm <= '5999') or TR.account_nm = '2660')\n                       and TR.RUN_DATE <= dateadd(day,9,TR.NORM_POSTING_DT)\n                       and TR.active_status = 'Y' \n                       and CUST.Activity_Status='Y'\n                     ),\nNon_week_wbs As (SELECT case when mod(FISCAL_WEEK,2) = 0 then trunc(SUNNORM_POSTING_DATE, 'week')+6 \n                             else trunc(SUNNORM_POSTING_DATE, 'week')+13 \n                         end norm_posting_dt_drvd,\n                        \"Organization_\"\n                         ,\"Account_\"\n                         ,brand_level\n                         , sum(Total_Bill_Amount)/2 as Total_Bill_Amount\n                     FROM prep1 nww\n                    INNER JOIN  prod_edw.ent.date_dim dt\n                       on date(nww.norm_posting_dt)=date(dt.date) \n                  group by \"Organization_\"\n                         ,\"Account_\"\n                         ,brand_level\n                         ,norm_posting_dt_drvd\n),\nFinal_Financials As (SELECT \"Organization_\"\n       ,\"Account_\"\n       ,brand_level as \"Specialties_\" \n       ,'EBTotal' AS \"Company_\"\n       ,dt.FISCAL_YEAR AS \"FY_\"\n       ,'Week'||dt.FISCAL_WEEK AS \"Time_\"\n       ,'Biweekly actuals' AS \"Scenario_\"\n       ,round(Total_Bill_Amount,2) AS \"Local\"\n  FROM Non_week_wbs nww\n inner join biweek \n    on nww.norm_posting_dt_drvd = biweek.biweekly\n inner join dt\n    on biweek.sunnorm_posting_date = dt.sunnorm_posting_date\n),\nAOA_PREP1 AS(\nselect tr.*,cust.bill_cycle,\n  case when tr.EMPLOYEE='' then 0 else cast (tr.EMPLOYEE as BIGINT) end as Resource\n  from (\n    SELECT\tDISTINCT ACTRANS.OBJ_ID, \n\t\t\t\tACTRANS.ACCT_UNIT as ACCT_UNIT_TXT,\n\t\t\t\tACTRANS.ACCOUNT,\n\t\t\t\tACTRANS.ACCT_CATEGORY,\n\t\t\t\tACTRANS.ACTIVITY,\n\t\t\t\tLTRIM(ARCUSTOMER.CUSTOMER) as CUSTOMER,\n\t\t\t\tCUSTDESC.NAME as SEARCH_NAME,\n\t\t\t\t CASE \tWHEN \t(ACTRANS.RESOURCE_CODE IS NULL)\tOR (ACTRANS.RESOURCE_CODE = '')\n\t\t\t\t\t\t\t\t\t\tTHEN\tACHISTDTL.RESOURCE_CODE\n\t\t\t\t\t\t\t\t\tELSE\tACTRANS.RESOURCE_CODE  END as EMPLOYEE,\n\t\t\n\t\t\t\tACTRANS.POSTING_DATE,\n                case when dayname(ACTRANS.POSTING_DATE) = 'Sun' then ACTRANS.POSTING_DATE\n                                                  else dateadd(day,7-DAYOFWEEK (ACTRANS.POSTING_DATE),ACTRANS.POSTING_DATE) end as Norm_Post_Date,\n                CASE when ACACTMXVAL.MX_VALUE is null then ARCSTMXVAL.MX_VALUE else ACACTMXVAL.MX_VALUE end as Brandlevel,\n\t\t\t\tACTRANS.SUM_ACCT_CAT,\n\t\t\t\tiff(NATACCT.NAT_CUSTOMER is null, ARCUSTOMER.CUSTOMER,NATACCT.NAT_CUSTOMER) as LAWSON_PARENT_NUMBER ,\n\t\t\t    iff(NAT_CUSTDESC.SEARCH_NAME is null, CUSTDESC.SEARCH_NAME, NAT_CUSTDESC.SEARCH_NAME) as LAWSON_PARENT_NAME\nFROM    \"PROD_DATALAKE\".\"LAWPROD\".\"ACTRANS\" ACTRANS\n\t\tINNER JOIN \"PROD_DATALAKE\".\"LAWPROD\".\"ACACTIVITY\" ACACTIVITY   ON ACTRANS.ACTIVITY = ACACTIVITY.ACTIVITY \n        INNER JOIN \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" ARCUSTOMER   ON ACACTIVITY.LEVEL_DETAIL_02 = ARCUSTOMER.CUSTOMER \n        INNER JOIN \"PROD_DATALAKE\".\"LAWPROD\".\"CUSTDESC\"   CUSTDESC     ON ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER \n        LEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"NATACCT\"    NATACCT      ON NATACCT.CUSTOMER = ARCUSTOMER.CUSTOMER \n        LEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"CUSTDESC\"   NAT_CUSTDESC ON NATACCT.CUSTOMER = NAT_CUSTDESC.CUSTOMER \n        LEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"ACACTMXVAL\" ACACTMXVAL   ON ACACTIVITY.OBJ_ID=ACACTMXVAL.OBJ_ID AND\tACACTMXVAL.MATRIX_CAT \t= 'BRAND'\n        LEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"ARCSTMXVAL\" ARCSTMXVAL   ON ARCUSTOMER.OBJ_ID=ARCSTMXVAL.OBJ_ID AND\tARCSTMXVAL.MATRIX_CAT \t= 'BRAND'\n\t\tLEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"ACHISTDTL\"ACHISTDTL      ON ACTRANS.OBJ_ID = ACHISTDTL.ATN_OBJ_ID\n\t\tWHERE ACTRANS.ACCOUNT \tNOT IN (1230) \n\t\tAND\tACTRANS.ACCT_CATEGORY \tNOT IN ('510BC')\n ) tr\n  \n inner join BiWeek_cust cust on cust.activity_txt = tr.ACTIVITY\n  \n  where\n  ( tr.Norm_Post_Date <= case when DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) in (1,2,3,4) then DATEADD(DAY, -7 - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) else\n DATEADD(DAY, - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) end\n and  tr.Norm_Post_Date >= DATE_FROM_PARTS(YEAR(to_date(current_timestamp())) - 2, 01, 01)) \n),\nAOA_PREP2 AS(\nselect \n\tcase when mod(FISCAL_WEEK,2) = 0 then trunc(SUNNORM_POSTING_DATE, 'week')+6 else trunc(SUNNORM_POSTING_DATE, 'week')+13 end norm_posting_dt,\n    '' as customer_name, \n    count(Distinct w.customer) as customer,\n    w.ACCT_UNIT_TXT,\n    UPPER(w.Brandlevel) as Brandlevel,\n    count(distinct w.Resource) as AOA,\nfrom AOA_PREP1 W\nLEFT JOIN dt2\non date(w.Norm_Post_Date)= date(dt2.date)\ngroup by UPPER(w.Brandlevel),w.ACCT_UNIT_TXT,\ncase when mod(FISCAL_WEEK,2) = 0 then trunc(SUNNORM_POSTING_DATE, 'week')+6 else trunc(SUNNORM_POSTING_DATE, 'week')+13 end\n),\nNon_week_AOA As (SELECT case when mod(FISCAL_WEEK,2) = 0 then trunc(SUNNORM_POSTING_DATE, 'week')+6 \n                             else trunc(SUNNORM_POSTING_DATE, 'week')+13 \n                          end norm_posting_dt_drvd\n                         ,w.ACCT_UNIT_TXT ||'B' AS \"Organization_\"\n                         ,'AOA' AS \"Account_\"\n                         ,w.Brandlevel\n\t\t\t\t\t\t ,w.AOA AS AOA           \n                     FROM AOA_PREP2 w\n                     INNER JOIN prod_edw.ent.date_dim dt\n                       on date(w.norm_posting_dt)=date(dt.date)\n),\nFinal_AOA As (SELECT  nwa.\"Organization_\" AS \"Organization_\"\n       ,'AOA' AS \"Account_\"\n       ,nwa.Brandlevel as \"Specialties_\" \n       ,'EBTotal' AS \"Company_\"\n       ,dt.FISCAL_YEAR AS \"FY_\"\n       ,'Week'||dt.FISCAL_WEEK AS \"Time_\"\n       ,'Biweekly actuals' AS \"Scenario_\"\n       ,AOA AS \"Local\"\n  FROM Non_week_AOA nwa \n inner join biweek \n    on nwa.norm_posting_dt_drvd = biweek.biweekly\n inner join dt\n    on biweek.sunnorm_posting_date = dt.sunnorm_posting_date  --dt.date\n),\nHB_PREP1 AS(\nSELECT TR.*,\n    case when TR.ACCT_CAT_CD='51RW' then TR.UNITS_AMOUNT else TR.BILLABLE_UNIT end as BILLABLE_UNIT_NEW,\n    case when TR.ACCT_CAT_CD='51RW' then TR.BILLABLE_UNIT else TR.UNITS_AMOUNT end as UNITS_AMOUNT_NEW,\n\tTR.norm_posting_dt as Norm_Post_Date,\n\tCUST.customer,\n\tCUST.customer_name,\n\tCUST.Activity_Status,\n\tCUST.bill_cycle,\n\tiff(g.brand_val_txt is null, 'UB', brand_val_txt) as Brandlevel, \n    k.conv_factor_val_txt\nfrom datalake.public.dim_trans TR\nleft join BiWeek_cust cust on cust.activity_txt = TR.activity \nleft join datalake.public.dim_brand g on g.activity_txt = CUST.activity_txt\n                 and  ( g.valid_to_dt >=  iff(dateadd('day', 7, TR.norm_posting_dt) < '2019-06-30', '2019-06-30', dateadd('day', 7, TR.norm_posting_dt)) \n                 and  g.valid_frm_dt < iff(dateadd('day', 7, TR.norm_posting_dt) < '2019-06-30', '2019-06-30', dateadd('day', 7, TR.norm_posting_dt))  )\nleft join (select r.*, s.CONV_FACTOR_VAL_TXT\n           from datalake.public.dim_acct_cat r\n           inner join datalake.public.dim_conv_factor s\n           on r.conv_factor_id = s.conv_factor_id) k\non TR.acct_cat_cd = k.acct_cat_txt\nwhere \n ( TR.norm_posting_dt <= case when DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) in (1,2,3,4) then DATEADD(DAY, -7 - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) else\n DATEADD(DAY, - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) end\n and  TR.norm_posting_dt >= DATE_FROM_PARTS(YEAR(to_date(current_timestamp())) - 2, 01, 01))\nand  ((TR.account_nm >= '4100' and TR.account_nm <= '5999') or TR.account_nm = '2660')\nand TR.RUN_DATE <= dateadd(day,9,TR.NORM_POSTING_DT)\nAND  TR.active_status = 'Y' and CUST.Activity_Status='Y' \n),\nHb_PREP2 AS(\n SELECT \n   case when mod(FISCAL_WEEK,2) = 0 then trunc(SUNNORM_POSTING_DATE, 'week')+6 else trunc(SUNNORM_POSTING_DATE, 'week')+13 end norm_posting_dt,\n\tUpper(w.Brandlevel) as Brandlevel , \n    w.ACCT_UNIT_TXT, \n    --w.customer, \n    --w.customer_name, \n    --w.bill_cycle,\n   sum(w.billable_amt)/2                                                                                                 as  Billable_Amt,\n    sum(w.BILLABLE_UNIT_NEW)/2                                                                                           as  Billable_Unit,\n    sum(w.UNITS_AMOUNT_NEW)/2                                                                                            as Units_Amount,                                                                             \n    Round(\n            sum(iff(w.conv_factor_val_txt = 'None', w.BILLABLE_UNIT_NEW,\n                iff((w.conv_factor_val_txt = 'BILLABLE_AMT / 25' OR\n                 w.conv_factor_val_txt = 'BILLABLE_AMT /25'), w.billable_amt / 25,\n                iff(w.conv_factor_val_txt = 'BILLABLE_AMT / 15', w.billable_amt / 15,\n                iff((w.conv_factor_val_txt = 'BILLABLE_UNIT * 8'), w.BILLABLE_UNIT_NEW * 8,\n                iff(w.conv_factor_val_txt = 'BILLABLE_UNIT * 40', w.BILLABLE_UNIT_NEW * 40,\n                iff(w.conv_factor_val_txt = 'BILLABLE_UNIT / 55', w.BILLABLE_UNIT_NEW / 55, 0))))))),\n                2) /2                                                                                                     as Conv_billed_hours,\n\nFROM HB_PREP1 w\n  LEFT JOIN  dt2\n  on date(w.Norm_Post_Date)=date(dt2.date)\n\ngroup by  Upper(w.Brandlevel),w.ACCT_UNIT_TXT,--w.customer, w.customer_name, w.bill_cycle,\n  case when mod(FISCAL_WEEK,2) = 0 then trunc(SUNNORM_POSTING_DATE, 'week')+6 else trunc(SUNNORM_POSTING_DATE, 'week')+13 end \n),\nFinal_HB As (SELECT  nwh.ACCT_UNIT_TXT ||'B' AS \"Organization_\"\n       ,'HB' AS \"Account_\"\n       ,nwh.Brandlevel as \"Specialties_\" \n       ,'EBTotal' AS \"Company_\"\n       ,dt.FISCAL_YEAR AS \"FY_\"\n       ,'Week'||dt.FISCAL_WEEK AS \"Time_\"\n       ,'Biweekly actuals' AS \"Scenario_\"\n       ,ROUND(nwh.Conv_billed_hours,2) AS \"Local\"\n  FROM Hb_PREP2 nwh  \n inner join biweek \n     on nwh.norm_posting_dt = biweek.biweekly\n inner join dt\n    on biweek.sunnorm_posting_date = dt.sunnorm_posting_date\n)\n\nselect * from Final_Financials\nunion all \nselect * from Final_AOA\nunion all\nselect * from Final_HB"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6339292":{"id":6339292,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-480,"y":288,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6339251],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WBS_MONTHLY"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with BiWeek_cust as (select distinct b.SEARCH_NAME as customer_name,\n                        \tp.value AS bill_cycle,\n                        \ta.active_status Activity_Status, \n                        \tactivity_txt,\n                        \ttry_to_number(level_detail_02) as customer\n                       from datalake.public.dim_activity a \n                       left join (select a.* \n\t\t                            from \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" a\n                                    inner join (select distinct CUSTOMER,count(CUSTOMER)  \n                                                  from \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\"\n                                                 group by CUSTOMER\n                                                having count(CUSTOMER)=1) b \n                                       on  a.customer=b.customer\n                                    union all\n                                   select a.* \n                                     from \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" a\n                                    inner join (select distinct CUSTOMER,count(CUSTOMER)  \n                                                  from \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\"\n                                                 group by CUSTOMER\n                                                having count(CUSTOMER)>1) b \n\t\t                               on  a.customer=b.customer\n\t\t                            where a.company=2) b  \n                         on try_to_number(a.level_detail_02) = b.customer\n                       left join(select Distinct a.ACCOUNTNUMBER as Customer_Number, a.NAME as Customer_Name, a.CDA_PAYCYCLE,k.value\n                                   from \"PROD_DATALAKE\".\"CRM_MSCRM\".\"ACCOUNTBASE\" a\n                                   left join (select distinct attributevalue,value \n\t\t\t\t\t                            from datalake.public.crm_dl_ldg_stringmapbase\n\t\t\t\t\t                           where attributename ='cda_paycycle') k \n\t\t                             on k.attributevalue=a.CDA_PAYCYCLE) p \n                         on p.Customer_Number=try_to_number(a.level_detail_02)  \n                      where a.active_status='Y'\n                        and p.value in ('Monthly')\n                     ),\n     dt as (select distinct\n                   sunnorm_posting_date,\n                   FISCAL_WEEK,\n                   FISCAL_YEAR,\n                   FISCAL_YEAR_PERIOD\n              from \"PROD_EDW\".\"ENT\".\"DATE_DIM\" dim \n             WHERE EXISTS (SELECT 1\n                             from \"PROD_EDW\".\"ENT\".\"DATE_DIM\" dim1\n\t\t\tWHERE (dim1.date >= current_date()-20\n                             AND dim1.date = dim.date)\n                          )\n           ),\n      dt2 as (select  \n                   distinct date, \n                   sunnorm_posting_date,\n                   FISCAL_WEEK,\n                   FISCAL_YEAR,\n                   FISCAL_YEAR_PERIOD\n              from \"PROD_EDW\".\"ENT\".\"DATE_DIM\" dim  \n              ),  \n     sun_dt AS (select DISTINCT fiscal_year_period,SUNNORM_POSTING_DATE\n                from\"PROD_EDW\".\"ENT\".\"DATE_DIM\" dim\n                ),\n     weeks_cnt AS (select fiscal_year_period, count(distinct sunnorm_posting_date) number_of_weeks\n                    from \"PROD_EDW\".\"ENT\".\"DATE_DIM\" \n                   group by fiscal_year_period\n                    ),      \n     prep1 as (SELECT TR.ACCT_UNIT_TXT||'B' AS \"Organization_\"\n                            ,TR.account_nm||'AL' AS \"Account_\"\n                            ,iff(g.brand_val_txt is null, 'UB', brand_val_txt) AS brand_level\n                            ,TR.norm_posting_dt\n                            ,CUST.customer\n                            ,CASE WHEN (SUBSTR(TR.account_nm,1,1) = '4' OR TR.account_nm = '2660') THEN (0-TR.TRAN_AMT) \n                                  ELSE TR.TRAN_AMT\n                              END AS Total_Bill_Amount\n                      from datalake.public.dim_trans TR\n                      left join BiWeek_cust cust on cust.activity_txt = TR.activity \n                      left join datalake.public.dim_brand g \n                        on g.activity_txt = CUST.activity_txt\n                       and  ( g.valid_to_dt >=  iff(dateadd('day', 7, TR.norm_posting_dt) < '2019-06-30', '2019-06-30', dateadd('day', 7, TR.norm_posting_dt)) \n                       and  g.valid_frm_dt < iff(dateadd('day', 7, TR.norm_posting_dt) < '2019-06-30', '2019-06-30', dateadd('day', 7, TR.norm_posting_dt))  )\n                     where ( TR.norm_posting_dt <= case when DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) in (1,2,3,4) then \n                                                             DATEADD(DAY, -7 - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), \n                                                             to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) \n                                                        else DATEADD(DAY, - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), \n                                                             to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) \n                                                    end\n                       and TR.norm_posting_dt >= DATE_FROM_PARTS(YEAR(to_date(current_timestamp())) - 1, 01, 01)\n                       )\n                       and ((TR.account_nm >= '4100' and TR.account_nm <= '5999') or TR.account_nm = '2660')\n                       and TR.RUN_DATE <= dateadd(day,9,TR.NORM_POSTING_DT)\n                       and TR.active_status = 'Y' \n                       and CUST.Activity_Status='Y'\n                     ),\n    Non_week_wbs As (SELECT dt.fiscal_year_period,\n                        \"Organization_\"\n                         ,\"Account_\"\n                         ,brand_level\n                         , sum(Total_Bill_Amount) as Total_Bill_Amount\n                     FROM prep1 nww\n                    INNER JOIN  prod_edw.ent.date_dim dt\n                       on date(nww.norm_posting_dt)=date(dt.date) \n                  group by \"Organization_\"\n                         ,\"Account_\"\n                         ,brand_level\n                         ,dt.fiscal_year_period\n\t\t\t\t\t\t ),                       \nFinal_Financials as (SELECT \"Organization_\"\n       ,\"Account_\"\n       ,brand_level as \"Specialties_\" \n       ,'EBTotal' AS \"Company_\"\n       ,dt.FISCAL_YEAR AS \"FY_\"\n       ,'Week'||dt.FISCAL_WEEK AS \"Time_\"\n       ,'Biweekly actuals' AS \"Scenario_\"\n       ,round(Total_Bill_Amount/wc.number_of_weeks,2) AS \"Local\"\n  FROM Non_week_wbs nww\n inner join weeks_cnt wc \n    on nww.fiscal_year_period = wc.fiscal_year_period  \n inner join sun_dt sd  \n    on sd.fiscal_year_period = nww.fiscal_year_period\n inner join dt\n    on sd.sunnorm_posting_date = dt.sunnorm_posting_date\n\t),\nAOA_PREP1 AS(\nselect tr.*,cust.bill_cycle,\n  case when tr.EMPLOYEE='' then 0 else cast (tr.EMPLOYEE as BIGINT) end as Resource\n  from (\n    SELECT\tDISTINCT ACTRANS.OBJ_ID, \n\t\t\t\tACTRANS.ACCT_UNIT as ACCT_UNIT_TXT,\n\t\t\t\tACTRANS.ACCOUNT,\n\t\t\t\tACTRANS.ACCT_CATEGORY,\n\t\t\t\tACTRANS.ACTIVITY,\n\t\t\t\tLTRIM(ARCUSTOMER.CUSTOMER) as CUSTOMER,\n\t\t\t\tCUSTDESC.NAME as SEARCH_NAME,\n\t\t\t\t CASE \tWHEN \t(ACTRANS.RESOURCE_CODE IS NULL)\tOR (ACTRANS.RESOURCE_CODE = '')\n\t\t\t\t\t\t\t\t\t\tTHEN\tACHISTDTL.RESOURCE_CODE\n\t\t\t\t\t\t\t\t\tELSE\tACTRANS.RESOURCE_CODE  END as EMPLOYEE,\n\t\t\n\t\t\t\tACTRANS.POSTING_DATE,\n                case when dayname(ACTRANS.POSTING_DATE) = 'Sun' then ACTRANS.POSTING_DATE\n                                                  else dateadd(day,7-DAYOFWEEK (ACTRANS.POSTING_DATE),ACTRANS.POSTING_DATE) end as Norm_Post_Date,\n                CASE when ACACTMXVAL.MX_VALUE is null then ARCSTMXVAL.MX_VALUE else ACACTMXVAL.MX_VALUE end as Brandlevel,\n\t\t\t\tACTRANS.SUM_ACCT_CAT,\n\t\t\t\tiff(NATACCT.NAT_CUSTOMER is null, ARCUSTOMER.CUSTOMER,NATACCT.NAT_CUSTOMER) as LAWSON_PARENT_NUMBER ,\n\t\t\t    iff(NAT_CUSTDESC.SEARCH_NAME is null, CUSTDESC.SEARCH_NAME, NAT_CUSTDESC.SEARCH_NAME) as LAWSON_PARENT_NAME\nFROM    \"PROD_DATALAKE\".\"LAWPROD\".\"ACTRANS\" ACTRANS\n\t\tINNER JOIN \"PROD_DATALAKE\".\"LAWPROD\".\"ACACTIVITY\" ACACTIVITY   ON ACTRANS.ACTIVITY = ACACTIVITY.ACTIVITY \n        INNER JOIN \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" ARCUSTOMER   ON ACACTIVITY.LEVEL_DETAIL_02 = ARCUSTOMER.CUSTOMER \n        INNER JOIN \"PROD_DATALAKE\".\"LAWPROD\".\"CUSTDESC\"   CUSTDESC     ON ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER \n        LEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"NATACCT\"    NATACCT      ON NATACCT.CUSTOMER = ARCUSTOMER.CUSTOMER \n        LEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"CUSTDESC\"   NAT_CUSTDESC ON NATACCT.CUSTOMER = NAT_CUSTDESC.CUSTOMER \n        LEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"ACACTMXVAL\" ACACTMXVAL   ON ACACTIVITY.OBJ_ID=ACACTMXVAL.OBJ_ID AND\tACACTMXVAL.MATRIX_CAT \t= 'BRAND'\n        LEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"ARCSTMXVAL\" ARCSTMXVAL   ON ARCUSTOMER.OBJ_ID=ARCSTMXVAL.OBJ_ID AND\tARCSTMXVAL.MATRIX_CAT \t= 'BRAND'\n\t\tLEFT JOIN  \"PROD_DATALAKE\".\"LAWPROD\".\"ACHISTDTL\"ACHISTDTL      ON ACTRANS.OBJ_ID = ACHISTDTL.ATN_OBJ_ID\n\t\tWHERE ACTRANS.ACCOUNT \tNOT IN (1230) \n\t\tAND\tACTRANS.ACCT_CATEGORY \tNOT IN ('510BC')\n ) tr\n  \n inner join BiWeek_cust cust on cust.activity_txt = tr.ACTIVITY\n  \n  where\n  ( tr.Norm_Post_Date <= case when DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) in (1,2,3,4) then DATEADD(DAY, -7 - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) else\n DATEADD(DAY, - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) end\n and  tr.Norm_Post_Date >= DATE_FROM_PARTS(YEAR(to_date(current_timestamp())) - 2, 01, 01)) \n),\n\nAOA_PREP2 AS(\nselect \n     w.Norm_Post_Date,\n     dt2.fiscal_year_period,\n    '' as customer_name, \n    count(Distinct w.customer) as customer,\n    'Monthly' as bill_cycle,\n    w.ACCT_UNIT_TXT,\n    UPPER(w.Brandlevel) as Brandlevel,         \n    count(distinct w.Resource) as AOA,\n\t\nfrom AOA_PREP1 W \nLEFT JOIN dt2 \nON date(w.Norm_Post_Date)=date(dt2.date)\ngroup by dt2.fiscal_year_period,UPPER(w.Brandlevel),w.ACCT_UNIT_TXT,w.Norm_Post_Date\n),\t\t\t\n\t\nNon_week_AOA As (SELECT dt.fiscal_year_period\n                         --,AP.Norm_Post_Date as Norm_Post_Date\n                         ,AP.ACCT_UNIT_TXT ||'B' AS \"Organization_\"\n                         ,'AOA' AS \"Account_\"\n                         ,AP.Brandlevel\n\t\t\t\t\t\t ,AP.AOA AS AOA           \n                         --, sum(Total_Bill_Amount) as Total_Bill_Amount\n                     FROM AOA_PREP2 AP\n                    INNER JOIN  prod_edw.ent.date_dim dt\n                       on date(AP.Norm_Post_Date)=date(dt.date) \n), \n\t\nFinal_AOA as (SELECT  nwa.\"Organization_\" AS \"Organization_\"\n       ,'AOA' AS \"Account_\"\n       ,nwa.Brandlevel as \"Specialties_\" \n       ,'EBTotal' AS \"Company_\"\n       ,dt.FISCAL_YEAR AS \"FY_\"\n       ,'Week'||dt.FISCAL_WEEK AS \"Time_\"\n       ,'Biweekly actuals' AS \"Scenario_\"\n       ,AOA AS \"Local\"\n  FROM Non_week_AOA nwa\n inner join weeks_cnt wc \n    on nwa.fiscal_year_period = wc.fiscal_year_period  \n inner join sun_dt sd  \n    on sd.fiscal_year_period = nwa.fiscal_year_period\n inner join dt\n    on sd.sunnorm_posting_date = dt.sunnorm_posting_date\n),\nHB_PREP1 AS(\nSELECT TR.*,\n      case when TR.ACCT_CAT_CD='51RW' then TR.UNITS_AMOUNT else TR.BILLABLE_UNIT end as BILLABLE_UNIT_NEW,\n    case when TR.ACCT_CAT_CD='51RW' then TR.BILLABLE_UNIT else TR.UNITS_AMOUNT end as UNITS_AMOUNT_NEW,\n\tTR.norm_posting_dt as Norm_Post_Date,\n\tCUST.customer,\n\tCUST.customer_name,\n\tCUST.Activity_Status,\n\tCUST.bill_cycle,\n\tiff(g.brand_val_txt is null, 'UB', brand_val_txt) as Brandlevel, \n    k.conv_factor_val_txt\n\t\nfrom datalake.public.dim_trans TR\nleft join BiWeek_cust cust on cust.activity_txt = TR.activity \nleft join datalake.public.dim_brand g on g.activity_txt = CUST.activity_txt\n                   and  ( g.valid_to_dt >=  iff(dateadd('day', 7, TR.norm_posting_dt) < '2019-06-30', '2019-06-30', dateadd('day', 7, TR.norm_posting_dt)) \n                   and  g.valid_frm_dt < iff(dateadd('day', 7, TR.norm_posting_dt) < '2019-06-30', '2019-06-30', dateadd('day', 7, TR.norm_posting_dt))  )\nleft join (select r.*, s.CONV_FACTOR_VAL_TXT\n           from datalake.public.dim_acct_cat r\n           inner join datalake.public.dim_conv_factor s\n           on r.conv_factor_id = s.conv_factor_id) k\non TR.acct_cat_cd = k.acct_cat_txt\nwhere\n ( TR.norm_posting_dt <= case when DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) in (1,2,3,4) then DATEADD(DAY, -7 - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) else\n DATEADD(DAY, - DAYOFWEEKISO(to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))), to_date(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago',current_timestamp()))) end\n and  TR.norm_posting_dt >= DATE_FROM_PARTS(YEAR(to_date(current_timestamp())) - 2, 01, 01))\nand  ((TR.account_nm >= '4100' and TR.account_nm <= '5999') or TR.account_nm = '2660')\nand TR.RUN_DATE <= dateadd(day,9,TR.NORM_POSTING_DT)\nAND  TR.active_status = 'Y' and CUST.Activity_Status='Y' \n),\nHB_PREP2 AS(\n SELECT \n\tdt2.fiscal_year_period ,\n\tUpper(w.Brandlevel) as Brandlevel , \n    w.ACCT_UNIT_TXT, \n    --w.customer, \n    --w.customer_name, \n    --w.bill_cycle,\n    sum(w.billable_amt)                                                                                                as  Billable_Amt,\n    sum(w.BILLABLE_UNIT_NEW)                                                                                           as  Billable_Unit,\n    sum(w.UNITS_AMOUNT_NEW)                                                                                            as  Units_Amount,                                                                             \n \n    Round(\n            sum(iff(w.conv_factor_val_txt = 'None', w.BILLABLE_UNIT_NEW,\n                iff((w.conv_factor_val_txt = 'BILLABLE_AMT / 25' OR\n                 w.conv_factor_val_txt = 'BILLABLE_AMT /25'), w.billable_amt / 25,\n                iff(w.conv_factor_val_txt = 'BILLABLE_AMT / 15', w.billable_amt / 15,\n                iff((w.conv_factor_val_txt = 'BILLABLE_UNIT * 8'), w.BILLABLE_UNIT_NEW * 8,\n                iff(w.conv_factor_val_txt = 'BILLABLE_UNIT * 40', w.BILLABLE_UNIT_NEW * 40,\n                iff(w.conv_factor_val_txt = 'BILLABLE_UNIT / 55', w.BILLABLE_UNIT_NEW / 55, 0))))))),\n                2) as Conv_billed_hours,\nFROM HB_PREP1 w\nLEFT JOIN dt2 ON date(w.Norm_Post_Date)=date(dt2.date)\ngroup by dt2.fiscal_year_period, Upper(w.Brandlevel),w.ACCT_UNIT_TXT --,w.customer, w.customer_name, w.bill_cycle\n),\nFinal_HB As (SELECT  nwh.ACCT_UNIT_TXT ||'B' AS \"Organization_\"\n       ,'HB' AS \"Account_\"\n       ,nwh.Brandlevel as \"Specialties_\" \n       ,'EBTotal' AS \"Company_\"\n       ,dt.FISCAL_YEAR AS \"FY_\"\n       ,'Week'||dt.FISCAL_WEEK AS \"Time_\"\n       ,'Biweekly actuals' AS \"Scenario_\"\n       ,ROUND(nwh.Conv_billed_hours,2) AS \"Local\"\n  FROM Hb_PREP2 nwh\n  inner join weeks_cnt wc \n    on nwh.fiscal_year_period = wc.fiscal_year_period  \n inner join sun_dt sd  \n    on sd.fiscal_year_period = nwh.fiscal_year_period\n inner join dt\n    on sd.sunnorm_posting_date = dt.sunnorm_posting_date\n)\n\nSELECT * FROM Final_Financials\nUNION ALL\nSELECT* FROM Final_AOA\nUNION ALL\nSELECT * FROM Final_HB"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6339293":{"id":6339293,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":-48,"y":256,"width":32,"height":32,"inputConnectorIDs":[6339294],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ESSBASE_NON_WEEKLY_WBS_CUSTOMER_EXPORT"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ESSBASE_NON_WEEKLY_WBS_CUSTOMER_EXPORT"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Organization_"},"2":{"slot":2,"type":"STRING","value":"Organization_"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"Account_"},"2":{"slot":2,"type":"STRING","value":"Account_"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"Specialties_"},"2":{"slot":2,"type":"STRING","value":"Specialties_"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"Company_"},"2":{"slot":2,"type":"STRING","value":"Company_"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"FY_"},"2":{"slot":2,"type":"STRING","value":"FY_"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"Time_"},"2":{"slot":2,"type":"STRING","value":"Time_"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"Scenario_"},"2":{"slot":2,"type":"STRING","value":"Scenario_"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"Local"},"2":{"slot":2,"type":"STRING","value":"Local"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLFINSCH}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${DB_Enterprise}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6339251":{"id":6339251,"sourceID":6339292,"targetID":6339290},"6339294":{"id":6339294,"sourceID":6339290,"targetID":6339293},"6339295":{"id":6339295,"sourceID":6339291,"targetID":6339290}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"jb_Non_Weekly_WBS_Customer_SQL_to_Table","description":"","type":"TRANSFORMATION","tag":"d1fa8e9b-bdf5-4647-b39c-636f23c320e3"}}