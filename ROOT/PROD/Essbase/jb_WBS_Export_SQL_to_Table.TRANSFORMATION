{"job":{"components":{"6338897":{"id":6338897,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":188,"y":166,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6338899],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Source Query"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"with cte_customers as (\n\tselect distinct b.search_name as customer_name,\n\t\tp.value as bill_cycle,\n        a.active_status activity_status,\n        activity_txt,\n        try_to_number(level_detail_02) as customer\n    from datalake.public.dim_activity a\n    left join (\n        select a.*\n        from prod_datalake.lawprod.arcustomer a\n        inner join (\n\t\t\tselect distinct customer, count(customer)\n\t\t\tfrom prod_datalake.lawprod.arcustomer\n\t\t\tgroup by customer\n\t\t\thaving count(customer) = 1\n          ) b on a.customer = b.customer        \n        union all            \n    \tselect a.*\n    \tfrom prod_datalake.lawprod.arcustomer a\n    \tinner join (\n    \t\tselect distinct customer, count(customer)\n    \t\tfrom prod_datalake.lawprod.arcustomer\n    \t\tgroup by customer\n    \t\thaving count(customer) > 1\n            ) b on a.customer = b.customer\n        where a.company = 2\n        ) b on try_to_number(a.level_detail_02) = b.customer\n    left join (\n        select distinct a.accountnumber as customer_number,\n\t\t\ta.name as customer_name,\n\t\t\ta.cda_paycycle,\n\t\t\tk.value\n        from prod_datalake.crm_mscrm.accountbase a\n        left join (\n\t\t\tselect distinct attributevalue, value\n\t\t\tfrom datalake.public.crm_dl_ldg_stringmapbase\n\t\t\twhere attributename = 'cda_paycycle'\n\t\t\t) k on k.attributevalue = a.cda_paycycle\n        ) p on p.customer_number = try_to_number(a.level_detail_02)\n      where a.active_status = 'Y'\n        and (p.value = 'Weekly' or p.value is null)\n      )\n\n, cte_distinct_counts as (\n    select tr.norm_post_date\n        , tr.acct_unit_txt\n        , upper(tr.brand) as \"Brand\"\n        , count(distinct case when tr.employee = '' then 0 else cast(tr.employee as bigint) end) as \"EA\"\n        , count(distinct tr.customer) as \"Cust Billed\"\n    from cte_customers cust\n    inner join (\n      select distinct actrans.obj_id,\n        actrans.acct_unit as acct_unit_txt,\n        actrans.account,\n        actrans.acct_category,\n        actrans.activity,\n        ltrim(arcustomer.customer) as customer,\n        custdesc.name as search_name,\n        case when (actrans.resource_code is null) or (actrans.resource_code = '') then achistdtl.resource_code \n            else actrans.resource_code \n            end as employee,\n        actrans.posting_date,\n        case when dayname(actrans.posting_date) = 'Sun' then actrans.posting_date \n    \t\telse dateadd(day, 7 - dayofweek(actrans.posting_date), actrans.posting_date) \n    \t\tend as norm_post_date,\n        case when acactmxval.mx_value is null then arcstmxval.mx_value else acactmxval.mx_value end as brand\n      from prod_datalake.lawprod.actrans actrans\n      inner join prod_datalake.lawprod.acactivity acactivity on actrans.activity = acactivity.activity\n      inner join prod_datalake.lawprod.arcustomer arcustomer on acactivity.level_detail_02 = arcustomer.customer\n      inner join prod_datalake.lawprod.custdesc custdesc on arcustomer.customer = custdesc.customer\n      left join prod_datalake.lawprod.natacct natacct on natacct.customer = arcustomer.customer\n      left join prod_datalake.lawprod.custdesc nat_custdesc on natacct.customer = nat_custdesc.customer\n      left join prod_datalake.lawprod.acactmxval acactmxval on acactivity.obj_id = acactmxval.obj_id AND acactmxval.matrix_cat = 'BRAND'\n      left join prod_datalake.lawprod.arcstmxval arcstmxval on arcustomer.obj_id = arcstmxval.obj_id AND arcstmxval.matrix_cat = 'BRAND'\n      left join prod_datalake.lawprod.achistdtl achistdtl on actrans.obj_id = achistdtl.atn_obj_id\n      where actrans.account not in (1230) and actrans.acct_category not in ('510BC')\n      ) tr ON cust.activity_txt = tr.activity\n    where tr.norm_post_date <= case when dayofweekiso(to_date(convert_timezone('America/Los_Angeles', 'America/Chicago',current_timestamp()))) in (1,2,3,4) \n          then dateadd(DAY, -7 - dayofweekiso(to_date(convert_timezone('America/Los_Angeles', 'America/Chicago', current_timestamp())))\n              , to_date(convert_timezone('America/Los_Angeles', 'America/Chicago',current_timestamp()))) \n          else dateadd(DAY, - dayofweekiso(to_date(convert_timezone('America/Los_Angeles', 'America/Chicago',current_timestamp())))\n              , to_date(convert_timezone('America/Los_Angeles', 'America/Chicago',current_timestamp()))) \n          end\n      and tr.norm_post_date >= date_from_parts(year(to_date(current_timestamp())) - 1, 01, 01)\n    group by tr.norm_post_date, tr.acct_unit_txt, upper(tr.brand)\n)\n\n, cte_calc_prep as (\n      select tr.*\n        , case when tr.acct_cat_cd = '51RW' then tr.units_amount else tr.billable_unit end as billable_unit_new\n        , case when tr.acct_cat_cd = '51RW' then tr.billable_unit else tr.units_amount end as units_amount_new\n        , tr.norm_posting_dt as norm_post_date\n        , iff(g.brand_val_txt is null, 'UB', brand_val_txt) as brandlevel\n        , k.conv_factor_val_txt\n      from datalake.public.dim_trans tr\n      left join cte_customers cust on cust.activity_txt = tr.activity\n      left join datalake.public.dim_brand g on g.activity_txt = cust.activity_txt\n        and g.valid_to_dt >= dateadd('day', 7, tr.norm_posting_dt)\n        and g.valid_frm_dt < dateadd('day', 7, tr.norm_posting_dt)\n      left join (\n        select r.*, s.conv_factor_val_txt\n        from datalake.public.dim_acct_cat r\n        inner join datalake.public.dim_conv_factor s on r.conv_factor_id = s.conv_factor_id\n        ) k on tr.acct_cat_cd = k.acct_cat_txt\n      where tr.norm_posting_dt <= case when dayofweekiso(to_date(convert_timezone('America/Los_Angeles', 'America/Chicago',current_timestamp()))) in (1,2,3,4) \n            then dateadd(DAY, -7 - dayofweekiso(to_date(convert_timezone('America/Los_Angeles', 'America/Chicago', current_timestamp())))\n                , to_date(convert_timezone('America/Los_Angeles', 'America/Chicago',current_timestamp()))) \n            else dateadd(DAY, - dayofweekiso(to_date(convert_timezone('America/Los_Angeles', 'America/Chicago',current_timestamp())))\n                , to_date(convert_timezone('America/Los_Angeles', 'America/Chicago',current_timestamp()))) \n            end\n        and tr.norm_posting_dt >= date_from_parts(year(to_date(current_timestamp())) - 1, 01, 01)\n        and ((tr.account_nm >= '4100' and tr.account_nm <= '5999') or tr.account_nm = '2660')\n--        and tr.run_date <= dateadd(day, 9, tr.norm_posting_dt)\n        and tr.active_status = 'Y'\n        and cust.activity_status = 'Y'\n      )\n      \n, cte_calc_final as (\n    select w.norm_post_date\n        , upper(w.brandlevel) as \"Brand\"\n        , w.acct_unit_txt\n        , round(sum(iff(w.conv_factor_val_txt = 'None', w.billable_unit_new\n            , iff((w.conv_factor_val_txt = 'BILLABLE_AMT / 25' or w.conv_factor_val_txt = 'BILLABLE_AMT /25'), w.billable_amt / 25\n                , iff((w.conv_factor_val_txt = 'BILLABLE_AMT / 15'), w.billable_amt / 15\n                    , iff((w.conv_factor_val_txt = 'BILLABLE_UNIT * 8'), w.billable_unit_new * 8\n                        , iff((w.conv_factor_val_txt = 'BILLABLE_UNIT * 40'), w.billable_unit_new * 40\n                            , iff((w.conv_factor_val_txt = 'BILLABLE_UNIT / 55'), w.billable_unit_new / 55\n                            , 0)))))))\n            , 2) as \"Billed Hrs\"\n        , sum(iff((w.account_nm in ('4100', '4950')), 0 - w.tran_amt, 0)) as \"Temp Billings\"\n        , sum(iff((w.account_nm = '4200'), 0 - w.tran_amt, 0)) as \"Subcont Rev\"\n        , sum(iff((w.account_nm = '4600'), 0 - w.tran_amt, 0)) as \"Conv Fees\"    \n        , sum(iff((w.account_nm in ('2660', '4700') and w.acct_cat_cd = '4700'), 0 - w.tran_amt, 0)) as \"DH Fees\"\n        , sum(iff((w.account_nm = '4750'), 0 - w.tran_amt, 0)) as \"QH Fees\"\n        , sum(iff((w.account_nm = '4800'), 0 - w.tran_amt, 0)) as \"ACA\"\n        , sum(iff((w.account_nm = '4525'), 0 - w.tran_amt, 0)) as \"Sick Rev\"\n        , sum(iff((w.account_nm = '4900'), 0 - w.tran_amt, 0)) as \"Other Rev\"\n        , sum(iff((w.account_nm in ('5100', '5950')), w.tran_amt, 0)) as \"Temp Wage\"\n        , sum(iff((w.account_nm = '5200'), w.tran_amt, 0)) as \"Subcont Cost\"\n        , sum(iff((w.account_nm = '5310'), w.tran_amt, 0)) as \"FICA\"\n        , sum(iff((w.account_nm = '5320'), w.tran_amt, 0)) as \"FUTA\"\n        , sum(iff((w.account_nm = '5330'), w.tran_amt, 0)) as \"SUTA\"\n        , sum(iff((w.account_nm = '5340'), w.tran_amt, 0)) as \"Local Tax\"\n        , sum(iff((w.account_nm = '5400'), w.tran_amt, 0)) as \"WC\"\n        , sum(iff((w.account_nm = '5410'), w.tran_amt, 0)) as \"WC Med\"\n        , sum(iff((w.account_nm in ('5500', '5501')), w.tran_amt, 0)) as \"Insurance\"\n        , sum(iff((w.account_nm = '5510'), w.tran_amt, 0)) as \"Benefit\"\n        , sum(iff((w.account_nm = '5515'), w.tran_amt, 0)) as \"Vacation\"\n        , sum(iff((w.account_nm = '5520'), w.tran_amt, 0)) as \"Holiday\"\n        , sum(iff((w.account_nm = '5530'), w.tran_amt, 0)) as \"401K\"\n        , sum(iff((w.account_nm = '5800'), w.tran_amt, 0)) as \"ACA Cost\"\n        , sum(iff((w.account_nm = '5525'), w.tran_amt, 0)) as \"Sick Pay\"\n        , sum(iff((w.account_nm = '5900'), w.tran_amt, 0)) as \"Other Cost\"\n        , sum(iff((w.account_nm = '5910'), w.tran_amt, 0)) as \"Fld Test\"\n        , sum(iff((w.account_nm = '5920'), w.tran_amt, 0)) as \"ComData\"\n        , sum(iff((w.account_nm = '5100'), w.tran_amt, 0)) as \"Associate Wage\"\n        , sum(iff((w.account_nm = '5950'), w.tran_amt, 0)) as \"Consulting Wage\"\n        , sum(iff((w.account_nm = '4100'), 0 - w.tran_amt, 0)) as \"Associate Revenue\"\n        , sum(iff((w.account_nm = '4950'), 0 - w.tran_amt, 0)) as \"Consulting Revenue\"\n        , sum(iff((w.account_nm = '5850'), w.tran_amt, 0)) as \"Customer Rebate\" \n     from cte_calc_prep w\n    group by w.norm_post_date, upper(w.brandlevel), w.acct_unit_txt\n    )\nselect 'Week' || LPAD(WEEKISO(coalesce(a.norm_post_date, b.norm_post_date)), 2, '0') as \"Posting Week\"\n    , coalesce(a.\"Brand\", b.\"Brand\") as \"Brand\"\n    , coalesce(a.acct_unit_txt, b.acct_unit_txt) as acct_unit_txt\n    , coalesce(b.\"EA\", 0) as \"EA\"\n    , coalesce(a.\"Billed Hrs\", 0) as \"Billed Hrs\"\n    , coalesce(b.\"Cust Billed\", 0) as \"Cust Billed\"\n    , coalesce(a.\"Temp Billings\", 0) as \"Temp Billings\"\n    , coalesce(a.\"Subcont Rev\", 0) as \"Subcont Rev\"\n    , coalesce(a.\"Conv Fees\", 0) as \"Conv Fees\"\n    , coalesce(a.\"DH Fees\", 0) as \"DH Fees\"\n    , coalesce(a.\"QH Fees\", 0) as \"QH Fees\"\n    , coalesce(a.\"ACA\", 0) as \"ACA\"\n    , coalesce(a.\"Sick Rev\", 0) as \"Sick Rev\"\n    , coalesce(a.\"Other Rev\", 0) as \"Other Rev\"\n    , coalesce(a.\"Temp Wage\", 0) as \"Temp Wage\"\n    , coalesce(a.\"Subcont Cost\", 0) as \"Subcont Cost\"\n    , coalesce(a.\"FICA\", 0) as \"FICA\"\n    , coalesce(a.\"FUTA\", 0) as \"FUTA\"\n    , coalesce(a.\"SUTA\", 0) as \"SUTA\"\n    , coalesce(a.\"Local Tax\", 0) as \"Local Tax\"\n    , coalesce(a.\"WC\", 0) as \"WC\"\n    , coalesce(a.\"WC Med\", 0) as \"WC Med\"\n    , coalesce(a.\"Insurance\", 0) as \"Insurance\"\n    , coalesce(a.\"Benefit\", 0) as \"Benefit\"\n    , coalesce(a.\"Vacation\", 0) as \"Vacation\"\n    , coalesce(a.\"Holiday\", 0) as \"Holiday\"\n    , coalesce(a.\"401K\", 0) as \"401K\"\n    , coalesce(a.\"ACA Cost\", 0) as \"ACA Cost\"\n    , coalesce(a.\"Sick Pay\", 0) as \"Sick Pay\"\n    , coalesce(a.\"Other Cost\", 0) as \"Other Cost\"\n    , coalesce(a.\"Fld Test\", 0) as \"Fld Test\"\n    , coalesce(a.\"ComData\", 0) as \"ComData\"\n    , coalesce(a.\"Associate Wage\", 0) as \"Associate Wage\"\n    , coalesce(a.\"Consulting Wage\", 0) as \"Consulting Wage\"\n    , coalesce(a.\"Associate Revenue\", 0) as \"Associate Revenue\"\n    , coalesce(a.\"Consulting Revenue\", 0) as \"Consulting Revenue\"\n    , coalesce(a.\"Customer Rebate\", 0) as \"Customer Rebate\"\n    , YEAR(coalesce(a.norm_post_date, b.norm_post_date)) as \"Year\"\nfrom cte_calc_final a\nfull join cte_distinct_counts b on a.norm_post_date = b.norm_post_date\n    and a.\"Brand\" = b.\"Brand\"\n    and a.acct_unit_txt = b.acct_unit_txt\nwhere (a.norm_post_date > dateadd(day, -13, getdate()) or b.norm_post_date > dateadd(day, -13, getdate()))"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6338898":{"id":6338898,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":343,"y":162,"width":32,"height":32,"inputConnectorIDs":[6338899],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WBS_TO_ESSBASE"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WBS_TO_ESSBASE"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Posting Week"},"2":{"slot":2,"type":"STRING","value":"Posting Week"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"Brand"},"2":{"slot":2,"type":"STRING","value":"Brand"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"ACCT_UNIT_TXT"},"2":{"slot":2,"type":"STRING","value":"Acct Unit"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"EA"},"2":{"slot":2,"type":"STRING","value":"EA"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"Billed Hrs"},"2":{"slot":2,"type":"STRING","value":"Billed Hrs"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"Cust Billed"},"2":{"slot":2,"type":"STRING","value":"Cust Billed"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"Temp Billings"},"2":{"slot":2,"type":"STRING","value":"Temp Billings"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"Subcont Rev"},"2":{"slot":2,"type":"STRING","value":"Subcont Rev"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"Conv Fees"},"2":{"slot":2,"type":"STRING","value":"Conv Fees"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"DH Fees"},"2":{"slot":2,"type":"STRING","value":"DH Fees"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"QH Fees"},"2":{"slot":2,"type":"STRING","value":"QH Fees"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"ACA"},"2":{"slot":2,"type":"STRING","value":"ACA"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"Sick Rev"},"2":{"slot":2,"type":"STRING","value":"Sick Rev"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"Other Rev"},"2":{"slot":2,"type":"STRING","value":"Other Rev"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"Temp Wage"},"2":{"slot":2,"type":"STRING","value":"Temp Wage"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"Subcont Cost"},"2":{"slot":2,"type":"STRING","value":"Subcont Cost"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"FICA"},"2":{"slot":2,"type":"STRING","value":"FICA"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"FUTA"},"2":{"slot":2,"type":"STRING","value":"FUTA"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"SUTA"},"2":{"slot":2,"type":"STRING","value":"SUTA"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"Local Tax"},"2":{"slot":2,"type":"STRING","value":"Local Tax"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"WC"},"2":{"slot":2,"type":"STRING","value":"WC"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"WC Med"},"2":{"slot":2,"type":"STRING","value":"WC Med"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"Insurance"},"2":{"slot":2,"type":"STRING","value":"Insurance"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"Benefit"},"2":{"slot":2,"type":"STRING","value":"Benefit"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"Vacation"},"2":{"slot":2,"type":"STRING","value":"Vacation"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"Holiday"},"2":{"slot":2,"type":"STRING","value":"Holiday"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"401K"},"2":{"slot":2,"type":"STRING","value":"401K"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"ACA Cost"},"2":{"slot":2,"type":"STRING","value":"ACA Cost"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"Sick Pay"},"2":{"slot":2,"type":"STRING","value":"Sick Pay"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"Other Cost"},"2":{"slot":2,"type":"STRING","value":"Other Cost"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"Fld Test"},"2":{"slot":2,"type":"STRING","value":"Fld Test"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"ComData"},"2":{"slot":2,"type":"STRING","value":"ComData"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"Associate Wage"},"2":{"slot":2,"type":"STRING","value":"Associate Wage"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"Consulting Wage"},"2":{"slot":2,"type":"STRING","value":"Consulting Wage"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"Associate Revenue"},"2":{"slot":2,"type":"STRING","value":"Associate Revenue"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"Consulting Revenue"},"2":{"slot":2,"type":"STRING","value":"Consulting Revenue"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"Customer Rebate"},"2":{"slot":2,"type":"STRING","value":"Customer Rebate"}}},"38":{"slot":38,"values":{"1":{"slot":1,"type":"STRING","value":"Year"},"2":{"slot":2,"type":"STRING","value":"Year"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLFINSCH}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${DB_Enterprise}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6338899":{"id":6338899,"sourceID":6338897,"targetID":6338898}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"jb_WBS_Export_SQL_to_Table","description":"","type":"TRANSFORMATION","tag":"80264edc-06b7-433d-aa77-8a37f7f5fec5"}}