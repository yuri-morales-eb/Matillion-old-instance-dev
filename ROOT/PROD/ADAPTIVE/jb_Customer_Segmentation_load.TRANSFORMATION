{"job":{"components":{"6341692":{"id":6341692,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":432,"y":272,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6341651],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL Logic"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH CTE_CUSTOMER_DATA AS (WITH CTE_EB_TRANSACTIONS AS (SELECT ACACT.LEVEL_DETAIL_02  AS CUSTOMER_NUMBER,\n                                                               MAX(ACTR.POSTING_DATE) AS POSTING_DATE\n                                                        FROM PROD_DATALAKE.LAWPROD.ACACTIVITY ACACT\n                                                                 INNER JOIN PROD_DATALAKE.LAWPROD.ACTRANS ACTR\n                                                                            ON ACTR.ACTIVITY = ACACT.ACTIVITY\n                                                        GROUP BY ACACT.LEVEL_DETAIL_02),\n                                CTE_EB_TRANSACTION_DIM_DATE AS (SELECT EBT.CUSTOMER_NUMBER AS CUSTOMER_NUMBER,\n                                                                       EBT.POSTING_DATE    AS POSTING_DATE,\n                                                                       DD.FISCAL_PERIOD    AS FISCAL_PERIOD,\n                                                                       DD.FISCAL_YEAR      AS FISCAL_YEAR\n                                                                FROM CTE_EB_TRANSACTIONS EBT\n                                                                         LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n                                                                                   ON EBT.POSTING_DATE = DD.DATE),\n                                CTE_ALL_CUSTOMERS_SOURCE AS (SELECT LWC.CUSTOMER_NUMBER   AS CUSTOMER_NUMBER,\n                                                                    LWC.CUSTOMER_NAME     AS CUSTOMER_NAME,\n                                                                    LWC.BILLING_FREQUENCY AS BILLING_FREQUENCY,\n                                                                    EBTDD.FISCAL_PERIOD   AS FISCAL_PERIOD,\n                                                                    EBTDD.FISCAL_YEAR     AS FISCAL_YEAR\n                                                             FROM PROD_ENTERPRISE.ADAPTIVE.VW_LAW_CUSTOMER LWC\n                                                                      LEFT JOIN CTE_EB_TRANSACTION_DIM_DATE EBTDD\n                                                                                ON LWC.CUSTOMER_NUMBER = EBTDD.CUSTOMER_NUMBER),\n                                CTE_ALL_CUSTOMERS AS (SELECT CS.CUSTOMER_NUMBER   AS CUSTOMER_NUMBER,\n                                                             CS.CUSTOMER_NAME     AS CUSTOMER_NAME,\n                                                             CS.BILLING_FREQUENCY AS BILLING_FREQUENCY\n                                                      FROM CTE_ALL_CUSTOMERS_SOURCE CS\n                                                      WHERE (CS.FISCAL_YEAR IS NULL OR CS.FISCAL_YEAR >= 2024)\n                                                        AND (CS.FISCAL_PERIOD IS NULL OR CS.FISCAL_PERIOD < (SELECT TO_NUMBER(DD.FISCAL_PERIOD) AS FISCAL_PERIOD\n                                                                                                             FROM PROD_EDW.ENT.DATE_DIM DD\n                                                                                                             WHERE DD.DATE = CURRENT_DATE())))\n                           SELECT FS.CUSTOMER_NUMBER   AS CUSTOMER_NUMBER,\n                                  FS.CUSTOMER_NAME     AS CUSTOMER_NAME,\n                                  FS.BILLING_FREQUENCY AS BILLING_FREQUENCY\n                           FROM CTE_ALL_CUSTOMERS FS),\n     CTE_CY_WC_CODES AS (WITH CTE_RANK AS (SELECT FPR.CUST_ID       AS CUST_ID,\n                                                  FPR.WC_CODE       AS WC_CODE,\n                                                  SUM(FPR.BILL_AMT) AS REV\n                                           FROM DATALAKE.PUBLIC.REPORT_FPR FPR\n                                                    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n                                                              ON DD.DATE = FPR.NORM_POSTING_DATE\n                                                                  AND DD.DW_ACTIVE_FLAG = 'Y'\n                                           WHERE FPR.WC_CODE IS NOT NULL\n                                             AND FPR.WC_CODE <> ''\n                                           GROUP BY CUST_ID, WC_CODE)\n                         SELECT R.CUST_ID                                                                   AS CUST_ID,\n                                R.WC_CODE                                                                   AS WC_CODE,\n                                ROW_NUMBER() OVER (PARTITION BY R.CUST_ID ORDER BY COALESCE(R.REV, 0) DESC) AS REV_RANK\n                         FROM CTE_RANK R\n                         QUALIFY REV_RANK = 1),\n     CTE_NAICS_DATA AS (SELECT DISTINCT CIU.CUSTOMERID AS CUSTOMER_NUMBER,\n                                        CIU.NAICS_CODE AS SIX_DIGIT_NAICS_CODE,\n                                        DN.INDUSTRY    AS INDUSTRY,\n                                        DN.SEGMENT     AS SEGMENT,\n                                        DN.SUB_SEGMENT AS SUB_SEGMENT\n                        FROM DEV_SANDBOX_MERILYTICS.DATAWAREHOUSE.DIM_CUSTOMER_INDUSTRY_UPDATED CIU\n                                 LEFT JOIN DEV_SANDBOX_MERILYTICS.DATAWAREHOUSE.DIM_NAICS_DESC DN\n                                           ON CIU.NAICS_CODE = DN.SIX_DIGIT_NAICS_CODE),\n     CTE_DATA_TRANSFORMATION AS (SELECT C.CUSTOMER_NUMBER                                                                                           AS CUSTOMER_CODE,\n                                        CASE\n                                            WHEN UPPER(LDGCM.ACCOUNT_TYPE) IN ('VIP', 'VIP/VMS', 'VIP/NPG', 'VIP/HYBRID') THEN 'VIP'\n                                            WHEN UPPER(LDGCM.ACCOUNT_TYPE) IN ('RETAIL', 'VMS') THEN LDGCM.ACCOUNT_TYPE\n                                            WHEN LDGCM.ACCOUNT_TYPE IS NULL THEN 'Retail'\n                                            WHEN UPPER(LDGCM.ACCOUNT_TYPE) IN ('NPG', 'HYBRID') THEN 'NPG'\n                                            END                                                                                                     AS ACCOUNT_TYPE_ROLLUP_NAME,\n                                        IFF(ACCOUNT_TYPE_ROLLUP_NAME = 'VIP', 'eBMax', NULL)                                                        AS EBMAX_NAME,\n                                        IFF(LDGCM.ACCOUNT_MGMT_FOCUS IS NULL OR LDGCM.ACCOUNT_MGMT_FOCUS = 'N', 'Non-Enterprise', 'Enterprise')     AS ENTERPRISE_NAME,\n                                        IFF(LDGCM.ACCOUNT_TYPE = 'HYBRID', 'Hybrid', IFF(LDGCM.ACCOUNT_TYPE IS NULL, 'Retail', LDGCM.ACCOUNT_TYPE)) AS ACCOUNT_TYPE_NAME,\n                                        WCCLAS.CLASSIFICATION                                                                                       AS WC_CODE_CLASSIFICATION_NAME,\n                                        WCCLAS.CONSOLIDATED_CLASSIFICATION                                                                          AS WC_CODE_CONSOLIDATED_NAME,\n                                        LDGCM.PARENT_ID                                                                                             AS PARENT_CODE,\n                                        LDGCM.PARENT_NAME                                                                                           AS PARENT_NAME,\n                                        NAICS.INDUSTRY                                                                                              AS INDUSTRY_NAME,\n                                        NAICS.SEGMENT                                                                                               AS SEGMENT_NAME,\n                                        NAICS.SUB_SEGMENT                                                                                           AS SUB_SEGMENT_NAME,\n                                        C.BILLING_FREQUENCY                                                                                         AS BIWEEKLY_ACCOUNT_FLAG_NAME\n                                 FROM CTE_CUSTOMER_DATA C\n                                          LEFT JOIN PROD_NPG_VIP.LDG.NPG_VIP_DL_LDG_CLIENT_MASTER LDGCM\n                                                    ON C.CUSTOMER_NUMBER = LDGCM.CUSTOMER_ID\n                                          LEFT JOIN CTE_CY_WC_CODES WCC\n                                                    ON C.CUSTOMER_NUMBER = WCC.CUST_ID\n                                          LEFT JOIN ${DB_Enterprise}.ADAPTIVE.WORKERS_COMP_CODES WCCLAS\n                                                    ON WCC.WC_CODE = WCCLAS.WC_CODE\n                                          LEFT JOIN CTE_NAICS_DATA NAICS\n                                                    ON C.CUSTOMER_NUMBER = NAICS.CUSTOMER_NUMBER)\nSELECT DT.CUSTOMER_CODE,\n       DT.EBMAX_NAME,\n       DT.ENTERPRISE_NAME,\n       DT.ACCOUNT_TYPE_NAME,\n       DT.ACCOUNT_TYPE_ROLLUP_NAME,\n       DT.WC_CODE_CONSOLIDATED_NAME,\n       DT.WC_CODE_CLASSIFICATION_NAME,\n       DT.PARENT_CODE,\n       DT.PARENT_NAME,\n       DT.INDUSTRY_NAME,\n       DT.SEGMENT_NAME,\n       DT.SUB_SEGMENT_NAME,\n       DT.BIWEEKLY_ACCOUNT_FLAG_NAME\nFROM CTE_DATA_TRANSFORMATION DT\nORDER BY DT.CUSTOMER_CODE\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341693":{"id":6341693,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":704,"y":272,"width":32,"height":32,"inputConnectorIDs":[6341695],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Customer_Segmentation"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CUSTOMER_SEGMENTATION"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CUSTOMER_CODE"},"2":{"slot":2,"type":"STRING","value":"CUSTOMER_CODE"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"EBMAX_NAME"},"2":{"slot":2,"type":"STRING","value":"EBMAX_NAME"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"ENTERPRISE_NAME"},"2":{"slot":2,"type":"STRING","value":"ENTERPRISE_NAME"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"ACCOUNT_TYPE_NAME"},"2":{"slot":2,"type":"STRING","value":"ACCOUNT_TYPE_NAME"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"ACCOUNT_TYPE_ROLLUP_NAME"},"2":{"slot":2,"type":"STRING","value":"ACCOUNT_TYPE_ROLLUP_NAME"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"WC_CODE_CONSOLIDATED_NAME"},"2":{"slot":2,"type":"STRING","value":"WC_CODE_CONSOLIDATED_NAME"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"WC_CODE_CLASSIFICATION_NAME"},"2":{"slot":2,"type":"STRING","value":"WC_CODE_CLASSIFICATION_NAME"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"PARENT_CODE"},"2":{"slot":2,"type":"STRING","value":"PARENT_CODE"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"PARENT_NAME"},"2":{"slot":2,"type":"STRING","value":"PARENT_NAME"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"INDUSTRY_NAME"},"2":{"slot":2,"type":"STRING","value":"INDUSTRY_NAME"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"SEGMENT_NAME"},"2":{"slot":2,"type":"STRING","value":"SEGMENT_NAME"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"SUB_SEGMENT_NAME"},"2":{"slot":2,"type":"STRING","value":"SUB_SEGMENT_NAME"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"BIWEEKLY_ACCOUNT_FLAG_NAME"},"2":{"slot":2,"type":"STRING","value":"BIWEEKLY_ACCOUNT_FLAG_NAME"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"run_timestamp"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_DATE"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"run_user"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_BY"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"run_id"},"2":{"slot":2,"type":"STRING","value":"DL_JOBID"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Append"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SCH_ADAPTIVE}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${DB_Enterprise}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341694":{"id":6341694,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":576,"y":272,"width":32,"height":32,"inputConnectorIDs":[6341651],"outputConnectorIDs":[6341695],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Calc Job Variables"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"'${run_history_id}'"},"2":{"slot":2,"type":"STRING","value":"run_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"CURRENT_TIMESTAMP()"},"2":{"slot":2,"type":"STRING","value":"run_timestamp"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"current_user()"},"2":{"slot":2,"type":"STRING","value":"run_user"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6341651":{"id":6341651,"sourceID":6341692,"targetID":6341694},"6341695":{"id":6341695,"sourceID":6341694,"targetID":6341693}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"jb_Customer_Segmentation_load","description":"","type":"TRANSFORMATION","tag":"57cc2b6e-8c3c-4cd6-9fed-3028e40210cc"}}