{"job":{"components":{"6341768":{"id":6341768,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":704,"y":272,"width":32,"height":32,"inputConnectorIDs":[6341775],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STATS_ACTUALS"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"STATS_ACTUALS"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"PERIOD_START_DATE"},"2":{"slot":2,"type":"STRING","value":"PERIOD_START_DATE"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"PERIOD_END_DATE"},"2":{"slot":2,"type":"STRING","value":"PERIOD_END_DATE"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"PERIOD_WEEK"},"2":{"slot":2,"type":"STRING","value":"PERIOD_WEEK"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"AMOUNT"},"2":{"slot":2,"type":"STRING","value":"AMOUNT"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"STAT_ACCOUNT_CODE"},"2":{"slot":2,"type":"STRING","value":"STAT_ACCOUNT_CODE"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"ACCT_UNIT"},"2":{"slot":2,"type":"STRING","value":"ACCT_UNIT"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"SUBVERSION"},"2":{"slot":2,"type":"STRING","value":"SUBVERSION"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"OPS_CHANNEL"},"2":{"slot":2,"type":"STRING","value":"OPS_CHANNEL"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"CUSTOMER"},"2":{"slot":2,"type":"STRING","value":"CUSTOMER"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"FISCAL_YEAR"},"2":{"slot":2,"type":"STRING","value":"FISCAL_YEAR"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"ACCT_PERIOD"},"2":{"slot":2,"type":"STRING","value":"ACCT_PERIOD"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"run_timestamp"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_DATE"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"run_user"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_BY"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"run_id"},"2":{"slot":2,"type":"STRING","value":"DL_JOBID"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Append"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SCH_ADAPTIVE}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${DB_Enterprise}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341769":{"id":6341769,"inputCardinality":"MANY","outputCardinality":"MANY","implementationID":-1841822228,"x":480,"y":272,"width":32,"height":32,"inputConnectorIDs":[6341774,6341776,6341777],"outputConnectorIDs":[6341778],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Unite 0"}}}},"visible":true},"2":{"slot":2,"name":"Method","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"All Columns"}}}},"visible":true},"3":{"slot":3,"name":"Cast Types","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"4":{"slot":4,"name":"Add Source Component Column","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"5":{"slot":5,"name":"Remove duplicates","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341770":{"id":6341770,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":320,"y":160,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6341777],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL Logic CB_HB_AOA"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH \n\nbluecrew_base_ids AS (\n    SELECT DISTINCT\n        CUSTOMER AS CUSTOMER_NUMBER\n    FROM  PROD_ENTERPRISE.ADAPTIVE.GL_AGG_TRANSFORM\n    WHERE customer is not null\n),\n\nCTE_CUST AS (WITH ARCUS AS (SELECT DISTINCT(ARC.DEFAULT_CODE)     AS DEFAULT_CODE,\n                                                SA.BRANCH__C           AS BRANCH__C,\n                                                GLT.ACCT_UNIT          AS ACCOUNT_UNIT,\n                                                TRIM(ARC.CUSTOMER)     AS CUSTOMER,\n                                                BD.ACCOUNTING_UNIT     AS ACCOUNT_UNIT_BD,\n                                                ARC.SEARCH_NAME        AS SEARCH_NAME,\n                                                TRIM(SA.ACCOUNTNUMBER) AS ACCOUNTNUMBER,\n                                                SA.LEGACY_ID__C        AS BC_ACCOUNT_ID,\n                                                SA.NAME                AS NAME,\n                                                GLT.*\n                                 FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARC\n                                          LEFT JOIN PROD_DATALAKE.LAWPROD.ARDISTRIB AS A\n                                                    ON TRIM(TRY_TO_NUMBER(ARC.CUSTOMER)) = TRIM(TRY_TO_NUMBER(A.CUSTOMER))\n                                          LEFT JOIN PROD_DATALAKE.LAWPROD.GLTRANS AS GLT\n                                                    ON A.GLT_OBJ_ID = GLT.OBJ_ID\n                                          LEFT JOIN PROD_DATALAKE.SALESFORCE.ACCOUNT SA\n                                                    ON TRIM(TRY_TO_NUMBER(SA.ACCOUNTNUMBER)) = TRIM(TRY_TO_NUMBER(ARC.CUSTOMER))\n                                                        AND LOWER(SA.BRAND__C) = 'bluecrew'\n                                          LEFT JOIN PROD_EDW.ENT.BRANCH_DIM BD\n                                                    ON (BD.BRANCH_NUMBER) = ARC.DEFAULT_CODE AND\n                                                       BD.DW_ACTIVE_FLAG = 'Y' AND\n                                                       BD.DW_DATA_SOURCE_KEY = '1' AND\n                                                       BD.BRAND_NAME = 'Bluecrew'\n                                 WHERE UPPER(A.MX_VALUE_01) = 'DIGITAL')\n                  SELECT ARCUS.DEFAULT_CODE               AS DEFAULT_CODE,\n                         ARCUS.CUSTOMER                   AS CUSTOMER,\n                         TO_DATE(MAX(ARCUS.POSTING_DATE)) AS POSTING_DATE,\n                         ARCUS.ACCOUNT_UNIT_BD            AS ACCOUNT_UNIT_BD\n                  FROM ARCUS\n                  GROUP BY ARCUS.DEFAULT_CODE, ARCUS.CUSTOMER, ARCUS.ACCOUNT_UNIT_BD),\n     CTE_BCWBS AS (SELECT DATE(SHIFT_START) + (-DAYOFWEEK(DATE(SHIFT_START) - 1) + 6) AS POSTING_DATE,\n                          SHIFT_START                                                 AS START_STAMP,\n                          SHIFT_END                                                   AS END_STAMP,\n                          SF.ACCOUNTNUMBER                                            AS CUSTOMER,\n                          TO_VARCHAR(SF.NAME)                                         AS NAME,\n                          CTEC.CUSTOMER                                               AS DC_CUSTOMER,\n                          DC.COMPANY_ID                                               AS COMPANY_ID_DC,\n                          FHW.*,\n                          DC.COMPANY_EB_ACCOUNT_UNIT                                  AS DC_CAU,\n                          IFNULL(DC_CAU, '41' || CC.REGIONCODE)                       AS CAU,\n                          IFNULL(IFF(CAU = '', '41501', CAU), '41501')                AS COMP_ACCTUNIT,\n                          CTEC.DEFAULT_CODE,\n                          CTEC.ACCOUNT_UNIT_BD,\n                          CASE\n                              WHEN LOWER(FHW.COMPANY_NAME) LIKE ('%hit%') THEN '41758'\n                              WHEN (CTEC.DEFAULT_CODE) IS NOT NULL AND (SUBSTR(CTEC.DEFAULT_CODE, 1, 1)) <> 8 AND (SUBSTR(CTEC.DEFAULT_CODE, 1, 1)) <> 6 THEN CTEC.DEFAULT_CODE\n                              WHEN (SUBSTR(CTEC.DEFAULT_CODE, 1, 1)) = 8 THEN (CTEC.ACCOUNT_UNIT_BD)\n                              WHEN (SUBSTR(CTEC.DEFAULT_CODE, 1, 1)) = 6 THEN (CTEC.ACCOUNT_UNIT_BD)\n                              WHEN CTEC.DEFAULT_CODE IS NULL THEN G.ACCOUNTING_UNIT\n                              END                                                     AS ACCOUNT_UNIT,\n                          CTEC.DEFAULT_CODE                                           AS DEF_AC,\n                          G.ACCOUNTING_UNIT                                           AS G_SFA_AC\n                   FROM DB_BC_FACTS.AZUL.FACT_HOURS_WORKED FHW\n                            LEFT JOIN DB_BC_FACTS.AZUL.DM_COMPANIES DC\n                                      ON TRIM(FHW.COMPANY_ID) = TRIM(DC.COMPANY_ID)\n                            LEFT JOIN PROD_DATALAKE.SALESFORCE.ACCOUNT SF\n                                      ON TRIM(TO_VARCHAR(SF.LEGACY_ID__C)) = TRIM(TO_VARCHAR(FHW.COMPANY_ID))\n                                          AND LOWER(SF.BRAND__C) = 'bluecrew'\n                            LEFT JOIN CTE_CUST CTEC\n                                      ON TRIM(TRY_TO_NUMBER(SF.ACCOUNTNUMBER)) = TRIM(TRY_TO_NUMBER(CTEC.CUSTOMER))\n                            LEFT JOIN (SELECT DISTINCT SF.LEGACY_ID__C     AS LEGACY_ID__C,\n                                                       SF.NAME             AS NAME,\n                                                       SF.ACCOUNTNUMBER    AS ACCOUNTNUMBER,\n                                                       BR.BRANCH_NUMBER    AS BRANCH_NUMBER,\n                                                       BRB.ACCOUNTING_UNIT AS ACCOUNTING_UNIT,\n                                                       SF.BRAND__C         AS BRAND__C\n                                       FROM PROD_DATALAKE.SALESFORCE.ACCOUNT SF\n                                                LEFT JOIN PROD_EDW.ENT.BRANCH_DIM BR\n                                                          ON BR.BRANCH_ID = SF.BRANCH__C AND\n                                                             BR.DW_ACTIVE_FLAG = 'Y' AND\n                                                             BR.DW_DATA_SOURCE_KEY = '2'\n                                                LEFT JOIN PROD_EDW.ENT.BRANCH_DIM BRB\n                                                          ON BR.BRANCH_NUMBER = BRB.BRANCH_NUMBER AND\n                                                             UPPER(BRB.BRAND_NAME) = 'BLUECREW' AND\n                                                             BRB.DW_ACTIVE_FLAG = 'Y' AND\n                                                             BRB.DW_DATA_SOURCE_KEY = '1'\n                                       WHERE UPPER(SF.BRAND__C) = 'BLUECREW'\n                                         AND SF.LEGACY_ID__C IS NOT NULL) AS G\n                                      ON TO_CHAR(G.LEGACY_ID__C) = TO_CHAR(DC.COMPANY_ID)\n                            LEFT JOIN\n                        (SELECT FCR.COMPANY_ID                  AS COMPANY_ID,\n                                MIN(LEFT(FCR.CUSTOMER_CODE, 3)) AS REGIONCODE\n                         FROM DB_BC_FACTS.AZUL.FACT_COMPANY_REVENUE FCR\n                         WHERE FCR.CUSTOMER_CODE IS NOT NULL\n                         GROUP BY FCR.COMPANY_ID) CC\n                        ON CC.COMPANY_ID = FHW.COMPANY_ID\n                   WHERE FHW.COMPANY_ID NOT IN (SELECT DMC.COMPANY_ID\n                                                FROM DB_BC_FACTS.AZUL.DM_COMPANIES DMC\n                                                WHERE DMC.COMPANY_NAME LIKE '%Bluecrew%')\n                    AND SF.ACCOUNTNUMBER IN (SELECT DISTINCT CUSTOMER_NUMBER FROM bluecrew_base_ids)),\n               \n     BC_BILLED_HOURS as (SELECT TO_DATE(BCW.POSTING_DATE)   AS NORM_POST_DATE,\n                             BCW.ACCOUNT_UNIT            AS ACCT_UNIT_TXT,\n                             TRY_TO_NUMBER(BCW.CUSTOMER) AS CUSTOMER,\n                             TRIM(TO_VARCHAR(BCW.NAME))  AS CUSTOMER_NAME,\n                             SUM(BCW.HOURS_WORKED)       AS BC_BILLED_HOURS\n                      FROM CTE_BCWBS BCW\n                      GROUP BY BCW.POSTING_DATE,\n                               BCW.ACCOUNT_UNIT,\n                               BCW.CUSTOMER,\n                               BCW.NAME),\n\n     FINAL_BC_BILLED_HOURS AS (SELECT TO_CHAR(DATEADD(DAY,\n                                                   CASE\n                                                       WHEN DATE_PART('DOW', BH.NORM_POST_DATE) = 0 THEN -6\n                                                       ELSE 1 - DATE_PART('DOW', BH.NORM_POST_DATE)\n                                                       END,\n                                                   BH.NORM_POST_DATE\n                                           ), 'MM/DD/YYYY')  AS PERIOD_START_DATE,\n                                   TO_CHAR(DATEADD(DAY,\n                                                   CASE\n                                                       WHEN DATE_PART('DOW', BH.NORM_POST_DATE) = 0 THEN 0\n                                                       ELSE 7 - DATE_PART('DOW', BH.NORM_POST_DATE)\n                                                       END,\n                                                   BH.NORM_POST_DATE\n                                           ), 'MM/DD/YYYY')  AS PERIOD_END_DATE,\n                                   DD.FISCAL_YEAR_WEEK       AS PERIOD_WEEK,\n                                   ROUND(BH.BC_BILLED_HOURS, 2) AS AMOUNT,\n                                   'HB'            \t\t\t AS STAT_ACCOUNT_CODE,\n                                   BH.ACCT_UNIT_TXT          AS ACCT_Unit,\n                                   'BLUECREW'                AS SUBVERSION,\n                                   'DIGITAL'                 AS OPS_CHANNEL,\n                                   BH.CUSTOMER               AS CUSTOMER,\n                                   DD.FISCAL_YEAR            AS FISCAL_YEAR,\n                                   DD.FISCAL_PERIOD          AS ACCT_PERIOD\n                            FROM BC_BILLED_HOURS BH\n                                     LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n                                               ON BH.NORM_POST_DATE = DD.DATE),\n\n     BC_AOA_CUST_LEVEL AS (SELECT TO_DATE(BCW.POSTING_DATE)   AS NORM_POST_DATE,\n                               BCW.ACCOUNT_UNIT            AS ACCT_UNIT_TXT,\n                               TRY_TO_NUMBER(BCW.CUSTOMER) AS CUSTOMER,\n                               TRIM(TO_VARCHAR(BCW.NAME))  AS CUSTOMER_NAME,\n                               COUNT(DISTINCT BCW.USER_ID) AS AOA_CUSTOMER\n                        FROM CTE_BCWBS BCW\n                        GROUP BY BCW.POSTING_DATE,\n                                 BCW.ACCOUNT_UNIT,\n                                 BCW.CUSTOMER,\n                                 BCW.NAME),\n\n     FINAL_BC_AOA_CUST_LEVEL AS (SELECT TO_CHAR(DATEADD(DAY,\n                                                     CASE\n                                                         WHEN DATE_PART('DOW', AOACU.NORM_POST_DATE) = 0 THEN -6\n                                                         ELSE 1 - DATE_PART('DOW', AOACU.NORM_POST_DATE)\n                                                         END,\n                                                     AOACU.NORM_POST_DATE\n                                             ), 'MM/DD/YYYY')          AS PERIOD_START_DATE,\n                                     TO_CHAR(DATEADD(DAY,\n                                                     CASE\n                                                         WHEN DATE_PART('DOW', AOACU.NORM_POST_DATE) = 0 THEN 0\n                                                         ELSE 7 - DATE_PART('DOW', AOACU.NORM_POST_DATE)\n                                                         END,\n                                                     AOACU.NORM_POST_DATE\n                                             ), 'MM/DD/YYYY')          AS PERIOD_END_DATE,\n                                     DD.FISCAL_YEAR_WEEK               AS PERIOD_WEEK,\n                                     AOACU.AOA_CUSTOMER                AS AMOUNT,\n                                     'AOA_CUST' \t\t\t\t\t   AS STAT_ACCOUNT_CODE,\n                                     AOACU.ACCT_UNIT_TXT               AS ACCT_Unit,\n                                     'BLUECREW'                        AS SUBVERSION,\n                                     'DIGITAL'                         AS COMPANY,\n                                     AOACU.CUSTOMER                    AS CUSTOMER,\n                                     DD.FISCAL_YEAR                    AS FISCAL_YEAR,\n                                     DD.FISCAL_PERIOD                  AS ACCT_PERIOD\n                              FROM BC_AOA_CUST_LEVEL AOACU\n                                       LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n                                                 ON AOACU.NORM_POST_DATE = DD.DATE),\n\n     BC_AOA_AU_LEVEL AS (SELECT TO_DATE(BCW.POSTING_DATE)   AS NORM_POST_DATE,\n                             BCW.ACCOUNT_UNIT            AS ACCT_UNIT_TXT,\n                             COUNT(DISTINCT BCW.USER_ID) AS AOA\n                      FROM CTE_BCWBS BCW\n                      GROUP BY BCW.POSTING_DATE,\n                               BCW.ACCOUNT_UNIT),\n\n     FINAL_BC_AOA_AU_LEVEL AS (SELECT TO_CHAR(DATEADD(DAY,\n                                                   CASE\n                                                       WHEN DATE_PART('DOW', AOAAU.NORM_POST_DATE) = 0 THEN -6\n                                                       ELSE 1 - DATE_PART('DOW', AOAAU.NORM_POST_DATE)\n                                                       END,\n                                                   AOAAU.NORM_POST_DATE\n                                           ), 'MM/DD/YYYY')        AS PERIOD_START_DATE,\n                                   TO_CHAR(DATEADD(DAY,\n                                                   CASE\n                                                       WHEN DATE_PART('DOW', AOAAU.NORM_POST_DATE) = 0 THEN 0\n                                                       ELSE 7 - DATE_PART('DOW', AOAAU.NORM_POST_DATE)\n                                                       END,\n                                                   AOAAU.NORM_POST_DATE\n                                           ), 'MM/DD/YYYY')        AS PERIOD_END_DATE,\n                                   DD.FISCAL_YEAR_WEEK             AS PERIOD_WEEK,\n                                   AOAAU.AOA                       AS AMOUNT,\n                                   'AOA_AU' \t\t\t\t\t   AS STAT_ACCOUNT_CODE,\n                                   AOAAU.ACCT_UNIT_TXT             AS ACCT_Unit,\n                                   'BLUECREW'                      AS SUBVERSION,\n                                   'DIGITAL'                       AS COMPANY,\n                                   NULL                            AS CUSTOMER,\n                                   DD.FISCAL_YEAR                  AS FISCAL_YEAR,\n                                   DD.FISCAL_PERIOD                AS ACCT_PERIOD\n                            FROM BC_AOA_AU_LEVEL AOAAU\n                                     LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n                                               ON AOAAU.NORM_POST_DATE = DD.DATE),\n\n     BC_CUSTOMER_BILLED_AU_LEVEL AS (SELECT TO_DATE(BCW.POSTING_DATE)                 AS NORM_POST_DATE,\n                                         BCW.ACCOUNT_UNIT                          AS ACCT_UNIT_TXT,\n                                         TO_NUMBER((COUNT(DISTINCT BCW.CUSTOMER))) AS CUSTOMER_BILLED\n                                  FROM CTE_BCWBS BCW\n                                  GROUP BY BCW.POSTING_DATE,\n                                           BCW.ACCOUNT_UNIT),\n\n     FINAL_BC_CUSTOMER_BILLED_AU_LEVEL AS (SELECT TO_CHAR(DATEADD(DAY,\n                                                               CASE\n                                                                   WHEN DATE_PART('DOW', CB.NORM_POST_DATE) = 0 THEN -6\n                                                                   ELSE 1 - DATE_PART('DOW', CB.NORM_POST_DATE)\n                                                                   END,\n                                                               CB.NORM_POST_DATE\n                                                       ), 'MM/DD/YYYY') AS PERIOD_START_DATE,\n                                               TO_CHAR(DATEADD(DAY,\n                                                               CASE\n                                                                   WHEN DATE_PART('DOW', CB.NORM_POST_DATE) = 0 THEN 0\n                                                                   ELSE 7 - DATE_PART('DOW', CB.NORM_POST_DATE)\n                                                                   END,\n                                                               CB.NORM_POST_DATE\n                                                       ), 'MM/DD/YYYY') AS PERIOD_END_DATE,\n                                               DD.FISCAL_YEAR_WEEK      AS PERIOD_WEEK,\n                                               CB.CUSTOMER_BILLED       AS AMOUNT,\n                                               'CB'       \t\t\t\tAS STAT_ACCOUNT_CODE,\n                                               CB.ACCT_UNIT_TXT         AS ACCT_Unit,\n                                               'BLUECREW'               AS SUBVERSION,\n                                               'DIGITAL'                AS OPS_CHANNEL,\n                                               NULL                     AS CUSTOMER,\n                                               DD.FISCAL_YEAR           AS FISCAL_YEAR,\n                                               DD.FISCAL_PERIOD         AS ACCT_PERIOD\n                                        FROM BC_CUSTOMER_BILLED_AU_LEVEL CB\n                                                 LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n                                                           ON CB.NORM_POST_DATE = DD.DATE),\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t   \n-------------- EB -----------------\n\n\nEB_base_ids AS (\n    SELECT DISTINCT CUSTOMER AS CUSTOMER_NUMBER\n    FROM  PROD_ENTERPRISE.ADAPTIVE.GL_AGG_TRANSFORM\n    WHERE CUSTOMER IS NOT NULL\n),\n\n/* ------------------------------------------------------------\n   ACTIVE_CUST: Used ONLY for HB (hours)\n   ------------------------------------------------------------ */\nACTIVE_CUST AS (\n    SELECT DISTINCT\n        CUSDATA.SEARCH_NAME                    AS CUSTOMER_NAME,\n        ACTDATA.ACTIVE_STATUS                  AS ACTIVITY_STATUS,\n        ACTDATA.ACTIVITY_TXT                   AS ACTIVITY_TXT,\n        TRY_TO_NUMBER(ACTDATA.LEVEL_DETAIL_02) AS CUSTOMER\n    FROM DATALAKE.PUBLIC.DIM_ACTIVITY ACTDATA\n    LEFT JOIN (\n        SELECT ARCUS1.*\n        FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUS1\n        INNER JOIN (\n            SELECT CUSTOMER\n            FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n            GROUP BY CUSTOMER\n            HAVING COUNT(*) = 1\n        ) B ON ARCUS1.CUSTOMER = B.CUSTOMER\n        UNION ALL\n        SELECT ARCUS2.*\n        FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUS2\n        INNER JOIN (\n            SELECT CUSTOMER\n            FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n            GROUP BY CUSTOMER\n            HAVING COUNT(*) > 1\n        ) B ON ARCUS2.CUSTOMER = B.CUSTOMER\n        WHERE ARCUS2.COMPANY = 2\n    ) CUSDATA\n      ON TRY_TO_NUMBER(ACTDATA.LEVEL_DETAIL_02) = CUSDATA.CUSTOMER\n    WHERE ACTDATA.ACTIVE_STATUS = 'Y'\n),\n\n/* ------------------------------------------------------------\n   Pay-cycle lookup \n   ------------------------------------------------------------ */\nPAYCYCLE_MAP AS (\n    SELECT DISTINCT \n        A.ACCOUNTNUMBER AS CUSTOMER_NUMBER,\n        A.NAME          AS CUSTOMER_NAME,\n        K.VALUE         AS PAYCYCLE_VALUE\n    FROM PROD_DATALAKE.CRM_MSCRM.ACCOUNTBASE A\n    LEFT JOIN (\n        SELECT DISTINCT ATTRIBUTEVALUE, VALUE\n        FROM DATALAKE.PUBLIC.CRM_DL_LDG_STRINGMAPBASE\n        WHERE ATTRIBUTENAME = 'cda_paycycle'\n    ) K ON K.ATTRIBUTEVALUE = A.CDA_PAYCYCLE\n),\n\n/* ------------------------------------------------------------\n    segments by pay-cycle (used to enforce filters)\n   ------------------------------------------------------------ */\nWEEKLY_CUST AS (\n    SELECT DISTINCT\n        B.SEARCH_NAME                    AS CUSTOMER_NAME,\n        A.ACTIVE_STATUS                  AS ACTIVITY_STATUS,\n        A.ACTIVITY_TXT,\n        TRY_TO_NUMBER(LEVEL_DETAIL_02)   AS CUSTOMER\n    FROM DATALAKE.PUBLIC.DIM_ACTIVITY A\n    LEFT JOIN (\n        SELECT ARCUS1.*\n        FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUS1\n        INNER JOIN (\n            SELECT CUSTOMER FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n            GROUP BY CUSTOMER HAVING COUNT(*) = 1\n        ) B ON ARCUS1.CUSTOMER = B.CUSTOMER\n        UNION ALL\n        SELECT ARCUS2.*\n        FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUS2\n        INNER JOIN (\n            SELECT CUSTOMER FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n            GROUP BY CUSTOMER HAVING COUNT(*) > 1\n        ) B ON ARCUS2.CUSTOMER = B.CUSTOMER\n        WHERE ARCUS2.COMPANY = 2\n    ) B ON TRY_TO_NUMBER(A.LEVEL_DETAIL_02) = B.CUSTOMER\n    LEFT JOIN PAYCYCLE_MAP P\n      ON P.CUSTOMER_NUMBER = TRY_TO_NUMBER(A.LEVEL_DETAIL_02)\n    WHERE A.ACTIVE_STATUS = 'Y'\n      AND (P.PAYCYCLE_VALUE = 'Weekly' OR P.PAYCYCLE_VALUE IS NULL)\n),\n\nBIWEEK_CUST AS (\n    SELECT DISTINCT\n        B.SEARCH_NAME                    AS CUSTOMER_NAME,\n       'Bi/Alt Weekly'                  AS BILL_CYCLE,\n        A.ACTIVE_STATUS                  AS ACTIVITY_STATUS,\n        A.ACTIVITY_TXT,\n        TRY_TO_NUMBER(LEVEL_DETAIL_02)   AS CUSTOMER\n    FROM DATALAKE.PUBLIC.DIM_ACTIVITY A\n    LEFT JOIN (\n        SELECT ARCUS1.*\n        FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUS1\n        INNER JOIN (\n            SELECT CUSTOMER FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n            GROUP BY CUSTOMER HAVING COUNT(*) = 1\n        ) B ON ARCUS1.CUSTOMER = B.CUSTOMER\n        UNION ALL\n        SELECT ARCUS2.*\n        FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUS2\n        INNER JOIN (\n            SELECT CUSTOMER FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n            GROUP BY CUSTOMER HAVING COUNT(*) > 1\n        ) B ON ARCUS2.CUSTOMER = B.CUSTOMER\n        WHERE ARCUS2.COMPANY = 2\n    ) B ON TRY_TO_NUMBER(A.LEVEL_DETAIL_02) = B.CUSTOMER\n    LEFT JOIN PAYCYCLE_MAP P\n      ON P.CUSTOMER_NUMBER = TRY_TO_NUMBER(A.LEVEL_DETAIL_02)\n    WHERE A.ACTIVE_STATUS = 'Y'\n      AND P.PAYCYCLE_VALUE IN ('Bi-Weekly','Alternate Bi-Weekly')\n),\n\nMONTHLY_CUST AS (\n    SELECT DISTINCT\n        B.SEARCH_NAME                    AS CUSTOMER_NAME,\n        'Monthly'                        AS BILL_CYCLE,\n        A.ACTIVE_STATUS                  AS ACTIVITY_STATUS,\n        A.ACTIVITY_TXT,\n        TRY_TO_NUMBER(LEVEL_DETAIL_02)   AS CUSTOMER\n    FROM DATALAKE.PUBLIC.DIM_ACTIVITY A\n    LEFT JOIN (\n        SELECT ARCUS1.*\n        FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUS1\n        INNER JOIN (\n            SELECT CUSTOMER FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n            GROUP BY CUSTOMER HAVING COUNT(*) = 1\n        ) B ON ARCUS1.CUSTOMER = B.CUSTOMER\n        UNION ALL\n        SELECT ARCUS2.*\n        FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUS2\n        INNER JOIN (\n            SELECT CUSTOMER FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n            GROUP BY CUSTOMER HAVING COUNT(*) > 1\n        ) B ON ARCUS2.CUSTOMER = B.CUSTOMER\n        WHERE ARCUS2.COMPANY = 2\n    ) B ON TRY_TO_NUMBER(A.LEVEL_DETAIL_02) = B.CUSTOMER\n    LEFT JOIN PAYCYCLE_MAP P\n      ON P.CUSTOMER_NUMBER = TRY_TO_NUMBER(A.LEVEL_DETAIL_02)\n    WHERE A.ACTIVE_STATUS = 'Y'\n      AND P.PAYCYCLE_VALUE = 'Monthly'\n),\n\n/* ------------------------------------------------------------\n   DATE PREP: week-end Sundays and fiscal period helpers\n   ------------------------------------------------------------ */\nDT AS (\n    SELECT DISTINCT\n           DATE,\n           SUNNORM_POSTING_DATE,\n           FISCAL_WEEK,\n           FISCAL_YEAR_WEEK,\n           FISCAL_YEAR,\n           FISCAL_PERIOD,\n           FISCAL_YEAR_PERIOD\n    FROM PROD_EDW.ENT.DATE_DIM\n    WHERE DATE IS NOT NULL\n),\nSUN_DT AS (\n    SELECT DISTINCT FISCAL_YEAR_PERIOD, SUNNORM_POSTING_DATE\n    FROM PROD_EDW.ENT.DATE_DIM\n),\nWEEKS_CNT AS (\n    SELECT FISCAL_YEAR_PERIOD, COUNT(DISTINCT SUNNORM_POSTING_DATE) AS NUMBER_OF_WEEKS\n    FROM PROD_EDW.ENT.DATE_DIM\n    GROUP BY FISCAL_YEAR_PERIOD\n),\nBIWEEK AS (\n    /* Map each Sunday to its “biweekly anchor”: second Sunday in the pair */\n    SELECT DISTINCT \n        SUNNORM_POSTING_DATE,\n        CASE WHEN MOD(FISCAL_WEEK, 2) = 0 \n             THEN TRUNC(SUNNORM_POSTING_DATE, 'week') + 6\n             ELSE TRUNC(SUNNORM_POSTING_DATE, 'week') + 13 \n        END AS BIWEEKLY\n    FROM PROD_EDW.ENT.DATE_DIM\n),\n\n/* ------------------------------------------------------------\n   WEEKLY base\n   ------------------------------------------------------------ */\n\n-- HB weekly base from DIM_TRANS with ALL active customers\nPREP1 AS (\n    SELECT TR.*,\n           CASE WHEN TR.ACCT_CAT_CD = '51RW' THEN TR.UNITS_AMOUNT ELSE TR.BILLABLE_UNIT END AS BILLABLE_UNIT_NEW,\n           CASE WHEN TR.ACCT_CAT_CD = '51RW' THEN TR.BILLABLE_UNIT ELSE TR.UNITS_AMOUNT END AS UNITS_AMOUNT_NEW,\n           TR.NORM_POSTING_DT                                                               AS NORM_POST_DATE,\n           CUST.CUSTOMER                                                                    AS CUSTOMER,\n           CUST.CUSTOMER_NAME                                                               AS CUSTOMER_NAME,\n           CUST.ACTIVITY_STATUS                                                             AS ACTIVITY_STATUS,\n           IFF(G.BRAND_VAL_TXT IS NULL, 'UB', BRAND_VAL_TXT)                                AS BRANDLEVEL,\n           K.CONV_FACTOR_VAL_TXT                                                            AS CONV_FACTOR_VAL_TXT\n    FROM DATALAKE.PUBLIC.DIM_TRANS TR\n    LEFT JOIN ACTIVE_CUST CUST\n           ON CUST.ACTIVITY_TXT = TR.ACTIVITY\n    LEFT JOIN DATALAKE.PUBLIC.DIM_BRAND G\n           ON G.ACTIVITY_TXT = CUST.ACTIVITY_TXT\n          AND ( G.VALID_TO_DT >= IFF(DATEADD('day', 7, TR.NORM_POSTING_DT) < '2019-06-30', '2019-06-30', DATEADD('day', 7, TR.NORM_POSTING_DT))\n            AND G.VALID_FRM_DT <  IFF(DATEADD('day', 7, TR.NORM_POSTING_DT) < '2019-06-30', '2019-06-30', DATEADD('day', 7, TR.NORM_POSTING_DT)) )\n    LEFT JOIN (\n        SELECT R.*, S.CONV_FACTOR_VAL_TXT\n        FROM DATALAKE.PUBLIC.DIM_ACCT_CAT R\n        INNER JOIN DATALAKE.PUBLIC.DIM_CONV_FACTOR S\n          ON R.CONV_FACTOR_ID = S.CONV_FACTOR_ID\n    ) K ON TR.ACCT_CAT_CD = K.ACCT_CAT_TXT\n    WHERE ((TR.ACCOUNT_NM >= '4100' AND TR.ACCOUNT_NM <= '5999') OR TR.ACCOUNT_NM = '2660')\n      AND TR.RUN_DATE <= DATEADD(DAY, 9, TR.NORM_POSTING_DT)\n      AND TR.ACTIVE_STATUS = 'Y'\n      AND CUST.ACTIVITY_STATUS = 'Y'\n),\nEB_BILLED_HOURS AS (\n    SELECT P1.NORM_POST_DATE,\n           P1.ACCT_UNIT_TXT,\n           P1.CUSTOMER,\n           P1.CUSTOMER_NAME,\n           ROUND(\n             SUM(IFF(P1.CONV_FACTOR_VAL_TXT = 'None', P1.BILLABLE_UNIT_NEW,\n                 IFF((P1.CONV_FACTOR_VAL_TXT IN ('BILLABLE_AMT / 25','BILLABLE_AMT /25')), P1.BILLABLE_AMT / 25,\n                 IFF(P1.CONV_FACTOR_VAL_TXT = 'BILLABLE_AMT / 15', P1.BILLABLE_AMT / 15,\n                 IFF(P1.CONV_FACTOR_VAL_TXT = 'BILLABLE_UNIT * 8',  P1.BILLABLE_UNIT_NEW * 8,\n                 IFF(P1.CONV_FACTOR_VAL_TXT = 'BILLABLE_UNIT * 40', P1.BILLABLE_UNIT_NEW * 40,\n                 IFF(P1.CONV_FACTOR_VAL_TXT = 'BILLABLE_UNIT / 55', P1.BILLABLE_UNIT_NEW / 55, 0)))))))\n           ,2) AS CONV_EB_BILLED_HOURS\n    FROM PREP1 P1\n    INNER JOIN EB_base_ids base ON base.CUSTOMER_NUMBER = P1.CUSTOMER\n    GROUP BY P1.NORM_POST_DATE, P1.ACCT_UNIT_TXT, P1.CUSTOMER, P1.CUSTOMER_NAME\n),\n\n-- AOA/CB weekly base from ACTRANS\nAOA_PREP1 AS (\n    SELECT TR.*,\n           CASE WHEN TR.EMPLOYEE = '' THEN 0 ELSE CAST(TR.EMPLOYEE AS BIGINT) END AS RESOURCE\n    FROM (\n        SELECT DISTINCT \n            ACTRANS.OBJ_ID                                           AS OBJ_ID,\n            ACTRANS.ACCT_UNIT                                        AS ACCT_UNIT_TXT,\n            ACTRANS.ACCOUNT                                          AS ACCOUNT,\n            ACTRANS.ACCT_CATEGORY                                    AS ACCT_CATEGORY,\n            ACTRANS.ACTIVITY                                         AS ACTIVITY,\n            LTRIM(ARCUSTOMER.CUSTOMER)                               AS CUSTOMER,\n            CUSTDESC.NAME                                            AS SEARCH_NAME,\n            CASE WHEN (ACTRANS.RESOURCE_CODE IS NULL) OR (ACTRANS.RESOURCE_CODE = '')\n                 THEN ACHISTDTL.RESOURCE_CODE\n                 ELSE ACTRANS.RESOURCE_CODE END                      AS EMPLOYEE,\n            ACTRANS.POSTING_DATE                                     AS POSTING_DATE,\n            CASE WHEN DAYNAME(ACTRANS.POSTING_DATE) = 'Sun' \n                 THEN ACTRANS.POSTING_DATE\n                 ELSE DATEADD(DAY, 7 - DAYOFWEEK(ACTRANS.POSTING_DATE), ACTRANS.POSTING_DATE) END AS NORM_POST_DATE,\n            CASE WHEN ACACTMXVAL.MX_VALUE IS NULL THEN ARCSTMXVAL.MX_VALUE ELSE ACACTMXVAL.MX_VALUE END AS BRANDLEVEL,\n            ACTRANS.SUM_ACCT_CAT                                     AS ACCT_CAT_CD,\n            IFF(NATACCT.NAT_CUSTOMER IS NULL, ARCUSTOMER.CUSTOMER, NATACCT.NAT_CUSTOMER)          AS LAWSON_PARENT_NUMBER,\n            IFF(NAT_CUSTDESC.SEARCH_NAME IS NULL, CUSTDESC.SEARCH_NAME, NAT_CUSTDESC.SEARCH_NAME) AS LAWSON_PARENT_NAME\n        FROM PROD_DATALAKE.LAWPROD.ACTRANS ACTRANS\n        INNER JOIN PROD_DATALAKE.LAWPROD.ACACTIVITY ACACTIVITY\n          ON ACTRANS.ACTIVITY = ACACTIVITY.ACTIVITY\n        INNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUSTOMER\n          ON ACACTIVITY.LEVEL_DETAIL_02 = ARCUSTOMER.CUSTOMER\n        INNER JOIN PROD_DATALAKE.LAWPROD.CUSTDESC CUSTDESC\n          ON ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.NATACCT NATACCT\n          ON NATACCT.CUSTOMER = ARCUSTOMER.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.CUSTDESC NAT_CUSTDESC\n          ON NATACCT.CUSTOMER = NAT_CUSTDESC.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ACACTMXVAL ACACTMXVAL\n          ON ACACTIVITY.OBJ_ID = ACACTMXVAL.OBJ_ID AND ACACTMXVAL.MATRIX_CAT = 'BRAND'\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ARCSTMXVAL ARCSTMXVAL\n          ON ARCUSTOMER.OBJ_ID = ARCSTMXVAL.OBJ_ID AND ARCSTMXVAL.MATRIX_CAT = 'BRAND'\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ACHISTDTL ACHISTDTL\n          ON ACTRANS.OBJ_ID = ACHISTDTL.ATN_OBJ_ID\n        WHERE ACTRANS.ACCOUNT NOT IN (1230)\n          AND ACTRANS.ACCT_CATEGORY NOT IN ('510BC')\n    ) TR\n    INNER JOIN WEEKLY_CUST CUST ON CUST.ACTIVITY_TXT = TR.ACTIVITY   -- <- strict weekly filter\n    INNER JOIN EB_base_ids base         ON base.CUSTOMER_NUMBER = LTRIM(TR.CUSTOMER)\n    WHERE TR.ACCT_CATEGORY <> 'BILLD'\n),\n\nEB_CUSTOMER_BILLED_AU_LEVEL AS (\n    SELECT DATE(AOAP1.NORM_POST_DATE) AS NORM_POST_DATE,\n           AOAP1.ACCT_UNIT_TXT        AS ACCT_UNIT_TXT,\n           COUNT(DISTINCT AOAP1.CUSTOMER) AS CUSTOMER_BILLED\n    FROM AOA_PREP1 AOAP1\n    GROUP BY AOAP1.NORM_POST_DATE, AOAP1.ACCT_UNIT_TXT\n),\n\n/* WEEKLY FINALs */\nFINAL_EB_CUSTOMER_BILLED_AU_LEVEL AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', CB.NORM_POST_DATE) = 0 THEN -6 ELSE 1 - DATE_PART('DOW', CB.NORM_POST_DATE) END,\n            CB.NORM_POST_DATE), 'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', CB.NORM_POST_DATE) = 0 THEN 0 ELSE 7 - DATE_PART('DOW', CB.NORM_POST_DATE) END,\n            CB.NORM_POST_DATE), 'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK      AS PERIOD_WEEK,\n        CB.CUSTOMER_BILLED       AS AMOUNT,\n        'CB'                     AS STAT_ACCOUNT_CODE,\n        CB.ACCT_UNIT_TXT         AS ACCT_UNIT,\n        'LAWSON'                 AS SUBVERSION,\n        'TRADITIONAL'            AS OPS_CHANNEL,\n  --      'Weekly/Null'            AS BILL_CYCLE,              -- weekly-only filter applied upstream\n        NULL                     AS CUSTOMER,\n        DD.FISCAL_YEAR           AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD         AS ACCT_PERIOD\n    FROM EB_CUSTOMER_BILLED_AU_LEVEL CB\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON CB.NORM_POST_DATE = DD.DATE\n),\nEB_AOA_AU_LEVEL AS (\n    SELECT DATE(AOAP1.NORM_POST_DATE) AS NORM_POST_DATE,\n           AOAP1.ACCT_UNIT_TXT        AS ACCT_UNIT_TXT,\n           COUNT(DISTINCT AOAP1.RESOURCE) AS AOA\n    FROM AOA_PREP1 AOAP1\n    GROUP BY AOAP1.NORM_POST_DATE, AOAP1.ACCT_UNIT_TXT\n),\nFINAL_EB_AOA_AU_LEVEL AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', AOAAU.NORM_POST_DATE) = 0 THEN -6 ELSE 1 - DATE_PART('DOW', AOAAU.NORM_POST_DATE) END,\n            AOAAU.NORM_POST_DATE), 'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', AOAAU.NORM_POST_DATE) = 0 THEN 0 ELSE 7 - DATE_PART('DOW', AOAAU.NORM_POST_DATE) END,\n            AOAAU.NORM_POST_DATE), 'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK AS PERIOD_WEEK,\n        AOAAU.AOA           AS AMOUNT,\n        'AOA_AU'            AS STAT_ACCOUNT_CODE,\n        AOAAU.ACCT_UNIT_TXT AS ACCT_UNIT,\n        'LAWSON'            AS SUBVERSION,\n        'TRADITIONAL'       AS OPS_CHANNEL,\n --       'Weekly/Null'       AS BILL_CYCLE,                 -- weekly-only filter applied upstream\n        NULL                AS CUSTOMER,\n        DD.FISCAL_YEAR      AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD    AS ACCT_PERIOD\n    FROM EB_AOA_AU_LEVEL AOAAU\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON AOAAU.NORM_POST_DATE = DD.DATE\n),\nEB_AOA_CUST_LEVEL AS (\n    SELECT DATE(AOAP1.NORM_POST_DATE) AS NORM_POST_DATE,\n           AOAP1.ACCT_UNIT_TXT,\n           AOAP1.CUSTOMER,\n           AOAP1.SEARCH_NAME,\n           COUNT(DISTINCT AOAP1.RESOURCE) AS AOA_CUSTOMER\n    FROM AOA_PREP1 AOAP1\n    GROUP BY AOAP1.NORM_POST_DATE, AOAP1.SEARCH_NAME, AOAP1.CUSTOMER, AOAP1.ACCT_UNIT_TXT\n),\nFINAL_EB_AOA_CUST_LEVEL AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', AOACU.NORM_POST_DATE) = 0 THEN -6 ELSE 1 - DATE_PART('DOW', AOACU.NORM_POST_DATE) END,\n            AOACU.NORM_POST_DATE), 'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', AOACU.NORM_POST_DATE) = 0 THEN 0 ELSE 7 - DATE_PART('DOW', AOACU.NORM_POST_DATE) END,\n            AOACU.NORM_POST_DATE), 'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK     AS PERIOD_WEEK,\n        AOACU.AOA_CUSTOMER      AS AMOUNT,\n        'AOA_CUST'              AS STAT_ACCOUNT_CODE,\n        AOACU.ACCT_UNIT_TXT     AS ACCT_UNIT,\n        'LAWSON'                AS SUBVERSION,\n        'TRADITIONAL'           AS OPS_CHANNEL,\n --       'Weekly/Null'           AS BILL_CYCLE,              -- weekly-only filter applied upstream\n        ROUND(AOACU.CUSTOMER,0) AS CUSTOMER,\n        DD.FISCAL_YEAR          AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD        AS ACCT_PERIOD\n    FROM EB_AOA_CUST_LEVEL AOACU\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON AOACU.NORM_POST_DATE = DD.DATE\n    \n),\nFINAL_EB_BILLED_HOURS AS (\n    \n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', BH.NORM_POST_DATE) = 0 THEN -6 ELSE 1 - DATE_PART('DOW', BH.NORM_POST_DATE) END,\n            BH.NORM_POST_DATE), 'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', BH.NORM_POST_DATE) = 0 THEN 0 ELSE 7 - DATE_PART('DOW', BH.NORM_POST_DATE) END,\n            BH.NORM_POST_DATE), 'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK      AS PERIOD_WEEK,\n        BH.CONV_EB_BILLED_HOURS  AS AMOUNT,\n        'HB'                     AS STAT_ACCOUNT_CODE,\n        BH.ACCT_UNIT_TXT         AS ACCT_UNIT,\n        'LAWSON'                 AS SUBVERSION,\n        'TRADITIONAL'            AS OPS_CHANNEL,\n   --     'Weekly/Null'            AS BILL_CYCLE,              -- HB weekly base (all customers)\n        ROUND(BH.CUSTOMER,0)     AS CUSTOMER,\n        DD.FISCAL_YEAR           AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD         AS ACCT_PERIOD\n    FROM EB_BILLED_HOURS BH\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON BH.NORM_POST_DATE = DD.DATE\n),\n\n/* ============================================================\n   BI-WEEKLY RECAST —  Replicate biweekly aggregate into each of the 2 weeks\n   ============================================================ */\nAOA_BW_PREP AS (\n    SELECT TR.*,\n           CASE WHEN TR.EMPLOYEE = '' THEN 0 ELSE CAST(TR.EMPLOYEE AS BIGINT) END AS RESOURCE\n    FROM (\n        SELECT DISTINCT \n            ACTRANS.OBJ_ID                                           AS OBJ_ID,\n            ACTRANS.ACCT_UNIT                                        AS ACCT_UNIT_TXT,\n            ACTRANS.ACCOUNT                                          AS ACCOUNT,\n            ACTRANS.ACCT_CATEGORY                                    AS ACCT_CATEGORY,\n            ACTRANS.ACTIVITY                                         AS ACTIVITY,\n            LTRIM(ARCUSTOMER.CUSTOMER)                               AS CUSTOMER,\n            CUSTDESC.NAME                                            AS SEARCH_NAME,\n            CASE WHEN (ACTRANS.RESOURCE_CODE IS NULL) OR (ACTRANS.RESOURCE_CODE = '')\n                 THEN ACHISTDTL.RESOURCE_CODE\n                 ELSE ACTRANS.RESOURCE_CODE END                      AS EMPLOYEE,\n            ACTRANS.POSTING_DATE                                     AS POSTING_DATE,\n            CASE WHEN DAYNAME(ACTRANS.POSTING_DATE) = 'Sun' \n                 THEN ACTRANS.POSTING_DATE\n                 ELSE DATEADD(DAY, 7 - DAYOFWEEK(ACTRANS.POSTING_DATE), ACTRANS.POSTING_DATE) END AS NORM_POST_DATE,\n            CASE WHEN ACACTMXVAL.MX_VALUE IS NULL THEN ARCSTMXVAL.MX_VALUE ELSE ACACTMXVAL.MX_VALUE END AS BRANDLEVEL,\n            ACTRANS.SUM_ACCT_CAT                                     AS ACCT_CAT_CD,\n            IFF(NATACCT.NAT_CUSTOMER IS NULL, ARCUSTOMER.CUSTOMER, NATACCT.NAT_CUSTOMER)          AS LAWSON_PARENT_NUMBER,\n            IFF(NAT_CUSTDESC.SEARCH_NAME IS NULL, CUSTDESC.SEARCH_NAME, NAT_CUSTDESC.SEARCH_NAME) AS LAWSON_PARENT_NAME\n        FROM PROD_DATALAKE.LAWPROD.ACTRANS ACTRANS\n        INNER JOIN PROD_DATALAKE.LAWPROD.ACACTIVITY ACACTIVITY ON ACTRANS.ACTIVITY = ACACTIVITY.ACTIVITY\n        INNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUSTOMER ON ACACTIVITY.LEVEL_DETAIL_02 = ARCUSTOMER.CUSTOMER\n        INNER JOIN PROD_DATALAKE.LAWPROD.CUSTDESC CUSTDESC ON ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.NATACCT NATACCT ON NATACCT.CUSTOMER = ARCUSTOMER.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.CUSTDESC NAT_CUSTDESC ON NATACCT.CUSTOMER = NAT_CUSTDESC.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ACACTMXVAL ACACTMXVAL ON ACACTIVITY.OBJ_ID = ACACTMXVAL.OBJ_ID AND ACACTMXVAL.MATRIX_CAT = 'BRAND'\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ARCSTMXVAL ARCSTMXVAL ON ARCUSTOMER.OBJ_ID = ARCSTMXVAL.OBJ_ID AND ARCSTMXVAL.MATRIX_CAT = 'BRAND'\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ACHISTDTL ACHISTDTL ON ACTRANS.OBJ_ID = ACHISTDTL.ATN_OBJ_ID\n        WHERE ACTRANS.ACCOUNT NOT IN (1230)\n          AND ACTRANS.ACCT_CATEGORY NOT IN ('510BC')\n    ) TR\n    INNER JOIN BIWEEK_CUST CUST ON CUST.ACTIVITY_TXT = TR.ACTIVITY\n    INNER JOIN EB_base_ids base  ON base.CUSTOMER_NUMBER = LTRIM(TR.CUSTOMER)\n    WHERE TR.ACCT_CATEGORY <> 'BILLD'\n),\nAOA_BW_AGG_AU AS (\n    SELECT \n        CASE WHEN MOD(D.FISCAL_WEEK,2)=0 \n             THEN TRUNC(D.SUNNORM_POSTING_DATE,'week') + 6\n             ELSE TRUNC(D.SUNNORM_POSTING_DATE,'week') + 13 END AS BIWEEK_ANCHOR,\n        P.ACCT_UNIT_TXT,\n        COUNT(DISTINCT P.RESOURCE) AS AOA\n    FROM AOA_BW_PREP P\n    LEFT JOIN DT D ON DATE(P.NORM_POST_DATE) = DATE(D.DATE)\n    GROUP BY 1, P.ACCT_UNIT_TXT\n),\nFINAL_EB_AOA_AU_LEVEL_BW AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', B.SUNNORM_POSTING_DATE)=0 THEN -6 ELSE 1 - DATE_PART('DOW', B.SUNNORM_POSTING_DATE) END,\n            B.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', B.SUNNORM_POSTING_DATE)=0 THEN 0 ELSE 7 - DATE_PART('DOW', B.SUNNORM_POSTING_DATE) END,\n            B.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK AS PERIOD_WEEK,\n        A.AOA               AS AMOUNT,\n        'AOA_AU'            AS STAT_ACCOUNT_CODE,\n        A.ACCT_UNIT_TXT     AS ACCT_UNIT,\n        'LAWSON'            AS SUBVERSION,\n        'TRADITIONAL'       AS OPS_CHANNEL,\n  --      'Bi/Alt Weekly'     AS BILL_CYCLE,\n        NULL                AS CUSTOMER,\n        DD.FISCAL_YEAR      AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD    AS ACCT_PERIOD\n    FROM AOA_BW_AGG_AU A\n    JOIN BIWEEK B ON A.BIWEEK_ANCHOR = B.BIWEEKLY\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON B.SUNNORM_POSTING_DATE = DD.DATE\n),\nAOA_BW_AGG_CUST AS (\n    SELECT \n        CASE WHEN MOD(D.FISCAL_WEEK,2)=0 \n             THEN TRUNC(D.SUNNORM_POSTING_DATE,'week') + 6\n             ELSE TRUNC(D.SUNNORM_POSTING_DATE,'week') + 13 END AS BIWEEK_ANCHOR,\n        P.ACCT_UNIT_TXT,\n        P.CUSTOMER,\n        COUNT(DISTINCT P.RESOURCE) AS AOA_CUSTOMER\n    FROM AOA_BW_PREP P\n    LEFT JOIN DT D ON DATE(P.NORM_POST_DATE) = DATE(D.DATE)\n    GROUP BY 1, P.ACCT_UNIT_TXT, P.CUSTOMER\n),\nFINAL_EB_AOA_CUST_LEVEL_BW AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', B.SUNNORM_POSTING_DATE)=0 THEN -6 ELSE 1 - DATE_PART('DOW', B.SUNNORM_POSTING_DATE) END,\n            B.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', B.SUNNORM_POSTING_DATE)=0 THEN 0 ELSE 7 - DATE_PART('DOW', B.SUNNORM_POSTING_DATE) END,\n            B.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK  AS PERIOD_WEEK,\n        A.AOA_CUSTOMER       AS AMOUNT,\n        'AOA_CUST'           AS STAT_ACCOUNT_CODE,\n        A.ACCT_UNIT_TXT      AS ACCT_UNIT,\n        'LAWSON'             AS SUBVERSION,\n        'TRADITIONAL'        AS OPS_CHANNEL,\n  --      'Bi/Alt Weekly'      AS BILL_CYCLE,\n        ROUND(A.CUSTOMER,0)  AS CUSTOMER,\n        DD.FISCAL_YEAR       AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD     AS ACCT_PERIOD\n    FROM AOA_BW_AGG_CUST A\n    JOIN BIWEEK B ON A.BIWEEK_ANCHOR = B.BIWEEKLY\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON B.SUNNORM_POSTING_DATE = DD.DATE\n),\nCB_BW_AGG AS (\n    SELECT \n        CASE WHEN MOD(D.FISCAL_WEEK,2)=0 \n             THEN TRUNC(D.SUNNORM_POSTING_DATE,'week') + 6\n             ELSE TRUNC(D.SUNNORM_POSTING_DATE,'week') + 13 END AS BIWEEK_ANCHOR,\n        P.ACCT_UNIT_TXT,\n        COUNT(DISTINCT P.CUSTOMER) AS CUSTOMER_BILLED\n    FROM AOA_BW_PREP P\n    LEFT JOIN DT D ON DATE(P.NORM_POST_DATE) = DATE(D.DATE)\n    GROUP BY 1, P.ACCT_UNIT_TXT\n),\nFINAL_EB_CUSTOMER_BILLED_AU_LEVEL_BW AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', B.SUNNORM_POSTING_DATE)=0 THEN -6 ELSE 1 - DATE_PART('DOW', B.SUNNORM_POSTING_DATE) END,\n            B.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', B.SUNNORM_POSTING_DATE)=0 THEN 0 ELSE 7 - DATE_PART('DOW', B.SUNNORM_POSTING_DATE) END,\n            B.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK AS PERIOD_WEEK,\n        A.CUSTOMER_BILLED   AS AMOUNT,\n        'CB'                AS STAT_ACCOUNT_CODE,\n        A.ACCT_UNIT_TXT     AS ACCT_UNIT,\n        'LAWSON'            AS SUBVERSION,\n        'TRADITIONAL'       AS OPS_CHANNEL,\n   --     'Bi/Alt Weekly'     AS BILL_CYCLE,\n        NULL                AS CUSTOMER,\n        DD.FISCAL_YEAR      AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD    AS ACCT_PERIOD\n    FROM CB_BW_AGG A\n    JOIN BIWEEK B ON A.BIWEEK_ANCHOR = B.BIWEEKLY\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON B.SUNNORM_POSTING_DATE = DD.DATE\n),\n\n/* ============================================================\n   MONTHLY RECAST — Assign counts to each Sunday in the fiscal period (no division)\n   ============================================================ */\nAOA_MN_PREP AS (\n    SELECT TR.*,\n           CASE WHEN TR.EMPLOYEE = '' THEN 0 ELSE CAST(TR.EMPLOYEE AS BIGINT) END AS RESOURCE,\n           D.FISCAL_YEAR_PERIOD\n    FROM (\n        SELECT DISTINCT \n            ACTRANS.OBJ_ID                                           AS OBJ_ID,\n            ACTRANS.ACCT_UNIT                                        AS ACCT_UNIT_TXT,\n            ACTRANS.ACCOUNT,\n            ACTRANS.ACCT_CATEGORY,\n            ACTRANS.ACTIVITY,\n            LTRIM(ARCUSTOMER.CUSTOMER)                               AS CUSTOMER,\n            CUSTDESC.NAME                                            AS SEARCH_NAME,\n            CASE WHEN (ACTRANS.RESOURCE_CODE IS NULL) OR (ACTRANS.RESOURCE_CODE = '')\n                 THEN ACHISTDTL.RESOURCE_CODE\n                 ELSE ACTRANS.RESOURCE_CODE END                      AS EMPLOYEE,\n            ACTRANS.POSTING_DATE,\n            CASE WHEN DAYNAME(ACTRANS.POSTING_DATE) = 'Sun' \n                 THEN ACTRANS.POSTING_DATE\n                 ELSE DATEADD(DAY, 7 - DAYOFWEEK(ACTRANS.POSTING_DATE), ACTRANS.POSTING_DATE) END AS NORM_POST_DATE,\n            CASE WHEN ACACTMXVAL.MX_VALUE IS NULL THEN ARCSTMXVAL.MX_VALUE ELSE ACACTMXVAL.MX_VALUE END AS BRANDLEVEL,\n            ACTRANS.SUM_ACCT_CAT                                     AS ACCT_CAT_CD,\n            IFF(NATACCT.NAT_CUSTOMER IS NULL, ARCUSTOMER.CUSTOMER, NATACCT.NAT_CUSTOMER)          AS LAWSON_PARENT_NUMBER,\n            IFF(NAT_CUSTDESC.SEARCH_NAME IS NULL, CUSTDESC.SEARCH_NAME, NAT_CUSTDESC.SEARCH_NAME) AS LAWSON_PARENT_NAME\n        FROM PROD_DATALAKE.LAWPROD.ACTRANS ACTRANS\n        INNER JOIN PROD_DATALAKE.LAWPROD.ACACTIVITY ACACTIVITY ON ACTRANS.ACTIVITY = ACACTIVITY.ACTIVITY\n        INNER JOIN PROD_DATALAKE.LAWPROD.ARCUSTOMER ARCUSTOMER ON ACACTIVITY.LEVEL_DETAIL_02 = ARCUSTOMER.CUSTOMER\n        INNER JOIN PROD_DATALAKE.LAWPROD.CUSTDESC CUSTDESC ON ARCUSTOMER.CUSTOMER = CUSTDESC.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.NATACCT NATACCT ON NATACCT.CUSTOMER = ARCUSTOMER.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.CUSTDESC NAT_CUSTDESC ON NATACCT.CUSTOMER = NAT_CUSTDESC.CUSTOMER\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ACACTMXVAL ACACTMXVAL ON ACACTIVITY.OBJ_ID = ACACTMXVAL.OBJ_ID AND ACACTMXVAL.MATRIX_CAT = 'BRAND'\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ARCSTMXVAL ARCSTMXVAL ON ARCUSTOMER.OBJ_ID = ARCSTMXVAL.OBJ_ID AND ARCSTMXVAL.MATRIX_CAT = 'BRAND'\n        LEFT JOIN  PROD_DATALAKE.LAWPROD.ACHISTDTL ACHISTDTL ON ACTRANS.OBJ_ID = ACHISTDTL.ATN_OBJ_ID\n        WHERE ACTRANS.ACCOUNT NOT IN (1230)\n          AND ACTRANS.ACCT_CATEGORY NOT IN ('510BC')\n    ) TR\n    INNER JOIN MONTHLY_CUST CUST ON CUST.ACTIVITY_TXT = TR.ACTIVITY\n    INNER JOIN EB_base_ids base  ON base.CUSTOMER_NUMBER = LTRIM(TR.CUSTOMER)\n    LEFT JOIN DT D               ON DATE(TR.NORM_POST_DATE) = DATE(D.DATE)\n    WHERE TR.ACCT_CATEGORY <> 'BILLD'\n),\nAOA_MN_AGG_AU AS (\n    SELECT P.FISCAL_YEAR_PERIOD, P.ACCT_UNIT_TXT, COUNT(DISTINCT P.RESOURCE) AS AOA\n    FROM AOA_MN_PREP P\n    GROUP BY 1,2\n),\nFINAL_EB_AOA_AU_LEVEL_MN AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', SD.SUNNORM_POSTING_DATE)=0 THEN -6 ELSE 1 - DATE_PART('DOW', SD.SUNNORM_POSTING_DATE) END,\n            SD.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', SD.SUNNORM_POSTING_DATE)=0 THEN 0 ELSE 7 - DATE_PART('DOW', SD.SUNNORM_POSTING_DATE) END,\n            SD.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK  AS PERIOD_WEEK,\n        A.AOA                AS AMOUNT,\n        'AOA_AU'             AS STAT_ACCOUNT_CODE,\n        A.ACCT_UNIT_TXT      AS ACCT_UNIT,\n        'LAWSON'             AS SUBVERSION,\n        'TRADITIONAL'        AS OPS_CHANNEL,\n      --  'Monthly'            AS BILL_CYCLE,\n        NULL                 AS CUSTOMER,\n        DD.FISCAL_YEAR       AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD     AS ACCT_PERIOD\n    FROM AOA_MN_AGG_AU A\n    JOIN SUN_DT SD ON SD.FISCAL_YEAR_PERIOD = A.FISCAL_YEAR_PERIOD\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON SD.SUNNORM_POSTING_DATE = DD.DATE\n),\nAOA_MN_AGG_CUST AS (\n    SELECT P.FISCAL_YEAR_PERIOD, P.ACCT_UNIT_TXT, P.CUSTOMER, COUNT(DISTINCT P.RESOURCE) AS AOA_CUSTOMER\n    FROM AOA_MN_PREP P\n    GROUP BY 1,2,3\n),\nFINAL_EB_AOA_CUST_LEVEL_MN AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', SD.SUNNORM_POSTING_DATE)=0 THEN -6 ELSE 1 - DATE_PART('DOW', SD.SUNNORM_POSTING_DATE) END,\n            SD.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', SD.SUNNORM_POSTING_DATE)=0 THEN 0 ELSE 7 - DATE_PART('DOW', SD.SUNNORM_POSTING_DATE) END,\n            SD.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK  AS PERIOD_WEEK,\n        A.AOA_CUSTOMER       AS AMOUNT,\n        'AOA_CUST'           AS STAT_ACCOUNT_CODE,\n        A.ACCT_UNIT_TXT      AS ACCT_UNIT,\n        'LAWSON'             AS SUBVERSION,\n        'TRADITIONAL'        AS OPS_CHANNEL,\n      --  'Monthly'            AS BILL_CYCLE,\n        ROUND(A.CUSTOMER,0)  AS CUSTOMER,\n        DD.FISCAL_YEAR       AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD     AS ACCT_PERIOD\n    FROM AOA_MN_AGG_CUST A\n    JOIN SUN_DT SD ON SD.FISCAL_YEAR_PERIOD = A.FISCAL_YEAR_PERIOD\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON SD.SUNNORM_POSTING_DATE = DD.DATE\n),\nCB_MN_AGG AS (\n    SELECT P.FISCAL_YEAR_PERIOD, P.ACCT_UNIT_TXT, COUNT(DISTINCT P.CUSTOMER) AS CUSTOMER_BILLED\n    FROM AOA_MN_PREP P\n    GROUP BY 1,2\n),\nFINAL_EB_CUSTOMER_BILLED_AU_LEVEL_MN AS (\n    SELECT\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', SD.SUNNORM_POSTING_DATE)=0 THEN -6 ELSE 1 - DATE_PART('DOW', SD.SUNNORM_POSTING_DATE) END,\n            SD.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_START_DATE,\n        TO_CHAR(DATEADD(DAY,\n            CASE WHEN DATE_PART('DOW', SD.SUNNORM_POSTING_DATE)=0 THEN 0 ELSE 7 - DATE_PART('DOW', SD.SUNNORM_POSTING_DATE) END,\n            SD.SUNNORM_POSTING_DATE),'MM/DD/YYYY') AS PERIOD_END_DATE,\n        DD.FISCAL_YEAR_WEEK  AS PERIOD_WEEK,\n        A.CUSTOMER_BILLED    AS AMOUNT,\n        'CB'                 AS STAT_ACCOUNT_CODE,\n        A.ACCT_UNIT_TXT      AS ACCT_UNIT,\n        'LAWSON'             AS SUBVERSION,\n        'TRADITIONAL'        AS OPS_CHANNEL,\n        -- 'Monthly'            AS BILL_CYCLE,\n        NULL                 AS CUSTOMER,\n        DD.FISCAL_YEAR       AS FISCAL_YEAR,\n        DD.FISCAL_PERIOD     AS ACCT_PERIOD\n    FROM CB_MN_AGG A\n    JOIN SUN_DT SD ON SD.FISCAL_YEAR_PERIOD = A.FISCAL_YEAR_PERIOD\n    LEFT JOIN PROD_EDW.ENT.DATE_DIM DD ON SD.SUNNORM_POSTING_DATE = DD.DATE\n),\n\n/* ------------------------------------------------------------\n   UNION sources\n   ------------------------------------------------------------ */\n\nUNION_SOURCES_BC AS (\n    -------------- BC -----------------\n    SELECT *\n\tFROM FINAL_BC_CUSTOMER_BILLED_AU_LEVEL\n\tUNION ALL\n\tSELECT *\n\tFROM FINAL_BC_AOA_AU_LEVEL\n\tUNION ALL\n\tSELECT *\n\tFROM FINAL_BC_AOA_CUST_LEVEL\n\tUNION ALL\n\tSELECT *\n\tFROM FINAL_BC_BILLED_HOURS\n    ),\n\nUNION_SOURCES_EB AS (\n\n    -------------- EB -----------------\n    SELECT * FROM FINAL_EB_CUSTOMER_BILLED_AU_LEVEL    -- must come from weekly customers\n    UNION ALL\n    SELECT * FROM FINAL_EB_AOA_AU_LEVEL                -- must come from weekly customers\n    UNION ALL\n    SELECT * FROM FINAL_EB_AOA_CUST_LEVEL              -- must come from weekly customers\n    UNION ALL\n    SELECT * FROM FINAL_EB_BILLED_HOURS                -- hours must come from ALL customers\n\n    -- EB BIWEEK RECAST (all must come from bi-weekly customers)\n    UNION ALL SELECT * FROM FINAL_EB_CUSTOMER_BILLED_AU_LEVEL_BW   -- bi-weekly customers\n    UNION ALL SELECT * FROM FINAL_EB_AOA_AU_LEVEL_BW               -- bi-weekly customers\n    UNION ALL SELECT * FROM FINAL_EB_AOA_CUST_LEVEL_BW             -- bi-weekly customers\n\n    -- EB MONTHLY RECAST (all must come from monthly customers)\n    UNION ALL SELECT * FROM FINAL_EB_CUSTOMER_BILLED_AU_LEVEL_MN   -- monthly customers\n    UNION ALL SELECT * FROM FINAL_EB_AOA_AU_LEVEL_MN               -- monthly customers\n    UNION ALL SELECT * FROM FINAL_EB_AOA_CUST_LEVEL_MN             -- monthly customers\n)\n\n-------------------------------------------------\nSELECT  PERIOD_START_DATE, PERIOD_END_DATE, PERIOD_WEEK, SUM(AMOUNT) AS AMOUNT, STAT_ACCOUNT_CODE, ACCT_UNIT, SUBVERSION, OPS_CHANNEL,CUSTOMER, FISCAL_YEAR, ACCT_PERIOD\nFROM UNION_SOURCES_BC\nWHERE PERIOD_END_DATE > TO_DATE('${STATS_ACTUALS_FY_DATE}')\nAND PERIOD_END_DATE <= TO_DATE('${STATS_ACTUALS_LS_DATE}')\nGROUP BY 1,2,3,5,6,7,8, 9,10,11\n\nUNION ALL\n\nSELECT  PERIOD_START_DATE, PERIOD_END_DATE, PERIOD_WEEK, SUM(AMOUNT) AS AMOUNT, STAT_ACCOUNT_CODE, ACCT_UNIT, SUBVERSION, OPS_CHANNEL,CUSTOMER, FISCAL_YEAR, ACCT_PERIOD\nFROM UNION_SOURCES_EB\nWHERE PERIOD_END_DATE > TO_DATE('${STATS_ACTUALS_FY_DATE}')\nAND PERIOD_END_DATE <= TO_DATE('${STATS_ACTUALS_LS_DATE}')\nGROUP BY 1,2,3,5,6,7,8, 9,10,11\n\n\n\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341771":{"id":6341771,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":320,"y":384,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6341774],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL Logic ATS"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH customer_ids AS (\n    SELECT DISTINCT\n        CUSTOMER AS CUSTOMER_NUMBER\n    FROM  PROD_ENTERPRISE.ADAPTIVE.GL_AGG_TRANSFORM\n    WHERE customer is not null\n),\n\nFilled_OF_Prep as (\n    SELECT CDA_JOBORDERID, COUNT(DISTINCT CDA_ASSIGNMENTID) AS ASSIGNED_TOTAL,\n    FROM \"PROD_ENTERPRISE\".\"OPERATIONS\".OE_ASSIGNMENT_TBL\n    WHERE CDA_ASSIGNMENTID IS NOT NULL\n    GROUP BY CDA_JOBORDERID\n),\n\nUnique_Audit_Job_Orders as (\n    SELECT distinct OBJECTID JOBORDER_ID\n    FROM \"PROD_ENTERPRISE\".\"OPERATIONS\".\"OE_JOBORDERAUDITHIST\"\n),\n\nORDER_FILLED_EB AS (\n\t\tSELECT \n            TO_CHAR(DATEADD(DAY,\n\t\t\t\tCASE\n\t\t\t\t\tWHEN DATE_PART('DOW', ReportView.JOB_START_DATE) = 0 THEN -6\n\t\t\t\t\tELSE 1 - DATE_PART('DOW', ReportView.JOB_START_DATE)\n\t\t\t\tEND,\n\t\t\tReportView.JOB_START_DATE), 'MM/DD/YYYY') AS PERIOD_START_DATE,\n\t\t\tTO_CHAR(DATEADD(DAY,\n\t\t\t\tCASE\n\t\t\t\t\tWHEN DATE_PART('DOW', ReportView.JOB_START_DATE) = 0 THEN 0\n\t\t\t\t\tELSE 7 - DATE_PART('DOW', ReportView.JOB_START_DATE)\n\t\t\t\tEND,\n\t\t\tReportView.JOB_START_DATE), 'MM/DD/YYYY') AS PERIOD_END_DATE,\n\t\t\tDD.FISCAL_YEAR_WEEK      AS PERIOD_WEEK,\n            SUM(LEAST(COALESCE(ASSIGNED_TOTAL, 0),NUMBER_REQUIRED)) AS AMOUNT,\n\t\t\t'FILLED'           \t\t AS STAT_ACCOUNT_CODE,\n\t\t\tReportView.ACCOUNT_UNIT_CODE        AS ACCT_UNIT, \n\t\t\t'ATS'                    AS SUBVERSION,\n\t\t\t'Traditional'            AS OPS_CHANNEL,\n\t\t\tReportView.CUSTOMER_NUMBER    AS CUSTOMER,\n\t\t\tDD.FISCAL_YEAR           AS FISCAL_YEAR,\n\t\t\tDD.FISCAL_PERIOD         AS ACCT_PERIOD\n\t\tFROM  PROD_EDW.ENT.JOBORDER_FACT ReportView -- PROD_DATALAKE.CRM_MSCRM.CDA_JOBORDERBASE\n        -- Integrity validation similar as PROD_ENTERPRISE.OPERATIONS.OE_JOBORDER_FILL_HISTORY_ALL\n        INNER JOIN Unique_Audit_Job_Orders Audit_Orders\n            ON Audit_Orders.JOBORDER_ID = ReportView.JOBORDER_ID\n        -- Filled number coming from OE_ASSIGNMENT_TBL\n        LEFT JOIN Filled_OF_Prep AS A\n            ON A.CDA_JOBORDERID = ReportView.JOBORDER_ID\n        INNER JOIN customer_ids base ON base.CUSTOMER_NUMBER = ReportView.CUSTOMER_NUMBER\n        LEFT JOIN \"PROD_DATALAKE\".\"CRM_MSCRM\".\"CDA_JOBCODEBASE\" codebase\n            ON codebase.cda_jobcodeid = ReportView.job_code_id\n        INNER JOIN PROD_EDW.ENT.BRANCH_DIM DIM\n            ON DIM.BRANCH_ID = REPORTVIEW.BRANCH_ID\n            AND DIM.DW_DATA_SOURCE_KEY = 1 \n            and DIM.DW_ACTIVE_FLAG = 'Y' \n            and DIM.STATE_CODE = 'Active' \n            and DIM.STATUS_CODE = 'Active'\n        INNER JOIN prod_edw.ent.accounting_unit_hierarchy_dim au_dim\n            on LPAD(DIM.ACCOUNTING_UNIT,5,'0') = au_dim.ACCOUNT_UNIT_CODE\n            AND au_dim.dw_active_flag = 'Y'\n            and coalesce(company_code, 1) <> 100\n        LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n\t\t\tON TO_DATE(ReportView.JOB_START_DATE) = DD.DATE        \n        WHERE ReportView.DW_ACTIVE_FLAG = 'Y' and ReportView.DW_DATA_SOURCE_KEY = 1\n        AND coalesce(codebase.cda_name,'') not in ('Recruiting Job Order')\n        AND au_dim.division_name IN ('Central Branch', 'Commercial', 'Commercial Field', 'EB Professional Solutions', 'Franchise Division', 'Northern Division', 'ProDrivers Division', 'South Central Division', 'Southeast Division', 'Western Division', 'Energy Division', 'RemX CCS (L3)')\n        AND ReportView.STATUS_CODE in ('Canceled', 'Canceled - Competition Filled', 'Canceled - Customer Filled Internally', 'Canceled - Turnaround Time', 'Complete', 'Filled', 'Open', 'Partial Filled', 'Not Able To Fill - No Drivers Available')\n        AND COALESCE(JOB_ORDER_TYPE, '') <> 'DH' \n        AND DIM.LOB IS NOT NULL -- DIVISION\n        GROUP BY PERIOD_START_DATE, PERIOD_END_DATE, PERIOD_WEEK, FISCAL_YEAR, FISCAL_PERIOD, CUSTOMER, ACCT_UNIT\n\t)\n    \n,ORDER_NEEDED_EB AS (\n\t\tSELECT \n\t\t\tTO_CHAR(DATEADD(DAY,\n\t\t\t\tCASE\n\t\t\t\t\tWHEN DATE_PART('DOW', ReportView.JOB_START_DATE) = 0 THEN -6\n\t\t\t\t\tELSE 1 - DATE_PART('DOW', ReportView.JOB_START_DATE)\n\t\t\t\tEND,\n\t\t\tReportView.JOB_START_DATE), 'MM/DD/YYYY') AS PERIOD_START_DATE,\n\t\t\tTO_CHAR(DATEADD(DAY,\n\t\t\t\tCASE\n\t\t\t\t\tWHEN DATE_PART('DOW', ReportView.JOB_START_DATE) = 0 THEN 0\n\t\t\t\t\tELSE 7 - DATE_PART('DOW', ReportView.JOB_START_DATE)\n\t\t\t\tEND,\n\t\t\tReportView.JOB_START_DATE), 'MM/DD/YYYY') AS PERIOD_END_DATE,\n\t\t\tDD.FISCAL_YEAR_WEEK      AS PERIOD_WEEK,\n            SUM(NUMBER_REQUIRED)     AS AMOUNT,\n\t\t\t'HEADCOUNT_ORDER'        AS STAT_ACCOUNT_CODE,\n\t\t\tReportView.ACCOUNT_UNIT_CODE        AS ACCT_UNIT, \n\t\t\t'ATS'                    AS SUBVERSION,\n\t\t\t'Traditional'            AS OPS_CHANNEL,\n\t\t\tReportView.CUSTOMER_NUMBER    AS CUSTOMER, \n\t\t\tDD.FISCAL_YEAR           AS FISCAL_YEAR,\n\t\t\tDD.FISCAL_PERIOD         AS ACCT_PERIOD\n        FROM  PROD_EDW.ENT.JOBORDER_FACT ReportView\n        -- Integrity validation similar as PROD_ENTERPRISE.OPERATIONS.OE_JOBORDER_FILL_HISTORY_ALL           \n        INNER JOIN Unique_Audit_Job_Orders Audit_Orders\n            ON Audit_Orders.JOBORDER_ID = ReportView.JOBORDER_ID\n\t\tINNER JOIN customer_ids base ON base.CUSTOMER_NUMBER = ReportView.CUSTOMER_NUMBER\n        LEFT JOIN \"PROD_DATALAKE\".\"CRM_MSCRM\".\"CDA_JOBCODEBASE\" codebase\n            ON codebase.cda_jobcodeid = ReportView.job_code_id\n        INNER JOIN PROD_EDW.ENT.BRANCH_DIM DIM\n            ON DIM.BRANCH_ID = REPORTVIEW.BRANCH_ID\n            AND DIM.DW_DATA_SOURCE_KEY = 1 \n            and DIM.DW_ACTIVE_FLAG = 'Y' \n            and DIM.STATE_CODE = 'Active' \n            and DIM.STATUS_CODE = 'Active'\n        INNER JOIN prod_edw.ent.accounting_unit_hierarchy_dim au_dim\n            on LPAD(DIM.ACCOUNTING_UNIT,5,'0') = au_dim.ACCOUNT_UNIT_CODE\n            AND au_dim.dw_active_flag = 'Y'\n            and coalesce(company_code, 1) <> 100\n        LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n\t\t\tON TO_DATE(ReportView.JOB_START_DATE) = DD.DATE        \n        WHERE ReportView.DW_ACTIVE_FLAG = 'Y' and ReportView.DW_DATA_SOURCE_KEY = 1\n            and NUMBER_REQUIRED>0\n        AND coalesce(codebase.cda_name,'') not in ('Recruiting Job Order')\n        AND au_dim.division_name IN ('Central Branch', 'Commercial', 'Commercial Field', 'EB Professional Solutions', 'Franchise Division', 'Northern Division', 'ProDrivers Division', 'South Central Division', 'Southeast Division', 'Western Division', 'Energy Division', 'RemX CCS (L3)')\n        AND ReportView.STATUS_CODE in ('Canceled', 'Canceled - Competition Filled', 'Canceled - Customer Filled Internally', 'Canceled - Turnaround Time', 'Complete', 'Filled', 'Open', 'Partial Filled', 'Not Able To Fill - No Drivers Available')\n        AND COALESCE(JOB_ORDER_TYPE, '') <> 'DH' \n        AND DIM.LOB IS NOT NULL -- DIVISION\n        GROUP BY PERIOD_START_DATE, PERIOD_END_DATE, PERIOD_WEEK, FISCAL_YEAR, FISCAL_PERIOD, CUSTOMER, ACCT_UNIT\n),\n\nCTE_CUST AS (\n  WITH ARCUS AS (\n    SELECT DISTINCT\n           ARC.DEFAULT_CODE               AS DEFAULT_CODE,\n           SA.BRANCH__C                   AS BRANCH__C,\n           GLT.ACCT_UNIT                  AS ACCOUNT_UNIT,\n           TRIM(ARC.CUSTOMER)             AS CUSTOMER,\n           BD.ACCOUNTING_UNIT             AS ACCOUNT_UNIT_BD,\n           ARC.SEARCH_NAME                AS SEARCH_NAME,\n           TRIM(SA.ACCOUNTNUMBER)         AS ACCOUNTNUMBER,\n           SA.LEGACY_ID__C                AS BC_ACCOUNT_ID,\n           SA.NAME                        AS NAME,\n           GLT.*\n    FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER ARC\n    LEFT JOIN PROD_DATALAKE.LAWPROD.ARDISTRIB A\n           ON TRIM(TRY_TO_NUMBER(ARC.CUSTOMER)) = TRIM(TRY_TO_NUMBER(A.CUSTOMER))\n    LEFT JOIN PROD_DATALAKE.LAWPROD.GLTRANS GLT\n           ON A.GLT_OBJ_ID = GLT.OBJ_ID\n    LEFT JOIN PROD_DATALAKE.SALESFORCE.ACCOUNT SA\n           ON TRIM(TRY_TO_NUMBER(SA.ACCOUNTNUMBER)) = TRIM(TRY_TO_NUMBER(ARC.CUSTOMER))\n          AND LOWER(SA.BRAND__C) = 'bluecrew'\n    LEFT JOIN PROD_EDW.ENT.BRANCH_DIM BD\n           ON BD.BRANCH_NUMBER = ARC.DEFAULT_CODE\n          AND BD.DW_ACTIVE_FLAG = 'Y'\n          AND BD.DW_DATA_SOURCE_KEY = '1'\n          AND BD.BRAND_NAME = 'Bluecrew'\n    WHERE UPPER(A.MX_VALUE_01) = 'DIGITAL'\n  )\n  SELECT\n      ARCUS.DEFAULT_CODE,\n      ARCUS.CUSTOMER,\n      ARCUS.ACCOUNT_UNIT_BD\n  FROM ARCUS\n  GROUP BY 1,2,3//, ARCUS.DEFAULT_CODE, ARCUS.CUSTOMER, ARCUS.ACCOUNT_UNIT_BD\n),\n \nCTE_BCWBS AS (\n  SELECT\n      to_date(FHW.JOB_START_DATE_TIME)                                 AS NORM_POST_DATE,\n      SF.ACCOUNTNUMBER                                        AS CUSTOMER,\n      TO_VARCHAR(SF.NAME)                                     AS NAME,\n      CTEC.CUSTOMER                                           AS DC_CUSTOMER,   \n      FHW.COMPANY_ORIGIN,\n      FHW.JOB_USERS_SIGNED_UP                                 AS JOBORDER_FILLED,\n      FHW.JOB_NEEDED_LAST_COUNT                                AS JOBORDER_NEEDED,\n      CTEC.DEFAULT_CODE,\n      CTEC.ACCOUNT_UNIT_BD,\n      CASE\n        WHEN LOWER(FHW.COMPANY_NAME) LIKE ('%hit%') THEN '41758'\n        WHEN CTEC.DEFAULT_CODE IS NOT NULL\n             AND SUBSTR(CTEC.DEFAULT_CODE, 1, 1) NOT IN ('8','6') THEN CTEC.DEFAULT_CODE\n        WHEN SUBSTR(CTEC.DEFAULT_CODE, 1, 1) IN ('8','6')        THEN CTEC.ACCOUNT_UNIT_BD\n        WHEN CTEC.DEFAULT_CODE IS NULL                            THEN G.ACCOUNTING_UNIT\n      END                                                     AS ACCOUNT_UNIT\n  FROM DB_BC_FACTS.AZUL.FACT_JOB FHW\n  LEFT JOIN DB_BC_FACTS.AZUL.DM_COMPANIES DC\n         ON TRIM(FHW.COMPANY_ID) = TRIM(DC.COMPANY_ID)\n  LEFT JOIN DB_BC_FACTS.AZUL.FACT_JOB_SHIFT_WORKED FJSW ON FJSW.JOB_ID = FHW.JOB_ID\n  LEFT JOIN PROD_DATALAKE.SALESFORCE.ACCOUNT SF\n         ON TRIM(TO_VARCHAR(SF.LEGACY_ID__C)) = TRIM(TO_VARCHAR(FHW.COMPANY_ID))\n        AND LOWER(SF.BRAND__C) = 'bluecrew'\n  LEFT JOIN CTE_CUST CTEC\n         ON TRIM(TRY_TO_NUMBER(SF.ACCOUNTNUMBER)) = TRIM(TRY_TO_NUMBER(CTEC.CUSTOMER))\n  LEFT JOIN ( \n      SELECT DISTINCT\n             SF.LEGACY_ID__C     AS LEGACY_ID__C,\n             SF.ACCOUNTNUMBER    AS ACCOUNTNUMBER,\n             BR.BRANCH_NUMBER    AS BRANCH_NUMBER,\n             BRB.ACCOUNTING_UNIT AS ACCOUNTING_UNIT\n      FROM PROD_DATALAKE.SALESFORCE.ACCOUNT SF\n      LEFT JOIN PROD_EDW.ENT.BRANCH_DIM BR\n             ON BR.BRANCH_ID = SF.BRANCH__C\n            AND BR.DW_ACTIVE_FLAG = 'Y'\n            AND BR.DW_DATA_SOURCE_KEY = '2'\n      LEFT JOIN PROD_EDW.ENT.BRANCH_DIM BRB\n             ON BR.BRANCH_NUMBER = BRB.BRANCH_NUMBER\n            AND UPPER(BRB.BRAND_NAME) = 'BLUECREW'\n            AND BRB.DW_ACTIVE_FLAG = 'Y'\n            AND BRB.DW_DATA_SOURCE_KEY = '1'\n      WHERE UPPER(SF.BRAND__C) = 'BLUECREW'\n        AND SF.LEGACY_ID__C IS NOT NULL\n        ) AS G\n         ON TO_CHAR(G.LEGACY_ID__C) = TO_CHAR(DC.COMPANY_ID)\n  LEFT JOIN (\n      SELECT FCR.COMPANY_ID, MIN(LEFT(FCR.CUSTOMER_CODE, 3)) AS REGIONCODE\n      FROM DB_BC_FACTS.AZUL.FACT_COMPANY_REVENUE FCR\n      WHERE FCR.CUSTOMER_CODE IS NOT NULL\n      GROUP BY FCR.COMPANY_ID\n      ) CC\n     ON CC.COMPANY_ID = FHW.COMPANY_ID\n  WHERE FHW.COMPANY_ID NOT IN (\n          SELECT DMC.COMPANY_ID\n          FROM DB_BC_FACTS.AZUL.DM_COMPANIES DMC\n          WHERE DMC.COMPANY_NAME LIKE '%Bluecrew%'\n      )\n      AND SF.ACCOUNTNUMBER IN (SELECT DISTINCT CUSTOMER_NUMBER FROM customer_ids)\n      AND FJSW.SHIFT_NEEDED > 0\n      AND FJSW.SHIFT_ACTIVE = TRUE\n      AND FHW.job_status not in ('Business Declined','Canceled','Canceled - Competition Filled', 'Canceled - Customer Filled Internally', 'Canceled - Route Canceled', 'Canceled - Turnaround Time', 'Cancelled', 'Complete', 'Filled', 'Hidden', 'Not Able To Fill - Branch Error','Not Able To Fill - Duplicate', 'Not Able To Fill - No Drivers Available', 'Not Able To Fill - No Proper Endorsements', 'Open', 'Partial Filled', 'Paused', 'Standard Order')\n),\n \nORDER_FILLED_BC AS(\n  SELECT\n      TO_CHAR(\n        DATEADD(DAY,\n          CASE WHEN DATE_PART('DOW', B.NORM_POST_DATE) = 0 THEN -6\n               ELSE 1 - DATE_PART('DOW', B.NORM_POST_DATE)\n          END,\n          B.NORM_POST_DATE\n        ),\n        'MM/DD/YYYY'\n      )                                        AS PERIOD_START_DATE,\n      TO_CHAR(\n        DATEADD(DAY,\n          CASE WHEN DATE_PART('DOW', B.NORM_POST_DATE) = 0 THEN 0\n               ELSE 7 - DATE_PART('DOW', B.NORM_POST_DATE)\n          END,\n          B.NORM_POST_DATE\n        ),\n        'MM/DD/YYYY'\n      )                                        AS PERIOD_END_DATE,\n      DD.FISCAL_YEAR_WEEK                      AS PERIOD_WEEK,\n      SUM(B.JOBORDER_FILLED)                   AS AMOUNT,\n      'FILLED'                                 AS STAT_ACCOUNT_CODE,  \n      B.ACCOUNT_UNIT                           AS ACCT_UNIT,   \n      'ATS'                                    AS SUBVERSION,\n      'Digital'                                AS OPS_CHANNEL,\n      CUSTOMER                                 AS CUSTOMER,         \n      DD.FISCAL_YEAR                           AS FISCAL_YEAR,\n      DD.FISCAL_PERIOD                         AS ACCT_PERIOD\n  FROM CTE_BCWBS B\n  LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n         ON B.NORM_POST_DATE = DD.DATE\n  WHERE B.JOBORDER_FILLED>0 \n  GROUP BY PERIOD_START_DATE, PERIOD_END_DATE, FISCAL_YEAR_WEEK, FISCAL_YEAR, FISCAL_PERIOD, CUSTOMER, ACCT_UNIT\n),\n\nORDER_NEEDED_BC AS(\n  SELECT \n      TO_CHAR(\n        DATEADD(DAY,\n          CASE WHEN DATE_PART('DOW', B.NORM_POST_DATE) = 0 THEN -6\n               ELSE 1 - DATE_PART('DOW', B.NORM_POST_DATE)\n          END,\n          B.NORM_POST_DATE\n        ),\n        'MM/DD/YYYY'\n      )                                        AS PERIOD_START_DATE,\n      TO_CHAR(\n        DATEADD(DAY,\n          CASE WHEN DATE_PART('DOW', B.NORM_POST_DATE) = 0 THEN 0\n               ELSE 7 - DATE_PART('DOW', B.NORM_POST_DATE)\n          END,\n          B.NORM_POST_DATE\n        ),\n        'MM/DD/YYYY'\n      )                                        AS PERIOD_END_DATE,\n      DD.FISCAL_YEAR_WEEK                      AS PERIOD_WEEK,\n      SUM(B.JOBORDER_NEEDED)                   AS AMOUNT,\n      'HEADCOUNT_ORDER'                        AS STAT_ACCOUNT_CODE,  \n      B.ACCOUNT_UNIT                           AS ACCT_UNIT,         \n      'ATS'                                    AS SUBVERSION,\n      'Digital'                                AS OPS_CHANNEL,                         \n      CUSTOMER                                 AS CUSTOMER,         \n      DD.FISCAL_YEAR                           AS FISCAL_YEAR,\n      DD.FISCAL_PERIOD                         AS ACCT_PERIOD\n  FROM CTE_BCWBS B\n  LEFT JOIN PROD_EDW.ENT.DATE_DIM DD\n         ON B.NORM_POST_DATE = DD.DATE\n  WHERE B.JOBORDER_NEEDED>0\n  GROUP BY PERIOD_START_DATE, PERIOD_END_DATE, FISCAL_YEAR_WEEK, FISCAL_YEAR, FISCAL_PERIOD, CUSTOMER, ACCT_UNIT\n),\n\nUNION_SOURCES AS (\n    SELECT * FROM ORDER_FILLED_EB\n    UNION ALL\n    SELECT * FROM ORDER_NEEDED_EB\n    UNION ALL\n    SELECT * FROM ORDER_FILLED_BC\n    UNION ALL\n    SELECT * FROM ORDER_NEEDED_BC\n)\n\n---------------- DATE FILTERS -------------------\n-- DATE FILTERS CAN BE APPLIED OVER:\n-- PERIOD_START_DATE ('MM/DD/YYYY'), \n-- PERIOD_END_DATE ('MM/DD/YYYY')\n-- PERIOD_WEEK (YYYYWW), \n-- FISCAL_YEAR (YYYY)\n-- ACCT_PERIOD ('00') \n-------------------------------------------------\nSELECT PERIOD_START_DATE, PERIOD_END_DATE, PERIOD_WEEK, AMOUNT, STAT_ACCOUNT_CODE, ACCT_UNIT, SUBVERSION, OPS_CHANNEL, CUSTOMER, FISCAL_YEAR, ACCT_PERIOD   \nFROM UNION_SOURCES \n------------------- EXAMPLE: --------------------\n--WHERE FISCAL_YEAR = 2025 AND ACCT_PERIOD >= '01' AND ACCT_PERIOD <= '09'\nWHERE PERIOD_END_DATE > TO_DATE('${STATS_ACTUALS_FY_DATE}')\nAND PERIOD_END_DATE <= TO_DATE('${STATS_ACTUALS_LS_DATE}')"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341772":{"id":6341772,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":320,"y":272,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6341776],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL Logic UKG"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH PREP AS (SELECT HPA.*,\n                     DATEADD(DAY, -5, HPA.PERIOD_CONTROL_DATE) AS PREV_NORM_POST_DATE\n              FROM PROD_DATALAKE.UKG.UKG_HEADCOUNT_PAYDATA_ALLOCATIONS HPA\n              /*WHERE HPA.PERIOD_CONTROL_DATE >= '2025-01-05'\n                AND HPA.PERIOD_CONTROL_DATE <= '2025-06-29'*/),---Capturing the previous normpostdate from period control date\n\n     BASE_CONTINUED AS (SELECT A.*,\n                     LPAD(A.ACCOUNTING_UNIT, 5, 0)        AS NEW_ACCOUNTING_UNIT,\n                     CONCAT(D.FISCAL_YEAR, D.FISCAL_WEEK) AS NORM_POST_WEEK,\n                     T.MAPPING                            AS MAPPING,\n                     DATEADD(DAY,\n                             CASE\n                                 WHEN DATE_PART('DOW', A.PREV_NORM_POST_DATE) = 0 THEN -6\n                                 ELSE 1 - DATE_PART('DOW', A.PREV_NORM_POST_DATE)\n                                 END,\n                             A.PREV_NORM_POST_DATE\n                     )                                    AS PERIOD_START_DATE,\n                     DATEADD(DAY,\n                             CASE\n                                 WHEN DATE_PART('DOW', A.PREV_NORM_POST_DATE) = 0 THEN 0\n                                 ELSE 7 - DATE_PART('DOW', A.PREV_NORM_POST_DATE)\n                                 END,\n                             A.PREV_NORM_POST_DATE\n                     )                                    AS PERIOD_END_DATE,\n                     D.FISCAL_YEAR_WEEK                   AS PERIOD_WEEK,\n                     D.FISCAL_YEAR                        AS FISCAL_YEAR,\n                     D.FISCAL_PERIOD                      AS FISCAL_PERIOD\n              FROM PREP A\n                       LEFT JOIN PROD_EDW.ENT.DATE_DIM D\n                                 ON D.DATE = A.PREV_NORM_POST_DATE\n                       LEFT JOIN PROD_DATALAKE.UKG.FTE_TITLES T\n                                 ON A.JOB_TITLE = T.TITLE),\n\n\t BASE_REGULAR AS (SELECT HPA.*,\n                     LPAD(HPA.ACCOUNTING_UNIT, 5, 0)      AS NEW_ACCOUNTING_UNIT,\n                     CONCAT(D.FISCAL_YEAR, D.FISCAL_WEEK) AS NORM_POST_WEEK,\n                     T.MAPPING                            AS MAPPING,\n                     DATEADD(DAY,\n                             CASE\n                                 WHEN DATE_PART('DOW', HPA.PERIOD_CONTROL_DATE) = 0 THEN -6\n                                 ELSE 1 - DATE_PART('DOW', HPA.PERIOD_CONTROL_DATE)\n                                 END,\n                             HPA.PERIOD_CONTROL_DATE\n                     )                                    AS PERIOD_START_DATE,\n                     DATEADD(DAY,\n                             CASE\n                                 WHEN DATE_PART('DOW', HPA.PERIOD_CONTROL_DATE) = 0 THEN 0\n                                 ELSE 7 - DATE_PART('DOW', HPA.PERIOD_CONTROL_DATE)\n                                 END,\n                             HPA.PERIOD_CONTROL_DATE\n                     )                                    AS PERIOD_END_DATE,\n                     D.FISCAL_YEAR_WEEK                   AS PERIOD_WEEK,\n                     D.FISCAL_YEAR                        AS FISCAL_YEAR,\n                     D.FISCAL_PERIOD                      AS FISCAL_PERIOD\n              FROM PROD_DATALAKE.UKG.UKG_HEADCOUNT_PAYDATA_ALLOCATIONS HPA\n                       LEFT JOIN PROD_EDW.ENT.DATE_DIM D\n                                 ON D.DATE = HPA.PERIOD_CONTROL_DATE\n                       LEFT JOIN PROD_DATALAKE.UKG.FTE_TITLES T\n                                 ON HPA.JOB_TITLE = T.TITLE\n              /*WHERE HPA.PERIOD_CONTROL_DATE >= '2025-01-05'\n                AND HPA.PERIOD_CONTROL_DATE <= '2025-06-29'*/),\n\t\t\t\t\n\t BASE AS (\n\t\tSELECT \n\t\t\t-- HPA FIELDS\n\t\t\tCOMPANY_CODE, EMPLOYEE_STATUS_CODE, EMPLOYEE_NUMBER, JOB_CODE, JOB_TITLE, PAY_DATE, TOTAL_HOURS, ACCOUNTING_UNIT, ACCOUNT_UNIT_NAME_NUMBER, ALLOCATION_PERCENTAGE, PERIOD_CONTROL_DATE, DL_CREATED_DATE, DL_CREATED_BY, DL_JOBID,\n\t\t\t-- CTE FIEDS\n\t\t\tNEW_ACCOUNTING_UNIT, NORM_POST_WEEK, MAPPING, PERIOD_START_DATE, PERIOD_END_DATE, PERIOD_WEEK, FISCAL_YEAR, FISCAL_PERIOD\n\t\tFROM BASE_CONTINUED\n\t\tUNION ALL \n\t\tSELECT \n\t\t\t-- HPA FIELDS\n\t\t\tCOMPANY_CODE, EMPLOYEE_STATUS_CODE, EMPLOYEE_NUMBER, JOB_CODE, JOB_TITLE, PAY_DATE, TOTAL_HOURS, ACCOUNTING_UNIT, ACCOUNT_UNIT_NAME_NUMBER, ALLOCATION_PERCENTAGE, PERIOD_CONTROL_DATE, DL_CREATED_DATE, DL_CREATED_BY, DL_JOBID,\n\t\t\t-- CTE FIEDS\n\t\t\tNEW_ACCOUNTING_UNIT, NORM_POST_WEEK, MAPPING, PERIOD_START_DATE, PERIOD_END_DATE, PERIOD_WEEK, FISCAL_YEAR, FISCAL_PERIOD\n\t\tFROM BASE_REGULAR\n\t ),\n\n     ESMI_ALL AS (SELECT B.NEW_ACCOUNTING_UNIT            AS NEW_ACCOUNTING_UNIT,\n                         B.PERIOD_START_DATE              AS PERIOD_START_DATE,\n                         B.PERIOD_END_DATE                AS PERIOD_END_DATE,\n                         B.PERIOD_WEEK                    AS PERIOD_WEEK,\n                         B.FISCAL_YEAR                    AS FISCAL_YEAR,\n                         B.FISCAL_PERIOD                  AS FISCAL_PERIOD,\n                         B.NORM_POST_WEEK                 AS NORM_POST_WEEK,\n                         B.EMPLOYEE_NUMBER                AS EMPLOYEE_NUMBER,\n                         'STAFF'                          AS CATEGORY,\n                         B.JOB_TITLE                      AS JOB_TITLE,\n                         B.MAPPING                        AS MAPPING,\n                         SUM(B.ALLOCATION_PERCENTAGE)     AS ALLOCATION_PERCENTAGE,\n                         SUM(B.ALLOCATION_PERCENTAGE) * 1 AS FTE_COUNT\n                  FROM BASE B\n                  WHERE B.COMPANY_CODE IN ('ESMI', 'DECCA') --ADDED DECCA HERE\n                  GROUP BY B.NEW_ACCOUNTING_UNIT,\n                           B.PERIOD_START_DATE,\n                           B.PERIOD_END_DATE,\n                           B.PERIOD_WEEK,\n                           B.FISCAL_YEAR,\n                           B.FISCAL_PERIOD,\n                           B.NORM_POST_WEEK,\n                           B.EMPLOYEE_NUMBER,\n                           B.JOB_TITLE,\n                           B.MAPPING),\n\n     EBDAL AS (SELECT B.EMPLOYEE_NUMBER                                               AS EMPLOYEE_NUMBER,\n                      B.JOB_CODE                                                      AS JOB_CODE,\n                      B.NEW_ACCOUNTING_UNIT                                           AS NEW_ACCOUNTING_UNIT,\n                      B.NORM_POST_WEEK                                                AS NORM_POST_WEEK,\n                      B.JOB_TITLE                                                     AS JOB_TITLE,\n                      B.MAPPING                                                       AS MAPPING,\n                      B.PERIOD_START_DATE                                             AS PERIOD_START_DATE,\n                      B.PERIOD_END_DATE                                               AS PERIOD_END_DATE,\n                      B.PERIOD_WEEK                                                   AS PERIOD_WEEK,\n                      B.FISCAL_YEAR                                                   AS FISCAL_YEAR,\n                      B.FISCAL_PERIOD                                                 AS FISCAL_PERIOD,\n                      ROUND(B.ALLOCATION_PERCENTAGE * (B.NEW_TOTAL_HOURS / 80.00), 2) AS FTE_COUNT\n               FROM (SELECT T.*,\n                            CASE\n                                WHEN T.TOTAL_HOURS > 80 THEN 80.00\n                                ELSE ROUND(T.TOTAL_HOURS, 2) END AS NEW_TOTAL_HOURS\n                     FROM BASE T\n                     WHERE T.COMPANY_CODE IN ('EBDAL')) B),\n\n     EBDAL_ALL AS (SELECT E.NORM_POST_WEEK      AS NORM_POST_WEEK,\n                          E.PERIOD_START_DATE   AS PERIOD_START_DATE,\n                          E.PERIOD_END_DATE     AS PERIOD_END_DATE,\n                          E.PERIOD_WEEK         AS PERIOD_WEEK,\n                          E.FISCAL_YEAR         AS FISCAL_YEAR,\n                          E.FISCAL_PERIOD       AS FISCAL_PERIOD,\n                          E.NEW_ACCOUNTING_UNIT AS NEW_ACCOUNTING_UNIT,\n                          E.EMPLOYEE_NUMBER     AS EMPLOYEE_NUMBER,\n                          'IN-HOUSE'            AS CATEGORY,\n                          E.JOB_TITLE           AS JOB_TITLE,\n                          E.MAPPING             AS MAPPING,\n                          SUM(E.FTE_COUNT)      AS FTE_COUNT\n                   FROM EBDAL E\n                   GROUP BY E.NORM_POST_WEEK,\n                            E.PERIOD_START_DATE,\n                            E.PERIOD_END_DATE,\n                            E.PERIOD_WEEK,\n                            E.FISCAL_YEAR,\n                            E.FISCAL_PERIOD,\n                            E.NEW_ACCOUNTING_UNIT,\n                            E.EMPLOYEE_NUMBER,\n                            E.JOB_TITLE,\n                            E.MAPPING),\n\n     FINAL AS (SELECT ESA.NORM_POST_WEEK,\n                      ESA.PERIOD_START_DATE,\n                      ESA.PERIOD_END_DATE,\n                      ESA.PERIOD_WEEK,\n                      ESA.FISCAL_YEAR,\n                      ESA.FISCAL_PERIOD,\n                      ESA.NEW_ACCOUNTING_UNIT,\n                      ESA.FTE_COUNT,\n                      ESA.CATEGORY,\n                      ESA.EMPLOYEE_NUMBER,\n                      ESA.JOB_TITLE,\n                      ESA.MAPPING\n               FROM ESMI_ALL ESA\n               UNION ALL\n               SELECT EBA.NORM_POST_WEEK,\n                      EBA.PERIOD_START_DATE,\n                      EBA.PERIOD_END_DATE,\n                      EBA.PERIOD_WEEK,\n                      EBA.FISCAL_YEAR,\n                      EBA.FISCAL_PERIOD,\n                      EBA.NEW_ACCOUNTING_UNIT,\n                      EBA.FTE_COUNT,\n                      EBA.CATEGORY,\n                      EBA.EMPLOYEE_NUMBER,\n                      EBA.JOB_TITLE,\n                      EBA.MAPPING\n               FROM EBDAL_ALL EBA)\n\n-- Requested Output --\nSELECT TO_CHAR(F.PERIOD_START_DATE, 'MM/DD/YYYY')                               AS PERIOD_START_DATE,\n       TO_CHAR(F.PERIOD_END_DATE, 'MM/DD/YYYY')                                 AS PERIOD_END_DATE,\n       F.PERIOD_WEEK                                     \t\t\t\t\t\tAS PERIOD_WEEK,\n\t   SUM(F.FTE_COUNT)                           \t\t\t\t\t\t\t\tAS AMOUNT,\n       REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(UPPER(F.CATEGORY || '_' || IFNULL(F.MAPPING, 'OTHER')),' ','_'),'/','_')\n\t\t\t,'IN-HOUSE', 'AIB'), 'MANAGER','MGR')\n\t\t\t,'PRODUCTION','PROD'),'OPERATIONS','OPS') \t\t\t\t\t\t\tAS STAT_ACCOUNT_CODE,\n       F.NEW_ACCOUNTING_UNIT                             \t\t\t\t\t\tAS ACCT_UNIT,\n       'UKG'                                        \t\t\t\t\t\t\tAS SUBVERSION,\n       NULL                                         \t\t\t\t\t\t\tAS OPS_CHANNEL,\n       NULL                                         \t\t\t\t\t\t\tAS CUSTOMER,\n       F.FISCAL_YEAR                     \t         \t\t\t\t\t\t\tAS FISCAL_YEAR,\n       F.FISCAL_PERIOD                     \t\t       \t\t\t\t\t\t\tAS ACCT_PERIOD\nFROM FINAL AS F\nWHERE F.FTE_COUNT > 0\nAND PERIOD_END_DATE > TO_DATE('${STATS_ACTUALS_FY_DATE}')\nAND PERIOD_END_DATE <= TO_DATE('${STATS_ACTUALS_LS_DATE}')\n---------------- DATE FILTERS -------------------\n-- DATE FILTERS CAN BE APPLIED OVER:\n-- PERIOD_START_DATE ('MM/DD/YYYY'), \n-- PERIOD_END_DATE ('MM/DD/YYYY')\n-- PERIOD_WEEK (YYYYWW), \n-- FISCAL_YEAR (YYYY)\n-- ACCT_PERIOD ('00') \n------------------- EXAMPLE: --------------------\n-- WHERE F.FTE_COUNT > 0 (KEEP THIS CONDITION)\n-- AND FISCAL_YEAR >= 2025 AND PERIOD_WEEK = 202532 AND ACCT_PERIOD = '08'\n-------------------------------------------------\nGROUP BY F.PERIOD_START_DATE, F.PERIOD_END_DATE, F.PERIOD_WEEK, F.NEW_ACCOUNTING_UNIT, F.FISCAL_YEAR, F.FISCAL_PERIOD, STAT_ACCOUNT_CODE\n\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341773":{"id":6341773,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":576,"y":272,"width":32,"height":32,"inputConnectorIDs":[6341778],"outputConnectorIDs":[6341775],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Calc Job Variables"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"'${run_history_id}'"},"2":{"slot":2,"type":"STRING","value":"run_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"CURRENT_TIMESTAMP()"},"2":{"slot":2,"type":"STRING","value":"run_timestamp"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"current_user()"},"2":{"slot":2,"type":"STRING","value":"run_user"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6341774":{"id":6341774,"sourceID":6341771,"targetID":6341769},"6341775":{"id":6341775,"sourceID":6341773,"targetID":6341768},"6341776":{"id":6341776,"sourceID":6341772,"targetID":6341769},"6341777":{"id":6341777,"sourceID":6341770,"targetID":6341769},"6341778":{"id":6341778,"sourceID":6341769,"targetID":6341773}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"jb_STATS_ACTUALS_load_Week","description":"","type":"TRANSFORMATION","tag":"255f0836-80fe-417e-bf82-091de76a80d5"}}