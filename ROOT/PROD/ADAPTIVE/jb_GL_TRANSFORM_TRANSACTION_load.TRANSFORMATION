{"job":{"components":{"6341786":{"id":6341786,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":432,"y":272,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6341789],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL Logic"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH\n/* -----------------------------------------\n   For each fiscal period pick the LAST fiscal week\n   (highest FISCAL_POSITION_OF_WEEK_IN_PERIOD; tie-break by newest Sunday)\n   ----------------------------------------- */\nlast_week_per_period AS (\n  SELECT\n    d.FISCAL_YEAR,\n    d.FISCAL_PERIOD,\n    d.FISCAL_YEAR_WEEK      AS fyw_final,\n    d.SUNNORM_POSTING_DATE  AS week_end_final\n  FROM PROD_EDW.ENT.DATE_DIM d\n  QUALIFY ROW_NUMBER() OVER (\n    PARTITION BY d.FISCAL_YEAR, d.FISCAL_PERIOD\n    ORDER BY d.FISCAL_POSITION_OF_WEEK_IN_PERIOD DESC,\n             d.SUNNORM_POSTING_DATE DESC\n  ) = 1\n),\n\n/* -----------------------------------------\n   GL base + natural week from Posting_Date\n   ----------------------------------------- */\ngl_with_natural_week AS (\n  SELECT\n    gl.*,\n    dd.FISCAL_YEAR           AS dd_fy,\n    dd.FISCAL_PERIOD         AS dd_fp,\n    dd.FISCAL_YEAR_WEEK      AS fyw_natural,\n    dd.SUNNORM_POSTING_DATE  AS week_end_natural\n  FROM PROD_DATALAKE.LAWPROD.GLTRANS gl\n  LEFT JOIN PROD_EDW.ENT.DATE_DIM dd\n    ON dd.\"DATE\" = gl.POSTING_DATE\n  WHERE gl.STATUS = 9\n    --  AND gl.FISCAL_YEAR >= 2024\n    AND gl.ACCT_PERIOD <= 12\n),\n\n/* -----------------------------------------\n   Decide which week to DISPLAY:\n   - If the natural week belongs to the posting month (GL FY/Period), keep it\n   - Otherwise, use the LAST week of that posting month (from last_week_per_period)\n   ----------------------------------------- */\ngl_week_decided AS (\n  SELECT\n    g.*,\n    CASE\n      WHEN g.dd_fy = g.Fiscal_Year AND g.dd_fp = g.Acct_Period\n        THEN g.fyw_natural\n      ELSE l.fyw_final\n    END AS fiscal_year_week_display,\n    CASE\n      WHEN g.dd_fy = g.Fiscal_Year AND g.dd_fp = g.Acct_Period\n        THEN g.week_end_natural\n      ELSE l.week_end_final\n    END AS week_end_display\n  FROM gl_with_natural_week g\n  LEFT JOIN last_week_per_period l\n    ON l.FISCAL_YEAR  = g.Fiscal_Year\n   AND l.FISCAL_PERIOD = g.Acct_Period\n),\n\n/* -----------------------------------------\n   Customer name stabilization:\n   - If only one SEARCH_NAME per CUSTOMER -> keep it\n   - If multiple SEARCH_NAMEs, prefer COMPANY = 1 row\n   ----------------------------------------- */\nCUST AS (\n  SELECT CUSTOMER, SEARCH_NAME\n  FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n  WHERE CUSTOMER IN (\n    SELECT CUSTOMER\n    FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n    GROUP BY CUSTOMER\n    HAVING COUNT(DISTINCT SEARCH_NAME) = 1\n  )\n  UNION ALL\n  SELECT CUSTOMER, SEARCH_NAME\n  FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n  WHERE COMPANY = 1\n    AND CUSTOMER IN (\n      SELECT CUSTOMER\n      FROM PROD_DATALAKE.LAWPROD.ARCUSTOMER\n      GROUP BY CUSTOMER\n      HAVING COUNT(DISTINCT SEARCH_NAME) > 1\n    )\n),\n\n/* -----------------------------------------\n   Ops Channel side + SFDC account info (possible PAYLCITY_CC1 twin)\n   Mirrors your UNION’s first branch.\n   ----------------------------------------- */\nGTM_OPS AS (\n  SELECT\n      GTM.OBJ_ID        AS OPS_OBJ_ID,\n      GTM.MATRIX_CAT    AS OPS_MATRIX_CAT,\n      GTM.MX_VALUE      AS OPS_MX_VALUE,\n      GTMM.OBJ_ID       AS PAY_OBJ_ID,\n      GTMM.MATRIX_CAT   AS PAY_MATRIX_CAT,\n      GTMM.MX_VALUE     AS PAY_MX_VALUE,\n      SA.ACCOUNTNUMBER  AS ACCOUNTNUMBER,\n      SA.NAME           AS NAME\n  FROM PROD_DATALAKE.LAWPROD.GTMXVALUE GTM\n  LEFT JOIN PROD_DATALAKE.LAWPROD.GTMXVALUE GTMM\n         ON GTM.OBJ_ID = GTMM.OBJ_ID\n        AND GTMM.MATRIX_CAT = 'PAYLCITY_CC1'\n  LEFT JOIN PROD_DATALAKE.SALESFORCE.ACCOUNT SA\n         ON (\n               TRIM(LEGACY_ID__C)         = TRIM(SUBSTR(GTMM.MX_VALUE, 7, 4))\n            OR LPAD(LEGACY_ID__C, 4, '0') = TRIM(SUBSTR(GTMM.MX_VALUE, 7, 4))\n            )\n        AND LOWER(SA.BRAND__C) = 'bluecrew'\n  WHERE GTM.MATRIX_CAT = 'OPS_CHANNEL'\n), \n\n/* -----------------------------------------\n   Paylocity-only rows (no OPS_CHANNEL twin) + SFDC\n   Mirrors your UNION’s second branch.\n   ----------------------------------------- */\nPAYLO_ONLY AS (\n  SELECT DISTINCT\n      GTMM.OBJ_ID       AS PAY_OBJ_ID,\n      GTMM.MATRIX_CAT   AS PAY_MATRIX_CAT,\n      GTMM.MX_VALUE     AS PAY_MX_VALUE,\n      SA.ACCOUNTNUMBER  AS ACCOUNTNUMBER,\n      SA.NAME           AS NAME\n  FROM PROD_DATALAKE.LAWPROD.GTMXVALUE GTMM\n  LEFT JOIN PROD_DATALAKE.SALESFORCE.ACCOUNT SA\n         ON (\n               TRIM(LEGACY_ID__C)         = TRIM(SUBSTR(GTMM.MX_VALUE, 7, 4))\n            OR LPAD(LEGACY_ID__C, 4, '0') = TRIM(SUBSTR(GTMM.MX_VALUE, 7, 4))\n            )\n        AND LOWER(SA.BRAND__C) = 'bluecrew'\n  WHERE GTMM.MATRIX_CAT = 'PAYLCITY_CC1'\n    AND GTMM.OBJ_ID NOT IN (\n          SELECT DISTINCT OBJ_ID\n          FROM PROD_DATALAKE.LAWPROD.GTMXVALUE\n          WHERE MATRIX_CAT = 'OPS_CHANNEL'\n        )\n),\n\n/* -----------------------------------------\n   AR Distribution + SFDC enrichment (fallback customer)\n   ----------------------------------------- */\nARD AS (\n      SELECT DISTINCT\n          ARD.GLT_OBJ_ID,\n          ARD.CUSTOMER,\n          TO_VARCHAR(SA.ACCOUNTNUMBER)                 AS CRM_CUSTOMER,\n          COALESCE(TO_VARCHAR(SA.NAME), AR.SEARCH_NAME) AS CUSTOMER_NAME\n      FROM PROD_DATALAKE.LAWPROD.ARDISTRIB ARD\n      LEFT JOIN PROD_DATALAKE.SALESFORCE.ACCOUNT SA\n             ON TRIM(TRY_TO_NUMBER(SA.ACCOUNTNUMBER)) = TRIM(TRY_TO_NUMBER(ARD.CUSTOMER))\n      LEFT JOIN PROD_DATALAKE.LAWPROD.ARCUSTOMER AR\n             ON TRIM(AR.CUSTOMER) = TRIM(TRY_TO_NUMBER(ARD.CUSTOMER))\n),\n\nVENDOR1 AS (\n  SELECT\n    TRIM(AVM.VENDOR)       AS VENDOR_CODE,\n    TRIM(AVM.VENDOR_VNAME) AS VENDOR_NAME\n  \n  FROM PROD_DATALAKE.LAWPROD.APVENMAST AVM\n  INNER JOIN PROD_DATALAKE.LAWPROD.APINVOICE APP\n    ON AVM.VENDOR_GROUP = APP.VENDOR_GROUP \n   AND AVM.VENDOR       = APP.VENDOR\n  WHERE \n  APP.INVOICE_DTE >= '2024-01-01'\n  \n  QUALIFY ROW_NUMBER() OVER (\n    PARTITION BY AVM.VENDOR_GROUP, AVM.VENDOR\n    ORDER BY APP.INVOICE_DTE DESC\n  ) = 1\n),\nVENDOR2 AS (\nSELECT \n    OBJ_ID,\n    CASE \n        WHEN TRY_TO_NUMBER(MX_VALUE) IS NULL THEN NULL \n        ELSE MX_VALUE \n    END AS MX_VALUE\nFROM PROD_DATALAKE.LAWPROD.GTMXVALUE\nWHERE MATRIX_CAT = 'VENDOR_ID'\n)\n\n/* Final SELECT (transaction-level; NO aggregation) */\nSELECT\n\n  DATEADD(DAY, -6, g.week_end_display)                 AS PERIOD_START_DATE,\n  g.week_end_display                                   AS PERIOD_END_DATE,\n  g.fiscal_year_week_display                           AS PERIOD_WEEK,\n  g.TRAN_AMOUNT                                        AS AMOUNT,\n  g.CURRENCY_CODE                                      AS CURRENCY,\n  g.ACCOUNT                                            AS GL_ACCOUNT_CODE,\n  g.ACCT_UNIT                                          AS ACCT_UNIT,\n  'Lawson'                                             AS SUBVERSION,\n  g.COMPANY                                            AS COMPANY,\n   CASE \n        WHEN g.Account  >= 4000 THEN COALESCE(VEN1.VENDOR_CODE, VEN2.MX_VALUE)\n        ELSE NULL\n    END AS VENDOR,\n\n    CASE\n    WHEN g.Account >= 4000 and g.Account  <= 5999\n         AND act.Level_Detail_02 IS NULL\n         AND ROUND(GTM.ACCOUNTNUMBER, 0) IS NULL\n         AND TRY_TO_NUMBER(ARD.CUSTOMER) IS NULL\n      THEN ROUND(PAY.ACCOUNTNUMBER, 0)           -- 4) Paylocity only\n    WHEN g.Account >= 4000 and g.Account  <= 5999\n         AND act.Level_Detail_02 IS NULL\n         AND ROUND(GTM.ACCOUNTNUMBER, 0) IS NULL\n      THEN TRY_TO_NUMBER(ARD.CUSTOMER)           -- 3) ARD\n    WHEN g.Account >= 4000 and g.Account  <= 5999\n         AND act.Level_Detail_02 IS NULL\n      THEN ROUND(GTM.ACCOUNTNUMBER, 0)              -- 2) OpsChannel\n    WHEN g.Account >= 4000 and g.Account  <= 5999\n         AND act.Level_Detail_02 IS NOT NULL\n      THEN act.Level_Detail_02                           -- 1) ACActivity\n    ELSE NULL\n  END AS Customer,\n\n\n  g.POSTING_DATE                                       AS TRANSACTION_DATE,\n  g.REFERENCE                                          AS REFERENCE,\n  g.DESCRIPTION                                        AS DESCRIPTION,\n  g.SUB_ACCOUNT                                        AS SUBLEDGER_SOURCE_CODE,\n  g.OBJ_ID                                             AS SRC_OBJ_ID,\n  g.STATUS                                             AS STATUS,\n  g.FISCAL_YEAR                                        AS FISCAL_YEAR,\n  g.ACCT_PERIOD                                        AS ACCT_PERIOD,\n  g.ORIG_PROGRAM                                       AS ORIG_PROGRAM,\n  g.JE_TYPE                                            AS JE_TYPE\n\n\n\nFROM gl_week_decided g\nLEFT JOIN PROD_DATALAKE.LAWPROD.ACACTIVITY act\n       ON g.Activity = act.Activity\nLEFT JOIN GTM_OPS GTM\n       ON g.OBJ_ID = GTM.OPS_OBJ_ID\nLEFT JOIN CUST C\n       ON C.CUSTOMER = act.Level_Detail_02\n LEFT JOIN  VENDOR1      AS VEN1\n       ON TRY_TO_NUMBER(VEN1.VENDOR_CODE) = TRY_TO_NUMBER(LEFT(g.DESCRIPTION, 9))\n       AND g.SYSTEM  = 'AP'\nLEFT JOIN VENDOR2 AS VEN2\n       ON  VEN2.OBJ_ID = g.OBJ_ID\nLEFT JOIN ARD\n       ON ARD.GLT_OBJ_ID = g.OBJ_ID\nLEFT JOIN PAYLO_ONLY PAY\n       ON PAY.PAY_OBJ_ID = g.OBJ_ID\nWHERE g.FISCAL_YEAR >= YEAR(TO_DATE('${GL_TRANSFORM_TRANS_FY_DATE}'))"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341787":{"id":6341787,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":576,"y":272,"width":32,"height":32,"inputConnectorIDs":[6341789],"outputConnectorIDs":[6341790],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Calc Job Variables"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"'${run_history_id}'"},"2":{"slot":2,"type":"STRING","value":"run_id"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"CURRENT_TIMESTAMP()"},"2":{"slot":2,"type":"STRING","value":"run_timestamp"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"current_user()"},"2":{"slot":2,"type":"STRING","value":"run_user"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6341788":{"id":6341788,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":720,"y":272,"width":32,"height":32,"inputConnectorIDs":[6341790],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"GL_TRANSFORM_TRANSACTION"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"GL_TRANSFORM_TRANSACTION"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"PERIOD_START_DATE"},"2":{"slot":2,"type":"STRING","value":"PERIOD_START_DATE"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"PERIOD_END_DATE"},"2":{"slot":2,"type":"STRING","value":"PERIOD_END_DATE"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"PERIOD_WEEK"},"2":{"slot":2,"type":"STRING","value":"PERIOD_WEEK"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"AMOUNT"},"2":{"slot":2,"type":"STRING","value":"AMOUNT"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"CURRENCY"},"2":{"slot":2,"type":"STRING","value":"CURRENCY"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"GL_ACCOUNT_CODE"},"2":{"slot":2,"type":"STRING","value":"GL_ACCOUNT_CODE"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"ACCT_UNIT"},"2":{"slot":2,"type":"STRING","value":"ACCT_UNIT"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"SUBVERSION"},"2":{"slot":2,"type":"STRING","value":"SUBVERSION"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"COMPANY"},"2":{"slot":2,"type":"STRING","value":"COMPANY"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"VENDOR"},"2":{"slot":2,"type":"STRING","value":"VENDOR"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"CUSTOMER"},"2":{"slot":2,"type":"STRING","value":"CUSTOMER"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"TRANSACTION_DATE"},"2":{"slot":2,"type":"STRING","value":"TRANSACTION_DATE"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"REFERENCE"},"2":{"slot":2,"type":"STRING","value":"REFERENCE"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"DESCRIPTION"},"2":{"slot":2,"type":"STRING","value":"DESCRIPTION"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"SUBLEDGER_SOURCE_CODE"},"2":{"slot":2,"type":"STRING","value":"SUBLEDGER_SOURCE_CODE"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"SRC_OBJ_ID"},"2":{"slot":2,"type":"STRING","value":"SRC_OBJ_ID"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"STATUS"},"2":{"slot":2,"type":"STRING","value":"STATUS"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"FISCAL_YEAR"},"2":{"slot":2,"type":"STRING","value":"FISCAL_YEAR"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"ACCT_PERIOD"},"2":{"slot":2,"type":"STRING","value":"ACCT_PERIOD"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"ORIG_PROGRAM"},"2":{"slot":2,"type":"STRING","value":"ORIG_PROGRAM"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"JE_TYPE"},"2":{"slot":2,"type":"STRING","value":"JE_TYPE"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"run_timestamp"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_DATE"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"run_user"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_BY"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"run_id"},"2":{"slot":2,"type":"STRING","value":"DL_JOBID"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Append"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SCH_ADAPTIVE}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${DB_Enterprise}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6341789":{"id":6341789,"sourceID":6341786,"targetID":6341787},"6341790":{"id":6341790,"sourceID":6341787,"targetID":6341788}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"jb_GL_TRANSFORM_TRANSACTION_load","description":"","type":"TRANSFORMATION","tag":"43c04164-f174-46bb-a7df-a2731c29b1e8"}}