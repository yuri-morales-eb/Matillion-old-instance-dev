{"job":{"components":{"6340651":{"id":6340651,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":704,"y":-112,"width":32,"height":32,"inputConnectorIDs":[6340663],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6340664],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Failure"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_End"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"FAILURE"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340652":{"id":6340652,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":704,"y":0,"width":32,"height":32,"inputConnectorIDs":[6340659],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6340665],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Success"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_End"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"SUCCESS"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340653":{"id":6340653,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1896325668,"x":-96,"y":0,"width":32,"height":32,"inputConnectorIDs":[6340662],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6340661],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit Begin"}}}},"visible":true},"2":{"slot":2,"name":"Transformation Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"_Audit_Datalake_Public_Begin"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"audit_job_name"},"2":{"slot":2,"type":"STRING","value":"${job_name}"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"audit_status"},"2":{"slot":2,"type":"STRING","value":"RUNNING"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340654":{"id":6340654,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":304,"y":-112,"width":32,"height":32,"inputConnectorIDs":[6340666,6340667,6340668,6340669],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6340663],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340655":{"id":6340655,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":224,"y":0,"width":32,"height":32,"inputConnectorIDs":[6340660],"outputSuccessConnectorIDs":[6340657],"outputFailureConnectorIDs":[6340666],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Create TempTable for RPT_WORKERS_COMP"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CREATE TEMPORARY TABLE ${SNFLENTDB}.${Sch_Payroll}.RPT_WORKERS_COMP_TEMP AS\nWITH\n    -- This CTE filter only rows needed from TRANSACTION_DETAIL_FACT\n    CTE_TRANSACTION_DETAIL_FACT AS (\n        SELECT\n            TRANSACTION_DETAIL_FACT_KEY,\n            BILL_PAY_WAGE_CODE_KEY,\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            BILLABLE_AMOUNT\n        FROM ${SNFLEDWDB}.${Sch_Enterprise}.TRANSACTION_DETAIL_FACT\n        WHERE POSTING_DATE >= DATE_FROM_PARTS(YEAR(CURRENT_DATE) - 1, 1, 1)\n          AND DW_ACTIVE_FLAG = 'Y'\n          AND DW_DATA_SOURCE_KEY = 3\n    ),\n    -- This CTE filter only rows needed from BILL_PAY_WAGE_CODE_DIM\n    CTE_BILL_PAY_WAGE_CODE_DIM AS (\n        SELECT\n            BILL_PAY_WAGE_CODE_KEY,\n            WAGE_CODE\n        FROM ${SNFLEDWDB}.${Sch_Enterprise}.BILL_PAY_WAGE_CODE_DIM\n        WHERE DW_ACTIVE_FLAG = 'Y'\n          AND DW_DATA_SOURCE_KEY = 3\n    ),\n    -- This CTE returned only pre-taxes required on this process.\n    CTE_PRE_TAXES AS (\n        SELECT\n            PD.PER_END_DATE,\n            PD.REPORT_ENTITY AS ENTITY,\n            PD.PROCESS_LEVEL AS BRANCH,\n            PD.CHECK_ID,\n            PD.CHECK_DATE,\n            PD.EMPLOYEE,\n            PD.WORK_STATE AS WORK_STATE,\n            PD.WAGE_AMOUNT AS GROSS_WAGES,\n            PD.DED_AMT,\n            PD.DED_CODE,\n            DC.TAX_STATUS\n        FROM ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PAYDEDUCTN AS PD\n        INNER JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.DEDCODE AS DC\n            ON DC.TAX_STATUS BETWEEN '06' AND '11' AND DC.DED_CODE = PD.DED_CODE\n        WHERE PER_END_DATE >= DATE_FROM_PARTS(YEAR(CURRENT_DATE) - 1, 1, 1)\n    ),\n    -- Next CTEs calculates the values for REGULAR, OVERTIME, DOUBLE TIME, SEVERANCE, BONUS, VACATION, SICK AND HOLIDAY amount\n\tCTE_REGULAR AS (\n        SELECT DISTINCT\n            F.POSTING_DATE,\n            F.EMPLOYEE_NUMBER,\n            F.ACTIVITY,\n            SUM(F.TRAN_AMOUNT) AS TRAN_AMOUNT\n        FROM CTE_BILL_PAY_WAGE_CODE_DIM AS B\n        INNER JOIN CTE_TRANSACTION_DETAIL_FACT AS F\n            ON B.BILL_PAY_WAGE_CODE_KEY = F.BILL_PAY_WAGE_CODE_KEY\n        WHERE B.WAGE_CODE IN\n              ('51A1','51A2','51A3','51A4','51A5','51AV','51BC','51BH','51BN','51BR','51C','51CA','51CN','51CP','51CS','51CT','51CV','51DA','51DH','51DL','51DN','51DP','51DR','51EL','51F','51FC','51FP','51FR','51FS',\n\t\t\t  '51GT','51H','51H1','51H2','51HL','51HS','51IP','51JD','51KR','51LA','51LD','51LO','51LT','51M1','51M2','51M3','51MH','51MP','51MS','51MW','51NY','51OM','51OP','51P','51PC','51PD','51PH','51PL','51PP',\n\t\t\t  '51PR','51PT','51PU','51PW','51R','51RB','51RM','51RO','51RR','51RW','51S','51SA','51SB','51SD','51SE','51SH','51SI','51SP','51SR','51ST','51SU','51SW','51T3','51TC','51TI','51TM','51TP','51TR','51TT',\n\t\t\t  '51U','51V','51VC','51YF','551R','552H','55SP','59D2','59PF','612A','612H','612J','612M','612R','612V','CDR','DTR1','DTR2','DTR3','DTR4','DTR5','DTR6','DTR7','GARR','REF','SBRV','SBSO','SCAR','SETT',\n\t\t\t  'SGTL','SHOL','SHR','SJUR','SMIL','SNMA','SNOD','SNOQ','SPR9','SPTO','SPTP','SWGL','UNPD','SBEN')\n        GROUP BY F.POSTING_DATE,\n                 F.EMPLOYEE_NUMBER,\n                 F.ACTIVITY\n    ),\n    CTE_OVERTIME AS (\n        SELECT DISTINCT\n            F.POSTING_DATE,\n            F.EMPLOYEE_NUMBER,\n            F.ACTIVITY,\n            SUM(F.TRAN_AMOUNT) AS TRAN_AMOUNT\n        FROM CTE_BILL_PAY_WAGE_CODE_DIM AS B\n        INNER JOIN CTE_TRANSACTION_DETAIL_FACT AS F\n            ON B.BILL_PAY_WAGE_CODE_KEY = F.BILL_PAY_WAGE_CODE_KEY\n        WHERE B.WAGE_CODE IN\n              ('51CO', '51EO', '51EW', '51FO', '51KO', '51MO', '51O', '51OA', '51OI', '51OO', '51OS', '51PO',\n               '51TO', '51VO', '51WO', '612O', 'DTO1', 'DTO2', 'DTO3', 'DTO4', 'DTO5', 'DTO6', 'DTO7', '51BO',\n               'CDO', 'SOVT')\n        GROUP BY F.POSTING_DATE,\n                 F.EMPLOYEE_NUMBER,\n                 F.ACTIVITY\n    ),\n    CTE_DOUBLE_TIME AS (\n        SELECT DISTINCT\n            F.POSTING_DATE,\n            F.EMPLOYEE_NUMBER,\n            F.ACTIVITY,\n             SUM(F.TRAN_AMOUNT) AS TRAN_AMOUNT\n        FROM CTE_BILL_PAY_WAGE_CODE_DIM AS B\n        INNER JOIN CTE_TRANSACTION_DETAIL_FACT AS F\n            ON B.BILL_PAY_WAGE_CODE_KEY = F.BILL_PAY_WAGE_CODE_KEY\n        WHERE B.WAGE_CODE IN\n              ('51BD','51CD','51DS','51ED','51FD','51KD','51MD','51OD','51TD','51VD','51WD','51ZD','612D',\n               'DTD1','DTD2','DTD3','DTD4','DTD5','DTD6','DTD7','51DI','51DT','CDD')\n        GROUP BY F.POSTING_DATE,\n                 F.EMPLOYEE_NUMBER,\n                 F.ACTIVITY\n    ),\n    CTE_SEVERENCE_PAY AS (\n        SELECT DISTINCT\n            F.POSTING_DATE,\n            F.EMPLOYEE_NUMBER,\n            F.ACTIVITY,\n             SUM(F.TRAN_AMOUNT) AS TRAN_AMOUNT\n        FROM CTE_BILL_PAY_WAGE_CODE_DIM AS B\n        INNER JOIN CTE_TRANSACTION_DETAIL_FACT AS F\n            ON B.BILL_PAY_WAGE_CODE_KEY = F.BILL_PAY_WAGE_CODE_KEY\n        WHERE B.WAGE_CODE IN ('51SV','612S')\n        GROUP BY F.POSTING_DATE,\n                 F.EMPLOYEE_NUMBER,\n                 F.ACTIVITY\n    ),\n    CTE_BONUSES AS (\n        SELECT DISTINCT\n            F.POSTING_DATE,\n            F.EMPLOYEE_NUMBER,\n            F.ACTIVITY,\n             SUM(F.TRAN_AMOUNT) AS TRAN_AMOUNT\n        FROM CTE_BILL_PAY_WAGE_CODE_DIM AS B\n        INNER JOIN CTE_TRANSACTION_DETAIL_FACT AS F\n            ON B.BILL_PAY_WAGE_CODE_KEY = F.BILL_PAY_WAGE_CODE_KEY\n        WHERE B.WAGE_CODE IN\n              ('51B','51FL','51GB','51RF','51RI','5515','612B','SBDH','SBGF','SBMG','SBOC','SBOP','SBOT','SBSA','SBST')\n        GROUP BY F.POSTING_DATE,\n                 F.EMPLOYEE_NUMBER,\n                 F.ACTIVITY\n    ),\n\tCTE_VACATION AS (\n        SELECT DISTINCT\n            F.POSTING_DATE,\n            F.EMPLOYEE_NUMBER,\n            F.ACTIVITY,\n             SUM(F.TRAN_AMOUNT) AS TRAN_AMOUNT\n        FROM CTE_BILL_PAY_WAGE_CODE_DIM AS B\n        INNER JOIN CTE_TRANSACTION_DETAIL_FACT AS F\n            ON B.BILL_PAY_WAGE_CODE_KEY = F.BILL_PAY_WAGE_CODE_KEY\n        WHERE B.WAGE_CODE IN\n              ('612V','51PT','SPTP','51V','SPTO')\n        GROUP BY F.POSTING_DATE,\n                 F.EMPLOYEE_NUMBER,\n                 F.ACTIVITY\n    ),\n\tCTE_SICK AS (\n        SELECT DISTINCT\n            F.POSTING_DATE,\n            F.EMPLOYEE_NUMBER,\n            F.ACTIVITY,\n             SUM(F.TRAN_AMOUNT) AS TRAN_AMOUNT\n        FROM CTE_BILL_PAY_WAGE_CODE_DIM AS B\n        INNER JOIN CTE_TRANSACTION_DETAIL_FACT AS F\n            ON B.BILL_PAY_WAGE_CODE_KEY = F.BILL_PAY_WAGE_CODE_KEY\n        WHERE B.WAGE_CODE IN\n              ('51CV','51H1','51H2','51SP','51SR','55SP','51SP')\n        GROUP BY F.POSTING_DATE,\n                 F.EMPLOYEE_NUMBER,\n                 F.ACTIVITY\n    ),\n\tCTE_HOLIDAY AS (\n        SELECT DISTINCT\n            F.POSTING_DATE,\n            F.EMPLOYEE_NUMBER,\n            F.ACTIVITY,\n             SUM(F.TRAN_AMOUNT) AS TRAN_AMOUNT\n        FROM CTE_BILL_PAY_WAGE_CODE_DIM AS B\n        INNER JOIN CTE_TRANSACTION_DETAIL_FACT AS F\n            ON B.BILL_PAY_WAGE_CODE_KEY = F.BILL_PAY_WAGE_CODE_KEY\n        WHERE B.WAGE_CODE IN\n              ('51HL','51HS','552H','612H','SHOL')\n        GROUP BY F.POSTING_DATE,\n                 F.EMPLOYEE_NUMBER,\n                 F.ACTIVITY\n    ),\n    CTE_UNION_ALL AS (\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            'REGULAR' AS CODE\n        FROM CTE_REGULAR\n\n        UNION ALL\n\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            'OVERTIME' AS CODE\n        FROM CTE_OVERTIME\n\n        UNION ALL\n\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            'DOUBLETIME' AS CODE\n        FROM CTE_DOUBLE_TIME\n\n        UNION ALL\n\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            'SEVERENCE' AS CODE\n        FROM CTE_SEVERENCE_PAY\n\n        UNION ALL\n\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            'BONUSES' AS CODE\n        FROM CTE_BONUSES\n\n        UNION ALL\n\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            'VACATION' AS CODE\n        FROM CTE_VACATION\n\n        UNION ALL\n\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            'SICK' AS CODE\n        FROM CTE_SICK\n\n        UNION ALL\n\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            TRAN_AMOUNT,\n            'HOLIDAY' AS CODE\n        FROM CTE_HOLIDAY\n    ),\n    CTE_ALL_CODES AS (\n        SELECT\n            POSTING_DATE,\n            EMPLOYEE_NUMBER,\n            ACTIVITY,\n            SUM(CASE WHEN CODE = 'REGULAR' THEN TRAN_AMOUNT ELSE 0 END) AS REGULAR_AMT,\n            SUM(CASE WHEN CODE = 'OVERTIME' THEN TRAN_AMOUNT ELSE 0 END) AS OVERTIME_AMT,\n            SUM(CASE WHEN CODE = 'DOUBLETIME' THEN TRAN_AMOUNT ELSE 0 END) AS DOUBLE_TIME_AMT,\n            SUM(CASE WHEN CODE = 'SEVERENCE' THEN TRAN_AMOUNT ELSE 0 END) AS SEVERENCE_AMT,\n            SUM(CASE WHEN CODE = 'VACATION' THEN TRAN_AMOUNT ELSE 0 END) AS VACATION_AMT,\n            SUM(CASE WHEN CODE = 'SICK' THEN TRAN_AMOUNT ELSE 0 END) AS SICK_AMT,\n            SUM(CASE WHEN CODE = 'HOLIDAY' THEN TRAN_AMOUNT ELSE 0 END) AS HOLIDAY_AMT,\n            SUM(CASE WHEN CODE = 'BONUSES' THEN TRAN_AMOUNT ELSE 0 END) AS BONUSES_AMT,\n      \t\tSUM(TRAN_AMOUNT) AS TOTAL_AMT\n        FROM CTE_UNION_ALL\n        GROUP BY POSTING_DATE, EMPLOYEE_NUMBER, ACTIVITY\n        ORDER BY POSTING_DATE, EMPLOYEE_NUMBER, ACTIVITY\n    ),\n    CTE_TRANSACTION_SUMMARY_FACT AS (\n        SELECT DISTINCT\n            POSTING_DATE\n            ,EMPLOYEE_NUMBER\n            ,ACTIVITY\n            ,CUSTOMER_NAME AS CLIENT_NAME\n            ,CUSTOMER_NUMBER AS CLIENT_NUMBER\n            ,ASSIGNMENT_NUMBER AS ASSIGNMENT\n            ,ACCOUNTING_UNIT\n            ,SUM(BILLED_HOURS_CONVERTED) AS CONVERTED_BILL_HOURS_WORKED\n        FROM ${SNFLEDWDB}.${Sch_Enterprise}.TRANSACTION_SUMMARY_FACT\n        WHERE POSTING_DATE >= DATE_FROM_PARTS(YEAR(CURRENT_DATE) - 1, 1, 1)\n          AND DW_ACTIVE_FLAG = 'Y' AND DW_DATA_SOURCE_KEY = 3\n          AND ACCOUNTING_UNIT NOT IN (11000,11001,50000,50001,51001)\n        GROUP BY POSTING_DATE\n            ,EMPLOYEE_NUMBER\n            ,ACTIVITY\n            ,CUSTOMER_NAME\n            ,CUSTOMER_NUMBER\n            ,ASSIGNMENT_NUMBER\n            ,ACCOUNTING_UNIT\n    ),\n    CTE_ALL_TRANSACTION_SUMMARY_FACT AS (\n        SELECT DISTINCT\n            TO_DATE(LAST_DAY(TR.POSTING_DATE,'WEEK')) AS WEEK_WORKED,\n            TR.POSTING_DATE\n            ,PD.ENTITY\n            ,TR.ACCOUNTING_UNIT\n            ,PD.BRANCH\n            ,PD.CHECK_ID\n            ,EE.FIRST_NAME\n            ,EE.LAST_NAME\n            ,EES.CDA_SSN\n            ,RIGHT(EES.CDA_SSN, 4) AS SSN_LAST_4\n            ,TR.EMPLOYEE_NUMBER\n            ,TR.ACTIVITY\n            ,PD.EMPLOYEE\n            ,TR.CLIENT_NAME\n            ,TR.CLIENT_NUMBER\n            ,TR.ASSIGNMENT\n            ,EE.ADDRESS_HOME_STATE AS HOME_STATE\n            ,PD.WORK_STATE\n            ,AD.JOB_TITLE\n            ,ET.WC_CODE\n            ,PD.GROSS_WAGES AS GROSS_WAGES\n            ,TR.CONVERTED_BILL_HOURS_WORKED\n            ,PD.DED_AMT\n            ,PD.DED_CODE\n        FROM CTE_TRANSACTION_SUMMARY_FACT AS TR\n        LEFT JOIN CTE_PRE_TAXES AS PD\n            ON TR.EMPLOYEE_NUMBER = PD.EMPLOYEE AND DATEADD(day, 5, TR.POSTING_DATE) = TO_DATE(PD.CHECK_DATE)\n        LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRSYSTEM AS PS\n            ON PS.PROCESS_LEVEL = PD.BRANCH\n        LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PAYMASTR AS PM\n            ON PM.PROCESS_LEVEL = PD.BRANCH AND PM.EMPLOYEE = PD.EMPLOYEE AND PM.CHECK_ID = PD.CHECK_ID AND PM.CHECK_DATE = PD.CHECK_DATE\n        LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.PRTIME AS PR\n            ON PR.EMPLOYEE = PD.EMPLOYEE AND PR.PROCESS_LEVEL = PD.BRANCH AND PR.CHECK_ID = PD.CHECK_ID\n        LEFT JOIN ${SNFLEDWDB}.${Sch_Enterprise}.ASSIGNMENT_DIM AS AD\n            ON AD.DW_ACTIVE_FLAG = 'Y' AND AD.DW_DATA_SOURCE_KEY = 1 AND AD.ASSIGNMENT_NUMBER = TR.ASSIGNMENT\n        LEFT JOIN ${SNFLEDWDB}.${Sch_Enterprise}.EMPLOYEE_PAYROLL_TIME_FACT AS ET\n            ON ET.DW_ACTIVE_FLAG = 'Y' AND ET.DW_DATA_SOURCE_KEY = 3 AND ET.EMPLOYEE_NUMBER = TR.EMPLOYEE_NUMBER AND ET.ASSIGNMENT_NUMBER = AD.ASSIGNMENT_NUMBER AND ET.CHECK_ID = PD.CHECK_ID\n        LEFT JOIN ${SNFLEDWDB}.${Sch_Enterprise}.EMPLOYEE_DIM AS EE\n            ON EE.DW_ACTIVE_FLAG = 'Y' AND EE.DW_DATA_SOURCE_KEY = 3 AND EE.EMPLOYEE_NUMBER = TR.EMPLOYEE_NUMBER\n        INNER JOIN ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_EMPLOYEEBASE AS EES\n            ON EES.CDA_EMPLOYEENUMBER = TR.EMPLOYEE_NUMBER\n        WHERE TR.POSTING_DATE >= DATE_FROM_PARTS(YEAR(CURRENT_DATE) - 1, 1, 1)\n    ),\n    CTE_JOIN_SUMMARY_AND_DETAIL AS (\n        SELECT DISTINCT\n            TR.WEEK_WORKED\n            ,TR.POSTING_DATE\n            ,TR.ENTITY\n            ,TR.ACCOUNTING_UNIT\n            ,TR.BRANCH\n            ,TR.CHECK_ID\n            ,TR.FIRST_NAME\n            ,TR.LAST_NAME\n            ,TR.CDA_SSN\n            ,TR.SSN_LAST_4\n            ,TR.EMPLOYEE_NUMBER\n            ,TR.CLIENT_NAME\n            ,TR.CLIENT_NUMBER\n            ,TR.ASSIGNMENT\n            ,TR.HOME_STATE\n            ,TR.WORK_STATE\n            ,TR.JOB_TITLE\n            ,TR.WC_CODE\n            ,COALESCE(TR.GROSS_WAGES, AC.TOTAL_AMT) AS GROSS_WAGES\n\t\t\t,AC.REGULAR_AMT\n            ,AC.OVERTIME_AMT\n            ,AC.DOUBLE_TIME_AMT\n            ,AC.SEVERENCE_AMT\n            ,AC.VACATION_AMT\n            ,AC.SICK_AMT\n            ,AC.HOLIDAY_AMT\n            ,AC.BONUSES_AMT\n            ,TR.CONVERTED_BILL_HOURS_WORKED\n            ,TR.DED_AMT\n            ,TR.DED_CODE\n        FROM CTE_ALL_TRANSACTION_SUMMARY_FACT AS TR\n        INNER JOIN CTE_ALL_CODES AS AC\n            ON AC.POSTING_DATE = TR.POSTING_DATE AND AC.EMPLOYEE_NUMBER = TR.EMPLOYEE_NUMBER AND AC.ACTIVITY = TR.ACTIVITY\n    ),\n    CTE_LAST_QUERY AS (\n        SELECT DISTINCT\n        \tWEEK_WORKED\n    \t\t,ENTITY\n            ,ACCOUNTING_UNIT\n            ,BRANCH\n            ,CHECK_ID\n            ,FIRST_NAME\n            ,LAST_NAME\n    \t\t,CDA_SSN\n            ,SSN_LAST_4\n            ,EMPLOYEE_NUMBER\n            ,CLIENT_NAME\n            ,CLIENT_NUMBER\n            ,ASSIGNMENT\n    \t\t,HOME_STATE\n    \t\t,WORK_STATE\n    \t\t,JOB_TITLE\n    \t\t,WC_CODE\n    \t\t,GROSS_WAGES\n\t\t\t,REGULAR_AMT\n    \t\t,OVERTIME_AMT\n    \t\t,DOUBLE_TIME_AMT\n    \t\t,SEVERENCE_AMT\n    \t\t,VACATION_AMT\n    \t\t,SICK_AMT\n    \t\t,HOLIDAY_AMT\n    \t\t,BONUSES_AMT\n    \t\t,CONVERTED_BILL_HOURS_WORKED\n    \t\t,DED_AMT\n    \t\t,DED_CODE\n    \tFROM CTE_JOIN_SUMMARY_AND_DETAIL\n      \tWHERE GROSS_WAGES <> 0\n    ), CTE_CLEANED_DATA AS (\n        SELECT *,\n            ROW_NUMBER() OVER (\n                PARTITION BY\n                    WEEK_WORKED\n            \t\t,ENTITY\n                    ,ACCOUNTING_UNIT\n                    ,BRANCH\n                    ,FIRST_NAME\n                    ,LAST_NAME\n            \t\t,CDA_SSN\n                    ,SSN_LAST_4\n                    ,EMPLOYEE_NUMBER\n                    ,CLIENT_NAME\n                    ,CLIENT_NUMBER\n                    ,ASSIGNMENT\n            \t\t,HOME_STATE\n            \t\t,JOB_TITLE\n            \t\t,WC_CODE\n            \t\t,GROSS_WAGES\n\t\t\t\t\t,REGULAR_AMT\n            \t\t,OVERTIME_AMT\n            \t\t,DOUBLE_TIME_AMT\n            \t\t,SEVERENCE_AMT\n            \t\t,VACATION_AMT\n            \t\t,SICK_AMT\n            \t\t,HOLIDAY_AMT\n            \t\t,BONUSES_AMT\n            \t\t,CONVERTED_BILL_HOURS_WORKED\n            \t\t,DED_AMT\n            \t\t,DED_CODE\n                    ORDER BY CASE\n                                WHEN WORK_STATE = '' OR WORK_STATE IS NULL THEN 2\n                                ELSE 1\n                            END\n                ) AS ROW_NUM_WS\n        FROM CTE_LAST_QUERY\n    ), CTE_CLEANED_DATA_2 AS (\n        SELECT *,\n            ROW_NUMBER() OVER (\n                PARTITION BY\n                    WEEK_WORKED\n            \t\t,ENTITY\n                    ,ACCOUNTING_UNIT\n                    ,BRANCH\n                    ,FIRST_NAME\n                    ,LAST_NAME\n            \t\t,CDA_SSN\n                    ,SSN_LAST_4\n                    ,EMPLOYEE_NUMBER\n                    ,CLIENT_NAME\n                    ,CLIENT_NUMBER\n                    ,ASSIGNMENT\n            \t\t,HOME_STATE\n            \t\t,WORK_STATE\n            \t\t,WC_CODE\n            \t\t,GROSS_WAGES\n\t\t\t\t\t,REGULAR_AMT\n            \t\t,OVERTIME_AMT\n            \t\t,DOUBLE_TIME_AMT\n            \t\t,SEVERENCE_AMT\n            \t\t,VACATION_AMT\n            \t\t,SICK_AMT\n            \t\t,HOLIDAY_AMT\n            \t\t,BONUSES_AMT\n            \t\t,CONVERTED_BILL_HOURS_WORKED\n            \t\t,DED_AMT\n            \t\t,DED_CODE\n                    ORDER BY CASE\n                                WHEN JOB_TITLE = '' OR JOB_TITLE IS NULL THEN 2\n                                ELSE 1\n                            END\n                ) AS ROW_NUM_JT\n        FROM CTE_CLEANED_DATA\n        WHERE ROW_NUM_WS = 1\n    )\n\n    SELECT DISTINCT\n        WEEK_WORKED\n        ,ENTITY\n        ,ACCOUNTING_UNIT\n        ,BRANCH\n        ,FIRST_NAME\n        ,LAST_NAME\n        ,CDA_SSN\n        ,SSN_LAST_4\n        ,EMPLOYEE_NUMBER\n        ,CLIENT_NAME\n        ,CLIENT_NUMBER\n        ,ASSIGNMENT\n        ,HOME_STATE\n        ,WORK_STATE\n        ,JOB_TITLE\n        ,WC_CODE\n        ,GROSS_WAGES\n        ,OVERTIME_AMT\n        ,DOUBLE_TIME_AMT\n        ,SEVERENCE_AMT\n        ,VACATION_AMT\n        ,SICK_AMT\n        ,HOLIDAY_AMT\n        ,BONUSES_AMT\n        ,CONVERTED_BILL_HOURS_WORKED\n        ,DED_AMT\n        ,DED_CODE\n    FROM CTE_CLEANED_DATA_2\n    WHERE ROW_NUM_JT = 1"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340656":{"id":6340656,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-256,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6340662],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340696":{"id":6340696,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":544,"y":0,"width":32,"height":32,"inputConnectorIDs":[6340658],"outputSuccessConnectorIDs":[6340659],"outputFailureConnectorIDs":[6340668],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Load RPT_WORKERS_COMP"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"### Jython process to load RPT_WORKERS_COMP table in Snowflake\n\n# Step 1: Start the cursor\ncursor = context.cursor()\n\n# Step 2: Fetch column names dynamically from RPT_WORKERS_COMP_TEMP\nquery = \"\"\"\n    SELECT column_name\n    FROM ${SNFLENTDB}.information_schema.columns\n    WHERE table_name = 'RPT_WORKERS_COMP_TEMP_PIVOTED'\n      AND table_schema = '${Sch_Payroll}'\n      AND table_catalog = '${SNFLENTDB}'\n      AND column_name != 'NODED'\n    ORDER BY ordinal_position\n\"\"\"\n\n# Execute the query to fetch column names\ncursor.execute(query)\n\n# Step 3: Construct the column list\ncolumns = []\nfor row in cursor.fetchall():\n    # Append each cleaned column name as a string\n    columns.append(str(row[0]))\n    \nif not columns:\n    raise Exception(\"No columns were retrieved from the table RPT_WORKERS_COMP_TEMP_PIVOTED.\")\n\n# Convert the list of column names to a comma-separated string\ncolumn_list = \", \".join(columns)\n\n# Step 4: Construct the dynamic INSERT query\ndynamic_query_template = \"\"\"\n    INSERT INTO ${SNFLENTDB}.${Sch_Payroll}.RPT_WORKERS_COMP ({columns})\n    SELECT {columns}\n    FROM ${SNFLENTDB}.${Sch_Payroll}.RPT_WORKERS_COMP_TEMP_PIVOTED\n\"\"\"\n\n# Replace the placeholder {columns} with the actual column list\ndynamic_query = dynamic_query_template.replace(\"{columns}\", column_list)\n\nprint(dynamic_query)\n\n# Step 5: Execute the dynamic query\ntry:\n    cursor.execute(dynamic_query)\n    print(\"Dynamic query executed successfully!\")\nexcept Exception as e:\n    print(\"Error occurred while executing the dynamic query:\")\n    print(str(e))\n    raise\n\n# Step 6: Load audit\ncursor.execute('SELECT COUNT(*) FROM ${SNFLENTDB}.${Sch_Payroll}.RPT_WORKERS_COMP')\nresult = cursor.fetchone()\ncontext.updateVariable(\"audit_rowcount\", int(result[0]))\nrowcount = result[0]\nprint(\"Row count:\")\nprint(rowcount)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340697":{"id":6340697,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":237373210,"x":64,"y":0,"width":32,"height":32,"inputConnectorIDs":[6340661],"outputSuccessConnectorIDs":[6340660],"outputFailureConnectorIDs":[6340669],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate Table RPT_WORKERS_COMP"}}}},"visible":true},"3":{"slot":3,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLENTDB}"}}}},"visible":true},"4":{"slot":4,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${Sch_Payroll}"}}}},"visible":true},"5":{"slot":5,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"RPT_WORKERS_COMP"}}}},"visible":true},"6":{"slot":6,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340698":{"id":6340698,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":384,"y":0,"width":32,"height":32,"inputConnectorIDs":[6340657],"outputSuccessConnectorIDs":[6340658],"outputFailureConnectorIDs":[6340667],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Execute Dynamic Pivot"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"### Pivoting columns dynamically\n\n# Step 1: Start the cursor\ncursor = context.cursor()\n\n# Step 2: Fetch unique DED_CODE values for the pivot columns\nded_code_query = \"\"\"\n                SELECT DISTINCT DED_CODE\n                FROM ${SNFLENTDB}.${Sch_Payroll}.RPT_WORKERS_COMP_TEMP\n                WHERE DED_CODE IS NOT NULL\n                ORDER BY DED_CODE;\n\"\"\"\n\ncursor.execute(ded_code_query)\n\nded_codes = [str(row[0]) for row in cursor.fetchall()]  # Fetch results into a list\n\nif not ded_codes:\n    raise Exception(\"No DED_CODE values found for pivot!\")\n\n# Step 2: Create variables with columns\npivot_columns = \", \".join([\"'%s'\" % code for code in ded_codes])  # Format as quoted strings\ncolumn_select = \", \".join(ded_codes)  # For the SELECT clause\ndefault_columns = \"WEEK_WORKED, ENTITY, ACCOUNTING_UNIT, BRANCH, FIRST_NAME, LAST_NAME, CDA_SSN, SSN_LAST_4, EMPLOYEE_NUMBER, CLIENT_NAME, CLIENT_NUMBER, ASSIGNMENT, HOME_STATE, WORK_STATE, JOB_TITLE, WC_CODE, GROSS_WAGES, OVERTIME_AMT, DOUBLE_TIME_AMT, SEVERENCE_AMT, VACATION_AMT, SICK_AMT, HOLIDAY_AMT, BONUSES_AMT, CONVERTED_BILL_HOURS_WORKED\".strip()\n\n# Step 3: Construct the pivot query dynamically\npivot_query_tmp = \"\"\"\n\t\t\t\t\tCREATE TEMPORARY TABLE ${SNFLENTDB}.${Sch_Payroll}.RPT_WORKERS_COMP_TEMP_PIVOTED AS\n                    SELECT\n                    \t{default_columns},\n                        {column_select}\n                    FROM (\n                        SELECT\n                         {default_columns},\n                          DED_CODE,\n                          DED_AMT\n                        FROM ${SNFLENTDB}.${Sch_Payroll}.RPT_WORKERS_COMP_TEMP\n                    )\n                    PIVOT (\n                        MAX(DED_AMT)\n                        FOR DED_CODE IN ({pivot_columns})\n                        DEFAULT ON NULL (0)\n                    ) AS PivotTable ({default_columns},\n                                    {column_select})\n\"\"\"\n\n# Replace the placeholder {columns} with the actual column list\npivot_query = pivot_query_tmp.replace(\"{column_select}\", column_select).replace(\"{pivot_columns}\", pivot_columns).replace(\"{default_columns}\", default_columns)\n\nprint(pivot_query)\n\n# Step 4: Execute the dynamic query\ntry:\n    cursor.execute(pivot_query)\n    print(\"Pivot query executed successfully!\")\nexcept Exception as e:\n    print(\"Error occurred while executing the pivot query:\")\n    print(str(e))\n    raise\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340699":{"id":6340699,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":864,"y":0,"width":32,"height":32,"inputConnectorIDs":[6340665],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Success"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6340700":{"id":6340700,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":864,"y":-112,"width":32,"height":32,"inputConnectorIDs":[6340664],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"6340657":{"id":6340657,"sourceID":6340655,"targetID":6340698},"6340658":{"id":6340658,"sourceID":6340698,"targetID":6340696},"6340659":{"id":6340659,"sourceID":6340696,"targetID":6340652},"6340660":{"id":6340660,"sourceID":6340697,"targetID":6340655}},"failureConnectors":{"6340666":{"id":6340666,"sourceID":6340655,"targetID":6340654},"6340667":{"id":6340667,"sourceID":6340698,"targetID":6340654},"6340668":{"id":6340668,"sourceID":6340696,"targetID":6340654},"6340669":{"id":6340669,"sourceID":6340697,"targetID":6340654}},"unconditionalConnectors":{"6340661":{"id":6340661,"sourceID":6340653,"targetID":6340697},"6340662":{"id":6340662,"sourceID":6340656,"targetID":6340653},"6340663":{"id":6340663,"sourceID":6340654,"targetID":6340651},"6340664":{"id":6340664,"sourceID":6340651,"targetID":6340700},"6340665":{"id":6340665,"sourceID":6340652,"targetID":6340699}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_WORKERS_COMP_REPORT_20250904","description":"","type":"ORCHESTRATION","tag":"60a8c101-f8f3-4181-a940-df9606640c30"}}