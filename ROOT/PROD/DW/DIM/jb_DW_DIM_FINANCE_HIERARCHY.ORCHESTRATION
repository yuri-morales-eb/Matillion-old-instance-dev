{"job":{"components":{"6336635":{"id":6336635,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-224,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336638],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336636":{"id":6336636,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":0,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336638],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336639],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_FINANCE_HIERARCHY"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n \njob_name = 'DW_DIM_FINANCE_HIERARCHY'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_FINANCE_HIERARCHY MGE USING (SELECT NVL(DIM.ACCTUNITID,LDG.ACCT_UNIT_CD) COMB_ID, LDG.REF_ACCT_UNIT_ID, LDG.ACCT_UNIT_DESC_TXT, LDG.BUDJ_AREA_CD, LDG.BUDJ_AREA_DESC_TXT, LDG.CAT_CD, LDG.CAT_DESC_TXT, LDG.CS_REP_AREA_CD, LDG.CNS_REP_AREA_DESC, LDG.DIV_CD, LDG.DIV_CD_DESC_TXT, LDG.REG_CD, LDG.REG_DESC_TXT, LDG.SUB_AREA1_CD, LDG.SUB_AREA1_DESC_TXT, LDG.SUB_AREA2_CD, LDG.SUB_AREA2_DESC_TXT FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_FINANCE_HIERARCHY DIM FULL OUTER JOIN (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.DIM_ACCT_UNIT WHERE VALID_TO_DT = '9999-12-31' QUALIFY ROW_NUMBER() OVER (PARTITION BY ACCT_UNIT_CD ORDER BY MODIFIED_DT DESC,CREATED_DT DESC) = 1 )LDG ON DIM.ACCTUNITID = LDG.ACCT_UNIT_CD where (DATE_TRUNC('DAY',LDG.MODIFIED_DT)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01')                                         FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_FINANCE_HIERARCHY) OR DATE_TRUNC('DAY',LDG.CREATED_DT)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_FINANCE_HIERARCHY))) COMB ON MGE.ACCTUNITID = COMB.COMB_ID WHEN NOT MATCHED THEN INSERT(ACCTUNITID,REFACCTUNITID,ACCTUNITNAME,BUDGETAREAID,BUDGETAREANAME,CATEGORYID,CATEGORYNAME,CNSREPAREAID,CNSREPAREANAME,DIVISIONID,DIVISIONNAME,REGIONID, REGIONNAME,SUBAREA1ID,SUBAREA1NAME,SUBAREA2ID,SUBAREA2NAME,DW_CREATED_DATE,DW_MODIFIED_DATE) VALUES (COMB.COMB_ID,REF_ACCT_UNIT_ID,ACCT_UNIT_DESC_TXT,BUDJ_AREA_CD,BUDJ_AREA_DESC_TXT,CAT_CD,CAT_DESC_TXT,CS_REP_AREA_CD,CNS_REP_AREA_DESC,DIV_CD,DIV_CD_DESC_TXT,REG_CD,REG_DESC_TXT, SUB_AREA1_CD,SUB_AREA1_DESC_TXT,SUB_AREA2_CD,SUB_AREA2_DESC_TXT,current_timestamp,current_timestamp) WHEN MATCHED THEN UPDATE SET MGE.REFACCTUNITID = COMB.REF_ACCT_UNIT_ID, MGE.ACCTUNITNAME = COMB.ACCT_UNIT_DESC_TXT, MGE.BUDGETAREAID = COMB.BUDJ_AREA_CD, MGE.BUDGETAREANAME = COMB.BUDJ_AREA_DESC_TXT, MGE.CATEGORYID = COMB.CAT_CD, MGE.CATEGORYNAME = COMB.CAT_DESC_TXT, MGE.CNSREPAREAID = COMB.CS_REP_AREA_CD, MGE.CNSREPAREANAME = COMB.CNS_REP_AREA_DESC, MGE.DIVISIONID = COMB.DIV_CD, MGE.DIVISIONNAME = COMB.DIV_CD_DESC_TXT, MGE.REGIONID = COMB.REG_CD, MGE.REGIONNAME = COMB.REG_DESC_TXT, MGE.SUBAREA1ID = COMB.SUB_AREA1_CD, MGE.SUBAREA1NAME = COMB.SUB_AREA1_DESC_TXT, MGE.SUBAREA2ID = COMB.SUB_AREA2_CD, MGE.SUBAREA2NAME = COMB.SUB_AREA2_DESC_TXT, MGE.DW_MODIFIED_DATE = current_timestamp;\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336637":{"id":6336637,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":232,"y":17,"width":32,"height":32,"inputConnectorIDs":[6336639],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_FINANCE_HIERARCHY_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336639":{"id":6336639,"sourceID":6336636,"targetID":6336637}},"unconditionalConnectors":{"6336638":{"id":6336638,"sourceID":6336635,"targetID":6336636}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_FINANCE_HIERARCHY","description":"","type":"ORCHESTRATION","tag":"db7d975c-0e0b-4cfb-a8be-c44eea3d9042"}}