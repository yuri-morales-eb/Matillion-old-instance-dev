{"job":{"components":{"6336623":{"id":6336623,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-352,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336626],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336624":{"id":6336624,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-176,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336626],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336627],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_TRANSACTION_ACTRANS"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_DIM_TRANSACTION_ACTRANS'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\ncursor = context.cursor()\n\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION mge USING (SELECT nvl(dim.transactionid, ldg.cda_transactionid) comb_id, cda_origobjid, cda_activity, cda_sourcetype, cda_assignmentid, cda_acctunitid, cda_customerid, cda_glaccountid, cda_employeeid, cda_timecardid, cda_acctcategory, cda_wagecodeid, cda_wagecodename, cda_postingdate, cda_transactiondate, cda_transactionamount, cda_unitsamount, cda_normpostingdate, cda_billableamount, cda_billableunit, cda_unitmeasure, cda_referencetext, cda_globjid, cda_transtype, cda_sourcestatus, cda_rundatetime, cda_fiscalyear, cda_acctperiod, cda_effectivedate, cda_je_type, CDA_InvoiceNumber, CDA_SalesTaxAmount, CDA_TaxableAmount FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION dim FULL OUTER JOIN (SELECT transactionid AS cda_transactionid, origobjid AS cda_origobjid, activity AS cda_activity, sourcetype AS cda_sourcetype, assignmentid AS cda_assignmentid, acctunitid AS cda_acctunitid, customerid AS cda_customerid, glaccountid AS cda_glaccountid, employeeid AS cda_employeeid, timecardid AS cda_timecardid, acctcategory AS cda_acctcategory, wagecodeid AS cda_wagecodeid, wagecodename AS cda_wagecodename, postingdate AS cda_postingdate, transactiondate AS cda_transactiondate, transactionamount AS cda_transactionamount, unitsamount AS cda_unitsamount, normpostingdate AS cda_normpostingdate, billableamount AS cda_billableamount, billableunit AS cda_billableunit, unitmeasure AS cda_unitmeasure, referencetext AS cda_referencetext, globjid AS cda_globjid, transtype AS cda_transtype, sourcestatus AS cda_sourcestatus, rundatetime AS cda_rundatetime, fiscalyear AS cda_fiscalyear, acctperiod AS cda_acctperiod, effectivedate AS cda_effectivedate, je_type AS cda_je_type, InvoiceNumber AS CDA_InvoiceNumber, SalesTaxAmount AS CDA_SalesTaxAmount, TaxableAmount AS CDA_TaxableAmount ,PBCRN FROM (SELECT act.obj_id AS transactionid, orig_obj_id AS origobjid, activity AS activity, 'ACTRANS' AS sourcetype, da.assignmentid, act.acct_unit AS acctunitid, da.customerid, glaccountid, de.employeeid, tc.timecardid, act.acct_category AS acctcategory, act.billcodeid AS wagecodeid, act.billcodedesc AS wagecodename, posting_date AS postingdate, act.tran_date AS transactiondate, tran_amount AS transactionamount, act.units_amount AS unitsamount, NormPostingDate, billable_amt AS billableamount, billable_unit AS billableunit, act.unit_measure AS unitmeasure, act.reference AS referencetext, act.glt_obj_id AS globjid, trans_type AS transtype, act.status AS sourcestatus, rundatetime, fiscal_year AS fiscalyear, period AS acctperiod, NULL AS effectivedate, NULL AS je_type, NULL AS modified_dt, NULL AS created_dt, INV.INVOICENUMBER AS InvoiceNumber, ACHISTDTL.TAX_AMT AS SalesTaxAmount, ACHISTDTL.TAXABLE_AMT AS TaxableAmount, row_number() OVER (PARTITION BY act.obj_id ORDER BY ACT.BILLCODEID ASC, ACT.PAYCODEID ASC) AS PBCRN FROM (SELECT obj_id, orig_obj_id, activity, trim(regexp_replace(activity, '[^[:digit:]]', ' ')) AS assignmentnumber, acct_unit, to_varchar(account) AS glaccountid, acct_category, posting_date, tran_date, tran_amount, units_amount, LAST_DAY(POSTING_DATE, 'Week') AS NormPostingDate, billable_amt, billable_unit, unit_measure, reference, glt_obj_id, trans_type, status, replace(run_date, '00:00:00.000', RIGHT(to_timestamp(run_time), 12)) AS rundatetime, run_time, fiscal_year, period, BILLCODEID, PAYCODEID, billcodedesc FROM ${SNFLKDB}.${SNFLKSCH}.lawson_dl_ldg_actrans_ph3 LEFT OUTER JOIN (SELECT DISTINCT BILLCODEID, PAYCODEID, billcodedesc FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_PAYBILLCODE) PBC ON ACCT_CATEGORY = IFNULL(PBC.BILLCODEID, PBC.PAYCODEID) WHERE date_trunc('DAY', run_date) >= (SELECT nvl(max(date_trunc('DAY', dw_created_date)), '1900-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION)) ACT LEFT OUTER JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ASSIGNMENT DA ON DA.ASSIGNMENTNUMBER = act.assignmentnumber LEFT OUTER JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_EMPLOYEE DE ON DA.EMPLOYEEID = DE.EMPLOYEEID LEFT OUTER JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TIMECARD TC ON DA.ASSIGNMENTNUMBER = TC.ASSIGNMENTID AND TC.WEEK_ENDING = ACT.POSTING_DATE AND TC.sourceid = ACT.ORIG_OBJ_ID LEFT OUTER JOIN (SELECT ATN_OBJ_ID, obj_id, TAX_AMT, TAXABLE_AMT, row_number() OVER (PARTITION BY ATN_OBJ_ID ORDER BY INVC_AMT DESC) AS ACHISTDTL_RN FROM ${SNFLKDB}.${SNFLKSCH}.Lawson_DL_LDG_achistdtl_ph3 qualify ACHISTDTL_RN = 1) achistdtl ON achistdtl.ATN_OBJ_ID = ACT.OBJ_ID LEFT OUTER JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE INV ON ACHISTDTL.obj_id = INV.INVOICEOBJID) T WHERE T.PBCRN = 1 ) ldg ON dim.transactionid = ldg.cda_transactionid) comb ON mge.transactionid = comb.comb_id WHEN NOT matched THEN INSERT (transactionid, origobjid, activity, sourcetype, assignmentid, acctunitid, customerid, glaccountid, employeeid, timecardid, acctcategory, wagecodeid, wagecodename, postingdate, transactiondate, transactionamount, unitsamount, normpostingdate, billableamount, billableunit, unitmeasure, referencetext, globjid, transtype, sourcestatus, rundatetime, fiscalyear, acctperiod, effectivedate, je_type, InvoiceNumber, SalesTaxAmount, TaxableAmount, dw_created_date, dw_modified_date) VALUES (comb.comb_id, cda_origobjid, cda_activity, cda_sourcetype, cda_assignmentid, cda_acctunitid, cda_customerid, cast(cda_glaccountid AS varchar(50)), cda_employeeid, cda_timecardid, cda_acctcategory, cda_wagecodeid, cda_wagecodename, cda_postingdate, cda_transactiondate, cda_transactionamount, cda_unitsamount, cda_normpostingdate, cda_billableamount, cda_billableunit, cda_unitmeasure, cda_referencetext, cda_globjid, cda_transtype, cda_sourcestatus, cda_rundatetime, cda_fiscalyear, cda_acctperiod, cda_effectivedate, cda_je_type, CDA_InvoiceNumber, CDA_SalesTaxAmount, CDA_TaxableAmount, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP) WHEN matched AND mge.transactionid = comb.comb_id AND origobjid <> cda_origobjid OR activity <> cda_activity OR sourcetype <> cda_sourcetype OR assignmentid <> cda_assignmentid OR acctunitid <> cda_acctunitid OR customerid <> cda_customerid OR glaccountid <> cast(cda_glaccountid AS varchar(50)) OR employeeid <> cda_employeeid OR timecardid <> cda_timecardid OR acctcategory <> cda_acctcategory OR wagecodeid <> cda_wagecodeid OR wagecodename <> cda_wagecodename OR postingdate <> cda_postingdate OR transactiondate <> cda_transactiondate OR transactionamount <> cda_transactionamount OR unitsamount <> cda_unitsamount OR normpostingdate <> cda_normpostingdate OR billableamount <> cda_billableamount OR billableunit <> cda_billableunit OR unitmeasure <> cda_unitmeasure OR referencetext <> cda_referencetext OR globjid <> cda_globjid OR transtype <> cda_transtype OR sourcestatus <> cda_sourcestatus OR rundatetime <> cda_rundatetime OR fiscalyear <> cda_fiscalyear OR acctperiod <> cda_acctperiod OR effectivedate <> cda_effectivedate OR je_type <> cda_je_type OR InvoiceNumber <> CDA_InvoiceNumber OR SalesTaxAmount <> CDA_SalesTaxAmount OR TaxableAmount <> CDA_TaxableAmount THEN UPDATE SET origobjid = cda_origobjid, activity = cda_activity, sourcetype = cda_sourcetype, assignmentid = cda_assignmentid, acctunitid = cda_acctunitid, customerid = cda_customerid, glaccountid = cast(cda_glaccountid AS varchar(50)), employeeid = cda_employeeid, timecardid = cda_timecardid, acctcategory = cda_acctcategory, wagecodeid = cda_wagecodeid, wagecodename = cda_wagecodename, postingdate = cda_postingdate, transactiondate = cda_transactiondate, transactionamount = cda_transactionamount, unitsamount = cda_unitsamount, normpostingdate = cda_normpostingdate, billableamount = cda_billableamount, billableunit = cda_billableunit, unitmeasure = cda_unitmeasure, referencetext = cda_referencetext, globjid = cda_globjid, transtype = cda_transtype, sourcestatus = cda_sourcestatus, rundatetime = cda_rundatetime, fiscalyear = cda_fiscalyear, acctperiod = cda_acctperiod, effectivedate = cda_effectivedate, je_type = cda_je_type, InvoiceNumber = CDA_InvoiceNumber, SalesTaxAmount = CDA_SalesTaxAmount, TaxableAmount = CDA_TaxableAmount, dw_modified_date = CURRENT_TIMESTAMP\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336625":{"id":6336625,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":80,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336627],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_TRANSACTION_ACTRANS_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336627":{"id":6336627,"sourceID":6336624,"targetID":6336625}},"unconditionalConnectors":{"6336626":{"id":6336626,"sourceID":6336623,"targetID":6336624}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_TRANSACTION_ACTRANS","description":"","type":"ORCHESTRATION","tag":"d38464a4-cf87-459a-8096-a2f127dcc0e2"}}