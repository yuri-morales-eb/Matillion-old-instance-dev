{"job":{"components":{"6336533":{"id":6336533,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-704,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336536],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336537],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Row Count","mapTo":"audit_rowcount"},"4":{"slot":4,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"},"6":{"slot":6,"fromId":null,"fromName":"Message","mapTo":"audit_message"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_CUSTOMER_HIERARCHY"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'DW_DIM_CUSTOMER_HIERARCHY'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CUSTOMER_HIERARCHY MGE USING ( With Parent AS ( SELECT 0 AS Level, P.ACCOUNTID, P.Name AS CustomerName, P.PARENTACCOUNTID, NULL AS ParentCustomerName, P.DL_CREATED_DATE, P.CREATEDON, P.MODIFIEDON , P.Name AS LawsonParentCustomerName FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_ACCOUNTBASE P WHERE P.parentaccountid IS NULL QUALIFY ROW_NUMBER() OVER (PARTITION BY P.ACCOUNTID ORDER BY P.CREATEDON, P.MODIFIEDON DESC) = 1 ) SELECT DISTINCT NVL(DIM.CustomerID,LDG.ACCOUNTID) COMB_ID, LDG.CUSTOMERNAME, LDG.PARENTACCOUNTID AS LDG_ParentCustomerID, LDG.ParentCustomerName as LDG_ParentCustomerName, LDG.Level AS LDG_Level, LDG.DL_CREATED_DATE AS LDG_DL_CREATED_DATE , NAT_CUSTOMER, LDG.LawsonParentCustomerName AS LawsonParentCustomerName1 FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CUSTOMER_HIERARCHY DIM FULL OUTER JOIN (SELECT DISTINCT LEVEL,ACCOUNTID, P.CustomerName, PARENTACCOUNTID, NULL AS ParentCustomerName, DL_CREATED_DATE, CREATEDON, MODIFIEDON,'' as NAT_CUSTOMER,P.LawsonParentCustomerName from parent P UNION ALL SELECT DISTINCT P.Level + 1, C.ACCOUNTID, C.Name AS CustomerName, C.PARENTACCOUNTID, P.CustomerName AS ParentCustomerName , C.DL_CREATED_DATE, C.CREATEDON, C.MODIFIEDON, NAT_CUSTOMER, C.Name AS LawsonParentCustomerName FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_ACCOUNTBASE C JOIN Parent P ON C.PARENTACCOUNTID = P.ACCOUNTID LEFT JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.NATACCT NAT ON C.ACCOUNTNUMBER = LTRIM(CUSTOMER) QUALIFY ROW_NUMBER() OVER (PARTITION BY C.ACCOUNTID ORDER BY C.CREATEDON, C.MODIFIEDON DESC) = 1 ) LDG ON DIM.CustomerID = LDG.ACCOUNTID WHERE (DATE_TRUNC('DAY',LDG.CREATEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CUSTOMER_HIERARCHY ) OR DATE_TRUNC('DAY',LDG.MODIFIEDON )>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CUSTOMER_HIERARCHY )) ) COMB ON MGE.CustomerID = COMB.COMB_ID WHEN NOT MATCHED THEN INSERT(CustomerID, CRMParentCustomerID, CRMParentCustomerName, Level, LawsonParentCustomerID, LawsonParentCustomerName, DW_CREATED_DATE, DW_MODIFIED_DATE ) VALUES (COMB_ID, LDG_ParentCustomerID, LDG_ParentCustomerName, LDG_Level, NAT_CUSTOMER, LawsonParentCustomerName1, current_timestamp, current_timestamp) WHEN MATCHED AND MGE.CustomerID = COMB.COMB_ID AND CRMParentCustomerID <> LDG_ParentCustomerID OR LawsonParentCustomerName <> LawsonParentCustomerName1 OR IFNULL(CRMParentCustomerName ,'NA') <> IFNULL(LDG_ParentCustomerName ,'NA') OR Level <> LDG_Level OR LawsonParentCustomerID <> NAT_CUSTOMER OR LawsonParentCustomerName <> LDG_ParentCustomerName THEN UPDATE SET CRMParentCustomerID = LDG_ParentCustomerID, CRMParentCustomerName = LDG_ParentCustomerName, Level = LDG_Level, LawsonParentCustomerID = NAT_CUSTOMER, LawsonParentCustomerName = LawsonParentCustomerName1, MGE.DW_MODIFIED_DATE = CURRENT_TIMESTAMP;\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (Job_Name,Job_StartTimeStamp))              \n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336534":{"id":6336534,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-544,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336537],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Row Count","mapTo":"audit_rowcount"},"4":{"slot":4,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"},"6":{"slot":6,"fromId":null,"fromName":"Message","mapTo":"audit_message"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_CUSTOMER_HIERARCHY_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336535":{"id":6336535,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-864,"y":-64,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336536],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336537":{"id":6336537,"sourceID":6336533,"targetID":6336534}},"unconditionalConnectors":{"6336536":{"id":6336536,"sourceID":6336535,"targetID":6336533}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"TargetDWH":{"definition":{"name":"TargetDWH","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"${audit_component}"}},"grids":{"MergeOutput":{"definition":{"name":"MergeOutput","scope":"TASKBATCH","definitions":[{"name":"inserted_cnt","type":"DECIMAL"},{"name":"updated_cnt","type":"DECIMAL"}],"description":"This will stored rows inserted and rows updated via merge statement","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"jb_DW_DIM_CUSTOMER_HIERARCHY","description":"","type":"ORCHESTRATION","tag":"4d2aa02c-16ff-43a4-9ec7-7459b59ceab5"}}