{"job":{"components":{"6336515":{"id":6336515,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-224,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336518],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336516":{"id":6336516,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-32,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336518],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336519],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_LABEL"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_DIM_LABEL'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_LABEL MGE USING ( SELECT DISTINCT LDG.ObjectTypeCode COMB_ID, LDG.attributename AS CDA_attributename, LDG.attributevalue AS CDA_attributevalue, LDG.value AS CDA_value, LDG.displayorder AS CDA_displayorder, LDG.name AS CDA_name, LDG.basetablename AS CDA_basetablename, LDG.entityid AS CDA_entityid, LDG.stringmapid AS CDA_stringmapid, LDG.DL_CREATED_DATE AS CDA_DL_CREATED_DATE, md5(LDG.name||LDG.attributename||LDG.attributevalue) AS DWLABELID FROM (SELECT DISTINCT * FROM (SELECT OBJECTTYPECODE, ATTRIBUTENAME, ATTRIBUTEVALUE, VALUE,DISPLAYORDER, STRINGMAPID, DL_CREATED_DATE FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_STRINGMAPBASE QUALIFY ROW_NUMBER() OVER (PARTITION BY OBJECTTYPECODE, ATTRIBUTENAME, ATTRIBUTEVALUE ORDER BY DL_CREATED_DATE DESC) = 1 ) smb JOIN (SELECT DISTINCT ObjectTypeCode AS Entity_ObjectTypeCode, name, basetablename, entityid FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_ENTITY QUALIFY ROW_NUMBER() OVER (PARTITION BY ObjectTypeCode ORDER BY DL_CREATED_DATE DESC) = 1 ) entity ON smb.ObjectTypeCode = entity.Entity_ObjectTypeCode ) LDG where (DATE_TRUNC('DAY',LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_LABEL ) OR DATE_TRUNC('DAY',LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_MODIFIED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_LABEL))) COMB ON MGE.DW_LABELID = COMB.DWLABELID WHEN NOT MATCHED THEN INSERT(ObjectTypeCode , AttributeName , AttributeValue , LabelValue , DisplayOrder, TableName , BaseTableName, EntityID , LabelValueID, DW_LABELID, DW_CREATED_DATE, DW_MODIFIED_DATE) VALUES (COMB.COMB_ID, CDA_attributename, CDA_attributevalue, CDA_value, CDA_displayorder, CDA_name, CDA_basetablename, CDA_entityid, CDA_stringmapid, DWLABELID, current_timestamp, current_timestamp) WHEN MATCHED THEN UPDATE SET AttributeName = CDA_AttributeName, AttributeValue = CDA_attributevalue, LabelValue = CDA_value, DisplayOrder = CDA_displayorder, TableName = CDA_name, BaseTableName = CDA_basetablename, EntityID = CDA_entityid, DW_MODIFIED_DATE = current_timestamp\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n\n\n\n\n  \n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336517":{"id":6336517,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":216,"y":17,"width":32,"height":32,"inputConnectorIDs":[6336519],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python Script 0"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336519":{"id":6336519,"sourceID":6336516,"targetID":6336517}},"unconditionalConnectors":{"6336518":{"id":6336518,"sourceID":6336515,"targetID":6336516}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_LABEL","description":"","type":"ORCHESTRATION","tag":"669a76fc-bdfa-4ca9-ad9c-96adbe67c2fa"}}