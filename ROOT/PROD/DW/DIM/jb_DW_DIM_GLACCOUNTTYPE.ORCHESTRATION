{"job":{"components":{"6336539":{"id":6336539,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-864,"y":-64,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336542],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336540":{"id":6336540,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-704,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336542],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336543],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Row Count","mapTo":"audit_rowcount"},"4":{"slot":4,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"},"6":{"slot":6,"fromId":null,"fromName":"Message","mapTo":"audit_message"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_GLACCOUNTTYPE"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'DW_DIM_GLACCOUNTTYPE'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\n#cursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ACTION MGE USING ( SELECT NVL(DIM.ACTIVITYID,LDG.ACTIVITYID) COMB_ID, CDA_ACTIONTYPE ,CDA_FOLLOWUPTYPE ,CDA_SAFETYOBSERVATION ,CDA_REGARDINGOBJECTIDS FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ACTION DIM FULL OUTER JOIN (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.crm_dl_ldg_cda_actionbase QUALIFY ROW_NUMBER() OVER (PARTITION BY ACTIVITYID ORDER BY DL_CREATED_DATE DESC) = 1 )LDG ON DIM.ACTIVITYID = LDG.ACTIVITYID where (DATE_TRUNC('DAY',DL_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ACTION ) )) COMB ON MGE.ACTIVITYID = COMB.COMB_ID WHEN NOT MATCHED THEN INSERT(ACTIVITYID,ACTION_TYPE,FOLLOWUP_TYPE,SAFETY_OBSERVATION,REGARDINGOBJECTIDS,DW_CREATED_DATE,DW_MODIFIED_DATE) VALUES (COMB.COMB_ID, CDA_ACTIONTYPE,CDA_FOLLOWUPTYPE,CDA_SAFETYOBSERVATION,CDA_REGARDINGOBJECTIDS,current_timestamp,current_timestamp) WHEN MATCHED AND MGE.ACTIVITYID = COMB.COMB_ID AND ACTION_TYPE <> COMB.CDA_ACTIONTYPE OR FOLLOWUP_TYPE <> CDA_FOLLOWUPTYPE OR SAFETY_OBSERVATION <> CDA_SAFETYOBSERVATION OR REGARDINGOBJECTIDS <> CDA_REGARDINGOBJECTIDS THEN UPDATE SET ACTION_TYPE = COMB.CDA_ACTIONTYPE, FOLLOWUP_TYPE = CDA_FOLLOWUPTYPE, SAFETY_OBSERVATION = CDA_SAFETYOBSERVATION, REGARDINGOBJECTIDS = CDA_REGARDINGOBJECTIDS, DW_MODIFIED_DATE = CURRENT_TIMESTAMP\")\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_GLACCOUNTTYPE MGE USING ( SELECT NVL(DIM.GLAccountID,LDG.GL_ACCOUNT_CODE) COMB_ID, GL_ACCOUNT_CODE, GL_ACCOUNT_DESC, CASE WHEN UPPER(TRIM(FINANCIAL_GROUP_CODE)) = 'SALE' then TRUE else FALSE END AS TotalSales1, CASE WHEN UPPER(TRIM(FINANCIAL_GROUP_CODE)) = 'TCOS' then TRUE else FALSE END AS TotalCostOfSales1, CASE WHEN UPPER(FUNCTIONAL_ACCOUNT_NAME) like '%WAGES%' then TRUE else FALSE END AS Wages1, FUNCTIONAL_ACCOUNT_NAME, FUNCTIONAL_ACCOUNT_CODE, FINANCIAL_LINE_CODE, FINANCIAL_LINE_NAME, FINANCIAL_GROUP_CODE, FINANCIAL_GROUP_NAME, REVERSE_SIGN FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_GLACCOUNTTYPE DIM FULL OUTER JOIN (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_CHARTS_OF_ACCTS_FORMAT SRC QUALIFY ROW_NUMBER() OVER (PARTITION BY GL_ACCOUNT_CODE ORDER BY DL_CREATED_DATE DESC) = 1 )LDG ON DIM.GLAccountID = LDG.GL_ACCOUNT_CODE where (DATE_TRUNC('DAY',LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_GLACCOUNTTYPE ) )) COMB ON MGE.GLAccountID = COMB.COMB_ID WHEN NOT MATCHED THEN INSERT( GLAccountID, GLAccountName, TotalSales, TotalCostOfSales, Wages, FunctAcctName, FunctAcctCode, FinLineCode, FinLineName, FinGroupCode, FinGroupName, ReverseSign, DW_CREATED_DATE, DW_MODIFIED_DATE ) VALUES ( GL_ACCOUNT_CODE, GL_ACCOUNT_DESC, TotalSales1, TotalCostOfSales1, Wages1, FUNCTIONAL_ACCOUNT_NAME, FUNCTIONAL_ACCOUNT_CODE, FINANCIAL_LINE_CODE, FINANCIAL_LINE_NAME, FINANCIAL_GROUP_CODE, FINANCIAL_GROUP_NAME, REVERSE_SIGN, current_timestamp, current_timestamp) WHEN MATCHED AND MGE.GLAccountID = COMB.COMB_ID AND GLAccountName <> GL_ACCOUNT_DESC OR TotalSales <> TotalSales1 OR TotalCostOfSales <> TotalCostOfSales1 OR Wages <> Wages1 OR FunctAcctName <> FUNCTIONAL_ACCOUNT_NAME OR FunctAcctCode <> FUNCTIONAL_ACCOUNT_CODE OR FinLineCode <> FINANCIAL_LINE_CODE OR FinLineName <> FINANCIAL_LINE_NAME OR FinGroupCode <> FINANCIAL_GROUP_CODE OR FinGroupName <> FINANCIAL_GROUP_NAME OR ReverseSign <> REVERSE_SIGN THEN UPDATE SET MGE.GLAccountID = COMB.GL_ACCOUNT_CODE, GLAccountName = GL_ACCOUNT_DESC, TotalSales = TotalSales1, TotalCostOfSales = TotalCostOfSales1, Wages = Wages1, FunctAcctName= FUNCTIONAL_ACCOUNT_NAME, FunctAcctCode = FUNCTIONAL_ACCOUNT_CODE, FinLineCode = FINANCIAL_LINE_CODE, FinLineName = FINANCIAL_LINE_NAME, FinGroupCode = FINANCIAL_GROUP_CODE, FinGroupName = FINANCIAL_GROUP_NAME, ReverseSign = REVERSE_SIGN, DW_MODIFIED_DATE = CURRENT_TIMESTAMP\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (Job_Name,Job_StartTimeStamp))              \n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336541":{"id":6336541,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-544,"y":-64,"width":32,"height":32,"inputConnectorIDs":[6336543],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Row Count","mapTo":"audit_rowcount"},"4":{"slot":4,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"},"6":{"slot":6,"fromId":null,"fromName":"Message","mapTo":"audit_message"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_GLACCOUNTTYPE_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336543":{"id":6336543,"sourceID":6336540,"targetID":6336541}},"unconditionalConnectors":{"6336542":{"id":6336542,"sourceID":6336539,"targetID":6336540}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"TargetDWH":{"definition":{"name":"TargetDWH","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"${audit_component}"}},"grids":{"MergeOutput":{"definition":{"name":"MergeOutput","scope":"TASKBATCH","definitions":[{"name":"inserted_cnt","type":"DECIMAL"},{"name":"updated_cnt","type":"DECIMAL"}],"description":"This will stored rows inserted and rows updated via merge statement","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"jb_DW_DIM_GLACCOUNTTYPE","description":"","type":"ORCHESTRATION","tag":"2bf61471-5789-406e-99f8-53994f781b9e"}}