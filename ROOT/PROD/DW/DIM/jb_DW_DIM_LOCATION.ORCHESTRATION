{"job":{"components":{"6336521":{"id":6336521,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-112,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336524],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336525],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_LOCATION"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_DIM_LOCATION'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_LOCATION MGE USING ( SELECT NVL(DIM.LOCATIONID,LDG.CDA_LOCATIONID) COMB_ID , CDA_NAME , CDA_ACCOUNTID , md5('cda_location' ||'cda_locationtype' ||cda_locationtype) locationtype_dwlabelid , CDA_LOCATIONNUMBER , CDA_ADDRESSLINE1 , CDA_ADDRESSLINE2 , CASE WHEN CDA_ADDRESSCITY ='ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ' THEN NULL ELSE CDA_ADDRESSCITY END AS CDA_ADDRESSCITY , CASE WHEN CDA_ADDRESSCOUNTY = 'ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ' THEN NULL ELSE CDA_ADDRESSCOUNTY END AS CDA_ADDRESSCOUNTY , CASE WHEN CDA_ADDRESSZIP = 'ÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿÿ' THEN NULL ELSE CDA_ADDRESSZIP END AS CDA_ADDRESSZIP , md5('cda_location'||'cda_addressstate'||cda_addressstate)  AS state_dwlabelid , CDA_INVOICEWEEKENDINGBREAK , CDA_PAYCYCLE , CDA_BILLCYCLE , CDA_WEEKENDINGDATE , CDA_TIMEENTRYFREQUENCY , CDA_INVOICENAME , CDA_INVOICEFORM , CDA_INVOICEVIEW , CDA_EMAILINVOICE FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_LOCATION DIM FULL OUTER JOIN ( SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_CDA_LOCATIONBASE QUALIFY ROW_NUMBER() OVER (PARTITION BY CDA_LOCATIONID ORDER BY MODIFIEDON DESC,CREATEDON DESC) = 1 )LDG ON DIM.LOCATIONID = LDG.CDA_LOCATIONID WHERE ( DATE_TRUNC('DAY',MODIFIEDON)>= ( SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_LOCATION ) OR DATE_TRUNC('DAY',CREATEDON)>= ( SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_LOCATION ) )) COMB ON MGE.LOCATIONID = COMB.COMB_ID WHEN NOT MATCHED THEN INSERT ( LOCATIONID, CUSTOMERID, LOCATIONTYPE_DW_LABELID, LOCATIONNAME, LOCATIONNUMBER, ADDRESS_LINE1, ADDRESS_LINE2, CITY, COUNTY, ZIP, STATE_DW_LABELID, INVOICEWEBREAK, PAYCYCLE, BILLCYCLE, WEEKENDINGDATE, TIMEENTRYFREQUENCY, INVOICENAME, INVOICEFORM, INVOICEVIEW, EMAILINVOICE, DW_CREATED_DATE, DW_MODIFIED_DATE ) VALUES ( COMB.COMB_ID, CDA_ACCOUNTID, LOCATIONTYPE_DWLABELID, CDA_NAME, CDA_LOCATIONNUMBER, CDA_ADDRESSLINE1, CDA_ADDRESSLINE2, CDA_ADDRESSCITY, CDA_ADDRESSCOUNTY , CDA_ADDRESSZIP, STATE_DWLABELID, CDA_INVOICEWEEKENDINGBREAK, CDA_PAYCYCLE, CDA_BILLCYCLE, CDA_WEEKENDINGDATE, CDA_TIMEENTRYFREQUENCY, CDA_INVOICENAME, CDA_INVOICEFORM, CDA_INVOICEVIEW, CDA_EMAILINVOICE, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP ) WHEN MATCHED AND MGE.LOCATIONID = COMB.COMB_ID AND CUSTOMERID <> CDA_ACCOUNTID OR LOCATIONTYPE_DW_LABELID <> LOCATIONTYPE_DWLABELID OR LOCATIONNAME <> COMB.CDA_NAME OR LOCATIONNUMBER <> CDA_LOCATIONNUMBER OR ADDRESS_LINE1 <> CDA_ADDRESSLINE1 OR ADDRESS_LINE2 <> CDA_ADDRESSLINE2 OR CITY <> CDA_ADDRESSCITY OR COUNTY <> CDA_ADDRESSCOUNTY OR ZIP <> CDA_ADDRESSZIP OR STATE_DW_LABELID <> STATE_DWLABELID OR INVOICEWEBREAK <> CDA_INVOICEWEEKENDINGBREAK OR PAYCYCLE <> CDA_PAYCYCLE OR BILLCYCLE <> CDA_BILLCYCLE OR WEEKENDINGDATE <> CDA_WEEKENDINGDATE OR TIMEENTRYFREQUENCY <> CDA_TIMEENTRYFREQUENCY OR INVOICENAME <> CDA_INVOICENAME OR INVOICEFORM <> CDA_INVOICEFORM OR INVOICEVIEW <> CDA_INVOICEVIEW OR EMAILINVOICE <> CDA_EMAILINVOICE THEN UPDATE SET CUSTOMERID = CDA_ACCOUNTID , LOCATIONTYPE_DW_LABELID = LOCATIONTYPE_DWLABELID , LOCATIONNAME = COMB.CDA_NAME , LOCATIONNUMBER=CDA_LOCATIONNUMBER , ADDRESS_LINE1=CDA_ADDRESSLINE1 , ADDRESS_LINE2=CDA_ADDRESSLINE2 , CITY=CDA_ADDRESSCITY , COUNTY=CDA_ADDRESSCOUNTY , ZIP=CDA_ADDRESSZIP , STATE_DW_LABELID=STATE_DWLABELID , INVOICEWEBREAK = CDA_INVOICEWEEKENDINGBREAK , PAYCYCLE = CDA_PAYCYCLE , BILLCYCLE = CDA_BILLCYCLE , WEEKENDINGDATE = CDA_WEEKENDINGDATE , TIMEENTRYFREQUENCY = CDA_TIMEENTRYFREQUENCY , INVOICENAME = CDA_INVOICENAME , INVOICEFORM = CDA_INVOICEFORM , INVOICEVIEW = CDA_INVOICEVIEW , EMAILINVOICE = CDA_EMAILINVOICE , DW_MODIFIED_DATE = CURRENT_TIMESTAMP\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n\n\n\n\n \n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336522":{"id":6336522,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":25,"y":21,"width":32,"height":32,"inputConnectorIDs":[6336525],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python Script 0"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336523":{"id":6336523,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-224,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336524],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336525":{"id":6336525,"sourceID":6336521,"targetID":6336522}},"unconditionalConnectors":{"6336524":{"id":6336524,"sourceID":6336523,"targetID":6336521}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_LOCATION","description":"","type":"ORCHESTRATION","tag":"f45626c7-cdc5-4df3-a22b-48bbeeb7aa30"}}