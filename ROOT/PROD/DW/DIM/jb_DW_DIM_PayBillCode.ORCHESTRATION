{"job":{"components":{"6336577":{"id":6336577,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":0,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336580],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336581],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_PayBillCode"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\njob_name = 'DW_DIM_PayBillCode'\ncontext.updateVariable(\"Job_Name\",job_name)\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.dim_paybillcode mge using ( SELECT nvl(dim.billcodeid,ldg_billcodeid) comb_id, ldg_paycodeid, ldg_paycodedesc, ldg_billcodedesc, ldg_convertfactor, ldg_convertfunction, ldg_convertfield, ldg_billedworkedhour, ldg_unittype, ldg_paysumgroup, ldg_paytype, ldg_billtype, ldg_premiumrate, ldg_calctype, ldg_status, act_dl_created_date AS act_dl_created_date, bc_dl_created_date AS ldg_bc_dl_created_date, pc_dl_created_date AS ldg_pc_dl_created_date, ldg.HourGroupType AS ldg_HourGroupType, ldg.norm_rate AS ldg_norm_rate, ldg.exclude_flag AS ldg_exclude_flag, ldg.allow_hours AS ldg_allow_hours, ldg.non_earnings AS ldg_non_earnings, ldg.unit_measure AS ldg_unit_measure, ldg.ot_prem_rate AS ldg_ot_prem_rate FROM ${SNFLDWHDB}.${SNFLDWHSCH}.dim_paybillcode dim FULL OUTER JOIN ( SELECT pc.pay_code AS ldg_paycodeid, pc.description AS ldg_paycodedesc, act.acct_category AS ldg_billcodeid, act.description AS ldg_billcodedesc, CASE WHEN CONTAINS(bc.conversion_factor, '/') THEN split_part(bc.conversion_factor, '/', 2) WHEN CONTAINS(bc.conversion_factor, '*') THEN split_part(bc.conversion_factor, '*', 2) END AS ldg_convertfactor, CASE WHEN CONTAINS(bc.conversion_factor, '/') THEN '/' WHEN CONTAINS(bc.conversion_factor, '*') THEN '*' END AS ldg_convertfunction, CASE WHEN CONTAINS(bc.conversion_factor, '/') THEN split_part(upper(bc.conversion_factor), '/', 1) WHEN CONTAINS(bc.conversion_factor, '*') THEN split_part(upper(bc.conversion_factor), '*', 1) END AS ldg_convertfield, iff(bc.account_category IS NOT NULL, 'Y', 'N') AS ldg_billedworkedhour, iff(bc.account_category IS NOT NULL, 'HOUR', 'UNIT') AS ldg_unittype, pc.pay_sum_grp AS ldg_paysumgroup, pc.calc_type AS ldg_paytype, act.category_type AS ldg_billtype, pc.ot_prem_rate AS ldg_premiumrate, pc.calc_type AS ldg_calctype, pc.activity AS ldg_status, act.dl_created_date AS act_dl_created_date, bc.dl_created_date AS bc_dl_created_date, pc.dl_created_date AS pc_dl_created_date, hgt.category AS HourGroupType, pc.norm_rate, pc.exclude_flag, pc.allow_hours, pc.non_earnings, pc.unit_measure, ot_prem_rate FROM ( SELECT acct_category, description, category_type, dl_created_date FROM ${SNFLKDB}.${SNFLKSCH}.lawson_dl_ldg_acacctcat_ph3 qualify row_number() OVER (partition BY acct_category ORDER BY dl_created_date DESC) = 1 ) act LEFT JOIN ( SELECT ACCT_CATEGORY, DESCRIPTION, CATEGORY FROM ${SNFLDWHDB}.${SNFLDWHSCH}.dim_hoursgrouptype ) hgt ON hgt.acct_category = act.acct_category LEFT JOIN ( SELECT conversion_factor, account_category, dl_created_date FROM ${SNFLKDB}.${SNFLKSCH}.lawson_dl_ldg_conv_billed_codes qualify row_number() OVER (partition BY account_category ORDER BY dl_created_date DESC) = 1 ) bc ON act.acct_category = bc.account_category FULL OUTER JOIN ( SELECT pay_code, description, pay_sum_grp, ot_prem_rate, calc_type, activity, dl_created_date , norm_rate, exclude_flag, allow_hours, non_earnings, unit_measure FROM ${SNFLKDB}.${SNFLKSCH}.lawson_dl_ldg_prpaycode qualify row_number() OVER (partition BY pay_code ORDER BY dl_created_date DESC) = 1 ) pc ON rtrim(pc.pay_code) = rtrim(replace(act.acct_category,'0','')) AND rtrim(act.acct_category) <> rtrim(pc.pay_code) ) ldg ON dim.billcodeid = ldg.ldg_billcodeid WHERE ( date_trunc('DAY',ldg.act_dl_created_date)>= ( SELECT nvl(max(date_trunc('DAY',dw_created_date)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.dim_paybillcode ) OR date_trunc('DAY',ldg.bc_dl_created_date)>= ( SELECT nvl(max(date_trunc('DAY',dw_created_date)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.dim_paybillcode ) OR date_trunc('DAY',ldg.pc_dl_created_date)>= ( SELECT nvl(max(date_trunc('DAY',dw_created_date)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.dim_paybillcode ) ) ) comb ON mge.billcodeid = comb.comb_id WHEN NOT matched THEN INSERT ( paycodeid, paycodedesc, billcodeid, billcodedesc, convertfactor, convertfunction, convertfield, billedworkedhour, unittype, paysumgroup, paytype, billtype, premiumrate, calctype, status, hourgrouptype, normrate, excludeflag, allowhours, nonearnings, unitmeasure, otpremrate, dw_created_date, dw_modified_date ) VALUES ( ldg_paycodeid, ldg_paycodedesc, comb.comb_id, ldg_billcodedesc, ldg_convertfactor, ldg_convertfunction, ldg_convertfield, ldg_billedworkedhour, ldg_unittype, ldg_paysumgroup, ldg_paytype, ldg_billtype, ldg_premiumrate, ldg_calctype, ldg_status, ldg_hourgrouptype, ldg_norm_rate, ldg_exclude_flag, ldg_allow_hours, ldg_non_earnings, ldg_unit_measure, ldg_ot_prem_rate, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP ) WHEN matched AND mge.billcodeid = comb.comb_id AND paycodeid <> ldg_paycodeid OR paycodedesc <> ldg_paycodedesc OR billcodedesc <> ldg_billcodedesc OR convertfactor <> ldg_convertfactor OR convertfunction <> ldg_convertfunction OR convertfield <> ldg_convertfield OR billedworkedhour <> ldg_billedworkedhour OR unittype <> ldg_unittype OR paysumgroup <> ldg_paysumgroup OR paytype <> ldg_paytype OR billtype <> ldg_billtype OR premiumrate <> ldg_premiumrate OR calctype <> ldg_calctype OR status <> ldg_status OR hourgrouptype <> ldg_hourgrouptype OR normrate <> ldg_norm_rate OR excludeflag <> ldg_exclude_flag OR allowhours <> ldg_allow_hours OR nonearnings <> ldg_non_earnings OR unitmeasure <> ldg_unit_measure OR otpremrate <> ldg_ot_prem_rate THEN UPDATE SET paycodeid = ldg_paycodeid, paycodedesc = ldg_paycodedesc, billcodedesc = ldg_billcodedesc, convertfactor = ldg_convertfactor, convertfunction = ldg_convertfunction, convertfield = ldg_convertfield, billedworkedhour = ldg_billedworkedhour, unittype = ldg_unittype, paysumgroup = ldg_paysumgroup, paytype = ldg_paytype, billtype = ldg_billtype, premiumrate = ldg_premiumrate, calctype = ldg_calctype, status = ldg_status, hourgrouptype = ldg_hourgrouptype, normrate = ldg_norm_rate, excludeflag = ldg_exclude_flag, allowhours = ldg_allow_hours, nonearnings = ldg_non_earnings, unitmeasure = ldg_unit_measure, otpremrate = ldg_ot_prem_rate, mge.dw_modified_date = CURRENT_TIMESTAMP\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n  \n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336578":{"id":6336578,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":219,"y":21,"width":32,"height":32,"inputConnectorIDs":[6336581],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_PayBillCode_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336579":{"id":6336579,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-224,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336580],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336581":{"id":6336581,"sourceID":6336577,"targetID":6336578}},"unconditionalConnectors":{"6336580":{"id":6336580,"sourceID":6336579,"targetID":6336577}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_PayBillCode","description":"","type":"ORCHESTRATION","tag":"40f881f9-ea9b-4dd3-af3a-e6de553181a6"}}