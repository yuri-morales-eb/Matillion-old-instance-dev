{"job":{"components":{"6336611":{"id":6336611,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":93,"y":14,"width":32,"height":32,"inputConnectorIDs":[6336615],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_JOBORDER_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336612":{"id":6336612,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-224,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336614],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336613":{"id":6336613,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-48,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336614],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336615],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_JOBORDER"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'DW_DIM_JOBORDER'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\n#cursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_JOBORDER MGE USING ( SELECT LDG.CDA_JOBORDERID, LDG.CREATEDON CDA_CREATEDON, LDG.cda_jobordernumber as jobordernumber, CDA_ACCOUNTINGUNITID, cda_branchid, cda_numberrequired, cda_numberfilled, cda_worklocation, cda_jobtitle, LDG.BRANDLEVEL_NAME AS cda_BRANDLEVEL_NAME, cda_jobcode, cda_startdate, cda_brandlevel, md5('cda_joborderstatecode'||statecode1) STATECODE1_DWLABELID, md5('cda_joborderstatuscode'||statuscode1) STATUSCODE1_DWLABELID FROM ( select A.CDA_JOBORDERID, A.CREATEDON, CDA_ACCOUNTINGUNITID, cda_branchid, cda_numberrequired, cda_numberfilled, cda_worklocation, cda_jobtitle, cda_jobcode, cda_startdate, cda_brandlevel, statecode AS statecode1, statuscode AS statuscode1, coalesce(B.VALUE,C.VALUE) BRANDLEVEL_NAME, cda_jobordernumber, A.MODIFIEDON from ( SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_CDA_JOBORDERBASE QUALIFY ROW_NUMBER() OVER (PARTITION BY CDA_JOBORDERID ORDER BY MODIFIEDON DESC,CREATEDON DESC) = 1 ) A left join (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_STRINGMAPBASE WHERE OBJECTTYPECODE = 10019 AND UPPER(ATTRIBUTENAME) = 'CDA_SKILLLEVEL' QUALIFY ROW_NUMBER() OVER (PARTITION BY OBJECTTYPECODE, ATTRIBUTENAME, ATTRIBUTEVALUE ORDER BY DL_CREATED_DATE DESC) = 1) B ON A.CDA_SKILLLEVEL = B.ATTRIBUTEVALUE left join (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_STRINGMAPBASE WHERE OBJECTTYPECODE = 10019 AND UPPER(ATTRIBUTENAME) = 'CDA_BRANDLEVEL' QUALIFY ROW_NUMBER() OVER (PARTITION BY OBJECTTYPECODE, ATTRIBUTENAME, ATTRIBUTEVALUE ORDER BY DL_CREATED_DATE DESC) = 1) C ON A.CDA_BRANDLEVEL = C.ATTRIBUTEVALUE ) LDG where (DATE_TRUNC('DAY',LDG.MODIFIEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_JOBORDER ) OR DATE_TRUNC('DAY',LDG.CREATEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_JOBORDER ))) COMB ON MGE.JOBORDERID = COMB.CDA_JOBORDERID WHEN NOT MATCHED THEN INSERT(JOBORDERID,CREATEDON,JOBORDER_NUMBER,CustomerId,BRANCHID,NUMBER_REQUIRED,NUMBER_FILLED,WORKLOCATIONID,JOB_TITLE,BRANDLEVEL_NAME, JOBCODEID,START_DATE,BRANDLEVELID, STATECODE_DW_LABELID, STATUSCODE_DW_LABELID, DW_CREATED_DATE,DW_MODIFIED_DATE) VALUES (COMB.CDA_JOBORDERID,CDA_CREATEDON, jobordernumber,CDA_ACCOUNTINGUNITID,CDA_BRANCHID,CDA_NUMBERREQUIRED,CDA_NUMBERFILLED,CDA_WORKLOCATION, CDA_JOBTITLE,cda_BRANDLEVEL_NAME,CDA_JOBCODE,TO_DATE(CDA_STARTDATE),cda_brandlevel,statecode1_dwlabelid,STATUSCODE1_dwlabelid, current_timestamp,current_timestamp) WHEN MATCHED THEN UPDATE SET CREATEDON = CDA_CREATEDON, JOBORDER_NUMBER = jobordernumber, CustomerId=CDA_ACCOUNTINGUNITID, BRANCHID = CDA_BRANCHID, NUMBER_REQUIRED = CDA_NUMBERREQUIRED, NUMBER_FILLED = CDA_NUMBERFILLED, WORKLOCATIONID = CDA_WORKLOCATION, JOB_TITLE = CDA_JOBTITLE, BRANDLEVEL_NAME = cda_BRANDLEVEL_NAME, JOBCODEID = CDA_JOBCODE, START_DATE = TO_DATE(CDA_STARTDATE), BRANDLEVELID = cda_brandlevel, STATECODE_DW_LABELID = STATECODE1_DWLABELID, STATUSCODE_DW_LABELID = STATUSCODE1_DWLABELID, DW_MODIFIED_DATE = CURRENT_TIMESTAMP\")\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_JOBORDER MGE USING (SELECT LDG.CDA_JOBORDERID,LDG.CREATEDON CDA_CREATEDON,LDG.cda_jobordernumber as jobordernumber,CDA_ACCOUNTID,cda_branchid,cda_numberrequired,cda_numberfilled,cda_worklocation,cda_jobtitle,LDG.BRANDLEVEL_NAME AS cda_BRANDLEVEL_NAME,cda_jobcode,cda_startdate,cda_brandlevel,md5('cda_joborderstatecode'||statecode1) STATECODE1_DWLABELID,md5('cda_joborderstatuscode'||statuscode1) STATUSCODE1_DWLABELID,CDA_BILLTOLOCATION,CDA_JOBORDERTYPE,CDA_WCCODE,CDA_SHIFTID,CDA_RECEIVEDON,CDA_FILLEDON,CDA_REQUESTOR FROM ( select A.CDA_JOBORDERID,A.CREATEDON,CDA_ACCOUNTID,cda_branchid,cda_numberrequired,cda_numberfilled,cda_worklocation,cda_jobtitle,cda_jobcode,cda_startdate,cda_brandlevel,statecode AS statecode1,statuscode AS statuscode1,coalesce(B.VALUE,C.VALUE) BRANDLEVEL_NAME,cda_jobordernumber,A.MODIFIEDON,cda_billtolocation,cda_jobordertype,cda_wccode,cda_shiftid,cda_receivedon,cda_filledon,cda_requestor from ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.CDA_JOBORDERBASE  A left join (SELECT * FROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.STRINGMAPBASE WHERE OBJECTTYPECODE = 10019 AND UPPER(ATTRIBUTENAME) = 'CDA_SKILLLEVEL') B ON A.CDA_SKILLLEVEL = B.ATTRIBUTEVALUE left join (SELECT * FROM ${SFDBPROD_DATALAKE}.${SNFLKSCH_CRM}.STRINGMAPBASE WHERE OBJECTTYPECODE = 10019 AND UPPER(ATTRIBUTENAME) = 'CDA_BRANDLEVEL') C ON A.CDA_BRANDLEVEL = C.ATTRIBUTEVALUE ) LDG where ( DATE_TRUNC('DAY',LDG.MODIFIEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_JOBORDER ) OR DATE_TRUNC('DAY',LDG.CREATEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_JOBORDER ) ) ) COMB ON MGE.JOBORDERID = COMB.CDA_JOBORDERID WHEN NOT MATCHED THEN INSERT(JOBORDERID,CREATEDON,JOBORDER_NUMBER,CustomerId,BRANCHID,NUMBER_REQUIRED,NUMBER_FILLED,WORKLOCATIONID,JOB_TITLE,BRANDLEVEL_NAME, JOBCODEID,START_DATE,BRANDLEVELID, STATECODE_DW_LABELID,STATUSCODE_DW_LABELID,BillToLocationId,JobOrderType,WCCodeId,ShiftId,ReceivedOnDate,FilledOnDate,RequestorID, DW_CREATED_DATE,DW_MODIFIED_DATE) VALUES (COMB.CDA_JOBORDERID,CDA_CREATEDON, jobordernumber,CDA_ACCOUNTID,CDA_BRANCHID,CDA_NUMBERREQUIRED,CDA_NUMBERFILLED,CDA_WORKLOCATION, CDA_JOBTITLE,cda_BRANDLEVEL_NAME,CDA_JOBCODE,TO_DATE(CDA_STARTDATE),cda_brandlevel,statecode1_dwlabelid,STATUSCODE1_dwlabelid, cda_billtolocation, cda_jobordertype, cda_wccode, cda_shiftid, cda_receivedon, cda_filledon, cda_requestor, current_timestamp,current_timestamp) WHEN MATCHED AND MGE.JOBORDERID = COMB.CDA_JOBORDERID AND CREATEDON <> CDA_CREATEDON OR JOBORDER_NUMBER <> jobordernumber OR CustomerId <> CDA_ACCOUNTID OR BRANCHID <> CDA_BRANCHID OR NUMBER_REQUIRED <> CDA_NUMBERREQUIRED OR NUMBER_FILLED <> CDA_NUMBERFILLED OR WORKLOCATIONID <> CDA_WORKLOCATION OR JOB_TITLE <> CDA_JOBTITLE OR BRANDLEVEL_NAME <> cda_BRANDLEVEL_NAME OR JOBCODEID <> CDA_JOBCODE OR START_DATE <> TO_DATE(CDA_STARTDATE) OR BRANDLEVELID <> cda_brandlevel OR STATECODE_DW_LABELID <> statecode1_dwlabelid \t\t OR STATUSCODE_DW_LABELID <> STATUSCODE1_dwlabelid OR BillToLocationId <> cda_billtolocation OR JobOrderType <> cda_jobordertype OR WCCodeId <> cda_wccode OR ShiftId <> cda_shiftid OR ReceivedOnDate <> cda_receivedon OR FilledOnDate <> cda_filledon OR RequestorID <> cda_requestor THEN UPDATE SET CREATEDON = CDA_CREATEDON,JOBORDER_NUMBER = jobordernumber,CustomerId=CDA_ACCOUNTID,BRANCHID = CDA_BRANCHID,NUMBER_REQUIRED = CDA_NUMBERREQUIRED,NUMBER_FILLED = CDA_NUMBERFILLED,WORKLOCATIONID = CDA_WORKLOCATION,JOB_TITLE = CDA_JOBTITLE,BRANDLEVEL_NAME = cda_BRANDLEVEL_NAME,JOBCODEID = CDA_JOBCODE,START_DATE = TO_DATE(CDA_STARTDATE),BRANDLEVELID = cda_brandlevel,STATECODE_DW_LABELID = STATECODE1_DWLABELID,STATUSCODE_DW_LABELID = STATUSCODE1_DWLABELID,BillToLocationId = cda_billtolocation,JobOrderType = cda_jobordertype,WCCodeId = cda_wccode,ShiftId = cda_shiftid,ReceivedOnDate = cda_receivedon,FilledOnDate = cda_filledon,RequestorID = cda_requestor,DW_MODIFIED_DATE = CURRENT_TIMESTAMP\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SFDBPROD_DATALAKE}' AS SOURCEDB_NAME ,'${SNFLKSCH_CRM}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\n\n\n\n\n  \n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336615":{"id":6336615,"sourceID":6336613,"targetID":6336611}},"unconditionalConnectors":{"6336614":{"id":6336614,"sourceID":6336612,"targetID":6336613}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_JOBORDER","description":"","type":"ORCHESTRATION","tag":"ad1b0fd0-38fd-45be-b17f-06ca2a05f5da"}}