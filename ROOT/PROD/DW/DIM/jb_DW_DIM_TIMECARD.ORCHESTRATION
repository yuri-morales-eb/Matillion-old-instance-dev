{"job":{"components":{"6336583":{"id":6336583,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-560,"y":-48,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336586],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336584":{"id":6336584,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-368,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6336586],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336587],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_Timecard"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_DIM_TIMECARD'\n\ncontext.updateVariable(\"Job_Name\",job_name)\n\nstart_time = datetime.now(timezone(snowflake_timezone)) \nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TIMECARD MGE USING ( SELECT LDG.BatchID AS LDG_BatchID, LDG.TimeCardID AS LDG_TimeCardID, LDG.TimeLineID AS LDG_TimeLineID, LDG.AssignmentID AS LDG_AssignmentID, LDG.SourceID AS LDG_SourceID, LDG.PayCodeID AS LDG_PayCodeID, LDG.BillCodeID AS LDG_BillCodeID, LDG.PayUnits AS LDG_PayUnits, LDG.BillUnits AS LDG_BillUnits, LDG.PayRate AS LDG_PayRate, LDG.BillRate AS LDG_BillRate, CAST(LDG.Week_Ending AS TimeStamp(0)) AS LDG_Week_Ending, LDG.Pay_Batch_ID AS LDG_Pay_Batch_ID, LDG.Pay_Cycle AS LDG_Pay_Cycle, LDG.Payment_Method AS LDG_Payment_Method, LDG.Deleted AS LDG_Deleted, LDG.Status AS LDG_Status, CAST(LDG.TimeCardCreated AS TimeStamp(0)) AS LDG_TimeCardCreated, CAST(LDG.TimeCardModified AS TimeStamp(0)) AS LDG_TimeCardModified, CAST(LDG.PayrollProcessDate AS TimeStamp(0)) AS LDG_PayrollProcessDate, LDG.ProcessingReason AS LDG_ProcessingReason, TP_Timecardchannel AS LDG_TimeCardChannel, TP_TIMERECONCILIATIONSTATUS AS LDG_TIMERECONCILIATIONSTATUS, TC_Termination, TC_CorpError, TC_Settlement FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TIMECARD DIM FULL OUTER JOIN (SELECT time_card.batch_id AS BatchID, time_card.id AS TimeCardID, time_line.id AS TimeLineID, time_card.ASSIGNMENT_ID AS AssignmentID, time_line.source_id AS SourceID, time_entry.pay_code AS PayCodeID, time_entry.bill_code AS BillCodeID, time_entry.pay_units AS PayUnits, time_entry.bill_units AS BillUnits, time_entry.pay_rate AS PayRate, time_entry.bill_rate AS BillRate, time_card.week_ending AS Week_Ending, time_card.pay_batch_id AS Pay_Batch_ID, time_card.pay_cycle AS Pay_Cycle, time_card.payment_method AS Payment_Method, time_card.deleted AS Deleted, time_card.status AS Status, time_card.created_at AS TimeCardCreated, time_Card.modified_At AS TimeCardModified, time_line.payroll_proc_date AS PayrollProcessDate, time_card.processing_reason AS ProcessingReason, time_entry.DL_CREATED_DATE AS TE_DL_CreatedOn, time_line.DL_CREATED_DATE AS TL_DL_CreatedOn, time_card.DL_CREATED_DATE AS TC_DL_CreatedOn, time_pool.TIMECARDCHANNEL AS TP_Timecardchannel, time_pool.TIMERECONCILIATIONSTATUS AS TP_TIMERECONCILIATIONSTATUS, time_card.TERMINATION AS TC_Termination, time_card.CORP_ERROR AS TC_CorpError, time_card.SETTLEMENT AS TC_Settlement FROM ( SELECT time_line_id,pay_code,bill_code,pay_units,bill_units,pay_rate ,bill_rate,DL_CREATED_DATE FROM ${SNFLKDB}.${SNFLKSCH}.LPM_DL_LDG_TIME_ENTRY QUALIFY ROW_NUMBER() OVER (PARTITION BY TIME_LINE_ID ORDER BY DL_CREATED_DATE DESC) = 1 ) time_entry JOIN (SELECT ID,TIMECARDCHANNEL,TIMERECONCILIATIONSTATUS FROM ${SFDBPROD_DATALAKE}.${SFDBPROD_DATALAKESCH}.TIMEPOOLRECONCILIATION) time_pool ON time_pool.ID = time_entry.TIME_LINE_ID JOIN ( SELECT time_card_id,id ,source_id ,payroll_proc_date,DL_CREATED_DATE FROM ${SNFLKDB}.${SNFLKSCH}.LPM_DL_LDG_TIME_LINE QUALIFY ROW_NUMBER() OVER (PARTITION BY ID ORDER BY DL_CREATED_DATE DESC) = 1 ) time_line ON time_line.id = time_entry.TIME_LINE_ID JOIN ( SELECT batch_id,id,ASSIGNMENT_ID ,week_ending,pay_batch_id,pay_cycle,payment_method,deleted ,status,TERMINATION,CORP_ERROR,SETTLEMENT,created_at ,modified_At,processing_reason ,DL_CREATED_DATE FROM ${SNFLKDB}.${SNFLKSCH}.LPM_DL_LDG_TIME_CARD QUALIFY ROW_NUMBER() OVER (PARTITION BY ID ORDER BY DL_CREATED_DATE DESC) = 1 ) time_card ON time_line.time_card_id = time_Card.ID ) LDG ON DIM.TimeLineID = LDG.TimeLineID AND DIM.TimeCardID = LDG.TimeCardID WHERE ( DATE_TRUNC('DAY',LDG.TE_DL_CreatedOn)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TIMECARD ) OR DATE_TRUNC('DAY',LDG.TL_DL_CreatedOn)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TIMECARD ) OR DATE_TRUNC('DAY',LDG.TC_DL_CreatedOn)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TIMECARD ) )) COMB ON MGE.TimeLineID = COMB.LDG_TimeLineID AND MGE.TimeCardID = COMB.LDG_TimeCardID WHEN NOT MATCHED THEN INSERT( BatchID, TimeCardID, TimeLineID, AssignmentID, SourceID, PayCodeID, BillCodeID, PayUnits, BillUnits, PayRate, BillRate, Week_Ending, PayBatchID, Pay_Cycle, Payment_Method, Deleted, Status, TimeCardCreated, TimeCardModified, PayrollProcessDate, ProcessingReason, TimeCardChannel, TimeReconcilliationStatus, Termination, CorpError, Settlement, DW_CREATED_DATE, DW_MODIFIED_DATE ) VALUES ( LDG_BatchID, LDG_TimeCardID, LDG_TimeLineID, LDG_AssignmentID, LDG_SourceID, LDG_PayCodeID, LDG_BillCodeID, LDG_PayUnits, LDG_BillUnits, LDG_PayRate, LDG_BillRate, LDG_Week_Ending, LDG_Pay_Batch_ID, LDG_Pay_Cycle, LDG_Payment_Method, LDG_Deleted, LDG_Status, LDG_TimeCardCreated, LDG_TimeCardModified, LDG_PayrollProcessDate, LDG_ProcessingReason, LDG_TimeCardChannel, LDG_TIMERECONCILIATIONSTATUS, TC_Termination, TC_CorpError, TC_Settlement, current_timestamp, current_timestamp) WHEN MATCHED AND MGE.TimeLineID = COMB.LDG_TimeLineID AND MGE.TimeCardID = COMB.LDG_TimeCardID AND BatchID <> LDG_BatchID OR AssignmentID <> LDG_AssignmentID OR SourceID <> LDG_SourceID OR PayCodeID <> LDG_PayCodeID OR BillCodeID <> LDG_BillCodeID OR PayUnits <> LDG_PayUnits OR BillUnits <> LDG_BillUnits OR PayRate <> LDG_PayRate OR BillRate <> LDG_BillRate OR Week_Ending <> LDG_Week_Ending OR PayBatchID <> LDG_Pay_Batch_ID OR Pay_Cycle <> LDG_Pay_Cycle OR Payment_Method <> LDG_Payment_Method OR Deleted <> LDG_Deleted OR Status <> LDG_Status OR TimeCardCreated <> LDG_TimeCardCreated OR TimeCardModified <> LDG_TimeCardModified OR PayrollProcessDate <> LDG_PayrollProcessDate OR ProcessingReason <> LDG_ProcessingReason OR TimeCardChannel <> LDG_TimeCardChannel OR TimeReconcilliationStatus <> LDG_TIMERECONCILIATIONSTATUS OR Termination <> TC_Termination OR CorpError <> TC_CorpError OR Settlement <> TC_Settlement THEN UPDATE SET BatchID = LDG_BatchID, TimeCardID = LDG_TimeCardID, TimeLineID = LDG_TimeLineID, AssignmentID = LDG_AssignmentID, SourceID = LDG_SourceID, PayCodeID = LDG_PayCodeID, BillCodeID = LDG_BillCodeID, PayUnits = LDG_PayUnits, BillUnits = LDG_BillUnits, PayRate = LDG_PayRate, BillRate = LDG_BillRate, Week_Ending = LDG_Week_Ending, PayBatchID = LDG_Pay_Batch_ID, Pay_Cycle = LDG_Pay_Cycle, Payment_Method = LDG_Payment_Method, Deleted = LDG_Deleted, Status = LDG_Status, TimeCardCreated = LDG_TimeCardCreated, TimeCardModified = LDG_TimeCardModified, PayrollProcessDate = LDG_PayrollProcessDate, ProcessingReason = LDG_ProcessingReason, TimeCardChannel = LDG_TimeCardChannel, TimeReconcilliationStatus = LDG_TIMERECONCILIATIONSTATUS, Termination = TC_Termination, CorpError = TC_CorpError, Settlement = TC_Settlement, MGE.DW_MODIFIED_DATE = CURRENT_TIMESTAMP\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336585":{"id":6336585,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-208,"y":-54,"width":32,"height":32,"inputConnectorIDs":[6336587],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_Timecard_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336587":{"id":6336587,"sourceID":6336584,"targetID":6336585}},"unconditionalConnectors":{"6336586":{"id":6336586,"sourceID":6336583,"targetID":6336584}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{"MergeOutput":{"definition":{"name":"MergeOutput","scope":"TASKBATCH","definitions":[{"name":"inserted_cnt","type":"DECIMAL"},{"name":"updated_cnt","type":"DECIMAL"}],"description":"This will stored rows inserted and rows updated via merge statement","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"jb_DW_DIM_TIMECARD","description":"","type":"ORCHESTRATION","tag":"0c3e8fc8-b970-4b9f-9131-956409f93b49"}}