{"job":{"components":{"6336595":{"id":6336595,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-224,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336598],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336596":{"id":6336596,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-32,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336598],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336599],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_INVOICE"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_DIM_INVOICE'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\n##cursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE MGE USING ( SELECT NVL(DIM.InvoiceNumber,LDG.invoice) COMB_ID, LDG.DL_CREATED_DATE, invoice ,customer ,obj_id ,process_level ,due_date , invoice_type , invoice_date ,Posting_date , invoice_amt ,units_amount , Xref_nbr , LDG.status , Bill_to , LDG.reference FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE DIM FULL OUTER JOIN (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_ACHISTHDR SRC QUALIFY ROW_NUMBER() OVER (PARTITION BY invoice ORDER BY DL_CREATED_DATE DESC,SRC.DL_CREATED_DATE DESC) = 1 )LDG ON DIM.InvoiceNumber = LDG.invoice where (LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DW_MODIFIED_DATE),'2000-01-01T00:00:00') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE ) ) COMB ON MGE.InvoiceNumber = COMB.invoice WHEN NOT MATCHED THEN INSERT( InvoiceNumber, CustomerID ,InvoiceObjID , InvoiceProcessLevel , DueDate , InvoiceType , InvoiceDate , InvoicePostingDate , InvoiceAmount , UnitsAmount , XRefNumber , Status , BillTo , Reference , DW_CREATED_DATE, DW_MODIFIED_DATE ) VALUES ( invoice, customer, obj_id, process_level, due_date, invoice_type, invoice_date, Posting_date, invoice_amt, units_amount, Xref_nbr, COMB.status, Bill_to, COMB.reference, current_timestamp, current_timestamp) WHEN MATCHED AND MGE.InvoiceNumber = COMB.COMB_ID AND CustomerID <> COMB.customer OR InvoiceObjID <> COMB.obj_id OR InvoiceProcessLevel <> COMB.process_level OR DueDate <> COMB.due_date OR InvoiceType <> COMB.invoice_type OR InvoicePostingDate <> COMB.invoice_date OR InvoiceAmount <> COMB.invoice_amt OR UnitsAmount <> COMB.units_amount OR XRefNumber <> COMB.Xref_nbr OR MGE.STATUS <> COMB.status OR Billto <> COMB.Bill_to OR MGE.reference <> COMB.reference THEN UPDATE SET InvoiceNumber = COMB.invoice, CustomerID = COMB.customer, InvoiceObjID = COMB.obj_id, InvoiceProcessLevel = COMB.process_level, DueDate = COMB.due_date, InvoiceType = COMB.invoice_type, InvoicePostingDate = COMB.invoice_date, InvoiceAmount = COMB.invoice_amt, UnitsAmount = COMB.units_amount, XRefNumber = COMB.Xref_nbr, MGE.STATUS = COMB.status, Billto = COMB.Bill_to, MGE.reference = COMB.reference, DW_MODIFIED_DATE = CURRENT_TIMESTAMP;\")\n##cursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE MGE USING ( SELECT NVL(DIM.InvoiceNumber,LDG.invoice) COMB_ID, LDG.DL_CREATED_DATE, invoice ,customer ,obj_id ,process_level ,due_date , invoice_type , invoice_date ,Posting_date , invoice_amt ,units_amount , Xref_nbr , LDG.status , Bill_to , LDG.reference FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE DIM FULL OUTER JOIN (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_ACHISTHDR SRC QUALIFY ROW_NUMBER() OVER (PARTITION BY invoice ORDER BY DL_CREATED_DATE DESC,SRC.DL_CREATED_DATE DESC) = 1 )LDG ON DIM.InvoiceNumber = LDG.invoice where (LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DW_MODIFIED_DATE),'2000-01-01T00:00:00') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE ) OR  (LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DW_CREATED_DATE),'2000-01-01T00:00:00') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE )) COMB ON MGE.InvoiceNumber = COMB.invoice WHEN NOT MATCHED THEN INSERT( InvoiceNumber, CustomerID ,InvoiceObjID , InvoiceProcessLevel , DueDate , InvoiceType , InvoiceDate , InvoicePostingDate , InvoiceAmount , UnitsAmount , XRefNumber , Status , BillTo , Reference , DW_CREATED_DATE, DW_MODIFIED_DATE ) VALUES ( invoice, customer, obj_id, process_level, due_date, invoice_type, invoice_date, Posting_date, invoice_amt, units_amount, Xref_nbr, COMB.status, Bill_to, COMB.reference, current_timestamp, current_timestamp) WHEN MATCHED AND MGE.InvoiceNumber = COMB.COMB_ID AND CustomerID <> COMB.customer OR InvoiceObjID <> COMB.obj_id OR InvoiceProcessLevel <> COMB.process_level OR DueDate <> COMB.due_date OR InvoiceType <> COMB.invoice_type OR InvoicePostingDate <> COMB.invoice_date OR InvoiceAmount <> COMB.invoice_amt OR UnitsAmount <> COMB.units_amount OR XRefNumber <> COMB.Xref_nbr OR MGE.STATUS <> COMB.status OR Billto <> COMB.Bill_to OR MGE.reference <> COMB.reference THEN UPDATE SET InvoiceNumber = COMB.invoice, CustomerID = COMB.customer, InvoiceObjID = COMB.obj_id, InvoiceProcessLevel = COMB.process_level, DueDate = COMB.due_date, InvoiceType = COMB.invoice_type, InvoicePostingDate = COMB.invoice_date, InvoiceAmount = COMB.invoice_amt, UnitsAmount = COMB.units_amount, XRefNumber = COMB.Xref_nbr, MGE.STATUS = COMB.status, Billto = COMB.Bill_to, MGE.reference = COMB.reference, DW_MODIFIED_DATE = CURRENT_TIMESTAMP;\")\n#cursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE MGE USING ( SELECT NVL(DIM.InvoiceNumber,LDG.invoice) COMB_ID, invoice, customer, obj_id, process_level, due_date, invoice_type, invoice_date, Posting_date, invoice_amt, units_amount, Xref_nbr, LDG.status, Bill_to, LDG.reference FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE DIM FULL OUTER JOIN (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_ACHISTHDR_PH3 QUALIFY ROW_NUMBER() OVER (PARTITION BY invoice ORDER BY DL_CREATED_DATE DESC) =1 ) LDG ON DIM.InvoiceNumber = LDG.invoice WHERE ( DATE_TRUNC('DAY',LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_createdate)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE ) OR DATE_TRUNC('DAY',LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_modifieddate)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE ) )) COMB ON MGE.InvoiceNumber = COMB.invoice WHEN NOT MATCHED THEN INSERT( InvoiceNumber, CustomerID, InvoiceObjID, InvoiceProcessLevel, DueDate, InvoiceType, InvoiceDate, InvoicePostingDate, InvoiceAmount, UnitsAmount, XRefNumber , Status , BillTo , Reference , DW_createdate, DW_modifieddate) VALUES ( invoice, customer, obj_id, process_level, due_date, invoice_type, invoice_date, Posting_date, invoice_amt, units_amount, Xref_nbr, COMB.status, Bill_to, COMB.reference, current_timestamp, current_timestamp) WHEN MATCHED AND MGE.InvoiceNumber = COMB.COMB_ID AND CustomerID <> COMB.customer OR InvoiceObjID <> COMB.obj_id OR InvoiceProcessLevel <> COMB.process_level OR DueDate <> COMB.due_date OR InvoiceType <> COMB.invoice_type OR InvoicePostingDate <> COMB.invoice_date OR InvoiceAmount <> COMB.invoice_amt OR UnitsAmount <> COMB.units_amount OR XRefNumber <> COMB.Xref_nbr OR MGE.STATUS <> COMB.status OR Billto <> COMB.Bill_to OR MGE.reference <> COMB.reference THEN UPDATE SET InvoiceNumber = COMB.invoice, CustomerID = COMB.customer, InvoiceObjID = COMB.obj_id, InvoiceProcessLevel = COMB.process_level, DueDate = COMB.due_date, InvoiceType = COMB.invoice_type, InvoicePostingDate = COMB.invoice_date, InvoiceAmount = COMB.invoice_amt, UnitsAmount = COMB.units_amount, XRefNumber = COMB.Xref_nbr, MGE.STATUS = COMB.status, Billto = COMB.Bill_to, MGE.reference = COMB.reference, DW_modifieddate = CURRENT_TIMESTAMP;\")\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE MGE USING ( SELECT NVL(DIM.InvoiceNumber,LDG.invoice) COMB_ID, invoice, customer, obj_id, process_level, due_date, invoice_type, invoice_date, Posting_date, invoice_amt, units_amount, Xref_nbr, LDG.status, Bill_to, LDG.reference FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE DIM FULL OUTER JOIN (SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_ACHISTHDR_PH3 QUALIFY ROW_NUMBER() OVER (PARTITION BY invoice ORDER BY DL_CREATED_DATE DESC) =1 ) LDG ON DIM.InvoiceNumber = LDG.invoice WHERE ( DATE_TRUNC('DAY',LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE ) OR DATE_TRUNC('DAY',LDG.DL_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_MODIFIED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_INVOICE ) )) COMB ON MGE.InvoiceNumber = COMB.invoice WHEN NOT MATCHED THEN INSERT( InvoiceNumber, CustomerID, InvoiceObjID, InvoiceProcessLevel, DueDate, InvoiceType, InvoiceDate, InvoicePostingDate, InvoiceAmount, UnitsAmount, XRefNumber , Status , BillTo , Reference , DW_CREATED_DATE, DW_MODIFIED_DATE) VALUES ( invoice, customer, obj_id, process_level, due_date, invoice_type, invoice_date, Posting_date, invoice_amt, units_amount, Xref_nbr, COMB.status, Bill_to, COMB.reference, current_timestamp, current_timestamp) WHEN MATCHED AND MGE.InvoiceNumber = COMB.COMB_ID AND CustomerID <> COMB.customer OR InvoiceObjID <> COMB.obj_id OR InvoiceProcessLevel <> COMB.process_level OR DueDate <> COMB.due_date OR InvoiceType <> COMB.invoice_type OR InvoiceDate <> invoice_date OR InvoicePostingDate <> COMB.invoice_date OR InvoiceAmount <> COMB.invoice_amt OR UnitsAmount <> COMB.units_amount OR XRefNumber <> COMB.Xref_nbr OR MGE.STATUS <> COMB.status OR Billto <> COMB.Bill_to OR MGE.reference <> COMB.reference THEN UPDATE SET InvoiceNumber = COMB.invoice, CustomerID = COMB.customer, InvoiceObjID = COMB.obj_id, InvoiceProcessLevel = COMB.process_level, DueDate = COMB.due_date, InvoiceType = COMB.invoice_type, InvoiceDate = invoice_date, InvoicePostingDate = COMB.invoice_date, InvoiceAmount = COMB.invoice_amt, UnitsAmount = COMB.units_amount, XRefNumber = COMB.Xref_nbr, MGE.STATUS = COMB.status, Billto = COMB.Bill_to, MGE.reference = COMB.reference, DW_MODIFIED_DATE = CURRENT_TIMESTAMP;\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n\n\n\n\n  \n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336597":{"id":6336597,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":216,"y":17,"width":32,"height":32,"inputConnectorIDs":[6336599],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_INVOICE_FAILURE"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336599":{"id":6336599,"sourceID":6336596,"targetID":6336597}},"unconditionalConnectors":{"6336598":{"id":6336598,"sourceID":6336595,"targetID":6336596}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_INVOICE","description":"","type":"ORCHESTRATION","tag":"d80ddf6e-f70f-4d57-8fad-981ae4dacbe1"}}