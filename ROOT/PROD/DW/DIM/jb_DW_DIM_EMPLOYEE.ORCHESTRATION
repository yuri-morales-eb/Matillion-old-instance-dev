{"job":{"components":{"6336567":{"id":6336567,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":106,"y":17,"width":32,"height":32,"inputConnectorIDs":[6336571],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_EMPLOYEE_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336568":{"id":6336568,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-224,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336570],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336569":{"id":6336569,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-64,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336570],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336571],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_EMPLOYEE"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"#Option 2 : Executing MERGE Statement and then capturing required information from metadata\n\nfrom datetime import datetime\nfrom pytz import timezone\n\njob_name = 'DW_DIM_EMPLOYEE'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_EMPLOYEE MGE USING(SELECT LDG.CDA_EMPLOYEEID,LDG.CDA_EMPLOYEENUMBER,LDG.CDA_FIRSTNAME,LDG.CDA_LASTNAME,LDG.CDA_ADDRESSHOME_LINE1,LDG.CDA_ADDRESSHOME_LINE2,LDG.CDA_ADDRESSHOME_CITY,MD5('CDA_EMPLOYEECDA_ADDRESSHOME_STATE' ||LDG.CDA_ADDRESSHOME_STATE) AS ADDRESSHOME_STATE_DWLABELID,LDG.CDA_ADDRESSHOME_POSTALCODE,LDG.CDA_ADDRESSMAIL_LINE1,LDG.CDA_ADDRESSMAIL_LINE2,LDG.CDA_ADDRESSMAIL_CITY,MD5('CDA_EMPLOYEECDA_ADDRESSMAIL_STATE' ||LDG.CDA_ADDRESSMAIL_STATE) ADDRESSMAIL_STATE_DWLABELID,LDG.CDA_ADDRESSMAIL_POSTALCODE,LDG.STATECODE,LDG.STATUSCODE,LDG.CDA_BRANCH,LDG.HM_ACCT_UNIT,LDG.CDA_APPLICATIONSTAGE,LDG.CDA_APPLICATIONSUBSTAGE,LDG.CDA_BRANDLEVEL,LDG.CDA_IS1099,LDG.CDA_THIRDPARTY,CASE WHEN LDG.STATUSCODE=754440027 THEN TRUE ELSE FALSE END AS REFERRED FROM (SELECT * FROM(SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_CDA_EMPLOYEEBASE QUALIFY ROW_NUMBER() OVER(PARTITION BY CDA_EMPLOYEEID ORDER BY MODIFIEDON DESC,CREATEDON DESC)=1)EB LEFT OUTER JOIN ${SFDBPROD_DATALAKE}.${SFSCHLAWPROD}.EMPLOYEE E ON EB.CDA_EMPLOYEENUMBER = E.EMPLOYEE)LDG WHERE (DATE_TRUNC('DAY',LDG.MODIFIEDON)>=(SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01')FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_EMPLOYEE)OR DATE_TRUNC('DAY',LDG.CREATEDON)>=(SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_EMPLOYEE))) COMB ON MGE.EMPLOYEEID = COMB.CDA_EMPLOYEEID WHEN NOT MATCHED THEN INSERT (EMPLOYEEID,EMPLOYEENUMBER,FIRSTNAME,LASTNAME,ADDRESSHOME_LINE1,ADDRESSHOME_LINE2,ADDRESSHOME_CITY,ADDRESSHOME_STATE_DW_LABELID, ADDRESSHOME_POSTALCODE,ADDRESSMAIL_LINE1,ADDRESSMAIL_LINE2,ADDRESSMAIL_CITY,ADDRESSMAIL_STATE_DW_LABELID,ADDRESSMAIL_POSTALCODE,STATECODE,EMPLOYMENTSTATUS,BRANCHID,ACCOUNTINGUNITID,APPLICATIONSTATUS,APPLICATIONNEXTSTEPS,BRANDLEVEL,IS_1099STATUS,THIRDPARTYSTATUS,REFERRED,DW_CREATED_DATE,DW_MODIFIED_DATE) VALUES (COMB.CDA_EMPLOYEEID,CDA_EMPLOYEENUMBER,CDA_FIRSTNAME,CDA_LASTNAME,CDA_ADDRESSHOME_LINE1,CDA_ADDRESSHOME_LINE2,CDA_ADDRESSHOME_CITY,ADDRESSHOME_STATE_DWLABELID,CDA_ADDRESSHOME_POSTALCODE,CDA_ADDRESSMAIL_LINE1,CDA_ADDRESSMAIL_LINE2, CDA_ADDRESSMAIL_CITY,ADDRESSMAIL_STATE_DWLABELID ,CDA_ADDRESSMAIL_POSTALCODE,STATECODE,STATUSCODE,CDA_BRANCH,HM_ACCT_UNIT,CDA_APPLICATIONSTAGE,CDA_APPLICATIONSUBSTAGE,CDA_BRANDLEVEL,CDA_IS1099,CDA_THIRDPARTY,REFERRED,CURRENT_TIMESTAMP, CURRENT_TIMESTAMP) WHEN MATCHED THEN UPDATE SET MGE.EMPLOYEENUMBER=COMB.CDA_EMPLOYEENUMBER,MGE.FIRSTNAME=COMB.CDA_FIRSTNAME,MGE.LASTNAME=COMB.CDA_LASTNAME,MGE.ADDRESSHOME_LINE1=COMB.CDA_ADDRESSHOME_LINE1,MGE.ADDRESSHOME_LINE2=COMB.CDA_ADDRESSHOME_LINE2,MGE.ADDRESSHOME_CITY=COMB.CDA_ADDRESSHOME_CITY,MGE.ADDRESSHOME_STATE_DW_LABELID=COMB.ADDRESSHOME_STATE_DWLABELID,MGE.ADDRESSHOME_POSTALCODE=COMB.CDA_ADDRESSHOME_POSTALCODE,MGE.ADDRESSMAIL_LINE1=COMB.CDA_ADDRESSMAIL_LINE1,MGE.ADDRESSMAIL_LINE2=COMB.CDA_ADDRESSMAIL_LINE2,MGE.ADDRESSMAIL_CITY=COMB.CDA_ADDRESSMAIL_CITY,MGE.ADDRESSMAIL_STATE_DW_LABELID=COMB.ADDRESSMAIL_STATE_DWLABELID,MGE.ADDRESSMAIL_POSTALCODE=COMB.CDA_ADDRESSMAIL_POSTALCODE,MGE.STATECODE=COMB.STATECODE,MGE.EMPLOYMENTSTATUS=COMB.STATUSCODE,MGE.BRANCHID=COMB.CDA_BRANCH,MGE.ACCOUNTINGUNITID=COMB.HM_ACCT_UNIT,MGE.APPLICATIONSTATUS=COMB.CDA_APPLICATIONSTAGE,MGE.APPLICATIONNEXTSTEPS=COMB.CDA_APPLICATIONSUBSTAGE,MGE.BRANDLEVEL=COMB.CDA_BRANDLEVEL,MGE.IS_1099STATUS=COMB.CDA_IS1099,MGE.THIRDPARTYSTATUS=COMB.CDA_THIRDPARTY,MGE.REFERRED=COMB.REFERRED,MGE.DW_MODIFIED_DATE=CURRENT_TIMESTAMP\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336571":{"id":6336571,"sourceID":6336569,"targetID":6336567}},"unconditionalConnectors":{"6336570":{"id":6336570,"sourceID":6336568,"targetID":6336569}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_EMPLOYEE","description":"","type":"ORCHESTRATION","tag":"43595dd4-a200-4c74-9e03-ddff8a9e5255"}}