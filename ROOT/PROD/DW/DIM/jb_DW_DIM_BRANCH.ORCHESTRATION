{"job":{"components":{"6336497":{"id":6336497,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-160,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6336451],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_BRANCH_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336498":{"id":6336498,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-480,"y":-48,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336500],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336499":{"id":6336499,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-304,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6336500],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336451],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_BRANCH"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'DW_DIM_BRNACH'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\n\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_BRANCH MGE USING ( SELECT NVL(DIM.BRANCHID,LDG.CDA_BRANCHID) COMB_ID, cda_branchid, md5('cda_branch'||'statecode'||CDA_STATECODE) STATECODE_DWLABELID, md5('cda_branch'||'statuscode'||CDA_STATUSCODE) STATUSCODE_DWLABELID, cda_name, cda_branchno, cda_accountingunitno, cda_areaid, cda_regionid, cda_brand, cda_branchmanager, LDG.cda_LINEOFBUSINESS FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_BRANCH DIM FULL OUTER JOIN (SELECT DISTINCT BB.* ,CASE WHEN commercial = 1 then UPPER('Commercial') WHEN Franchise = 1 then UPPER('Franchise') WHEN Remx = 1 then UPPER('RemX') WHEN (commercial = 0 AND franchise=0 and remx = 0) THEN UPPER(BRANDREF.CRMBRANDNAME) END AS cda_LINEOFBUSINESS FROM ( SELECT cda_branchid,statecode as cda_statecode,statuscode as cda_statuscode, cda_name, cda_branchno, cda_accountingunitno,cda_areaid, cda_regionid,cda_brand, cda_branchmanager, MODIFIEDON,CREATEDON FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_CDA_BRANCHBASE QUALIFY ROW_NUMBER() OVER (PARTITION BY CDA_BRANCHID ORDER BY MODIFIEDON DESC,CREATEDON DESC) = 1 ) BB LEFT OUTER JOIN ( SELECT DISTINCT CDA_BRANCHID, COMMERCIAL, REMX,FRANCHISE FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_BRANCHREF ) BRANCHREF ON BB.cda_branchid = BRANCHREF.CDA_BRANCHID LEFT OUTER JOIN ( SELECT DISTINCT BRANDID,BRANDLEVELDESC,BRANDCD,BRANDDESC,CRMBRANDNAME,CRMBRANDID FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_BRANDREF ) BRANDREF ON BB.cda_brand = BRANDREF.CRMBRANDID AND BB.cda_brand = BRANDREF.CRMBRANDID )LDG ON DIM.BRANCHID = LDG.CDA_BRANCHID WHERE (DATE_TRUNC('DAY',LDG.MODIFIEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_BRANCH ) OR DATE_TRUNC('DAY',LDG.CREATEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_BRANCH ))) COMB ON MGE.BRANCHID = COMB.COMB_ID WHEN NOT MATCHED THEN INSERT(BRANCHID,STATECODE_DW_LABELID,STATUSCODE_DW_LABELID, BRANCH_NAME, BRANCH_NUMBER,ACCTUNITID,AREAID,REGIONID,CRMBRANDID,BRANCH_MANAGER,LINEOFBUSINESS, DW_CREATED_DATE,DW_MODIFIED_DATE) VALUES (cda_branchid,STATECODE_DWLABELID,STATUSCODE_DWLABELID,cda_name,cda_branchno,cda_accountingunitno,cda_areaid,cda_regionid,cda_brand,cda_branchmanager,cda_LINEOFBUSINESS,current_timestamp,current_timestamp) WHEN MATCHED AND MGE.BRANCHID = COMB.COMB_ID AND STATECODE_DW_LABELID <> STATECODE_DWLABELID OR STATUSCODE_DW_LABELID <> STATUSCODE_DWLABELID OR BRANCH_NAME<> cda_name OR BRANCH_NUMBER <> cda_branchno OR ACCTUNITID <> cda_accountingunitno OR AREAID <> cda_areaid OR REGIONID <> cda_regionid OR CRMBRANDID <> cda_brand OR BRANCH_MANAGER <> cda_branchmanager OR LINEOFBUSINESS <> cda_LINEOFBUSINESS THEN UPDATE SET STATECODE_DW_LABELID = STATECODE_DWLABELID, STATUSCODE_DW_LABELID = STATUSCODE_DWLABELID, BRANCH_NAME = cda_name, BRANCH_NUMBER = cda_branchno, ACCTUNITID = cda_accountingunitno, AREAID = cda_areaid, REGIONID = cda_regionid, CRMBRANDID = cda_brand, BRANCH_MANAGER = cda_branchmanager, LINEOFBUSINESS = cda_LINEOFBUSINESS, MGE.DW_MODIFIED_DATE = CURRENT_TIMESTAMP;\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n  \n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336451":{"id":6336451,"sourceID":6336499,"targetID":6336497}},"unconditionalConnectors":{"6336500":{"id":6336500,"sourceID":6336498,"targetID":6336499}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_BRANCH","description":"","type":"ORCHESTRATION","tag":"f59c42c0-31d4-4b30-b87f-11f437e5cfda"}}