{"job":{"components":{"6336589":{"id":6336589,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-400,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6336592],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336593],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_CustomerField"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_DIM_CustomerField'\n\ncontext.updateVariable(\"Job_Name\",job_name)\n\nstart_time = datetime.now(timezone(snowflake_timezone)) \nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CustomerField MGE USING (SELECT DISTINCT NVL(LDG.CDA_CUSTOMERFIELDVALUEID,DIM.CustomerFieldID) COMB_ID ,LDG.CDA_CUSTOMERFIELDVALUEID,LDG.CDA_CUSTOMERFIELDNAME,LDG.CDA_VALUE ,LDG.CDA_ASSIGNMENT ,LDG.STATECODE ,LDG.STATUSCODE,LDG.CREATEDON,LDG.MODIFIEDON,LDG.CDA_SYSTEMFIELDNAME FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CustomerField DIM FULL OUTER JOIN (SELECT DISTINCT * FROM  ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_CDA_CUSTOMERFIELDVALUEBASE SRC QUALIFY ROW_NUMBER() OVER (PARTITION BY CDA_CUSTOMERFIELDVALUEID ORDER BY CREATEDON DESC,MODIFIEDON DESC) = 1 )AS LDG ON DIM.CustomerFieldID = LDG.CDA_CUSTOMERFIELDVALUEID WHERE (DATE_TRUNC('DAY',LDG.CREATEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CustomerField) OR DATE_TRUNC('DAY',LDG.MODIFIEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_MODIFIED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CustomerField))) COMB ON MGE.CustomerFieldID = COMB.CDA_CUSTOMERFIELDVALUEID\t WHEN NOT MATCHED THEN INSERT(CustomerFieldID,CustomerFieldName,CustomerFieldValue,AssignmentId,STATECODE,STATUSCODE ,  CREATEDON ,  MODIFIEDON , CustomerSystemFieldName,DW_CREATED_DATE,  DW_MODIFIED_DATE ) VALUES(CDA_CUSTOMERFIELDVALUEID,CDA_CUSTOMERFIELDNAME,CDA_VALUE,CDA_ASSIGNMENT,COMB.STATECODE,COMB.STATUSCODE,CREATEDON,MODIFIEDON,CDA_SYSTEMFIELDNAME,CURRENT_TIMESTAMP,CURRENT_TIMESTAMP) WHEN MATCHED AND MGE.CustomerFieldID = COMB.COMB_ID AND CustomerFieldID <> CDA_CUSTOMERFIELDVALUEID OR CustomerFieldName <> CDA_CUSTOMERFIELDNAME OR CustomerFieldValue <> CDA_VALUE OR AssignmentId <> CDA_ASSIGNMENT OR MGE.STATECODE <> COMB.STATECODE OR MGE.STATUSCODE <> COMB.STATUSCODE OR CustomerSystemFieldName <> CDA_SYSTEMFIELDNAME THEN UPDATE SET CustomerFieldID = CDA_CUSTOMERFIELDVALUEID , CustomerFieldName = CDA_CUSTOMERFIELDNAME , CustomerFieldValue = CDA_VALUE , AssignmentId = CDA_ASSIGNMENT , MGE.STATECODE = COMB.STATECODE, MGE.STATUSCODE = COMB.STATUSCODE, CustomerSystemFieldName = CDA_SYSTEMFIELDNAME, DW_MODIFIED_DATE = CURRENT_TIMESTAMP \")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336590":{"id":6336590,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-208,"y":-54,"width":32,"height":32,"inputConnectorIDs":[6336593],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_CustomerField_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336591":{"id":6336591,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-560,"y":-48,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336592],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336593":{"id":6336593,"sourceID":6336589,"targetID":6336590}},"unconditionalConnectors":{"6336592":{"id":6336592,"sourceID":6336591,"targetID":6336589}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{"MergeOutput":{"definition":{"name":"MergeOutput","scope":"TASKBATCH","definitions":[{"name":"inserted_cnt","type":"DECIMAL"},{"name":"updated_cnt","type":"DECIMAL"}],"description":"This will stored rows inserted and rows updated via merge statement","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"jb_DW_DIM_CustomerField","description":"","type":"ORCHESTRATION","tag":"35c987cd-f22f-472d-9347-a06a1f6e147e"}}