{"job":{"components":{"6336617":{"id":6336617,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-144,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336620],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336621],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_TRANSACTION_GLTRANS"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_DIM_TRANSACTION_GLTRANS'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION mge USING (SELECT nvl(dim.transactionid, ldg.cda_transactionid) comb_id, cda_origobjid, cda_activity, cda_sourcetype, cda_assignmentid, cda_acctunitid, cda_customerid, cda_glaccountid, cda_employeeid, cda_timecardid, cda_acctcategory, cda_wagecodeid, cda_wagecodename, cda_postingdate, cda_transactiondate, cda_transactionamount, cda_unitsamount, cda_normpostingdate, cda_billableamount, cda_billableunit, cda_unitmeasure, cda_referencetext, cda_globjid, cda_transtype, cda_sourcestatus, cda_rundatetime, cda_fiscalyear, cda_acctperiod, cda_effectivedate, cda_je_type, CDA_InvoiceNumber, CDA_SalesTaxAmount, CDA_TaxableAmount FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION dim FULL OUTER JOIN (SELECT DISTINCT transactionid AS cda_transactionid, origobjid AS cda_origobjid, activity AS cda_activity, sourcetype AS cda_sourcetype, assignmentid AS cda_assignmentid, acctunitid AS cda_acctunitid, customerid AS cda_customerid, glaccountid AS cda_glaccountid, employeeid AS cda_employeeid, timecardid AS cda_timecardid, acctcategory AS cda_acctcategory, wagecodeid AS cda_wagecodeid, wagecodename AS cda_wagecodename, postingdate AS cda_postingdate, transactiondate AS cda_transactiondate, transactionamount AS cda_transactionamount, unitsamount AS cda_unitsamount, normpostingdate AS cda_normpostingdate, billableamount AS cda_billableamount, billableunit AS cda_billableunit, unitmeasure AS cda_unitmeasure, referencetext AS cda_referencetext, globjid AS cda_globjid, transtype AS cda_transtype, sourcestatus AS cda_sourcestatus, rundatetime AS cda_rundatetime, fiscalyear AS cda_fiscalyear, acctperiod AS cda_acctperiod, effectivedate AS cda_effectivedate, je_type AS cda_je_type, InvoiceNumber AS CDA_InvoiceNumber, SalesTaxAmount AS CDA_SalesTaxAmount, TaxableAmount AS CDA_TaxableAmount ,PBCRN FROM (SELECT DISTINCT GL_TRANS_ID AS TransactionID, GLT.SRC_OBJ_ID AS OrigObjID, ACTIVITY_ID AS Activity, GLT.ASSIGNMENTNUMBER, 'GLTRANS' AS SourceType, DA.AssignmentID, ACCT_UNIT_TXT AS AcctUnitID, DA.CUSTOMERID, GLAccountID, DE.EmployeeID, TC. TimeCardID, ACCT_CAT_CD AS AcctCategory, GLT.BILLCODEID AS WageCodeID, GLT.BILLCODEDESC AS WageCodeName, POSTING_DT AS PostingDate, NULL AS TransactionDate, TRAN_AMT AS TransactionAmount, UNITS_AMT AS UnitsAmount, NORM_POSTING_DT AS NormPostingDate, NULL AS BillableAmount, NULL AS BillableUnit, NULL AS UnitMeasure, REF_TXT AS ReferenceText, NULL AS GLObjID, NULL AS TransType, GLT.STATUS AS SourceStatus, NULL AS RunDateTime, FISCAL_YEAR AS FiscalYear, ACCT_PERIOD AS AcctPeriod, EFFECT_DATE AS EffectiveDate, JE_TYPE AS JE_Type, GLT.MODIFIED_DT, GLT.CREATED_DT, NULL AS InvoiceNumber, ACHISTDTL.TAX_AMT AS SalesTaxAmount, ACHISTDTL.TAXABLE_AMT AS TaxableAmount ,row_number() OVER (PARTITION BY GL_TRANS_ID order by GLT.BILLCODEID ASC, GLT.PAYCODEID ASC) AS PBCRN FROM (SELECT DISTINCT GLT.GL_TRANS_ID, GLT.SRC_OBJ_ID, GLT.ACTIVITY_ID, TRIM(REGEXP_REPLACE(GLT.ACTIVITY_ID, '[^[:digit:]]', ' ')) AS ASSIGNMENTNUMBER, GLT.ACCT_UNIT_TXT, TO_VARCHAR(GLT.ACCOUNT_NM) AS GLAccountID, GLT.ACCT_CAT_CD, GLT.POSTING_DT, GLT.TRAN_AMT, GLT.UNITS_AMT, GLT.NORM_POSTING_DT, GLT.REF_TXT, GLT.STATUS, GLT.FISCAL_YEAR, GLT.ACCT_PERIOD, GLT.EFFECT_DATE, GLT.JE_TYPE, GLT.MODIFIED_DT, GLT.CREATED_DT, BILLCODEID, PAYCODEID, billcodedesc FROM ${SNFLKDB}.${SNFLKSCH}.dim_gl_trans GLT LEFT OUTER JOIN (SELECT DISTINCT BILLCODEID, PAYCODEID, billcodedesc FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_PAYBILLCODE ) PBC ON GLT.ACCT_CAT_CD = IFNULL(PBC.BILLCODEID, PBC.PAYCODEID) WHERE DATE_TRUNC('DAY', CREATED_DT) >= (SELECT NVL(MAX(DATE_TRUNC('DAY', DW_CREATED_DATE)), '1900-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION WHERE SOURCETYPE = 'GLTRANS') OR DATE_TRUNC('DAY', MODIFIED_DT) >= (SELECT NVL(MAX(DATE_TRUNC('DAY', DW_CREATED_DATE)), '1900-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION WHERE SOURCETYPE = 'GLTRANS') OR SRC_OBJ_ID IN (SELECT ORIGOBJID FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION WHERE SOURCETYPE = 'GLTRANS' AND SOURCESTATUS <> 9) ) GLT LEFT OUTER JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ASSIGNMENT DA ON DA.ASSIGNMENTNUMBER = GLT.ASSIGNMENTNUMBER LEFT OUTER JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_EMPLOYEE DE ON DA.EMPLOYEEID = DE.EMPLOYEEID LEFT OUTER JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TIMECARD TC ON DA.ASSIGNMENTNUMBER = TC.ASSIGNMENTID AND TC.WEEK_ENDING = GLT.POSTING_DT AND TC.PAYCODEID = GLT.ACCT_CAT_CD AND TC.sourceid = GLT.SRC_OBJ_ID LEFT OUTER JOIN (SELECT ATN_OBJ_ID, obj_id, TAX_AMT, TAXABLE_AMT, row_number() OVER (PARTITION BY ATN_OBJ_ID ORDER BY INVC_AMT DESC) AS ACHISTDTL_RN FROM ${SNFLKDB}.${SNFLKSCH}.Lawson_DL_LDG_achistdtl_ph3 qualify ACHISTDTL_RN = 1) ACHISTDTL ON ACHISTDTL.ATN_OBJ_ID = GLT.SRC_OBJ_ID WHERE NOT EXISTS (SELECT ACT.ACTIVITY FROM ${SNFLKDB}.${SNFLKSCH}.LAWSON_DL_LDG_ACTRANS_PH3 ACT WHERE ACT.ACTIVITY = GLT.ACTIVITY_ID ) ) T WHERE T.PBCRN = 1 ) ldg ON dim.transactionid = ldg.cda_transactionid) comb ON mge.transactionid = comb.comb_id WHEN NOT matched THEN INSERT (transactionid, origobjid, activity, sourcetype, assignmentid, acctunitid, customerid, glaccountid, employeeid, timecardid, acctcategory, wagecodeid, wagecodename, postingdate, transactiondate, transactionamount, unitsamount, normpostingdate, billableamount, billableunit, unitmeasure, referencetext, globjid, transtype, sourcestatus, rundatetime, fiscalyear, acctperiod, effectivedate, je_type, InvoiceNumber, SalesTaxAmount, TaxableAmount, dw_created_date, dw_modified_date) VALUES (comb.comb_id, cda_origobjid, cda_activity, cda_sourcetype, cda_assignmentid, cda_acctunitid, cda_customerid, cast(cda_glaccountid AS varchar(50)), cda_employeeid, cda_timecardid, cda_acctcategory, cda_wagecodeid, cda_wagecodename, cda_postingdate, cda_transactiondate, cda_transactionamount, cda_unitsamount, cda_normpostingdate, cda_billableamount, cda_billableunit, cda_unitmeasure, cda_referencetext, cda_globjid, cda_transtype, cda_sourcestatus, cda_rundatetime, cda_fiscalyear, cda_acctperiod, cda_effectivedate, cda_je_type, CDA_InvoiceNumber, CDA_SalesTaxAmount, CDA_TaxableAmount, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP) WHEN matched AND mge.transactionid = comb.comb_id AND origobjid <> cda_origobjid OR activity <> cda_activity OR sourcetype <> cda_sourcetype OR assignmentid <> cda_assignmentid OR acctunitid <> cda_acctunitid OR customerid <> cda_customerid OR glaccountid <> cast(cda_glaccountid AS varchar(50)) OR employeeid <> cda_employeeid OR timecardid <> cda_timecardid OR acctcategory <> cda_acctcategory OR wagecodeid <> cda_wagecodeid OR wagecodename <> cda_wagecodename OR postingdate <> cda_postingdate OR transactiondate <> cda_transactiondate OR transactionamount <> cda_transactionamount OR unitsamount <> cda_unitsamount OR normpostingdate <> cda_normpostingdate OR billableamount <> cda_billableamount OR billableunit <> cda_billableunit OR unitmeasure <> cda_unitmeasure OR referencetext <> cda_referencetext OR globjid <> cda_globjid OR transtype <> cda_transtype OR sourcestatus <> cda_sourcestatus OR rundatetime <> cda_rundatetime OR fiscalyear <> cda_fiscalyear OR acctperiod <> cda_acctperiod OR effectivedate <> cda_effectivedate OR je_type <> cda_je_type OR InvoiceNumber <> CDA_InvoiceNumber OR SalesTaxAmount <> CDA_SalesTaxAmount OR TaxableAmount <> CDA_TaxableAmount THEN UPDATE SET origobjid = cda_origobjid, activity = cda_activity, sourcetype = cda_sourcetype, assignmentid = cda_assignmentid, acctunitid = cda_acctunitid, customerid = cda_customerid, glaccountid = cast(cda_glaccountid AS varchar(50)), employeeid = cda_employeeid, timecardid = cda_timecardid, acctcategory = cda_acctcategory, wagecodeid = cda_wagecodeid, wagecodename = cda_wagecodename, postingdate = cda_postingdate, transactiondate = cda_transactiondate, transactionamount = cda_transactionamount, unitsamount = cda_unitsamount, normpostingdate = cda_normpostingdate, billableamount = cda_billableamount, billableunit = cda_billableunit, unitmeasure = cda_unitmeasure, referencetext = cda_referencetext, globjid = cda_globjid, transtype = cda_transtype, sourcestatus = cda_sourcestatus, rundatetime = cda_rundatetime, fiscalyear = cda_fiscalyear, acctperiod = cda_acctperiod, effectivedate = cda_effectivedate, je_type = cda_je_type, InvoiceNumber = CDA_InvoiceNumber, SalesTaxAmount = CDA_SalesTaxAmount, TaxableAmount = CDA_TaxableAmount, dw_modified_date = CURRENT_TIMESTAMP\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336618":{"id":6336618,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":80,"y":16,"width":32,"height":32,"inputConnectorIDs":[6336621],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_TRANSACTION_GLTRANS_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336619":{"id":6336619,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-336,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336620],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336621":{"id":6336621,"sourceID":6336617,"targetID":6336618}},"unconditionalConnectors":{"6336620":{"id":6336620,"sourceID":6336619,"targetID":6336617}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_DIM_TRANSACTION_GLTRANS","description":"","type":"ORCHESTRATION","tag":"52e7f508-f9c7-4de0-abee-37310fef73b1"}}