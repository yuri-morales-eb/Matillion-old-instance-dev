{"job":{"components":{"6336573":{"id":6336573,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-560,"y":-48,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336608],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336574":{"id":6336574,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-368,"y":-48,"width":32,"height":32,"inputConnectorIDs":[6336608],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336609],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_Assignment"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_DIM_ASSIGNMENT'\n\ncontext.updateVariable(\"Job_Name\",job_name)\n\nstart_time = datetime.now(timezone(snowflake_timezone)) \nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\ncursor = context.cursor()\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ASSIGNMENT MGE USING ( SELECT LDG.CDA_ASSIGNMENTID , LDG.CDA_REPORTSTOID , LDG.CDA_WCCODE , LDG.CDA_FILLEDBYID , LDG.CREATEDON AS CDA_CREATEDON , LDG.MODIFIEDON AS CDA_MODIFIEDON , md5('cda_assignmentstatecode'||LDG.STATECODE) STATECODE_DWLABELID , md5('cda_assignmentstatuscode'||LDG.STATUSCODE) STATUSCODE_DWLABELID , LDG.CDA_ACTUALENDDATE , LDG.CDA_ASSIGNMENTNUMBER , LDG.CDA_BACKOFFICEFLAG , LDG.CDA_ESTIMATEDENDDATE , LDG.CDA_REASONLEFT , LDG.CDA_REPLACEMENT , md5('cda_assignmentcda_replacementreason'||CDA_REPLACEMENTREASON) CDA_REPLACEMENTREASON_DWLABELID , LDG.CDA_REPLACEMENTREQUIRED , LDG.CDA_STARTDATE , LDG.CDA_ACCOUNTID , LDG.CDA_ACCOUNTINGUNITID , LDG.CDA_EMPLOYEEID , LDG.CDA_JOBORDER , LDG.CDA_SHIFTID , LDG.CDA_STAFFINGSUPERVISORID , LDG.CDA_APPROVERID , LDG.CDA_DEPARTMENTID , LDG.CDA_JOBCODEID , md5('cda_assignmentcda_assignmenttype'||LDG.CDA_ASSIGNMENTTYPE) CDA_ASSIGNMENTTYPE_DWLABELID , LDG.CDA_BACKOFFICEMODIFIEDON , LDG.CDA_BADGENUMBER , LDG.CDA_JOBTITLE , LDG.CDA_PONUMBER , LDG.OWNERID AS CDA_OWNERID , LDG.CDA_ASSIGNMENTTYPE , LDG.CDA_OTMULTIPLIER , LDG.CDA_DTMULTIPLIER FROM ( SELECT * FROM ${SNFLKDB}.${SNFLKSCH}.CRM_DL_LDG_CDA_ASSIGNMENTBASE QUALIFY ROW_NUMBER() OVER (PARTITION BY CDA_ASSIGNMENTID ORDER BY MODIFIEDON DESC,CREATEDON DESC) = 1 )LDG where (DATE_TRUNC('DAY',LDG.MODIFIEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ASSIGNMENT) OR DATE_TRUNC('DAY',LDG.CREATEDON)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ASSIGNMENT) )) COMB ON MGE.ASSIGNMENTID = COMB.CDA_ASSIGNMENTID WHEN NOT MATCHED THEN INSERT (ASSIGNMENTID,REPORTSTOID,WCCODEID,FILLEDBYID,CREATEDON,MODIFIEDON,STATECODE_DW_LABELID,STATUSCODE_DW_LABELID,ACTUALENDDATE,ASSIGNMENTNUMBER, BACKOFFICEFLAG ,ESTIMATEDENDDATE, ASSIGNMENTENDREASONID,REPLACEMENT,REPLACEMENTREASON_DW_LABELID,REPLACEMENTREQUIRED,STARTDATE,CUSTOMERID,BRANCHID, EMPLOYEEID,JOBORDERID,SHIFTID, STAFFINGSUPERVISORID,APPROVERID,DEPARTMENTID,JOBCODEID,ASSIGNMENTTYPE_DW_LABELID,BACKOFFICEMODIFIEDON, BADGENUMBER,JOBTITLE ,PONUMBER,SALESREPID,ASSIGNMENTTYPE,OTMULTIPLIER,DTMULTIPLIER, DW_CREATED_DATE,DW_MODIFIED_DATE) VALUES (COMB.CDA_ASSIGNMENTID,CDA_REPORTSTOID,CDA_WCCODE,CDA_FILLEDBYID,CDA_CREATEDON,CDA_MODIFIEDON,STATECODE_DWLABELID,STATUSCODE_DWLABELID, TO_DATE(CDA_ACTUALENDDATE), CDA_ASSIGNMENTNUMBER,CDA_BACKOFFICEFLAG,TO_DATE(CDA_ESTIMATEDENDDATE), CDA_REASONLEFT,CDA_REPLACEMENT, CDA_REPLACEMENTREASON_DWLABELID,CDA_REPLACEMENTREQUIRED,TO_DATE(CDA_STARTDATE),CDA_ACCOUNTID,CDA_ACCOUNTINGUNITID,CDA_EMPLOYEEID, CDA_JOBORDER,CDA_SHIFTID,CDA_STAFFINGSUPERVISORID,CDA_APPROVERID,CDA_DEPARTMENTID,CDA_JOBCODEID,CDA_ASSIGNMENTTYPE_DWLABELID, CDA_BACKOFFICEMODIFIEDON, CDA_BADGENUMBER,CDA_JOBTITLE,CDA_PONUMBER,CDA_OWNERID,CDA_ASSIGNMENTTYPE, CDA_OTMULTIPLIER, CDA_DTMULTIPLIER, current_timestamp,current_timestamp) WHEN MATCHED AND MGE.ASSIGNMENTID = COMB.CDA_ASSIGNMENTID AND REPORTSTOID <> COMB.CDA_REPORTSTOID OR WCCODEID <> COMB.CDA_WCCODE OR FILLEDBYID <> COMB.CDA_FILLEDBYID OR CREATEDON <> COMB.CDA_CREATEDON OR MODIFIEDON <> COMB.CDA_MODIFIEDON OR STATECODE_DW_LABELID <> COMB.STATECODE_DWLABELID OR STATUSCODE_DW_LABELID <> COMB.STATUSCODE_DWLABELID OR ASSIGNMENTNUMBER <> COMB.CDA_ASSIGNMENTNUMBER OR BACKOFFICEFLAG <> COMB.CDA_BACKOFFICEFLAG OR ASSIGNMENTENDREASONID <> COMB.CDA_REASONLEFT OR REPLACEMENT <> COMB.CDA_REPLACEMENT OR REPLACEMENTREASON_DW_LABELID <> COMB.CDA_REPLACEMENTREASON_DWLABELID OR REPLACEMENTREQUIRED <> COMB.CDA_REPLACEMENTREQUIRED OR CUSTOMERID <> COMB.CDA_ACCOUNTID OR BRANCHID <> COMB.CDA_ACCOUNTINGUNITID OR EMPLOYEEID <> COMB.CDA_EMPLOYEEID OR JOBORDERID <> COMB.CDA_JOBORDER OR SHIFTID <> COMB.CDA_SHIFTID OR STAFFINGSUPERVISORID <> COMB.CDA_STAFFINGSUPERVISORID OR APPROVERID <> COMB.CDA_APPROVERID OR DEPARTMENTID <> COMB.CDA_DEPARTMENTID OR JOBCODEID <> COMB.CDA_JOBCODEID OR ASSIGNMENTTYPE_DW_LABELID <> COMB.CDA_ASSIGNMENTTYPE_DWLABELID OR BACKOFFICEMODIFIEDON <> COMB.CDA_BACKOFFICEMODIFIEDON OR STARTDATE <> TO_DATE(COMB.CDA_STARTDATE) OR ACTUALENDDATE <> TO_DATE(COMB.CDA_ACTUALENDDATE) OR ESTIMATEDENDDATE <> TO_DATE(COMB.CDA_ESTIMATEDENDDATE) OR BADGENUMBER <> CDA_BADGENUMBER OR JOBTITLE <> CDA_JOBTITLE OR PONUMBER <> CDA_PONUMBER OR SALESREPID <> CDA_OWNERID OR ASSIGNMENTTYPE <> CDA_ASSIGNMENTTYPE OR OTMULTIPLIER <> CDA_OTMULTIPLIER OR DTMULTIPLIER <> CDA_DTMULTIPLIER THEN UPDATE SET MGE.REPORTSTOID = COMB.CDA_REPORTSTOID, MGE.WCCODEID = COMB.CDA_WCCODE, MGE.FILLEDBYID = COMB.CDA_FILLEDBYID, MGE.CREATEDON = COMB.CDA_CREATEDON, MGE.MODIFIEDON = COMB.CDA_MODIFIEDON, MGE.STATECODE_DW_LABELID = COMB.STATECODE_DWLABELID, MGE.STATUSCODE_DW_LABELID = COMB.STATUSCODE_DWLABELID, MGE.ASSIGNMENTNUMBER = COMB.CDA_ASSIGNMENTNUMBER, MGE.BACKOFFICEFLAG = COMB.CDA_BACKOFFICEFLAG, MGE.ASSIGNMENTENDREASONID = COMB.CDA_REASONLEFT, MGE.REPLACEMENT = COMB.CDA_REPLACEMENT, MGE.REPLACEMENTREASON_DW_LABELID = COMB.CDA_REPLACEMENTREASON_DWLABELID, MGE.REPLACEMENTREQUIRED = COMB.CDA_REPLACEMENTREQUIRED, MGE.CUSTOMERID = COMB.CDA_ACCOUNTID, MGE.BRANCHID = COMB.CDA_ACCOUNTINGUNITID, MGE.EMPLOYEEID = COMB.CDA_EMPLOYEEID, MGE.JOBORDERID = COMB.CDA_JOBORDER, MGE.SHIFTID = COMB.CDA_SHIFTID, MGE.STAFFINGSUPERVISORID = COMB.CDA_STAFFINGSUPERVISORID, MGE.APPROVERID = COMB.CDA_APPROVERID, MGE.DEPARTMENTID = COMB.CDA_DEPARTMENTID, MGE.JOBCODEID = COMB.CDA_JOBCODEID, MGE.ASSIGNMENTTYPE_DW_LABELID = COMB.CDA_ASSIGNMENTTYPE_DWLABELID, MGE.BACKOFFICEMODIFIEDON = COMB.CDA_BACKOFFICEMODIFIEDON, MGE.STARTDATE = TO_DATE(COMB.CDA_STARTDATE), MGE.ACTUALENDDATE = TO_DATE(COMB.CDA_ACTUALENDDATE), MGE.ESTIMATEDENDDATE = TO_DATE(COMB.CDA_ESTIMATEDENDDATE), MGE.BADGENUMBER = COMB.CDA_BADGENUMBER, MGE.JOBTITLE = COMB.CDA_JOBTITLE, MGE.PONUMBER = COMB.CDA_PONUMBER, MGE.SALESREPID = COMB.CDA_OWNERID, MGE.ASSIGNMENTTYPE = COMB.CDA_ASSIGNMENTTYPE, MGE.OTMULTIPLIER = COMB.CDA_OTMULTIPLIER, MGE.DTMULTIPLIER = COMB.CDA_DTMULTIPLIER, MGE.DW_MODIFIED_DATE = current_timestamp\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336575":{"id":6336575,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-208,"y":-54,"width":32,"height":32,"inputConnectorIDs":[6336609],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DIM_ASSIGNMENT_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"cursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLKDB}' AS SOURCEDB_NAME ,'${SNFLKSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (Job_Name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336609":{"id":6336609,"sourceID":6336574,"targetID":6336575}},"unconditionalConnectors":{"6336608":{"id":6336608,"sourceID":6336573,"targetID":6336574}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{"MergeOutput":{"definition":{"name":"MergeOutput","scope":"TASKBATCH","definitions":[{"name":"inserted_cnt","type":"DECIMAL"},{"name":"updated_cnt","type":"DECIMAL"}],"description":"This will stored rows inserted and rows updated via merge statement","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"jb_DW_DIM_ASSIGNMENT","description":"","type":"ORCHESTRATION","tag":"1ea52938-086d-4d26-9f20-cefb41c40d4e"}}