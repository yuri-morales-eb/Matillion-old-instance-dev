{"job":{"components":{"6336647":{"id":6336647,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-240,"y":-80,"width":32,"height":32,"inputConnectorIDs":[6336672],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"FACT_SALES_Failure"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\njob_name = 'DW_FACT_SALES'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\n\ncursor = context.cursor()\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS(JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS)  select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLDWHDB}' AS SOURCEDB_NAME ,'${SNFLDWHSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,0 AS ROWS_INSERTED ,0 AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'FAILURE' AS JOB_STATUS\" % (job_name,Job_StartTimeStamp))\t\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336648":{"id":6336648,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-624,"y":-80,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[6336650],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"6336649":{"id":6336649,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-432,"y":-80,"width":32,"height":32,"inputConnectorIDs":[6336650],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[6336672],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Status","mapTo":"audit_status"},"2":{"slot":2,"fromId":null,"fromName":"Component","mapTo":"audit_component"},"3":{"slot":3,"fromId":null,"fromName":"Started At","mapTo":"audit_started"},"4":{"slot":4,"fromId":null,"fromName":"Duration","mapTo":"audit_duration"},"5":{"slot":5,"fromId":null,"fromName":"Completed At","mapTo":"audit_completed"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"FACT_SALES"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"from datetime import datetime\nfrom pytz import timezone\n\n\njob_name = 'DW_FACT_SALES'\ncontext.updateVariable(\"Job_Name\",job_name)\n\nfmt = \"%Y-%m-%d %H:%M:%S\"\nCurrentTime = datetime.now(timezone(snowflake_timezone))\ncontext.updateVariable(\"Job_StartTimeStamp\",CurrentTime.strftime(fmt))\n\ncursor = context.cursor()\ncursor.execute(\"use warehouse ${SNFLKWH_FACT};\")\ncursor.execute(\"alter warehouse ${SNFLKWH_FACT} resume if suspended;\")\ncursor.execute(\"alter warehouse ${SNFLKWH_FACT} set warehouse_size='X-LARGE';\")\ncursor.execute(\"TRUNCATE TABLE ${SNFLDWHDB}.${SNFLDWHSCH}.FACT_SALES;\")\n\ncursor.execute(\"MERGE INTO ${SNFLDWHDB}.${SNFLDWHSCH}.FACT_SALES MGE USING ( SELECT DISTINCT NVL(LDG.CUSTOMERID,FCT.CUSTOMERID) COMB_ID ,LDG.CUSTOMERID ,LDG.CRMBRANDID ,LDG.BRANCHID ,LDG.ACCTUNITID ,LDG.POSTINGDATE ,LDG.ACCTUNITNAME ,LDG.CUSTOMERNUMBER ,LDG.NAME ,LDG.LOCATIONID ,LDG.LOCATIONNAME ,LDG.NORMPOSTINGDATE ,LDG.BILLABLEUNIT ,LDG.BILLHOURS ,LDG.CONVERTFACTOR ,LDG.PAYHOURS ,LDG.PAYUNITS ,(LDG.REVENUEAMOUNT-LDG.COSTAMOUNT) AS GROSSPROFITAMOUNT ,LDG.REVENUEAMOUNT ,LDG.PAYAMOUNT ,LDG.COSTAMOUNT ,LDG.FIRSTBILLDATE ,LDG.LASTBILLDATE ,LDG.AOA ,LDG.TOTALHEADCOUNT ,LDG.CRMPARENTCUSTOMERID ,LDG.CRMPARENTCUSTOMERNAME ,LDG.DIM_ASSIGNMENT_DW_CREATED_DATE ,LDG.DIM_ASSIGNMENT_DW_MODIFIED_DATE FROM ${SNFLDWHDB}.${SNFLDWHSCH}.FACT_SALES FCT FULL OUTER JOIN ( SELECT DISTINCT DIM_ASSIGNMENT.CUSTOMERID ,DIM_BRANCH.CRMBRANDID ,DIM_ASSIGNMENT.BRANCHID ,DIM_TRANSACTION.ACCTUNITID ,DIM_TRANSACTION.POSTINGDATE ,DIM_ACCT_UNIT.ACCTUNITNAME ,DIM_CUSTOMER.CUSTOMERNUMBER ,DIM_CUSTOMER.NAME ,DIM_LOCATION.LOCATIONID ,DIM_LOCATION.LOCATIONNAME ,DIM_TRANSACTION.NORMPOSTINGDATE ,SUM(DIM_TRANSACTION.BILLABLEUNIT) AS BILLABLEUNIT ,CASE WHEN UPPER(DIM_PAYBILLCODE.UNITTYPE) = 'HOUR' THEN SUM(DIM_TRANSACTION.BILLABLEUNIT) ELSE 0 END AS BILLHOURS ,DIM_PAYBILLCODE.CONVERTFACTOR ,CASE WHEN DIM_GLACCOUNTTYPE.WAGES = TRUE THEN SUM(DIM_TRANSACTION.UNITSAMOUNT) ELSE 0 END AS PAYHOURS ,CASE WHEN DIM_GLACCOUNTTYPE.WAGES = TRUE THEN SUM(DIM_TRANSACTION.UNITSAMOUNT) ELSE 0 END AS PAYUNITS ,CASE WHEN DIM_GLACCOUNTTYPE.TOTALCOSTOFSALES = TRUE THEN SUM(DIM_TRANSACTION.TRANSACTIONAMOUNT) ELSE 0 END AS REVENUEAMOUNT ,CASE WHEN DIM_GLACCOUNTTYPE.WAGES = TRUE THEN SUM(DIM_TRANSACTION.TRANSACTIONAMOUNT) ELSE 0 END AS PAYAMOUNT ,CASE WHEN DIM_GLACCOUNTTYPE.TOTALCOSTOFSALES = TRUE THEN SUM(DIM_TRANSACTION.TRANSACTIONAMOUNT) ELSE 0 END AS COSTAMOUNT ,MIN(DIM_TRANSACTION.POSTINGDATE) AS FIRSTBILLDATE ,MAX(DIM_TRANSACTION.POSTINGDATE) AS LASTBILLDATE ,COUNT(DISTINCT DIM_TRANSACTION.EMPLOYEEID) AS AOA ,CASE WHEN DIM_PAYBILLCODE.BILLEDWORKEDHOUR = 'TRUE' THEN COUNT(DISTINCT DIM_TRANSACTION.EMPLOYEEID) ELSE 0 END AS TOTALHEADCOUNT,DIM_CUSTOMER_HIERARCHY.CRMPARENTCUSTOMERID ,DIM_CUSTOMER_HIERARCHY.CRMPARENTCUSTOMERNAME ,DIM_ASSIGNMENT.DW_CREATED_DATE AS DIM_ASSIGNMENT_DW_CREATED_DATE ,DIM_ASSIGNMENT.DW_MODIFIED_DATE AS DIM_ASSIGNMENT_DW_MODIFIED_DATE FROM ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ASSIGNMENT DIM_ASSIGNMENT JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_TRANSACTION DIM_TRANSACTION ON DIM_ASSIGNMENT.ASSIGNMENTID = DIM_TRANSACTION.ASSIGNMENTID JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_GLACCOUNTTYPE DIM_GLACCOUNTTYPE ON DIM_TRANSACTION.GLACCOUNTID = DIM_GLACCOUNTTYPE.GLACCOUNTID JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_BRANCH DIM_BRANCH ON DIM_ASSIGNMENT.BRANCHID = DIM_BRANCH.BRANCHID JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_ACCT_UNIT DIM_ACCT_UNIT ON DIM_TRANSACTION.ACCTUNITID = DIM_ACCT_UNIT.ACCTUNITID JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CUSTOMER DIM_CUSTOMER ON DIM_ASSIGNMENT.CUSTOMERID = DIM_CUSTOMER.CUSTOMERID JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_JOBORDER DIM_JOBORDER ON DIM_JOBORDER.JOBORDERID = DIM_ASSIGNMENT.JOBORDERID JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_LOCATION DIM_LOCATION ON DIM_LOCATION.LOCATIONID = DIM_JOBORDER.WORKLOCATIONID LEFT OUTER JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_PAYBILLCODE DIM_PAYBILLCODE ON DIM_TRANSACTION.ACCTCATEGORY = IFNULL(DIM_PAYBILLCODE.BILLCODEID,DIM_PAYBILLCODE.PAYCODEID) JOIN ${SNFLDWHDB}.${SNFLDWHSCH}.DIM_CUSTOMER_HIERARCHY DIM_CUSTOMER_HIERARCHY ON DIM_CUSTOMER.CUSTOMERID = DIM_CUSTOMER_HIERARCHY.CUSTOMERID GROUP BY DIM_ASSIGNMENT.CUSTOMERID ,DIM_ASSIGNMENT.BRANCHID ,DIM_TRANSACTION.ACCTUNITID ,DIM_TRANSACTION.POSTINGDATE ,DIM_TRANSACTION.NORMPOSTINGDATE ,DIM_GLACCOUNTTYPE.WAGES ,DIM_GLACCOUNTTYPE.TOTALCOSTOFSALES ,DIM_BRANCH.CRMBRANDID ,DIM_ACCT_UNIT.ACCTUNITNAME ,DIM_CUSTOMER.CUSTOMERNUMBER ,DIM_CUSTOMER.NAME ,DIM_LOCATION.LOCATIONID ,DIM_LOCATION.LOCATIONNAME ,DIM_PAYBILLCODE.UNITTYPE ,DIM_PAYBILLCODE.CONVERTFACTOR ,DIM_CUSTOMER_HIERARCHY.CRMPARENTCUSTOMERID ,DIM_CUSTOMER_HIERARCHY.CRMPARENTCUSTOMERNAME ,DIM_PAYBILLCODE.BILLEDWORKEDHOUR , DIM_ASSIGNMENT.DW_CREATED_DATE ,DIM_ASSIGNMENT.DW_MODIFIED_DATE )AS LDG ON LDG.CUSTOMERID = FCT.CUSTOMERID AND (DATE_TRUNC('DAY',LDG.DIM_ASSIGNMENT_DW_CREATED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.FACT_SALES) OR DATE_TRUNC('DAY',LDG.DIM_ASSIGNMENT_DW_MODIFIED_DATE)>= (SELECT NVL(MAX(DATE_TRUNC('DAY',DW_CREATED_DATE)),'2000-01-01') FROM ${SNFLDWHDB}.${SNFLDWHSCH}.FACT_SALES )) ) COMB ON MGE.CUSTOMERID = COMB.COMB_ID WHEN NOT MATCHED THEN INSERT(CUSTOMERID,BRANDID,BRANCHID,ACCTUNITID,POSTINGDATE,ACCTUNITNAME,CUSTOMERNUMBER,CUSTOMERNAME,LOCATIONID,LOCATIONNAME,NORMPOSTINGDATE,BILLEDUNITS,BILLHOURS,CONVERTEDBILLEDHOURS, PAYHOURS,PAYUNITS,GROSSPROFITAMOUNT,REVENUEAMOUNT,PAYAMOUNT,COSTAMOUNT,FIRSTBILLDATE,LASTBILLDATE,AOA,TOTALHEADCOUNT,PARENTCUSTOMERID,PARENTCUSTOMERNAME,DW_CREATED_DATE,DW_MODIFIED_DATE) VALUES (CUSTOMERID,CRMBRANDID,BRANCHID,ACCTUNITID,POSTINGDATE,ACCTUNITNAME,CUSTOMERNUMBER,NAME,LOCATIONID,LOCATIONNAME,NORMPOSTINGDATE,BILLABLEUNIT,BILLHOURS,CONVERTFACTOR, PAYHOURS,PAYUNITS,GROSSPROFITAMOUNT,REVENUEAMOUNT,PAYAMOUNT,COSTAMOUNT,FIRSTBILLDATE,LASTBILLDATE,AOA,TOTALHEADCOUNT,CRMPARENTCUSTOMERID,CRMPARENTCUSTOMERNAME,current_timestamp,current_timestamp) WHEN MATCHED AND MGE.CUSTOMERID = COMB.COMB_ID OR MGE.CUSTOMERID <> COMB.CUSTOMERID OR MGE.BRANDID <> COMB.CRMBRANDID OR MGE.BRANCHID <> COMB.BRANCHID OR MGE.ACCTUNITID <> COMB.ACCTUNITID OR MGE.POSTINGDATE <> COMB.POSTINGDATE OR MGE.ACCTUNITNAME <> COMB.ACCTUNITNAME OR MGE.CUSTOMERNUMBER <> COMB.CUSTOMERNUMBER OR MGE.CUSTOMERNAME <> COMB.NAME OR MGE.LOCATIONID <> COMB.LOCATIONID OR MGE.LOCATIONNAME <> COMB.LOCATIONNAME OR MGE.NORMPOSTINGDATE <> COMB.NORMPOSTINGDATE OR MGE.BILLEDUNITS <> COMB.BILLABLEUNIT OR MGE.BILLHOURS <> COMB.BILLHOURS OR MGE.CONVERTEDBILLEDHOURS <> COMB.CONVERTFACTOR OR MGE.PAYHOURS <> COMB.PAYHOURS OR MGE.PAYUNITS <> COMB.PAYUNITS OR MGE.GROSSPROFITAMOUNT <> COMB.GROSSPROFITAMOUNT OR MGE.REVENUEAMOUNT <> COMB.REVENUEAMOUNT OR MGE.PAYAMOUNT <> COMB.PAYAMOUNT OR MGE.COSTAMOUNT <> COMB.COSTAMOUNT OR MGE.FIRSTBILLDATE <> COMB.FIRSTBILLDATE OR MGE.LASTBILLDATE <> COMB.LASTBILLDATE OR MGE.AOA <> COMB.AOA OR MGE.TOTALHEADCOUNT <> COMB.TOTALHEADCOUNT OR MGE.PARENTCUSTOMERID <> COMB.CRMPARENTCUSTOMERID OR MGE.PARENTCUSTOMERNAME <> COMB.CRMPARENTCUSTOMERNAME THEN UPDATE SET MGE.CUSTOMERID = COMB.CUSTOMERID , MGE.BRANDID = COMB.CRMBRANDID , MGE.BRANCHID = COMB.BRANCHID , MGE.ACCTUNITID = COMB.ACCTUNITID , MGE.POSTINGDATE = COMB.POSTINGDATE , MGE.ACCTUNITNAME = COMB.ACCTUNITNAME , MGE.CUSTOMERNUMBER = COMB.CUSTOMERNUMBER , MGE.CUSTOMERNAME = COMB.NAME , MGE.LOCATIONID = COMB.LOCATIONID , MGE.LOCATIONNAME = COMB.LOCATIONNAME , MGE.NORMPOSTINGDATE = COMB.NORMPOSTINGDATE , MGE.BILLEDUNITS = COMB.BILLABLEUNIT , MGE.BILLHOURS = COMB.BILLHOURS , MGE.CONVERTEDBILLEDHOURS = COMB.CONVERTFACTOR , MGE.PAYHOURS = COMB.PAYHOURS , MGE.PAYUNITS = COMB.PAYUNITS , MGE.GROSSPROFITAMOUNT = COMB.GROSSPROFITAMOUNT , MGE.REVENUEAMOUNT = COMB.REVENUEAMOUNT , MGE.PAYAMOUNT = COMB.PAYAMOUNT , MGE.COSTAMOUNT = COMB.COSTAMOUNT , MGE.FIRSTBILLDATE = COMB.FIRSTBILLDATE , MGE.LASTBILLDATE = COMB.LASTBILLDATE , MGE.AOA = COMB.AOA , MGE.TOTALHEADCOUNT = COMB.TOTALHEADCOUNT , MGE.PARENTCUSTOMERID = COMB.CRMPARENTCUSTOMERID , MGE.PARENTCUSTOMERNAME = COMB.CRMPARENTCUSTOMERNAME;\")\ncursor.execute(\"INSERT INTO ${SNFLDWHDB}.${SNFLDWHSCH}.AUDIT_METRICS (JOB_NAME,USER_NAME,SOURCEDB_NAME,SOURCESCHEMA_NAME,DESTINATIONDB_NAME,DESTINATIONSCHEMA_NAME,ROWS_INSERTED, ROWS_UPDATED, START_DATE, END_DATE,JOB_STATUS) WITH CTE (Rows_Inserted,Rows_Updated) AS (SELECT * FROM TABLE(RESULT_SCAN(LAST_QUERY_ID()))) select '%s' AS JOB_NAME ,CURRENT_USER() AS USER_NAME ,'${SNFLDWHDB}' AS SOURCEDB_NAME ,'${SNFLDWHSCH}' AS SOURCESCHEMA_NAME ,'${SNFLDWHDB}' AS DESTINATIONDB_NAME ,'${SNFLDWHSCH}' AS DESTINATIONSCHEMA_NAME ,CTE.Rows_Inserted AS ROWS_INSERTED ,CTE.Rows_Updated AS ROWS_UPDATED ,'%s' AS START_DATE ,CURRENT_TIMESTAMP() AS END_DATE ,'SUCCESS' AS JOB_STATUS FROM CTE\" % (job_name,Job_StartTimeStamp))\t\n\n\n\ncursor.execute(\"alter warehouse ${SNFLKWH_FACT} set warehouse_size='SMALL';\")\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{"6336672":{"id":6336672,"sourceID":6336649,"targetID":6336647}},"unconditionalConnectors":{"6336650":{"id":6336650,"sourceID":6336648,"targetID":6336649}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"jb_DW_FACT_SALES","description":"","type":"ORCHESTRATION","tag":"3e51fe2f-7763-490e-8e16-984d9d7812fb"}}