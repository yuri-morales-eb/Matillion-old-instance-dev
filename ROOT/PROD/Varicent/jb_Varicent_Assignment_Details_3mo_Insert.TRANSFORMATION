{"job":{"components":{"6342893":{"id":6342893,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":432,"y":240,"width":32,"height":32,"inputConnectorIDs":[6342897],"outputConnectorIDs":[6342896],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Audit"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CURRENT_TIMESTAMP"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_DATE"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"CURRENT_USER"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_BY"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"${run_history_id}"},"2":{"slot":2,"type":"STRING","value":"DL_JOBID"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"'Y'"},"2":{"slot":2,"type":"STRING","value":"ACTIVE_FLAG"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6342894":{"id":6342894,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":144,"y":240,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6342897],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"3mo Export"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH WEEKLY_CUST AS (\n\tSELECT DISTINCT B.SEARCH_NAME AS CUSTOMER_NAME\n\t\t,A.ACTIVE_STATUS ACTIVITY_STATUS\n\t\t,ACTIVITY_TXT\n\t\t,TRY_TO_NUMBER(LEVEL_DETAIL_02) AS CUSTOMER\n\tFROM DATALAKE.PUBLIC.DIM_ACTIVITY A\n    LEFT JOIN (\n\t\tSELECT A.*\n\t\tFROM \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" A\n\t\tINNER JOIN (\n\t\t\tSELECT DISTINCT CUSTOMER,COUNT(CUSTOMER)\n\t\t\tFROM \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\"\n\t\t\tGROUP BY CUSTOMER\n\t\t\tHAVING COUNT(CUSTOMER) = 1\n\t\t\t) B ON A.CUSTOMER = B.CUSTOMER\n\t\tUNION ALL\n\t\tSELECT A.*\n\t\tFROM \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" A\n\t\tINNER JOIN (\n\t\t\tSELECT DISTINCT CUSTOMER,COUNT(CUSTOMER)\n\t\t\tFROM \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\"\n\t\t\tGROUP BY CUSTOMER\n\t\t\tHAVING COUNT(CUSTOMER) > 1\n\t\t\t) B ON A.CUSTOMER = B.CUSTOMER\n\t\tWHERE A.COMPANY = 2\n\t\t) B ON TRY_TO_NUMBER(A.LEVEL_DETAIL_02) = B.CUSTOMER\n\tWHERE A.ACTIVE_STATUS = 'Y'\n\t)\n\t\n,PREP1 AS (\n\tSELECT TR.ACTIVITY\n\t\t,TR.ACCT_UNIT_TXT\n\t\t,CASE WHEN TR.ACCOUNT_NM IN (4100 ,4200 ,4600 ,4900 ,2660 ,4800 ,4750 ,4950 ,4525)\n\t\t\tTHEN - 1 * TR.TRAN_AMT\n\t\t\tELSE 0\n\t\t\tEND AS BILLABLE_AMT\n\t\t,CASE WHEN TR.ACCOUNT_NM IN (5100 ,5950 ,5525 ,6120 ,5520 ,5515)\n\t\t\tOR (TR.ACCOUNT_NM IN (5900) AND TR.UNITS_AMOUNT <> 0)\n\t\t\tTHEN TR.TRAN_AMT\n\t\t\tELSE 0.00\n\t\t\tEND PAY_AMT\n\t\t,CASE WHEN TR.ACCOUNT_NM IN (5310 ,5320 ,5330 ,6811 ,6812 ,5800 ,5400 ,5410 ,5500 ,5501 ,5510 ,5530 ,5910)\n\t\t\tOR (TR.ACCOUNT_NM IN (5400) AND TR.ACCT_CAT_CD = 'XWHC')\n\t\t\tOR (TR.ACCOUNT_NM IN (5900) AND TR.UNITS_AMOUNT = 0)\n\t\t\tTHEN TR.TRAN_AMT\n\t\t\tELSE 0\n\t\t\tEND BURDEN\n\t\t,TR.ACCOUNT_NM\n\t\t,TR.TRAN_AMT\n\t\t,TR.ACCT_CAT_CD\n\t\t,CASE WHEN TR.ACCT_CAT_CD = '51RW'\n\t\t\tTHEN TR.UNITS_AMOUNT\n\t\t\tELSE TR.BILLABLE_UNIT\n\t\t\tEND AS BILLABLE_UNIT_NEW\n\t\t,CASE WHEN TR.ACCT_CAT_CD = '51RW'\n\t\t\tTHEN TR.BILLABLE_UNIT\n\t\t\tELSE TR.UNITS_AMOUNT\n\t\t\tEND AS UNITS_AMOUNT_NEW\n\t\t,TR.NORM_POSTING_DT AS NORM_POST_DATE\n\t\t,CUST.CUSTOMER\n\t\t,CUST.CUSTOMER_NAME\n\t\t,CUST.ACTIVITY_STATUS\n\t\t,IFF(BR.BRAND_VAL_TXT IS NULL, 'UB', BRAND_VAL_TXT) AS BRANDLEVEL\n\t\t,K.CONV_FACTOR_VAL_TXT\n\t\t,MAX(TR.POSTING_DT) OVER (PARTITION BY CUSTOMER ORDER BY TR.POSTING_DT) AS BILL_DATE\n\t\t,COALESCE(VIP.INTERVAL_START_3_MONTH, LAG(VIP.INTERVAL_START_3_MONTH, 1) \n\t\t\tIGNORE NULLS OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT)) AS VIP_INTERVAL_START_3_MONTH \n\t\t,VIP.PREV_INTERVAL_START_3_MONTH as VIP_PREV_INTERVAL_START_3_MONTH\n\t\t,COALESCE(\n\t\t\tLEAD(VIP.INTERVAL_START_3_MONTH, 1) IGNORE NULLS OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT),\n\t\t\tLEAD(VIP.PREV_INTERVAL_START_3_MONTH, 1) IGNORE NULLS OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT)) AS VIP_NEXT_INTERVAL_START_3_MONTH\n\t\t,COALESCE(CBB.INTERVAL_START_3_MONTH, LAG(CBB.INTERVAL_START_3_MONTH, 1) \n\t\t\tIGNORE NULLS OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT)) AS CBB_INTERVAL_START_3_MONTH \n\t\t,CBB.PREV_INTERVAL_START_3_MONTH as CBB_PREV_INTERVAL_START_3_MONTH\n\t\t,COALESCE(\n\t\t\tLEAD(CBB.INTERVAL_START_3_MONTH, 1) IGNORE NULLS OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT),\n\t\t\tLEAD(CBB.PREV_INTERVAL_START_3_MONTH, 1) IGNORE NULLS OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT)) AS CBB_NEXT_INTERVAL_START_3_MONTH\n\tFROM DATALAKE.PUBLIC.DIM_TRANS TR\n\tLEFT JOIN WEEKLY_CUST CUST ON CUST.ACTIVITY_TXT = TR.ACTIVITY\n\tLEFT JOIN (\n\t\tSELECT DISTINCT ACTIVITY_TXT\n\t\t\t,BRAND_VAL_TXT\n\t\t\t,MAX(VALID_FRM_DT) VALID_FRM_DT\n\t\t\t,MAX(VALID_TO_DT) VALID_TO_DT\n\t\t\tFROM DATALAKE.PUBLIC.DIM_BRAND\n\t\tGROUP BY ACTIVITY_TXT ,BRAND_VAL_TXT\n\t\t) BR ON BR.ACTIVITY_TXT = TR.ACTIVITY AND TR.NORM_POSTING_DT BETWEEN BR.VALID_FRM_DT AND BR.VALID_TO_DT\n\tLEFT JOIN (\n\t\t with curr_acc as(select a.ACCOUNTnumber as current_account\n\t\t\t\t, sf.EFFECTIVE_FROM as  EFFECTIVE_FROM\n\t\t\t\t, sf.VIP AS VIP_FLAG\n\t\t\t\t, lag(sf.VIP, 1) over (partition by sf.ACCOUNT order by sf.effective_from) as PREV_VIP_FLAG--customer_number,min(posting_date) pd_date   --46,726   left join \n             from  \"PROD_DATALAKE\".\"SALESFORCE\".\"ACCOUNT\" a\n             inner join PROD_ENTERPRISE.FINANCE.SALESFORCEACCOUNTTYPETRACKING sf \n             on sf.account=a.accountnumber\n--where  sf.account= '760737'\n           )\n\n,hist_acc as (\nselect a.CRM_ACCOUNT_NUMBER__C as hist_account,\n       ac.accountnumber as current_account\n\t\t\t\t, sf.EFFECTIVE_FROM as  EFFECTIVE_FROM\n\t\t\t\t, sf.VIP AS VIP_FLAG\n\t\t\t\t, lag(sf.VIP, 1) over (partition by sf.ACCOUNT order by sf.effective_from) as PREV_VIP_FLAG--customer_number,min(posting_date) pd_date   --46,726   left join ---\nfrom  \"PROD_DATALAKE\".\"SALESFORCE\".\"BRANCH_ACCOUNT_HISTORY__C\" a\ninner join PROD_ENTERPRISE.FINANCE.SALESFORCEACCOUNTTYPETRACKING sf\non sf.account=a.CRM_ACCOUNT_NUMBER__C\nleft join \"PROD_DATALAKE\".\"SALESFORCE\".\"ACCOUNT\" ac on ac.id=a.ACCOUNT_NAME__C\n--where sf.account='767224'\n\n),\n\nentire_query as (select distinct curr_acc.current_account as account, hist_acc.EFFECTIVE_FROM as  EFFECTIVE_FROM\n\t\t\t\t,  hist_acc.VIP_FLAG as VIP_FLAG\n\t\t\t\t,  hist_acc.PREV_VIP_FLAG as PREV_VIP_FLAG\nfrom curr_acc inner join hist_acc \non curr_acc.current_account = hist_acc.current_account\nand curr_acc.current_account<>hist_acc.hist_account)\n--and hist_acc.current_account='767224')\n--where hist_acc.history_account='769718'\n--select * from entire_query\n,\n\ncurrent_cust as (\n    SELECT distinct ACCOUNT \n\t\t\t\t, EFFECTIVE_FROM\n\t\t\t\t, VIP AS VIP_FLAG\n\t\t\t\t, lag(VIP, 1) over (partition by ACCOUNT order by effective_from) as PREV_VIP_FLAG\n\t\t\tFROM PROD_ENTERPRISE.FINANCE.SALESFORCEACCOUNTTYPETRACKING\n           -- where account=767224     --2021-09-27   --2022-09-19\n            --order by EFFECTIVE_FROM\n\n) ,\nuni as (select ACCOUNT,EFFECTIVE_FROM,VIP_FLAG,PREV_VIP_FLAG from entire_query \n                  union \n                  SELECT ACCOUNT,EFFECTIVE_FROM,VIP_FLAG,PREV_VIP_FLAG\n                from current_cust)\n      \n      (SELECT ACCOUNT\n\t\t\t, EFFECTIVE_FROM AS INTERVAL_START_3_MONTH\n\t\t\t, coalesce(lead(EFFECTIVE_FROM, 1) over (partition by ACCOUNT order by EFFECTIVE_FROM), '1/1/4000') as NEXT_INTERVAL_START_3_MONTH\n      \t\t, lag(EFFECTIVE_FROM, 1) over (partition by ACCOUNT order by EFFECTIVE_FROM) as PREV_INTERVAL_START_3_MONTH\n     from \n     (SELECT u.ACCOUNT\n\t\t\t\t, u.EFFECTIVE_FROM\n\t\t\t\t, u.VIP_FLAG AS VIP_FLAG\n\t\t\t\t, lag(u.VIP_FLAG, 1) over (partition by u.ACCOUNT order by u.effective_from) as PREV_VIP_FLAG\n          from uni u\n\t/*SELECT ACCOUNT\n\t\t\t\t, EFFECTIVE_FROM\n\t\t\t\t, VIP AS VIP_FLAG\n\t\t\t\t, lag(VIP, 1) over (partition by ACCOUNT order by effective_from) as PREV_VIP_FLAG\n\t\t\tFROM PROD_ENTERPRISE.FINANCE.SALESFORCEACCOUNTTYPETRACKING*/\n\t\t\t)\n\t\tWHERE (VIP_FLAG = TRUE) and (PREV_VIP_FLAG = FALSE OR PREV_VIP_FLAG IS NULL)\n\t\t)) VIP ON VIP.ACCOUNT = CUST.CUSTOMER AND TR.NORM_POSTING_DT BETWEEN VIP.INTERVAL_START_3_MONTH AND VIP.NEXT_INTERVAL_START_3_MONTH\n    LEFT JOIN (\n\t\tSELECT CUSTOMER_NUMBER\n\t\t\t  ,POSTING_DATE\n\t\t\t  ,LAG(POSTING_DATE, 1) OVER (PARTITION BY CUSTOMER_NUMBER ORDER BY POSTING_DATE) PREV_POSTING_DATE\n\t\t\t  ,LAG(INTERVAL_START_3_MONTH, 1) IGNORE NULLS OVER (PARTITION BY CUSTOMER_NUMBER ORDER BY POSTING_DATE) PREV_INTERVAL_START_3_MONTH ,INTERVAL_START_3_MONTH\n\t\t  FROM ${DB_Enterprise}.SALES.VW_CLIENT_BILLING_BASE_CUR_HIST--${DB_Enterprise}.SALES.VW_CLIENT_BILLING_BASE\n\t  ) CBB ON CBB.CUSTOMER_NUMBER = CUST.CUSTOMER AND CBB.POSTING_DATE = TR.NORM_POSTING_DT\n\tLEFT JOIN (\n\t\tSELECT R.* ,S.CONV_FACTOR_VAL_TXT\n\t\tFROM DATALAKE.PUBLIC.DIM_ACCT_CAT R\n\t\tINNER JOIN DATALAKE.PUBLIC.DIM_CONV_FACTOR S ON R.CONV_FACTOR_ID = S.CONV_FACTOR_ID) K ON TR.ACCT_CAT_CD = K.ACCT_CAT_TXT\n\t\tWHERE (TR.NORM_POSTING_DT <= CASE \n\t\t\tWHEN DAYOFWEEKISO(TO_DATE(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago', CURRENT_TIMESTAMP()))) IN (1 ,2 ,3 ,4)\n\t\t\tTHEN DATEADD(DAY, - 7 - DAYOFWEEKISO(TO_DATE(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago', CURRENT_TIMESTAMP()))), TO_DATE(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago', CURRENT_TIMESTAMP())))\n\t\t\tELSE DATEADD(DAY, - DAYOFWEEKISO(TO_DATE(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago', CURRENT_TIMESTAMP()))), TO_DATE(CONVERT_TIMEZONE('America/Los_Angeles', 'America/Chicago', CURRENT_TIMESTAMP())))\n\t\t\tEND\tAND TR.NORM_POSTING_DT >= DATE_FROM_PARTS(YEAR(TO_DATE(CURRENT_TIMESTAMP())) - 2, 01, 01)) \n\t\tAND TR.RUN_DATE <= DATEADD(DAY, 9, TR.NORM_POSTING_DT)\n\t\tAND TR.ACTIVE_STATUS = 'Y'\n\t\tAND CUST.ACTIVITY_STATUS = 'Y'\n\t\tAND TR.FISCAL_YEAR >= '2022'\n\t\tand cbb.INTERVAL_START_3_MONTH between '2024-07-29' and '2025-03-30'\n\t)\n                \n,PREP2 AS (\n\tSELECT P.*\n\t\t,DATEDIFF('DAY', \n\t\t\tCOALESCE(VIP_INTERVAL_START_3_MONTH, VIP_PREV_INTERVAL_START_3_MONTH, VIP_NEXT_INTERVAL_START_3_MONTH)\n\t\t\t, NORM_POST_DATE\n\t\t\t) AS VIP_CUST_AGE\n\t\t,DATEDIFF('DAY', \n\t\t\tCOALESCE(CBB_INTERVAL_START_3_MONTH, CBB_PREV_INTERVAL_START_3_MONTH, CBB_NEXT_INTERVAL_START_3_MONTH)\n\t\t\t, NORM_POST_DATE\n\t\t\t) AS CBB_CUST_AGE\n\t\t,CASE WHEN VIP_INTERVAL_START_3_MONTH IS NOT NULL AND VIP_CUST_AGE < CBB_CUST_AGE THEN VIP_CUST_AGE ELSE CBB_CUST_AGE END AS CUST_AGE\n\t\t,CASE WHEN CUST_AGE BETWEEN 0 AND 547 THEN 'NEW' /* 0-18 months */\n\t\t\t WHEN CUST_AGE BETWEEN 548 AND 1094 THEN 'EXISTING' /* 18-36 months */\n\t\t\t WHEN CUST_AGE > 1094 THEN 'LEGACY' /* 36+ months */\n\t\t\t WHEN CUST_AGE < 0 THEN 'LEGACY'\n\t\t\t WHEN VIP_INTERVAL_START_3_MONTH IS NULL \n\t\t\t\tAND VIP_PREV_INTERVAL_START_3_MONTH IS NULL \n\t\t\t\tAND VIP_NEXT_INTERVAL_START_3_MONTH IS NULL\n                AND CBB_INTERVAL_START_3_MONTH IS NULL \n\t\t\t\tAND CBB_PREV_INTERVAL_START_3_MONTH IS NULL \n\t\t\t\tAND CBB_NEXT_INTERVAL_START_3_MONTH IS NULL\n\t\t\t\tTHEN 'LEGACY'\n\t\t END AS CUSTOMER_TYPE\n\tFROM PREP1 P\n\t)\n                \n,CALC_FIELDS AS (\n\tSELECT W.NORM_POST_DATE\n\t\t,W.ACTIVITY\n\t\t,W.CUSTOMER_TYPE\n\t\t,W.ACCT_UNIT_TXT\n\t\t,W.CUSTOMER\n\t\t,W.CUSTOMER_NAME\n        ,SUM(IFF(((W.ACCOUNT_NM in ('2660','4700') and W.ACCT_CAT_CD = '4700')), 0-W.TRAN_AMT, 0)) as DIRECT_HIRE_FEES\n        ,SUM(IFF((W.ACCOUNT_NM = '4750'), 0-W.TRAN_AMT, 0)) as QUICK_HIRE_FEES\n        ,SUM(IFF((W.ACCOUNT_NM = '4600'), 0-W.TRAN_AMT, 0)) AS CONVERSION_FEES\n        ,SUM(W.BILLABLE_AMT - IFF(W.ACCOUNT_NM in ('2660', '4600', '4750'),0-W.TRAN_AMT,0)) AS BILL_AMT\n        ,SUM((W.BILLABLE_AMT - IFF(W.ACCOUNT_NM in ('2660', '4600', '4750'),0-W.TRAN_AMT,0)) - W.PAY_AMT - W.BURDEN) AS GROSS_PROFIT\n        ,SUM(IFF((W.ACCOUNT_NM = '4100' OR W.ACCOUNT_NM = '4101'), 0 - W.TRAN_AMT, 0)) AS ASSOC_BILL_AMT -- Not used anymore\n        ,SUM(W.PAY_AMT + W.BURDEN) AS COST_AMT       \n        ,SUM(IFF((W.ACCOUNT_NM = '4600'), W.TRAN_AMT, 0) \n\t\t\t+ IFF((W.ACCOUNT_NM = '2660' AND W.ACCT_CAT_CD = '4700'), W.TRAN_AMT, 0) \n\t\t\t+ IFF((W.ACCOUNT_NM = '4750'), W.TRAN_AMT, 0)) AS FEES -- Not used anymore\n\tFROM PREP2 W\n\tWHERE W.NORM_POST_DATE > '${varicent_load_date}'\n\tGROUP BY W.NORM_POST_DATE ,W.ACTIVITY ,W.ACCT_UNIT_TXT ,W.CUSTOMER ,W.CUSTOMER_NAME ,W.CUSTOMER_TYPE\n\t)\n\n,ACTIVEDIRECTORY AS (\n\tSELECT DISTINCT a.USER_ID CRMUSER\n\t\t,b.EMPLOYEE_NUMBER\n\t\t,b.FIRST_NAME\n\t\t,b.LAST_NAME\n\t\t,ROW_NUMBER() OVER (PARTITION BY a.USER_ID ORDER BY a.dw_active_flag DESC, b.dw_active_flag DESC) RN\n\tfrom PROD_EDW.ENT.ACTIVE_DIRECTORY_DIM b\n\tjoin PROD_EDW.ENT.SYSTEM_USERS_DIM a on a.SAM_ACCOUNT = b.SAM_ACCOUNT and a.SYSTEM = 'CRM'\n\t)\n  \n,AD_SAMACCOUNT AS (\n\tSELECT DISTINCT b.SAM_ACCOUNT\n\t\t,b.EMPLOYEE_NUMBER\n\t\t,b.FIRST_NAME\n\t\t,b.LAST_NAME\n\t\t,ROW_NUMBER() OVER (PARTITION BY b.SAM_ACCOUNT ORDER BY b.dw_active_flag DESC, a.dw_active_flag DESC) RN\n\tfrom PROD_EDW.ENT.ACTIVE_DIRECTORY_DIM b\n\tjoin PROD_EDW.ENT.SYSTEM_USERS_DIM a on a.SAM_ACCOUNT = b.SAM_ACCOUNT\n) \n \n SELECT concat(ASSIGNMENT.ACCT_UNIT_TXT,REPLACE(ASSIGNMENT.ACTIVITY, 'A', ''),TO_DATE(ASSIGNMENT.NORM_POST_DATE)) AS UNIQUELINEID\n    ,ASSIGNMENT.ACCT_UNIT_TXT AS ACCT_UNIT\n    ,ASSIGNMENT.CUSTOMER AS CUST_ID\n    ,ASSIGNMENT.CUSTOMER_NAME AS CUST_NAME\n    ,ASSIGNMENT.CUSTOMER_TYPE AS CUSTOMER_TYPE\n    ,(CASE WHEN LEFT(ACACTMXVAL.MX_VALUE, 1) = 'H'THEN 'H'\n        ELSE ''\n        END) AS STANDARD_INHERITED_INDICATOR\n    ,REPLACE(ASSIGNMENT.ACTIVITY, 'A', '') AS ASSIGNMENT_NUMBER\n    ,DATE (ASSIGNMENT.NORM_POST_DATE) AS GL_POST_DATE\n    ,ASSIGNMENT.BILL_AMT + ASSIGNMENT.CONVERSION_FEES AS TEMP_SALES\n    ,ASSIGNMENT.BILL_AMT + ASSIGNMENT.CONVERSION_FEES + ASSIGNMENT.DIRECT_HIRE_FEES + ASSIGNMENT.QUICK_HIRE_FEES AS TOTAL_SALES\n    ,ASSIGNMENT.QUICK_HIRE_FEES + ASSIGNMENT.DIRECT_HIRE_FEES AS FEE_SALES\n    ,ASSIGNMENT.COST_AMT AS COST_OF_GOOD_SOLD \n    ,ASSIGNMENT.GROSS_PROFIT + ASSIGNMENT.CONVERSION_FEES + ASSIGNMENT.DIRECT_HIRE_FEES + ASSIGNMENT.QUICK_HIRE_FEES AS TOTAL_GROSS_PROFIT\n    ,ASSIGNMENT.GROSS_PROFIT + ASSIGNMENT.CONVERSION_FEES AS TEMP_GROSS_PROFIT\n    ,ASSIGNMENT.QUICK_HIRE_FEES + ASSIGNMENT.DIRECT_HIRE_FEES AS FEES_GROS_PROFIT\n    ,CASE WHEN (C.FIRST_NAME IS NOT NULL OR C.LAST_NAME IS NOT NULL) THEN CONCAT (C.FIRST_NAME,' ',C.LAST_NAME)\n          WHEN (E.FIRST_NAME IS NOT NULL OR E.LAST_NAME IS NOT NULL) THEN CONCAT (E.FIRST_NAME,' ',E.LAST_NAME)\n          ELSE NULL\n      END AS SALES_REP_NAME\n    ,CASE WHEN BASE.CDA_ASSIGNMENTNUMBER IS NOT NULL THEN C.EMPLOYEE_NUMBER\n          WHEN MBF.MISC_BILLING_NUMBER IS NOT NULL THEN E.EMPLOYEE_NUMBER\n          ELSE NULL\n      END AS SALES_REP_UKG_EMPLOYEE_NUMBER\n    ,CONCAT (D.FIRST_NAME,' ',D.LAST_NAME) AS SUPERVISOR_NAME\n    ,D.EMPLOYEE_NUMBER AS SUPERVISORS_UKG_EMPLOYEE_NUMBER\n    ,CONCAT (B.FIRST_NAME,' ',B.LAST_NAME) AS FILLED_BY_NAME\n    ,B.EMPLOYEE_NUMBER AS FILLED_BY_UKG_EMPLOYEE_NUMBER\n    ,OWNER.NPG_MANAGER AS NPG_MANAGER_NAME\n    ,AD1.EMPLOYEE_NUMBER AS NPG_MANAGER_UKG_EMPLOYEE_NUMBER\n    ,OWNER.NPG_OPS_MANAGER AS NPG_OPERATIONS_NAME\n    ,AD2.EMPLOYEE_NUMBER AS NPG_OPERATIONS_UKG_EMPLOYEE_NUMBER\n    ,OWNER.SPS_SPECIALIST AS SINGLE_POINT_SOLUTIONS_NAME\n    ,AD3.EMPLOYEE_NUMBER AS SINGLE_POINT_SOLUTIONS_UKG_EMPLOYEE_NUMBER\n    ,OWNER.VIP_DIRECTOR AS VIP_DIRECTOR_NAME\n    ,AD4.EMPLOYEE_NUMBER AS VIP_UKG_EMPLOYEE_NUMBER\n    ,'' AS STRATEGIC_ACCOUNT_NAME\n    ,'' AS STRATEGIC_ACCOUNT_UKG_EMPLOYEE_NUMBER\n    ,'' AS STAFFING_PERFORMANCE_MANAGER_NAME\n    ,'' AS STAFFING_PERFORMANCE_MANAGER_UKG_EMPLOYEE_NUMBER\n\t, NULL AS CLIENT_CAMPAIGN\n    , NULL AS CLIENT_CAMPAIGN_TYPE\n    , NULL CLIENT_CAMPAIGN_DATE\nFROM CALC_FIELDS ASSIGNMENT\nLEFT JOIN PROD_DATALAKE.CRM_MSCRM.CDA_ASSIGNMENTBASE BASE ON REPLACE(ASSIGNMENT.ACTIVITY, 'A', '') = BASE.CDA_ASSIGNMENTNUMBER\nLEFT JOIN PROD_EDW.ENT.MISC_BILLING_FACT MBF ON ASSIGNMENT.CUSTOMER = MBF.CUSTOMER_NUMBER \n\tAND REPLACE(ASSIGNMENT.ACTIVITY, 'A', '') = MBF.MISC_BILLING_NUMBER\nLEFT JOIN PROD_DATALAKE.LAWPROD.ACACTIVITY ACT ON REPLACE(ASSIGNMENT.ACTIVITY, 'A', '') = REPLACE(ACT.ACTIVITY, 'A', '')\nLEFT JOIN PROD_DATALAKE.LAWPROD.ACACTMXVAL ACACTMXVAL ON ACT.OBJ_ID = ACACTMXVAL.OBJ_ID AND ACACTMXVAL.MATRIX_CAT = 'SALESREP'\nLEFT JOIN ACTIVEDIRECTORY B ON B.CRMUSER = BASE.CDA_FILLEDBYID AND B.RN = 1\nLEFT JOIN ACTIVEDIRECTORY C ON C.CRMUSER = BASE.OWNERID\tAND C.RN = 1\nLEFT JOIN ACTIVEDIRECTORY D ON D.CRMUSER = BASE.CDA_STAFFINGSUPERVISORID AND D.RN = 1\nLEFT JOIN ACTIVEDIRECTORY E ON E.CRMUSER = MBF.SALE_REP_ID AND E.RN = 1\nLEFT JOIN (\n\tSELECT *, ROW_NUMBER() OVER (PARTITION BY CUSTOMER_NUMBER ORDER BY CREATED_DT DESC) RN\n\tFROM \"PROD_ENTERPRISE\".\"SALES\".\"SALESFORCEACCOUNTOWNERTRACKING\"\n\tWHERE ACTIVE_STATUS = 'Y' AND TO_DATE = '9999-12-31'\n\t) OWNER ON ASSIGNMENT.CUSTOMER = OWNER.CUSTOMER_NUMBER AND OWNER.RN = 1\nLEFT JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"USER\" U1 ON OWNER.NPG_MANAGER_EMPID = U1.ID\tAND OWNER.NPG_MANAGER = CONCAT(U1.FIRSTNAME,' ',U1.LASTNAME)\nLEFT JOIN AD_SAMACCOUNT AD1 ON UPPER(AD1.SAM_ACCOUNT) = UPPER(U1.SAM_ACCOUNT__C) AND AD1.RN = 1 \nLEFT JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"USER\" U2 ON OWNER.NPG_OPS_MGR_EMPID = U2.ID\tAND OWNER.NPG_OPS_MANAGER = CONCAT(U2.FIRSTNAME,' ',U2.LASTNAME)\nLEFT JOIN AD_SAMACCOUNT AD2 ON UPPER(AD2.SAM_ACCOUNT) = UPPER(U2.SAM_ACCOUNT__C) AND AD2.RN = 1\nLEFT JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"USER\" U3 ON OWNER.SPS_SPECIALIST_EMPID = U3.ID\tAND OWNER.SPS_SPECIALIST = CONCAT(U3.FIRSTNAME\t,' ',U3.LASTNAME)\nLEFT JOIN AD_SAMACCOUNT AD3 ON UPPER(AD3.SAM_ACCOUNT) = UPPER(U3.SAM_ACCOUNT__C) AND AD3.RN = 1\nLEFT JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"USER\" U4 ON OWNER.VIP_DIRECTOR_EMPID = U4.ID AND OWNER.VIP_DIRECTOR = CONCAT(U4.FIRSTNAME,' ',U4.LASTNAME)\nLEFT JOIN AD_SAMACCOUNT AD4 ON UPPER(AD4.SAM_ACCOUNT) = UPPER(U4.SAM_ACCOUNT__C) AND AD4.RN = 1\nWHERE (MBF.MISC_BILLING_NUMBER IS NOT NULL OR BASE.CDA_ASSIGNMENTNUMBER IS NOT NULL)\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6342895":{"id":6342895,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":632,"y":247,"width":32,"height":32,"inputConnectorIDs":[6342896],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"LDG_ASSIGNMENT_DETAILS"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"LDG_ASSIGNMENT_DETAILS"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"UNIQUELINEID"},"2":{"slot":2,"type":"STRING","value":"UNIQUELINEID"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"ACCT_UNIT"},"2":{"slot":2,"type":"STRING","value":"ACCT_UNIT"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"CUST_ID"},"2":{"slot":2,"type":"STRING","value":"CUST_ID"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"CUST_NAME"},"2":{"slot":2,"type":"STRING","value":"CUST_NAME"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"CUSTOMER_TYPE"},"2":{"slot":2,"type":"STRING","value":"CUSTOMER_TYPE"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"STANDARD_INHERITED_INDICATOR"},"2":{"slot":2,"type":"STRING","value":"STANDARD_INHERITED_INDICATOR"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"ASSIGNMENT_NUMBER"},"2":{"slot":2,"type":"STRING","value":"ASSIGNMENT_NUMBER"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"GL_POST_DATE"},"2":{"slot":2,"type":"STRING","value":"GL_POST_DATE"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"TEMP_SALES"},"2":{"slot":2,"type":"STRING","value":"TEMP_SALES"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"TOTAL_SALES"},"2":{"slot":2,"type":"STRING","value":"TOTAL_SALES"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"FEE_SALES"},"2":{"slot":2,"type":"STRING","value":"FEE_SALES"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"COST_OF_GOOD_SOLD"},"2":{"slot":2,"type":"STRING","value":"COST_OF_GOOD_SOLD"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"TOTAL_GROSS_PROFIT"},"2":{"slot":2,"type":"STRING","value":"TOTAL_GROSS_PROFIT"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"TEMP_GROSS_PROFIT"},"2":{"slot":2,"type":"STRING","value":"TEMP_GROSS_PROFIT"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"FEES_GROS_PROFIT"},"2":{"slot":2,"type":"STRING","value":"FEES_GROS_PROFIT"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"SALES_REP_NAME"},"2":{"slot":2,"type":"STRING","value":"SALES_REP_NAME"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"SALES_REP_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"SALES_REP_UKG_EMPLOYEE_NUMBER"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"SUPERVISOR_NAME"},"2":{"slot":2,"type":"STRING","value":"SUPERVISOR_NAME"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"SUPERVISORS_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"SUPERVISORS_UKG_EMPLOYEE_NUMBER"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"FILLED_BY_NAME"},"2":{"slot":2,"type":"STRING","value":"FILLED_BY_NAME"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"FILLED_BY_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"FILLED_BY_UKG_EMPLOYEE_NUMBER"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"NPG_MANAGER_NAME"},"2":{"slot":2,"type":"STRING","value":"NPG_MANAGER_NAME"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"NPG_MANAGER_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"NPG_MANAGER_UKG_EMPLOYEE_NUMBER"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"NPG_OPERATIONS_NAME"},"2":{"slot":2,"type":"STRING","value":"NPG_OPERATIONS_NAME"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"NPG_OPERATIONS_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"NPG_OPERATIONS_UKG_EMPLOYEE_NUMBER"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"SINGLE_POINT_SOLUTIONS_NAME"},"2":{"slot":2,"type":"STRING","value":"SINGLE_POINT_SOLUTIONS_NAME"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"SINGLE_POINT_SOLUTIONS_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"SINGLE_POINT_SOLUTIONS_UKG_EMPLOYEE_NUMBER"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"VIP_DIRECTOR_NAME"},"2":{"slot":2,"type":"STRING","value":"VIP_DIRECTOR_NAME"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"VIP_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"VIP_UKG_EMPLOYEE_NUMBER"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"STRATEGIC_ACCOUNT_NAME"},"2":{"slot":2,"type":"STRING","value":"STRATEGIC_ACCOUNT_NAME"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"STRATEGIC_ACCOUNT_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"STRATEGIC_ACCOUNT_UKG_EMPLOYEE_NUMBER"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"STAFFING_PERFORMANCE_MANAGER_NAME"},"2":{"slot":2,"type":"STRING","value":"STAFFING_PERFORMANCE_MANAGER_NAME"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"STAFFING_PERFORMANCE_MANAGER_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"STAFFING_PERFORMANCE_MANAGER_UKG_EMPLOYEE_NUMBER"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"DL_CREATED_DATE"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_DATE"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"DL_CREATED_BY"},"2":{"slot":2,"type":"STRING","value":"DL_CREATEDBY"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"DL_JOBID"},"2":{"slot":2,"type":"STRING","value":"DL_JOBID"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"CLIENT_CAMPAIGN"},"2":{"slot":2,"type":"STRING","value":"CLIENT_CAMPAIGN"}}},"38":{"slot":38,"values":{"1":{"slot":1,"type":"STRING","value":"CLIENT_CAMPAIGN_TYPE"},"2":{"slot":2,"type":"STRING","value":"CLIENT_CAMPAIGN_TYPE"}}},"39":{"slot":39,"values":{"1":{"slot":1,"type":"STRING","value":"CLIENT_CAMPAIGN_DATE"},"2":{"slot":2,"type":"STRING","value":"CLIENT_CAMPAIGN_DATE"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKSCH_VARICENT}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${DB_Enterprise}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6342896":{"id":6342896,"sourceID":6342893,"targetID":6342895},"6342897":{"id":6342897,"sourceID":6342894,"targetID":6342893}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"jb_Varicent_Assignment_Details_3mo_Insert","description":"","type":"TRANSFORMATION","tag":"be96a284-1295-492e-87fe-26c907f948c8"}}