{"job":{"components":{"6342927":{"id":6342927,"inputCardinality":"ONE","outputCardinality":"ZERO","implementationID":211954775,"x":128,"y":80,"width":32,"height":32,"inputConnectorIDs":[6342931],"outputConnectorIDs":[],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Enterprise ASSIGNMENT_DETAILS"}}}},"visible":true},"2":{"slot":2,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ASSIGNMENT_DETAILS"}}}},"visible":true},"4":{"slot":4,"name":"Column Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"UNIQUELINEID"},"2":{"slot":2,"type":"STRING","value":"UNIQUELINEID"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"ACCT_UNIT"},"2":{"slot":2,"type":"STRING","value":"ACCT_UNIT"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"CUST_ID"},"2":{"slot":2,"type":"STRING","value":"CUST_ID"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"CUST_NAME"},"2":{"slot":2,"type":"STRING","value":"CUST_NAME"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"CUSTOMER_TYPE"},"2":{"slot":2,"type":"STRING","value":"CUSTOMER_TYPE"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"STANDARD_INHERITED_INDICATOR"},"2":{"slot":2,"type":"STRING","value":"STANDARD_INHERITED_INDICATOR"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"ASSIGNMENT_NUMBER"},"2":{"slot":2,"type":"STRING","value":"ASSIGNMENT_NUMBER"}}},"8":{"slot":8,"values":{"1":{"slot":1,"type":"STRING","value":"GL_POST_DATE"},"2":{"slot":2,"type":"STRING","value":"GL_POST_DATE"}}},"9":{"slot":9,"values":{"1":{"slot":1,"type":"STRING","value":"TEMP_SALES"},"2":{"slot":2,"type":"STRING","value":"TEMP_SALES"}}},"10":{"slot":10,"values":{"1":{"slot":1,"type":"STRING","value":"TOTAL_SALES"},"2":{"slot":2,"type":"STRING","value":"TOTAL_SALES"}}},"11":{"slot":11,"values":{"1":{"slot":1,"type":"STRING","value":"FEE_SALES"},"2":{"slot":2,"type":"STRING","value":"FEE_SALES"}}},"12":{"slot":12,"values":{"1":{"slot":1,"type":"STRING","value":"COST_OF_GOOD_SOLD"},"2":{"slot":2,"type":"STRING","value":"COST_OF_GOOD_SOLD"}}},"13":{"slot":13,"values":{"1":{"slot":1,"type":"STRING","value":"TOTAL_GROSS_PROFIT"},"2":{"slot":2,"type":"STRING","value":"TOTAL_GROSS_PROFIT"}}},"14":{"slot":14,"values":{"1":{"slot":1,"type":"STRING","value":"TEMP_GROSS_PROFIT"},"2":{"slot":2,"type":"STRING","value":"TEMP_GROSS_PROFIT"}}},"15":{"slot":15,"values":{"1":{"slot":1,"type":"STRING","value":"FEES_GROS_PROFIT"},"2":{"slot":2,"type":"STRING","value":"FEES_GROS_PROFIT"}}},"16":{"slot":16,"values":{"1":{"slot":1,"type":"STRING","value":"SALES_REP_NAME"},"2":{"slot":2,"type":"STRING","value":"SALES_REP_NAME"}}},"17":{"slot":17,"values":{"1":{"slot":1,"type":"STRING","value":"SALES_REP_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"SALES_REP_UKG_EMPLOYEE_NUMBER"}}},"18":{"slot":18,"values":{"1":{"slot":1,"type":"STRING","value":"SUPERVISOR_NAME"},"2":{"slot":2,"type":"STRING","value":"SUPERVISOR_NAME"}}},"19":{"slot":19,"values":{"1":{"slot":1,"type":"STRING","value":"SUPERVISORS_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"SUPERVISORS_UKG_EMPLOYEE_NUMBER"}}},"20":{"slot":20,"values":{"1":{"slot":1,"type":"STRING","value":"FILLED_BY_NAME"},"2":{"slot":2,"type":"STRING","value":"FILLED_BY_NAME"}}},"21":{"slot":21,"values":{"1":{"slot":1,"type":"STRING","value":"FILLED_BY_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"FILLED_BY_UKG_EMPLOYEE_NUMBER"}}},"22":{"slot":22,"values":{"1":{"slot":1,"type":"STRING","value":"NPG_MANAGER_NAME"},"2":{"slot":2,"type":"STRING","value":"NPG_MANAGER_NAME"}}},"23":{"slot":23,"values":{"1":{"slot":1,"type":"STRING","value":"NPG_MANAGER_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"NPG_MANAGER_UKG_EMPLOYEE_NUMBER"}}},"24":{"slot":24,"values":{"1":{"slot":1,"type":"STRING","value":"NPG_OPERATIONS_NAME"},"2":{"slot":2,"type":"STRING","value":"NPG_OPERATIONS_NAME"}}},"25":{"slot":25,"values":{"1":{"slot":1,"type":"STRING","value":"NPG_OPERATIONS_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"NPG_OPERATIONS_UKG_EMPLOYEE_NUMBER"}}},"26":{"slot":26,"values":{"1":{"slot":1,"type":"STRING","value":"SINGLE_POINT_SOLUTIONS_NAME"},"2":{"slot":2,"type":"STRING","value":"SINGLE_POINT_SOLUTIONS_NAME"}}},"27":{"slot":27,"values":{"1":{"slot":1,"type":"STRING","value":"SINGLE_POINT_SOLUTIONS_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"SINGLE_POINT_SOLUTIONS_UKG_EMPLOYEE_NUMBER"}}},"28":{"slot":28,"values":{"1":{"slot":1,"type":"STRING","value":"VIP_DIRECTOR_NAME"},"2":{"slot":2,"type":"STRING","value":"VIP_DIRECTOR_NAME"}}},"29":{"slot":29,"values":{"1":{"slot":1,"type":"STRING","value":"VIP_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"VIP_UKG_EMPLOYEE_NUMBER"}}},"30":{"slot":30,"values":{"1":{"slot":1,"type":"STRING","value":"STRATEGIC_ACCOUNT_NAME"},"2":{"slot":2,"type":"STRING","value":"STRATEGIC_ACCOUNT_NAME"}}},"31":{"slot":31,"values":{"1":{"slot":1,"type":"STRING","value":"STRATEGIC_ACCOUNT_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"STRATEGIC_ACCOUNT_UKG_EMPLOYEE_NUMBER"}}},"32":{"slot":32,"values":{"1":{"slot":1,"type":"STRING","value":"STAFFING_PERFORMANCE_MANAGER_NAME"},"2":{"slot":2,"type":"STRING","value":"STAFFING_PERFORMANCE_MANAGER_NAME"}}},"33":{"slot":33,"values":{"1":{"slot":1,"type":"STRING","value":"STAFFING_PERFORMANCE_MANAGER_UKG_EMPLOYEE_NUMBER"},"2":{"slot":2,"type":"STRING","value":"STAFFING_PERFORMANCE_MANAGER_UKG_EMPLOYEE_NUMBER"}}},"34":{"slot":34,"values":{"1":{"slot":1,"type":"STRING","value":"DL_CREATED_DATE"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_DATE"}}},"35":{"slot":35,"values":{"1":{"slot":1,"type":"STRING","value":"DL_CREATED_BY"},"2":{"slot":2,"type":"STRING","value":"DL_CREATEDBY"}}},"36":{"slot":36,"values":{"1":{"slot":1,"type":"STRING","value":"DL_JOBID"},"2":{"slot":2,"type":"STRING","value":"DL_JOBID"}}},"37":{"slot":37,"values":{"1":{"slot":1,"type":"STRING","value":"REFERRER_BDM"},"2":{"slot":2,"type":"STRING","value":"REFERRER_BDM"}}}},"visible":true},"5":{"slot":5,"name":"Truncate","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Append"}}}},"visible":true},"200":{"slot":200,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${SNFLKSCH_VARICENT}"}}}},"visible":true},"201":{"slot":201,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${DB_Enterprise}"}}}},"visible":true},"202":{"slot":202,"name":"Warehouse","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"203":{"slot":203,"name":"Fix Data Type Mismatches","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"204":{"slot":204,"name":"Order By","elements":{},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6342928":{"id":6342928,"inputCardinality":"ZERO_OR_MANY","outputCardinality":"MANY","implementationID":-1266674941,"x":-288,"y":80,"width":32,"height":32,"inputConnectorIDs":[],"outputConnectorIDs":[6342930],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Source Query"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"WITH WEEKLY_CUST AS (SELECT DISTINCT B.SEARCH_NAME                  AS CUSTOMER_NAME\n                                   , A.ACTIVE_STATUS                   ACTIVITY_STATUS\n                                   , ACTIVITY_TXT\n                                   , TRY_TO_NUMBER(LEVEL_DETAIL_02) AS CUSTOMER\n                     FROM DATALAKE.PUBLIC.DIM_ACTIVITY A\n                              LEFT JOIN (SELECT A.*\n                                         FROM \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" A\n                                                  INNER JOIN (SELECT DISTINCT CUSTOMER, COUNT(CUSTOMER)\n                                                              FROM \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\"\n                                                              GROUP BY CUSTOMER\n                                                              HAVING COUNT(CUSTOMER) = 1) B ON A.CUSTOMER = B.CUSTOMER\n                                         UNION ALL\n                                         SELECT A.*\n                                         FROM \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\" A\n                                                  INNER JOIN (SELECT DISTINCT CUSTOMER, COUNT(CUSTOMER)\n                                                              FROM \"PROD_DATALAKE\".\"LAWPROD\".\"ARCUSTOMER\"\n                                                              GROUP BY CUSTOMER\n                                                              HAVING COUNT(CUSTOMER) > 1) B ON A.CUSTOMER = B.CUSTOMER\n                                         WHERE A.COMPANY = 2) B ON TRY_TO_NUMBER(A.LEVEL_DETAIL_02) = B.CUSTOMER\n                     WHERE A.ACTIVE_STATUS = 'Y')\n\n   , PREP1 AS (SELECT TR.ACTIVITY\n                    , TR.ACCT_UNIT_TXT\n                    , CASE\n                          WHEN TR.ACCOUNT_NM IN (4100, 4200, 4600, 4900, 2660, 4800, 4750, 4950, 4525)\n                              THEN - 1 * TR.TRAN_AMT\n                          ELSE 0\n        END                                                                                                                       AS BILLABLE_AMT\n                    , CASE\n                          WHEN TR.ACCOUNT_NM IN (5100, 5950, 5525, 6120, 5520, 5515)\n                              OR (TR.ACCOUNT_NM IN (5900) AND TR.UNITS_AMOUNT <> 0)\n                              THEN TR.TRAN_AMT\n                          ELSE 0.00\n        END                                                                                                                          PAY_AMT\n                    , CASE\n                          WHEN TR.ACCOUNT_NM IN\n                               (5310, 5320, 5330, 6811, 6812, 5800, 5400, 5410, 5500, 5501, 5510, 5530, 5910)\n                              OR (TR.ACCOUNT_NM IN (5400) AND TR.ACCT_CAT_CD = 'XWHC')\n                              OR (TR.ACCOUNT_NM IN (5900) AND TR.UNITS_AMOUNT = 0)\n                              THEN TR.TRAN_AMT\n                          ELSE 0\n        END                                                                                                                          BURDEN\n                    , TR.ACCOUNT_NM\n                    , TR.TRAN_AMT\n                    , TR.ACCT_CAT_CD\n                    , CASE\n                          WHEN TR.ACCT_CAT_CD = '51RW'\n                              THEN TR.UNITS_AMOUNT\n                          ELSE TR.BILLABLE_UNIT\n        END                                                                                                                       AS BILLABLE_UNIT_NEW\n                    , CASE\n                          WHEN TR.ACCT_CAT_CD = '51RW'\n                              THEN TR.BILLABLE_UNIT\n                          ELSE TR.UNITS_AMOUNT\n        END                                                                                                                       AS UNITS_AMOUNT_NEW\n                    , TR.NORM_POSTING_DT                                                                                          AS NORM_POST_DATE\n                    , CUST.CUSTOMER\n                    , CUST.CUSTOMER_NAME\n                    , CUST.ACTIVITY_STATUS\n                    , IFF(BR.BRAND_VAL_TXT IS NULL, 'UB', BRAND_VAL_TXT)                                                          AS BRANDLEVEL\n                    , K.CONV_FACTOR_VAL_TXT\n                    , MAX(TR.POSTING_DT) OVER (PARTITION BY CUSTOMER ORDER BY TR.POSTING_DT)                                      AS BILL_DATE\n                    , COALESCE(VIP.INTERVAL_START_6_MONTH, LAG(VIP.INTERVAL_START_6_MONTH, 1)\n                                                               IGNORE NULLS\n                                                                   OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT)) AS VIP_INTERVAL_START_6_MONTH\n                    , VIP.PREV_INTERVAL_START_6_MONTH                                                                             as VIP_PREV_INTERVAL_START_6_MONTH\n                    , COALESCE(\n            LEAD(VIP.INTERVAL_START_6_MONTH, 1) IGNORE NULLS\n                OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT),\n            LEAD(VIP.PREV_INTERVAL_START_6_MONTH, 1) IGNORE NULLS\n                OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT))                                                    AS VIP_NEXT_INTERVAL_START_6_MONTH\n                    , COALESCE(CBB.INTERVAL_START_6_MONTH, LAG(CBB.INTERVAL_START_6_MONTH, 1)\n                                                               IGNORE NULLS\n                                                                   OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT)) AS CBB_INTERVAL_START_6_MONTH\n                    , CBB.PREV_INTERVAL_START_6_MONTH                                                                             as CBB_PREV_INTERVAL_START_6_MONTH\n                    , COALESCE(\n            LEAD(CBB.INTERVAL_START_6_MONTH, 1) IGNORE NULLS\n                OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT),\n            LEAD(CBB.PREV_INTERVAL_START_6_MONTH, 1) IGNORE NULLS\n                OVER (PARTITION BY CUST.CUSTOMER ORDER BY TR.NORM_POSTING_DT))                                                    AS CBB_NEXT_INTERVAL_START_6_MONTH\n\n               FROM DATALAKE.PUBLIC.DIM_TRANS TR\n                        LEFT JOIN WEEKLY_CUST CUST ON CUST.ACTIVITY_TXT = TR.ACTIVITY\n                        LEFT JOIN (SELECT DISTINCT ACTIVITY_TXT\n                                                 , BRAND_VAL_TXT\n                                                 , MAX(VALID_FRM_DT) VALID_FRM_DT\n                                                 , MAX(VALID_TO_DT)  VALID_TO_DT\n                                   FROM DATALAKE.PUBLIC.DIM_BRAND\n                                   GROUP BY ACTIVITY_TXT, BRAND_VAL_TXT) BR ON BR.ACTIVITY_TXT = TR.ACTIVITY AND\n                                                                               TR.NORM_POSTING_DT BETWEEN BR.VALID_FRM_DT AND BR.VALID_TO_DT\n                        LEFT JOIN (with curr_acc as (select a.ACCOUNTnumber                                               as current_account\n                                                          , sf.EFFECTIVE_FROM                                             as EFFECTIVE_FROM\n                                                          , sf.VIP                                                        AS VIP_FLAG\n                                                          , lag(sf.VIP, 1)\n                                                                over (partition by sf.ACCOUNT order by sf.effective_from) as PREV_VIP_FLAG--customer_number,min(posting_date) pd_date   --46,726   left join\n                                                     from \"PROD_DATALAKE\".\"SALESFORCE\".\"ACCOUNT\" a\n                                                              inner join PROD_ENTERPRISE.FINANCE.SALESFORCEACCOUNTTYPETRACKING sf\n                                                                         on sf.account = a.accountnumber)\n\n                                      , hist_acc as (select a.CRM_ACCOUNT_NUMBER__C                                       as hist_account\n                                                          , ac.accountnumber                                              as current_account\n                                                          , sf.EFFECTIVE_FROM                                             as EFFECTIVE_FROM\n                                                          , sf.VIP                                                        AS VIP_FLAG\n                                                          , lag(sf.VIP, 1)\n                                                                over (partition by sf.ACCOUNT order by sf.effective_from) as PREV_VIP_FLAG--customer_number,min(posting_date) pd_date   --46,726   left join ---\n                                                     from \"PROD_DATALAKE\".\"SALESFORCE\".\"BRANCH_ACCOUNT_HISTORY__C\" a\n                                                              inner join PROD_ENTERPRISE.FINANCE.SALESFORCEACCOUNTTYPETRACKING sf\n                                                                         on sf.account = a.CRM_ACCOUNT_NUMBER__C\n                                                              left join \"PROD_DATALAKE\".\"SALESFORCE\".\"ACCOUNT\" ac on ac.id = a.ACCOUNT_NAME__C)\n\n                                      , entire_query as (select distinct curr_acc.current_account as account\n                                                                       , hist_acc.EFFECTIVE_FROM  as EFFECTIVE_FROM\n                                                                       , hist_acc.VIP_FLAG        as VIP_FLAG\n                                                                       , hist_acc.PREV_VIP_FLAG   as PREV_VIP_FLAG\n                                                         from curr_acc\n                                                                  inner join hist_acc\n                                                                             on curr_acc.current_account =\n                                                                                hist_acc.current_account\n                                                                                 and curr_acc.current_account <>\n                                                                                     hist_acc.hist_account)\n\n                                      , current_cust as (SELECT distinct ACCOUNT\n                                                                       , EFFECTIVE_FROM\n                                                                       , VIP                                                             AS VIP_FLAG\n                                                                       , lag(VIP, 1) over (partition by ACCOUNT order by effective_from) as PREV_VIP_FLAG\n                                                         FROM PROD_ENTERPRISE.FINANCE.SALESFORCEACCOUNTTYPETRACKING)\n\n                                      , uni as (select ACCOUNT, EFFECTIVE_FROM, VIP_FLAG, PREV_VIP_FLAG\n                                                from entire_query\n                                                union\n                                                SELECT ACCOUNT, EFFECTIVE_FROM, VIP_FLAG, PREV_VIP_FLAG\n                                                from current_cust)\n\n                                       (SELECT ACCOUNT\n                                             , EFFECTIVE_FROM                                          AS INTERVAL_START_6_MONTH\n                                             , coalesce(lead(EFFECTIVE_FROM, 1)\n                                                             over (partition by ACCOUNT order by EFFECTIVE_FROM),\n                                                        '1/1/4000')                                    as NEXT_INTERVAL_START_6_MONTH\n                                             , lag(EFFECTIVE_FROM, 1)\n                                                   over (partition by ACCOUNT order by EFFECTIVE_FROM) as PREV_INTERVAL_START_6_MONTH\n                                        from (SELECT u.ACCOUNT\n                                                   , u.EFFECTIVE_FROM\n                                                   , u.VIP_FLAG                                                  AS VIP_FLAG\n                                                   , lag(u.VIP_FLAG, 1)\n                                                         over (partition by u.ACCOUNT order by u.effective_from) as PREV_VIP_FLAG\n                                              from uni u)\n                                        WHERE (VIP_FLAG = TRUE)\n                                          and (PREV_VIP_FLAG = FALSE OR PREV_VIP_FLAG IS NULL))) VIP\n                                  ON VIP.ACCOUNT = CUST.CUSTOMER AND\n                                     TR.NORM_POSTING_DT BETWEEN VIP.INTERVAL_START_6_MONTH AND VIP.NEXT_INTERVAL_START_6_MONTH\n                        LEFT JOIN (SELECT CUSTOMER_NUMBER\n                                        , POSTING_DATE\n                                        , LAG(POSTING_DATE, 1)\n                                              OVER (PARTITION BY CUSTOMER_NUMBER ORDER BY POSTING_DATE)              PREV_POSTING_DATE\n                                        , LAG(INTERVAL_START_6_MONTH, 1)\n                                              IGNORE NULLS OVER (PARTITION BY CUSTOMER_NUMBER ORDER BY POSTING_DATE) PREV_INTERVAL_START_6_MONTH\n                                        , INTERVAL_START_6_MONTH\n                                   FROM ${DB_Enterprise}.SALES.VW_CLIENT_BILLING_BASE_CUR_HIST\n               ) CBB ON CBB.CUSTOMER_NUMBER = CUST.CUSTOMER AND CBB.POSTING_DATE = TR.NORM_POSTING_DT\n                        LEFT JOIN (SELECT R.*, S.CONV_FACTOR_VAL_TXT\n                                   FROM DATALAKE.PUBLIC.DIM_ACCT_CAT R\n                                            INNER JOIN DATALAKE.PUBLIC.DIM_CONV_FACTOR S\n                                                       ON R.CONV_FACTOR_ID = S.CONV_FACTOR_ID) K\n                                  ON TR.ACCT_CAT_CD = K.ACCT_CAT_TXT\n               WHERE (TR.NORM_POSTING_DT <= CASE\n                                                WHEN DAYOFWEEKISO(TO_DATE(CONVERT_TIMEZONE('America/Los_Angeles',\n                                                                                           'America/Chicago',\n                                                                                           CURRENT_TIMESTAMP()))) IN\n                                                     (1, 2, 3, 4)\n                                                    THEN DATEADD(DAY, - 7 - DAYOFWEEKISO(TO_DATE(CONVERT_TIMEZONE(\n                                                        'America/Los_Angeles', 'America/Chicago',\n                                                        CURRENT_TIMESTAMP()))),\n                                                                 TO_DATE(CONVERT_TIMEZONE('America/Los_Angeles',\n                                                                                          'America/Chicago',\n                                                                                          CURRENT_TIMESTAMP())))\n                                                ELSE DATEADD(DAY,\n                                                             - DAYOFWEEKISO(TO_DATE(CONVERT_TIMEZONE(\n                                                                     'America/Los_Angeles',\n                                                                     'America/Chicago',\n                                                                     CURRENT_TIMESTAMP()))),\n                                                             TO_DATE(CONVERT_TIMEZONE('America/Los_Angeles',\n                                                                                      'America/Chicago',\n                                                                                      CURRENT_TIMESTAMP())))\n                   END AND TR.NORM_POSTING_DT >= DATE_FROM_PARTS(YEAR(TO_DATE(CURRENT_TIMESTAMP())) - 2, 01, 01))\n                 AND TR.RUN_DATE <= DATEADD(DAY, 9, TR.NORM_POSTING_DT)\n                 AND TR.ACTIVE_STATUS = 'Y'\n                 AND CUST.ACTIVITY_STATUS = 'Y'\n                 AND TR.FISCAL_YEAR >= '2022')\n\n   , PREP2 AS (SELECT P.*\n                    , DATEDIFF('DAY',\n                               COALESCE(VIP_INTERVAL_START_6_MONTH, VIP_PREV_INTERVAL_START_6_MONTH,\n                                        VIP_NEXT_INTERVAL_START_6_MONTH)\n        , NORM_POST_DATE\n                      )                         AS VIP_CUST_AGE\n                    , DATEDIFF('DAY',\n                               COALESCE(CBB_INTERVAL_START_6_MONTH, CBB_PREV_INTERVAL_START_6_MONTH,\n                                        CBB_NEXT_INTERVAL_START_6_MONTH)\n        , NORM_POST_DATE\n                      )                         AS CBB_CUST_AGE\n                    , CASE\n                          WHEN VIP_INTERVAL_START_6_MONTH IS NOT NULL AND VIP_CUST_AGE < CBB_CUST_AGE THEN VIP_CUST_AGE\n                          ELSE CBB_CUST_AGE END AS CUST_AGE\n                    , CASE\n                          WHEN CUST_AGE BETWEEN 0 AND 547 THEN 'NEW' /* 0-18 months */\n                          WHEN CUST_AGE BETWEEN 548 AND 1094 THEN 'EXISTING' /* 18-36 months */\n                          WHEN CUST_AGE > 1094 THEN 'LEGACY' /* 36+ months */\n                          WHEN CUST_AGE < 0 THEN 'LEGACY'\n                          WHEN VIP_INTERVAL_START_6_MONTH IS NULL\n                              AND VIP_PREV_INTERVAL_START_6_MONTH IS NULL\n                              AND VIP_NEXT_INTERVAL_START_6_MONTH IS NULL\n                              AND CBB_INTERVAL_START_6_MONTH IS NULL\n                              AND CBB_PREV_INTERVAL_START_6_MONTH IS NULL\n                              AND CBB_NEXT_INTERVAL_START_6_MONTH IS NULL\n                              THEN 'LEGACY'\n        END                                     AS CUSTOMER_TYPE\n               FROM PREP1 P)\n\n   , CALC_FIELDS AS (SELECT W.NORM_POST_DATE\n                          , W.ACTIVITY\n                          , W.CUSTOMER_TYPE\n                          , W.ACCT_UNIT_TXT\n                          , W.CUSTOMER\n                          , W.CUSTOMER_NAME\n                          , SUM(IFF(((W.ACCOUNT_NM in ('2660', '4700') and W.ACCT_CAT_CD = '4700')), 0 - W.TRAN_AMT,\n                                    0))                                                           as DIRECT_HIRE_FEES\n                          , SUM(IFF((W.ACCOUNT_NM = '4750'), 0 - W.TRAN_AMT, 0))                  as QUICK_HIRE_FEES\n                          , SUM(IFF((W.ACCOUNT_NM = '4600'), 0 - W.TRAN_AMT, 0))                  AS CONVERSION_FEES\n                          , SUM(W.BILLABLE_AMT -\n                                IFF(W.ACCOUNT_NM in ('2660', '4600', '4750'), 0 - W.TRAN_AMT, 0)) AS BILL_AMT\n                          , SUM((W.BILLABLE_AMT - IFF(W.ACCOUNT_NM in ('2660', '4600', '4750'), 0 - W.TRAN_AMT, 0)) -\n                                W.PAY_AMT -\n                                W.BURDEN)                                                         AS GROSS_PROFIT\n                          , SUM(IFF((W.ACCOUNT_NM = '4100' OR W.ACCOUNT_NM = '4101'), 0 - W.TRAN_AMT,\n                                    0))                                                           AS ASSOC_BILL_AMT -- Not used anymore\n                          , SUM(W.PAY_AMT + W.BURDEN)                                             AS COST_AMT\n                          , SUM(IFF((W.ACCOUNT_NM = '4600'), W.TRAN_AMT, 0)\n        + IFF((W.ACCOUNT_NM = '2660' AND W.ACCT_CAT_CD = '4700'), W.TRAN_AMT, 0)\n        +\n                                IFF((W.ACCOUNT_NM = '4750'), W.TRAN_AMT, 0))                      AS FEES           -- Not used anymore\n                     FROM PREP2 W\n                     WHERE W.NORM_POST_DATE > '${varicent_load_date}'\n                     GROUP BY W.NORM_POST_DATE\n                            , W.ACTIVITY\n                            , W.ACCT_UNIT_TXT\n                            , W.CUSTOMER\n                            , W.CUSTOMER_NAME\n                            , W.CUSTOMER_TYPE)\n\n   , ACTIVEDIRECTORY AS (SELECT DISTINCT a.USER_ID                                                                                        CRMUSER\n                                       , b.EMPLOYEE_NUMBER\n                                       , b.FIRST_NAME\n                                       , b.LAST_NAME\n                                       , ROW_NUMBER() OVER (PARTITION BY a.USER_ID ORDER BY a.dw_active_flag DESC, b.dw_active_flag DESC) RN\n                         from PROD_EDW.ENT.ACTIVE_DIRECTORY_DIM b\n                                  join PROD_EDW.ENT.SYSTEM_USERS_DIM a\n                                       on a.SAM_ACCOUNT = b.SAM_ACCOUNT and a.SYSTEM = 'CRM')\n\n   , AD_SAMACCOUNT AS (SELECT DISTINCT b.SAM_ACCOUNT\n                                     , b.EMPLOYEE_NUMBER\n                                     , b.FIRST_NAME\n                                     , b.LAST_NAME\n                                     , ROW_NUMBER() OVER (PARTITION BY b.SAM_ACCOUNT ORDER BY b.dw_active_flag DESC, a.dw_active_flag DESC) RN\n                       from PROD_EDW.ENT.ACTIVE_DIRECTORY_DIM b\n                                join PROD_EDW.ENT.SYSTEM_USERS_DIM a on a.SAM_ACCOUNT = b.SAM_ACCOUNT)\n\n   , ref_bdm AS (select distinct cust_sf.account_number                             AS bdm_acct,\n                                 concat(userdim.first_name, ' ', userdim.last_name) AS REFERRER_BDM\n                 FROM prod_edw.ent.ukg_user_dim userdim\n                          INNER JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"OPPORTUNITY\" OP\n                                     ON SPLIT_PART(lower(userdim.email), '@', 1) =\n                                        SPLIT_PART(lower(op.RECRUITER_S_EMAIL__C), '@', 1)\n                                         and userdim.dw_active_flag = 'Y'\n                          inner join prod_edw.ent.customer_sf_dim cust_sf on cust_sf.account_id = op.accountid\n                     and cust_sf.dw_active_flag = 'Y'\n                 where OP.RECRUITER_S_EMAIL__C is not null)\n\nSELECT concat(ASSIGNMENT.ACCT_UNIT_TXT, REPLACE(ASSIGNMENT.ACTIVITY, 'A', ''),\n              TO_DATE(ASSIGNMENT.NORM_POST_DATE))                                                                   AS UNIQUELINEID\n     , ASSIGNMENT.ACCT_UNIT_TXT                                                                                     AS ACCT_UNIT\n     , ASSIGNMENT.CUSTOMER                                                                                          AS CUST_ID\n     , ASSIGNMENT.CUSTOMER_NAME                                                                                     AS CUST_NAME\n     , ASSIGNMENT.CUSTOMER_TYPE                                                                                     AS CUSTOMER_TYPE\n     , (CASE\n            WHEN LEFT(ACACTMXVAL.MX_VALUE, 1) = 'H' THEN 'H'\n            ELSE ''\n    END)                                                                                                            AS STANDARD_INHERITED_INDICATOR\n     , REPLACE(ASSIGNMENT.ACTIVITY, 'A', '')                                                                        AS ASSIGNMENT_NUMBER\n     , DATE(ASSIGNMENT.NORM_POST_DATE)                                                                              AS GL_POST_DATE\n     , ASSIGNMENT.BILL_AMT + ASSIGNMENT.CONVERSION_FEES                                                             AS TEMP_SALES\n     , ASSIGNMENT.BILL_AMT + ASSIGNMENT.CONVERSION_FEES + ASSIGNMENT.DIRECT_HIRE_FEES +\n       ASSIGNMENT.QUICK_HIRE_FEES                                                                                   AS TOTAL_SALES\n     , ASSIGNMENT.QUICK_HIRE_FEES + ASSIGNMENT.DIRECT_HIRE_FEES                                                     AS FEE_SALES\n     , ASSIGNMENT.COST_AMT                                                                                          AS COST_OF_GOOD_SOLD\n     , ASSIGNMENT.GROSS_PROFIT + ASSIGNMENT.CONVERSION_FEES + ASSIGNMENT.DIRECT_HIRE_FEES +\n       ASSIGNMENT.QUICK_HIRE_FEES                                                                                   AS TOTAL_GROSS_PROFIT\n     , ASSIGNMENT.GROSS_PROFIT + ASSIGNMENT.CONVERSION_FEES                                                         AS TEMP_GROSS_PROFIT\n     , ASSIGNMENT.QUICK_HIRE_FEES + ASSIGNMENT.DIRECT_HIRE_FEES                                                     AS FEES_GROS_PROFIT\n     , CASE\n           WHEN (C.FIRST_NAME IS NOT NULL OR C.LAST_NAME IS NOT NULL) THEN CONCAT(C.FIRST_NAME\n               , ' '\n               , C.LAST_NAME)\n           WHEN (E.FIRST_NAME IS NOT NULL OR E.LAST_NAME IS NOT NULL) THEN CONCAT(E.FIRST_NAME\n               , ' '\n               , E.LAST_NAME)\n           ELSE NULL\n    END\n                                                                                                                    AS SALES_REP_NAME\n     , CASE\n           WHEN BASE.CDA_ASSIGNMENTNUMBER IS NOT NULL THEN C.EMPLOYEE_NUMBER\n           WHEN MBF.MISC_BILLING_NUMBER IS NOT NULL THEN E.EMPLOYEE_NUMBER\n           ELSE NULL\n    END\n                                                                                                                    AS SALES_REP_UKG_EMPLOYEE_NUMBER\n     , CONCAT(D.FIRST_NAME, ' ', D.LAST_NAME)                                                                       AS SUPERVISOR_NAME\n     , D.EMPLOYEE_NUMBER                                                                                            AS SUPERVISORS_UKG_EMPLOYEE_NUMBER\n     , CONCAT(B.FIRST_NAME, ' ', B.LAST_NAME)                                                                       AS FILLED_BY_NAME\n     , B.EMPLOYEE_NUMBER                                                                                            AS FILLED_BY_UKG_EMPLOYEE_NUMBER\n     , OWNER.NPG_MANAGER                                                                                            AS NPG_MANAGER_NAME\n     , AD1.EMPLOYEE_NUMBER                                                                                          AS NPG_MANAGER_UKG_EMPLOYEE_NUMBER\n     , OWNER.NPG_OPS_MANAGER                                                                                        AS NPG_OPERATIONS_NAME\n     , AD2.EMPLOYEE_NUMBER                                                                                          AS NPG_OPERATIONS_UKG_EMPLOYEE_NUMBER\n     , OWNER.SPS_SPECIALIST                                                                                         AS SINGLE_POINT_SOLUTIONS_NAME\n     , AD3.EMPLOYEE_NUMBER                                                                                          AS SINGLE_POINT_SOLUTIONS_UKG_EMPLOYEE_NUMBER\n     , OWNER.VIP_DIRECTOR                                                                                           AS VIP_DIRECTOR_NAME\n     , AD4.EMPLOYEE_NUMBER                                                                                          AS VIP_UKG_EMPLOYEE_NUMBER\n     , ''                                                                                                           AS STRATEGIC_ACCOUNT_NAME\n     , ''                                                                                                           AS STRATEGIC_ACCOUNT_UKG_EMPLOYEE_NUMBER\n     , ''                                                                                                           AS STAFFING_PERFORMANCE_MANAGER_NAME\n     , ''                                                                                                           AS STAFFING_PERFORMANCE_MANAGER_UKG_EMPLOYEE_NUMBER\n     , NULL                                                                                                         AS CLIENT_CAMPAIGN\n     , NULL                                                                                                         AS CLIENT_CAMPAIGN_TYPE\n     , NULL                                                                                                            CLIENT_CAMPAIGN_DATE\n     , ref.REFERRER_BDM\nFROM CALC_FIELDS ASSIGNMENT\n         LEFT JOIN PROD_DATALAKE.CRM_MSCRM.CDA_ASSIGNMENTBASE BASE\n                   ON REPLACE(ASSIGNMENT.ACTIVITY, 'A', '') = BASE.CDA_ASSIGNMENTNUMBER\n         LEFT JOIN PROD_EDW.ENT.MISC_BILLING_FACT MBF ON ASSIGNMENT.CUSTOMER = MBF.CUSTOMER_NUMBER\n    AND REPLACE(ASSIGNMENT.ACTIVITY, 'A', '') = MBF.MISC_BILLING_NUMBER\n         LEFT JOIN PROD_DATALAKE.LAWPROD.ACACTIVITY ACT\n                   ON REPLACE(ASSIGNMENT.ACTIVITY, 'A', '') = REPLACE(ACT.ACTIVITY, 'A', '')\n         LEFT JOIN PROD_DATALAKE.LAWPROD.ACACTMXVAL ACACTMXVAL\n                   ON ACT.OBJ_ID = ACACTMXVAL.OBJ_ID AND ACACTMXVAL.MATRIX_CAT = 'SALESREP'\n         LEFT JOIN ACTIVEDIRECTORY B ON B.CRMUSER = BASE.CDA_FILLEDBYID AND B.RN = 1\n         LEFT JOIN ACTIVEDIRECTORY C ON C.CRMUSER = BASE.OWNERID AND C.RN = 1\n         LEFT JOIN ACTIVEDIRECTORY D ON D.CRMUSER = BASE.CDA_STAFFINGSUPERVISORID AND D.RN = 1\n         LEFT JOIN ACTIVEDIRECTORY E ON E.CRMUSER = MBF.SALE_REP_ID AND E.RN = 1\n         LEFT JOIN ref_bdm ref on ref.bdm_acct = ASSIGNMENT.CUSTOMER\n         LEFT JOIN (SELECT *, ROW_NUMBER() OVER (PARTITION BY CUSTOMER_NUMBER ORDER BY CREATED_DT DESC) RN\n                    FROM \"PROD_ENTERPRISE\".\"SALES\".\"SALESFORCEACCOUNTOWNERTRACKING\"\n                    WHERE ACTIVE_STATUS = 'Y'\n                      AND TO_DATE = '9999-12-31') OWNER ON ASSIGNMENT.CUSTOMER = OWNER.CUSTOMER_NUMBER AND OWNER.RN = 1\n         LEFT JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"USER\" U1\n                   ON OWNER.NPG_MANAGER_EMPID = U1.ID AND OWNER.NPG_MANAGER = CONCAT(U1.FIRSTNAME, ' ', U1.LASTNAME)\n         LEFT JOIN AD_SAMACCOUNT AD1 ON UPPER(AD1.SAM_ACCOUNT) = UPPER(U1.SAM_ACCOUNT__C) AND AD1.RN = 1\n         LEFT JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"USER\" U2\n                   ON OWNER.NPG_OPS_MGR_EMPID = U2.ID AND OWNER.NPG_OPS_MANAGER = CONCAT(U2.FIRSTNAME, ' ', U2.LASTNAME)\n         LEFT JOIN AD_SAMACCOUNT AD2 ON UPPER(AD2.SAM_ACCOUNT) = UPPER(U2.SAM_ACCOUNT__C) AND AD2.RN = 1\n         LEFT JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"USER\" U3 ON OWNER.SPS_SPECIALIST_EMPID = U3.ID AND\n                                                             OWNER.SPS_SPECIALIST =\n                                                             CONCAT(U3.FIRSTNAME, ' ', U3.LASTNAME)\n         LEFT JOIN AD_SAMACCOUNT AD3 ON UPPER(AD3.SAM_ACCOUNT) = UPPER(U3.SAM_ACCOUNT__C) AND AD3.RN = 1\n         LEFT JOIN \"PROD_DATALAKE\".\"SALESFORCE\".\"USER\" U4\n                   ON OWNER.VIP_DIRECTOR_EMPID = U4.ID AND OWNER.VIP_DIRECTOR = CONCAT(U4.FIRSTNAME, ' ', U4.LASTNAME)\n         LEFT JOIN AD_SAMACCOUNT AD4 ON UPPER(AD4.SAM_ACCOUNT) = UPPER(U4.SAM_ACCOUNT__C) AND AD4.RN = 1\nWHERE (MBF.MISC_BILLING_NUMBER IS NOT NULL OR BASE.CDA_ASSIGNMENTNUMBER IS NOT NULL)\n"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"},"6342929":{"id":6342929,"inputCardinality":"ONE","outputCardinality":"MANY","implementationID":1716658327,"x":-96,"y":80,"width":32,"height":32,"inputConnectorIDs":[6342930],"outputConnectorIDs":[6342931],"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Add audit columns"}}}},"visible":true},"2":{"slot":2,"name":"Include Input Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true},"3":{"slot":3,"name":"Calculations","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CURRENT_TIMESTAMP"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_DATE"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"CURRENT_USER"},"2":{"slot":2,"type":"STRING","value":"DL_CREATED_BY"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"${run_history_id}"},"2":{"slot":2,"type":"STRING","value":"DL_JOBID"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"'Y'"},"2":{"slot":2,"type":"STRING","value":"ACTIVE_FLAG"}}}},"visible":true}},"exportMappings":{},"expectedFailure":null,"activationStatus":"ENABLED"}},"connectors":{"6342930":{"id":6342930,"sourceID":6342928,"targetID":6342929},"6342931":{"id":6342931,"sourceID":6342929,"targetID":6342927}},"notes":{},"noteConnectors":{},"variables":{},"grids":{}},"info":{"name":"jb_Varicent_Assignment_Details_Insert","description":"","type":"TRANSFORMATION","tag":"9ba59b54-b937-457b-a4bb-447cf3f76e79"}}